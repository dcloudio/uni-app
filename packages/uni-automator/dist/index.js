"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("fs"),e=require("path"),s=require("debug"),n=require("merge"),i=require("jsonc-parser"),o=require("licia/isRelative"),r=require("ws"),a=require("events"),p=require("licia/uuid"),c=require("licia/stringify"),l=require("licia/dateFormat"),u=require("licia/waitUntil"),h=require("os"),d=require("address"),m=require("default-gateway"),g=require("licia/isStr"),y=require("licia/getPort"),v=require("qrcode-terminal"),f=require("licia/fs"),w=require("licia/isFn"),P=require("licia/trim"),M=require("licia/startWith"),A=require("licia/isNum"),I=require("licia/sleep"),E=require("licia/isUndef"),k=require("child_process"),_=require("licia/toStr"),T=require("fs-extra");function C(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var b=C(t),U=C(e),N=C(s),O=C(o),R=C(r),S=C(p),D=C(c),x=C(l),j=C(u),$=C(h),L=C(d),q=C(m),F=C(g),H=C(y),W=C(v),B=C(f),X=C(w),V=C(P),J=C(M),G=C(A),z=C(I),Y=C(E),K=C(_);class Q extends a.EventEmitter{constructor(t){super(),this.ws=t,this.ws.addEventListener("message",(t=>{this.emit("message",t.data)})),this.ws.addEventListener("close",(()=>{this.emit("close")}))}send(t,e){this.ws.send(t,e)}close(){this.ws.close()}}const Z=new Map,tt=["onCompassChange","onThemeChange","onUserCaptureScreen","onWindowResize","onMemoryWarning","onAccelerometerChange","onKeyboardHeightChange","onNetworkStatusChange","onPushMessage","onLocationChange","onGetWifiList","onWifiConnected","onWifiConnectedWithPartialInfo","onSocketOpen","onSocketError","onSocketMessage","onSocketClose"];const et=new Map;function st(t,e){(null==t?void 0:t.success)&&"function"==typeof(null==t?void 0:t.success)&&(e?t.success(e):t.success()),(null==t?void 0:t.complete)&&"function"==typeof(null==t?void 0:t.complete)&&(e?t.complete(e):t.complete())}function nt(t,e){(null==t?void 0:t.fail)&&"function"==typeof(null==t?void 0:t.fail)&&(e?t.fail(e):t.fail()),(null==t?void 0:t.complete)&&"function"==typeof(null==t?void 0:t.complete)&&(e?t.complete(e):t.complete())}async function it(t,e){const[s,n]=function(t){return F.default(t)?[!0,[t]]:[!1,t]}(e),i=await t(n);return s?i[0]:i}function ot(t){try{return require(t)}catch(e){return require(require.resolve(t,{paths:[process.cwd()]}))}}/^win/.test(process.platform);const rt="Connection closed";class at extends a.EventEmitter{constructor(t,e,s){super(),this.puppet=e,this.namespace=s,this.callbacks=new Map,this.transport=t,this.isAlive=!0,this.id=Date.now(),this.exConnectionClosed=!1,this.debug=N.default("automator:protocol:"+this.namespace),this.onMessage=t=>{var e,s,n;if(this.isAlive=!0,"true"===process.env.UNI_APP_X&&'"pong"'===t)return;const{id:i,method:o,error:r,result:a,params:p}=JSON.parse(t);if((null===(e=null==a?void 0:a.data)||void 0===e?void 0:e.length)>10240){let t=JSON.stringify({id:i,method:o,error:r,result:Object.assign(Object.assign({},a),{data:a.data.substring(0,30)+"...<more>"}),params:p});this.debug(`${x.default("yyyy-mm-dd HH:MM:ss:l")} ◀ RECV ${t}`)}else this.debug(`${x.default("yyyy-mm-dd HH:MM:ss:l")} ◀ RECV ${t}`);if(null===(s=null==a?void 0:a.method)||void 0===s?void 0:s.startsWith("on"))return void((t,e)=>{const s=Z.get(t.method);(null==s?void 0:s.has(e))&&s.get(e)(t.data)})(a,i);if(null===(n=null==a?void 0:a.method)||void 0===n?void 0:n.startsWith("Socket.")){return void((t,e,s)=>{const n=et.get(e);(null==n?void 0:n.has(t))&&n.get(t)(s)})(a.method.replace("Socket.",""),a.id,a.data)}if(!i)return this.puppet.emit(o,p);const{callbacks:c}=this;if(i&&c.has(i)){const t=c.get(i);c.delete(i),r?t.reject(Error(r.message||r.detailMessage||r.errMsg)):t.resolve(a)}},this.onClose=()=>{this.callbacks.forEach((t=>{t.reject(Error(rt))}))},this.transport.on("message",this.onMessage),this.transport.on("close",this.onClose)}isBroken(){return!!this.exConnectionClosed}send(t,e={},s=!0){if(s&&this.puppet.adapter.has(t))return this.puppet.adapter.send(this,t,e);if(this.exConnectionClosed)throw this.exConnectionClosed;const n=S.default(),i=D.default({id:n,method:t,params:e});return"ping"!==t&&this.debug(`${x.default("yyyy-mm-dd HH:MM:ss:l")} SEND ► ${i}`),new Promise(((t,e)=>{try{this.transport.send(i,(t=>{t&&e(Error(rt))}))}catch(t){e(Error(rt))}this.callbacks.set(n,{resolve:t,reject:e})})).catch((t=>{throw t.message===rt&&(this.exConnectionClosed=t),t}))}dispose(){this.callbacks.clear(),this.transport.close()}startHeartbeat(){"true"===process.env.UNI_APP_X&&("android"===process.env.UNI_APP_PLATFORM?this.startXAndroidHeartbeat():"ios"===process.env.UNI_APP_PLATFORM&&this.startXIosHeartbeat())}startXAndroidHeartbeat(){const t=new Map,e=ot("adbkit"),s=$.default.platform();let n="",i="";"darwin"===s?(n='ps | grep "u0_a"',i="logcat -b crash | grep -C 10 io.dcloud.uniappx"):"win32"===s&&(n='dumpsys activity | findstr "Run"',i="logcat | findstr UncaughtExceptionHandler"),t.set(this.id,setInterval((async()=>{if(!this.isAlive){const o=e.createClient(),r=await o.listDevices();if(!r.length)throw Error("Device not found");const a=r[0].id,p=await o.getProperties(a);return("1"===p["ro.kernel.qemu"]||"goldfish"===p["ro.hardware"])&&"win32"===s&&(i="logcat | grep UncaughtExceptionHandler"),o.shell(a,n).then((function(t){let e,s="";t.on("data",(function(t){s+=t.toString(),e&&clearTimeout(e),e=setTimeout((()=>{s.includes("io.dcloud.uniapp")||(o.shell(a,"screencap -p /sdcard/uni-automator-screenshot-when-uniapp-un-active.png"),console.log("ADBCommandAppIsLaunch",n),console.log("ADBCommandAppIsLaunch res",s),console.log("Stop the test process."))}),50)}))})),o.shell(a,i).then((t=>{let e,s="";t.on("data",(t=>{s+=t.toString(),e&&clearTimeout(e),e=setTimeout((()=>{console.log(`crash log: ${s}`)}),50)}))})),clearInterval(t.get(this.id)),t.delete(this.id),void this.dispose()}this.send("ping").catch((t=>{})),this.isAlive=!1}),5e3))}startXIosHeartbeat(){const t=new Map;t.set(this.id,setInterval((async()=>{if(!this.isAlive)return console.log("Stop the test process."),clearInterval(t.get(this.id)),t.delete(this.id),void this.dispose();this.send("ping").catch((t=>{})),this.isAlive=!1}),5e3))}static createDevtoolConnection(t,e){return new Promise(((s,n)=>{const i=new R.default(t);i.addEventListener("open",(()=>{s(new at(new Q(i),e,"devtool"))})),i.addEventListener("error",n)}))}static createRuntimeConnection(t,e,s){return new Promise(((n,i)=>{N.default("automator:runtime")(`${x.default("yyyy-mm-dd HH:MM:ss:l")} port=${t}`);const o=new R.default.Server({port:t});j.default((async()=>{if(e.runtimeConnection)return!0}),s,1e3).catch((()=>{o.close(),i("Failed to connect to runtime, please make sure the project is running")})),o.on("connection",(function(t){N.default("automator:runtime")(`${x.default("yyyy-mm-dd HH:MM:ss:l")} connected`);const s=new at(new Q(t),e,"runtime");e.setRuntimeConnection(s),process.env.UNI_AUTOMATOR_NEED_RESTART_BETWEEN_TEST?global.socketConnected=!0:s.startHeartbeat(),n(s)})),e.setRuntimeServer(o)}))}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function pt(t,e,s,n){var i,o=arguments.length,r=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(r=(o<3?i(r):o>3?i(e,s,r):i(e,s))||r);return o>3&&r&&Object.defineProperty(e,s,r),r}var ct;function lt(t,e){const s=e.value;return e.value=async function(e){return(await(null==s?void 0:s.call(this,e)))(t)},e}function ut(t,e,s){return lt(ct.RUNTIME,s)}function ht(t,e,s){return lt(ct.DEVTOOL,s)}!function(t){t.RUNTIME="runtime",t.DEVTOOL="devtool"}(ct||(ct={}));class dt{constructor(t){this.puppet=t}invoke(t,e){return async s=>this.puppet.devtoolConnection?(s===ct.DEVTOOL?this.puppet.devtoolConnection:this.puppet.runtimeConnection).send(t,e):this.puppet.runtimeConnection.send(t,e)}on(t,e){this.puppet.on(t,e)}}class mt extends dt{constructor(t,e){super(t),this.id=e.elementId,this.pageId=e.pageId,this.nodeId=e.nodeId,this.videoId=e.videoId}async getData(t){return this.invokeMethod("Element.getData",t)}async setData(t){return this.invokeMethod("Element.setData",t)}async callMethod(t){return this.invokeMethod("Element.callMethod",t)}async getElement(t){return this.invokeMethod("Element.getElement",t)}async getElements(t){return this.invokeMethod("Element.getElements",t)}async getOffset(){return this.invokeMethod("Element.getOffset")}async getHTML(t){return this.invokeMethod("Element.getHTML",t)}async getAttributes(t){return this.invokeMethod("Element.getAttributes",t)}async getStyles(t){return this.invokeMethod("Element.getStyles",t)}async getDOMProperties(t){return this.invokeMethod("Element.getDOMProperties",t)}async getProperties(t){return this.invokeMethod("Element.getProperties",t)}async tap(){return this.invokeMethod("Element.tap")}async longpress(){return this.invokeMethod("Element.longpress")}async touchstart(t){return this.invokeMethod("Element.touchstart",t)}async touchmove(t){return this.invokeMethod("Element.touchmove",t)}async touchend(t){return this.invokeMethod("Element.touchend",t)}async triggerEvent(t){return this.invokeMethod("Element.triggerEvent",t)}async callFunction(t){return this.invokeMethod("Element.callFunction",t)}async callContextMethod(t){return this.invokeMethod("Element.callContextMethod",t)}invokeMethod(t,e={}){return e.elementId=this.id,e.pageId=this.pageId,this.nodeId&&(e.nodeId=this.nodeId),this.videoId&&(e.videoId=this.videoId),this.invoke(t,e)}}pt([ut],mt.prototype,"getData",null),pt([ut],mt.prototype,"setData",null),pt([ut],mt.prototype,"callMethod",null),pt([ht],mt.prototype,"getElement",null),pt([ht],mt.prototype,"getElements",null),pt([ht],mt.prototype,"getOffset",null),pt([ht],mt.prototype,"getHTML",null),pt([ht],mt.prototype,"getAttributes",null),pt([ht],mt.prototype,"getStyles",null),pt([ht],mt.prototype,"getDOMProperties",null),pt([ht],mt.prototype,"getProperties",null),pt([ht],mt.prototype,"tap",null),pt([ht],mt.prototype,"longpress",null),pt([ht],mt.prototype,"touchstart",null),pt([ht],mt.prototype,"touchmove",null),pt([ht],mt.prototype,"touchend",null),pt([ht],mt.prototype,"triggerEvent",null),pt([ht],mt.prototype,"callFunction",null),pt([ht],mt.prototype,"callContextMethod",null);const gt=Object.prototype.hasOwnProperty,yt=Array.isArray,vt=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;function ft(t,e){if(yt(t))return t;if(e&&(s=e,n=t,gt.call(s,n)))return[t];var s,n;const i=[];return t.replace(vt,(function(t,e,s,n){return i.push(s?n.replace(/\\(\\)?/g,"$1"):e||t),n})),i}function wt(t,e){const s=ft(e,t);let n;for(n=s.shift();null!=n;){if(null==(t=t[n]))return;n=s.shift()}return t}const Pt=require("util"),Mt=["scrollLeft","scrollTop","scrollWidth","scrollHeight"];class At{constructor(t,e,s){this.puppet=t,this.id=e.elementId,this.pageId=e.pageId,this.nodeId=e.nodeId||null,this.videoId=e.videoId||null,this.tagName=e.tagName,this.nvue=e.nvue,this.elementMap=s,At.allElementMaps.add(s),"body"!==this.tagName&&"page-body"!==this.tagName||(this.tagName="page"),this.api=new mt(t,e)}toJSON(){return JSON.stringify({id:this.id,tagName:this.tagName,pageId:this.pageId,nodeId:this.nodeId,videoId:this.videoId})}toString(){return this.toJSON()}[Pt.inspect.custom](){return this.toJSON()}async $(t){try{const e=await this.api.getElement({selector:t});return At.create(this.puppet,Object.assign({},e,{pageId:this.pageId}),this.elementMap)}catch(t){return null}}async $$(t){const{elements:e}=await this.api.getElements({selector:t});return e.map((t=>At.create(this.puppet,Object.assign({},t,{pageId:this.pageId}),this.elementMap)))}async size(){const[t,e]=await this.domProperty(["offsetWidth","offsetHeight"]);return{width:t,height:e}}async offset(){const{left:t,top:e}=await this.api.getOffset();return{left:t,top:e}}async text(){return this.domProperty("innerText")}async attribute(t){if(!F.default(t))throw Error("name must be a string");return(await this.api.getAttributes({names:[t]})).attributes[0]}async value(){return!this.puppet.isX||"ios"!==process.env.UNI_APP_PLATFORM&&"h5"!=process.env.UNI_PLATFORM?this.property("value"):this.domProperty("value")}async property(t){if(!F.default(t))throw Error("name must be a string");if(this.puppet.checkProperty){let e=this.publicProps;if(e||(this.publicProps=e=await this._property("__propPublic")),!e[t])throw Error(`${this.tagName}.${t} not exists`)}return this.puppet.isX&&"h5"===process.env.UNI_PLATFORM&&Mt.includes(t)?await this.domProperty(t):this._property(t)}async html(){return(await this.api.getHTML({type:"inner"})).html}async outerHtml(){return(await this.api.getHTML({type:"outer"})).html}async style(t){if(!F.default(t))throw Error("name must be a string");return(await this.api.getStyles({names:[t]})).styles[0]}async tap(){return this.api.tap()}async longpress(){return this.nvue||"true"===process.env.UNI_APP_X&&("ios"===process.env.UNI_APP_PLATFORM||"android"===process.env.UNI_APP_PLATFORM||"h5"==process.env.UNI_PLATFORM||"app-harmony"==process.env.UNI_PLATFORM)?this.api.longpress():(await this.touchstart(),await z.default(350),this.touchend())}async trigger(t,e){const s={type:t};return Y.default(e)||(s.detail=e),this.api.triggerEvent(s)}async touchstart(t){return this.api.touchstart(t)}async touchmove(t){return this.api.touchmove(t)}async touchend(t){return this.api.touchend(t)}async domProperty(t){return it((async t=>(await this.api.getDOMProperties({names:t})).properties),t)}_property(t){return it((async t=>(await this.api.getProperties({names:t})).properties),t)}send(t,e){return e.elementId=this.id,e.pageId=this.pageId,this.nodeId&&(e.nodeId=this.nodeId),this.videoId&&(e.videoId=this.videoId),this.puppet.send(t,e)}async callFunction(t,...e){return(await this.api.callFunction({functionName:t,args:e})).result}static create(t,e,s){let n,i=s.get(e.elementId);if(i)return i;if(e.nodeId)n=It;else switch(e.tagName.toLowerCase()){case"input":n=Et;break;case"textarea":n=kt;break;case"scroll-view":n=_t;break;case"swiper":n=Tt;break;case"movable-view":n=Ct;break;case"switch":n=bt;break;case"slider":n=Ut;break;case"video":n=Nt;break;default:n=At}return i=new n(t,e,s),s.set(e.elementId,i),i}static clearAllElementMaps(){At.allElementMaps.forEach((t=>t.clear()))}}At.allElementMaps=new Set;class It extends At{async setData(t){return this.api.setData({data:t})}async data(t){const e={};if(t&&(e.path=t),"true"===process.env.UNI_APP_X&&"android"===process.env.UNI_APP_PLATFORM&&"true"!==process.env.UNI_AUTOMATOR_APP_WEBVIEW){const s=(await this.api.getData(e)).data;return t?wt(s,t):s}return(await this.api.getData(e)).data}async callMethod(t,...e){return(await this.api.callMethod({method:t,args:e})).result}}class Et extends At{async input(t){return this.callFunction("input.input",t)}}class kt extends At{async input(t){return this.callFunction("textarea.input",t)}}class _t extends At{async scrollTo(t,e){return this.callFunction("scroll-view.scrollTo",t,e)}async property(t){return"scrollTop"===t?this.callFunction("scroll-view.scrollTop"):"scrollLeft"===t?this.callFunction("scroll-view.scrollLeft"):super.property(t)}async scrollWidth(){return this.callFunction("scroll-view.scrollWidth")}async scrollHeight(){return this.callFunction("scroll-view.scrollHeight")}}class Tt extends At{async swipeTo(t){return this.callFunction("swiper.swipeTo",t)}}class Ct extends At{async moveTo(t,e){return this.callFunction("movable-view.moveTo",t,e)}async property(t){return"x"===t?this._property("_translateX"):"y"===t?this._property("_translateY"):super.property(t)}}class bt extends At{async tap(){return this.callFunction("switch.tap")}}class Ut extends At{async slideTo(t){return this.callFunction("slider.slideTo",t)}}class Nt extends At{async callContextMethod(t,...e){return await this.api.callContextMethod({method:t,args:e})}}class Ot extends dt{constructor(t,e){super(t),this.id=e.id}async getData(t){return this.invokeMethod("Page.getData",t)}async setData(t){return this.invokeMethod("Page.setData",t)}async callMethod(t){return this.invokeMethod("Page.callMethod",t)}async callMethodWithCallback(t){return this.invokeMethod("Page.callMethodWithCallback",t)}async getElement(t){return this.invokeMethod("Page.getElement",t)}async getElements(t){return this.invokeMethod("Page.getElements",t)}async getWindowProperties(t){return this.invokeMethod("Page.getWindowProperties",t)}invokeMethod(t,e={}){return e.pageId=this.id,this.invoke(t,e)}}pt([ut],Ot.prototype,"getData",null),pt([ut],Ot.prototype,"setData",null),pt([ut],Ot.prototype,"callMethod",null),pt([ut],Ot.prototype,"callMethodWithCallback",null),pt([ht],Ot.prototype,"getElement",null),pt([ht],Ot.prototype,"getElements",null),pt([ht],Ot.prototype,"getWindowProperties",null);const Rt=require("util");class St{constructor(t,e){this.puppet=t,this.id=e.id,this.path=e.path,this.query=e.query,this.elementMap=new Map,this.api=new Ot(t,e)}toJSON(){return JSON.stringify({id:this.id,path:this.path,query:this.query})}toString(){return this.toJSON()}[Rt.inspect.custom](){return this.toJSON()}async waitFor(t,e=0){return G.default(t)?await z.default(t):X.default(t)?j.default(t,e,50):F.default(t)?j.default((async()=>{if("true"===process.env.UNI_APP_X){return!!await this.$(t)}return(await this.$$(t)).length>0}),e,50):void 0}async $(t){try{const e=await this.api.getElement({selector:t});return At.create(this.puppet,Object.assign({selector:t},e,{pageId:this.id}),this.elementMap)}catch(t){return null}}async $$(t){const{elements:e}=await this.api.getElements({selector:t});return e.map((e=>At.create(this.puppet,Object.assign({selector:t},e,{pageId:this.id}),this.elementMap)))}async data(t){const e={};if(t&&(e.path=t),"true"===process.env.UNI_APP_X&&"android"===process.env.UNI_APP_PLATFORM&&"true"!==process.env.UNI_AUTOMATOR_APP_WEBVIEW){const s=(await this.api.getData(e)).data;return t?wt(s,t):s}return(await this.api.getData(e)).data}async setData(t){return this.api.setData({data:t})}async size(){const[t,e]=await this.windowProperty(["document.documentElement.scrollWidth","document.documentElement.scrollHeight"]);return{width:t,height:e}}async callMethod(t,...e){return(await this.api.callMethod({method:t,args:e})).result}async callMethodWithCallback(t,...e){return await this.api.callMethodWithCallback({method:t,args:e})}async scrollTop(){return this.windowProperty("document.documentElement.scrollTop")}async windowProperty(t){const e=F.default(t);e&&(t=[t]);const{properties:s}=await this.api.getWindowProperties({names:t});return e?s[0]:s}static create(t,e,s){let n=s.get(e.id);return n?(n.path=e.path,n.query=e.query,n):(n=new St(t,e),s.set(e.id,n),n)}}class Dt extends dt{async getPageStack(){return this.invoke("App.getPageStack")}async callUniMethod(t){return this.invoke("App.callUniMethod",t)}async getCurrentPage(){return this.invoke("App.getCurrentPage")}async mockUniMethod(t){return this.invoke("App.mockUniMethod",t)}async captureScreenshotByRuntime(t){return this.invoke("App.captureScreenshot",t)}async captureScreenshotWithDeviceByRuntime(t){return this.invoke("App.captureScreenshotWithDevice",t)}async socketEmitter(t){return this.invoke("App.socketEmitter",t)}async callFunction(t){return this.invoke("App.callFunction",t)}async captureScreenshot(t){return this.invoke("App.captureScreenshot",t)}async adbCommand(t){return this.invoke("App.adbCommand",t)}async swipe(t){return this.invoke("App.swipe",t)}async tap(t){return this.invoke("App.tap",t)}async keyboardInput(t){return this.invoke("App.keyboardInput",t)}async start(t){return this.invoke("App.start",t)}async exit(){return this.invoke("App.exit")}async addBinding(t){return this.invoke("App.addBinding",t)}async enableLog(){return this.invoke("App.enableLog")}onLogAdded(t){return this.on("App.logAdded",t)}onBindingCalled(t){return this.on("App.bindingCalled",t)}onExceptionThrown(t){return this.on("App.exceptionThrown",t)}}pt([ut],Dt.prototype,"getPageStack",null),pt([ut],Dt.prototype,"callUniMethod",null),pt([ut],Dt.prototype,"getCurrentPage",null),pt([ut],Dt.prototype,"mockUniMethod",null),pt([ut],Dt.prototype,"captureScreenshotByRuntime",null),pt([ut],Dt.prototype,"captureScreenshotWithDeviceByRuntime",null),pt([ut],Dt.prototype,"socketEmitter",null),pt([ht],Dt.prototype,"callFunction",null),pt([ht],Dt.prototype,"captureScreenshot",null),pt([ht],Dt.prototype,"adbCommand",null),pt([ht],Dt.prototype,"swipe",null),pt([ht],Dt.prototype,"tap",null),pt([ht],Dt.prototype,"keyboardInput",null),pt([ht],Dt.prototype,"start",null),pt([ht],Dt.prototype,"exit",null),pt([ht],Dt.prototype,"addBinding",null),pt([ht],Dt.prototype,"enableLog",null);class xt extends dt{async getInfo(){return this.invoke("Tool.getInfo")}async enableRemoteDebug(t){return this.invoke("Tool.enableRemoteDebug")}async close(){return this.invoke("Tool.close")}async getTestAccounts(){return this.invoke("Tool.getTestAccounts")}onRemoteDebugConnected(t){this.puppet.once("Tool.onRemoteDebugConnected",t),this.puppet.once("Tool.onPreviewConnected",t)}}function jt(t){return new Promise((e=>setTimeout(e,t)))}pt([ht],xt.prototype,"getInfo",null),pt([ht],xt.prototype,"enableRemoteDebug",null),pt([ht],xt.prototype,"close",null),pt([ht],xt.prototype,"getTestAccounts",null);class $t extends a.EventEmitter{constructor(t,e){super(),this.puppet=t,this.options=e,this.pageMap=new Map,this.appBindings=new Map,this.appApi=new Dt(t),this.toolApi=new xt(t),this.appApi.onLogAdded((t=>{this.emit("console",t)})),this.appApi.onBindingCalled((({name:t,args:e})=>{try{const s=this.appBindings.get(t);s&&s(...e)}catch(t){}})),this.appApi.onExceptionThrown((t=>{this.emit("exception",t)}))}async pageStack(){return(await this.appApi.getPageStack()).pageStack.map((t=>St.create(this.puppet,t,this.pageMap)))}async navigateTo(t){return this.changeRoute("navigateTo",t)}async redirectTo(t){return this.changeRoute("redirectTo",t)}async navigateBack(){return this.changeRoute("navigateBack")}async reLaunch(t){return process.env.UNI_AUTOMATOR_FAILOVER_ON_RELAUNCH&&this.puppet.runtimeConnection.isBroken()&&("app-plus"!==this.puppet.platform&&"app-harmony"!==this.puppet.platform||(await this.start("jest"),await j.default((()=>!this.puppet.runtimeConnection.isBroken()),5e3,50).catch((t=>{throw new Error("re-launch failed")})))),this.changeRoute("reLaunch",t)}async switchTab(t){return this.changeRoute("switchTab",t)}async currentPage(){const{id:t,path:e,query:s}=await this.appApi.getCurrentPage();return St.create(this.puppet,{id:t,path:e,query:s},this.pageMap)}async systemInfo(){return this.callUniMethod("getSystemInfoSync")}async callUniMethod(t,...e){return(await this.appApi.callUniMethod({method:t,args:e})).result}async mockUniMethod(t,e,...s){return X.default(e)||(n=e,F.default(n)&&(n=V.default(n),J.default(n,"function")||J.default(n,"() =>")))?this.appApi.mockUniMethod({method:t,functionDeclaration:e.toString(),args:s}):this.appApi.mockUniMethod({method:t,result:e});var n}async restoreUniMethod(t){return this.appApi.mockUniMethod({method:t})}async evaluate(t,...e){return(await this.appApi.callFunction({functionDeclaration:t.toString(),args:e})).result}async pageScrollTo(t){await this.callUniMethod("pageScrollTo",{scrollTop:t,duration:0})}async close(){try{await this.appApi.exit()}catch(t){}await jt(1e3),this.puppet.disposeRuntimeServer(),await this.toolApi.close(),this.disconnect()}async start(t){t&&At.clearAllElementMaps(),await this.appApi.start(t)}async teardown(){return this["disconnect"===this.options.teardown?"disconnect":"close"]()}async remote(t){if(!this.puppet.devtools.remote)return console.warn(`Failed to enable remote, ${this.puppet.devtools.name} is unimplemented`);const{qrCode:e}=await this.toolApi.enableRemoteDebug({auto:t});var s;e&&await(s=e,new Promise((t=>{W.default.generate(s,{small:!0},(e=>{process.stdout.write(e),t(void 0)}))})));const n=new Promise((t=>{this.toolApi.onRemoteDebugConnected((async()=>{await jt(1e3),t(void 0)}))})),i=new Promise((t=>{this.puppet.setRemoteRuntimeConnectionCallback((()=>{t(void 0)}))}));return Promise.all([n,i])}disconnect(){this.puppet.dispose()}on(t,e){return"console"===t&&this.appApi.enableLog(),super.on(t,e),this}async exposeFunction(t,e){if(this.appBindings.has(t))throw Error(`Failed to expose function with name ${t}: already exists!`);this.appBindings.set(t,e),await this.appApi.addBinding({name:t})}async checkVersion(){}async screenshot(t){let e="captureScreenshot";this.puppet.isX&&("app-plus"!==this.puppet.platform&&"app-harmony"!==this.puppet.platform||(e=(null==t?void 0:t.deviceShot)?"captureScreenshotWithDeviceByRuntime":"captureScreenshotByRuntime"));const{data:s}=await this.appApi[e]({id:null==t?void 0:t.id,fullPage:null==t?void 0:t.fullPage,deviceShot:null==t?void 0:t.deviceShot,area:null==t?void 0:t.area,offsetX:null==t?void 0:t.offsetX,offsetY:null==t?void 0:t.offsetY});if(!(null==t?void 0:t.path))return s;await B.default.writeFile(t.path,s,"base64")}async testAccounts(){return(await this.toolApi.getTestAccounts()).accounts}async changeRoute(t,e){if(this.puppet.isVue3&&"h5"===process.env.UNI_PLATFORM&&"navigateBack"!==t){const{__id__:s}=await this.callUniMethod(t,{url:e,isAutomatedTesting:!0}),n=Date.now();return await j.default((async()=>{if(Date.now()-n>15e3)throw Error(`${t} to ${e} failed, unable to get the correct current page`);let i;try{i=await this.currentPage()}catch(t){return!1}return i.id===s&&i}),0,1e3)}return await this.callUniMethod(t,{url:e}),await jt(1e3),await this.currentPage()}async socketEmitter(t){return this.appApi.socketEmitter(t)}async adbCommand(t){return"android"===process.env.UNI_APP_PLATFORM?await this.appApi.adbCommand(t):Error("Program.adbCommand is only supported on the app android platform")}async swipe(t){return await this.appApi.swipe(t)}async tap(t){return await this.appApi.tap(t)}async keyboardInput(t){return await this.appApi.keyboardInput(t)}}class Lt{constructor(t){this.options=t}has(t){return!!this.options[t]}send(t,e,s){const n=this.options[e];if(!n)return Promise.reject(Error(`adapter for ${e} not found`));const i=n.reflect;return i?(n.params&&(s=n.params(s)),"function"==typeof i?i(t.send.bind(t),s):(e=i,t.send(e,s))):Promise.reject(Error(`${e}'s reflect is required`))}}const qt=N.default("automator:puppet"),Ft=".automator.json";function Ht(t){try{return require(t)}catch(t){}}function Wt(t,e,s,n){const i=function(t,e,s){let n,i;return process.env.UNI_OUTPUT_DIR?(i=U.default.join(process.env.UNI_OUTPUT_DIR,`../.automator/${e}`,Ft),n=Ht(i)):(i=U.default.join(t,`dist/${s}/.automator/${e}`,Ft),n=Ht(i),n||(i=U.default.join(t,`unpackage/dist/${s}/.automator/${e}`,Ft),n=Ht(i))),qt(`${i}=>${JSON.stringify(n)}`),n}(t,s,n);if(!i||!i.wsEndpoint)return!1;const o=require("../package.json").version;if(i.version!==o)return qt(`unmet=>${i.version}!==${o}`),!1;const r=function(t){let e;try{const t=q.default.v4.sync();e=L.default.ip(t&&t.interface),e&&(/^10[.]|^172[.](1[6-9]|2[0-9]|3[0-1])[.]|^192[.]168[.]/.test(e)||(e=void 0))}catch(t){}return"ws://"+(e||"localhost")+":"+t}(e);return qt(`wsEndpoint=>${r}`),i.wsEndpoint===r}class Bt extends a.EventEmitter{constructor(t,e){if(super(),this.isX=!1,this.isVue3=!1,"true"===process.env.UNI_APP_X&&(this.isX=!0),e)this.target=e;else{if(this.target=null,"h5"===t)try{this.target=ot("@dcloudio/uni-h5/lib/h5/uni.automator.js")}catch(t){}this.target||(this.target=ot(`@dcloudio/uni-${"app"===t?"app-plus":t}/lib/uni.automator.js`))}if(!this.target)throw Error("puppet is not provided");this.platform=t,this.adapter=new Lt(this.target.adapter||{})}setCompiler(t){this.compiler=t}setRuntimeServer(t){this.wss=t}setRemoteRuntimeConnectionCallback(t){this.remoteRuntimeConnectionCallback=t}setRuntimeConnection(t){this.runtimeConnection=t,this.remoteRuntimeConnectionCallback&&(this.remoteRuntimeConnectionCallback(),this.remoteRuntimeConnectionCallback=null)}setDevtoolConnection(t){this.devtoolConnection=t}disposeRuntimeServer(){this.wss&&this.wss.close()}disposeRuntime(){this.runtimeConnection.dispose()}disposeDevtool(){this.compiler&&this.compiler.stop(),this.devtoolConnection&&this.devtoolConnection.dispose()}dispose(){this.disposeRuntime(),this.disposeDevtool(),this.disposeRuntimeServer()}send(t,e){return this.runtimeConnection.send(t,e)}validateProject(t){const e=this.target.devtools.required;return!e||!e.find((e=>!b.default.existsSync(U.default.join(t,e))))}validateDevtools(t){const e=this.target.devtools.validate;return e?e(t,this):Promise.resolve(t)}createDevtools(t,e,s){const n=this.target.devtools.create;return n?(e.timeout=s,n(t,e,this)):Promise.resolve()}shouldCompile(t,e,s,n){this.compiled=!0;const i=this.target.shouldCompile;if(i)this.compiled=i(s,n);else if(!0===s.compile)this.compiled=!0;else{if("false"===process.env.UNI_AUTOMATOR_COMPILE)return!1;this.compiled=!Wt(t,e,this.platform,this.mode)}return this.compiled}beforeCompile(){this.target.beforeCompile&&this.target.beforeCompile(U.default.resolve(__dirname,".."))}afterCompile(){this.target.afterCompile&&this.target.afterCompile()}get checkProperty(){return"mp-weixin"===this.platform}get devtools(){return this.target.devtools}get mode(){const t=this.target.mode;return t||("production"===process.env.NODE_ENV?"build":"dev")}}const Xt=N.default("automator:compiler"),Vt=/The\s+(.*)\s+directory is ready/;class Jt{constructor(t){this.puppet=t,this.puppet.setCompiler(this)}compile(t){const e=this.puppet.mode,s=this.puppet.platform;let n=t.silent;const i=t.port,o=t.host,r=`${e}:${s}`,a=t.projectPath,[p,c]=this.getSpawnArgs(t,r);c.push("--auto-port"),c.push(K.default(i)),o&&(c.push("--auto-host"),c.push(o));const l={cwd:t.cliPath,env:Object.assign(Object.assign({},process.env),{NODE_ENV:"build"===e?"production":"development"})};return new Promise(((t,i)=>{const o=o=>{const r=o.toString().trim();if(!n&&console.log(r),r.includes("- Network")||r.includes("> Network")||r.includes("➜  Network")){const e=r.match(/Network:(.*)/)[1].trim();Xt(`url: ${e}`),t({path:e})}else if(r.includes("DONE  Build failed"))i(r);else if(r.includes("DONE  Build complete")){const i=r.match(Vt);let o="";if(i&&i.length>1)o=U.default.join(a,i[1]);else{const t=this.puppet.isX&&"app-plus"===s?"app":s;o=U.default.join(a,`dist/${e}/${t}`),!T.existsSync(o)&&o.endsWith("app-plus")&&(o=o.substring(0,o.length-8)+"app"),T.existsSync(o)||(o=process.env.UNI_OUTPUT_DIR)}this.puppet.afterCompile(),n=!0,this.stop(),t({path:"true"===process.env.UNI_AUTOMATOR_APP_WEBVIEW?process.env.UNI_OUTPUT_DIR:o})}};Xt(`${p} ${c.join(" ")} %o`,l),this.cliProcess=k.spawn(p,c,l),this.cliProcess.on("error",(t=>{i(t)})),this.cliProcess.stdout.on("data",o),this.cliProcess.stderr.on("data",o)}))}stop(){this.cliProcess&&this.cliProcess.kill("SIGTERM")}getSpawnArgs(t,e){let s;const n=t.cliPath;try{s=require(U.default.join(n,"package.json"))}catch(t){}let i=this.puppet.isX;if(s&&(s.devDependencies&&s.devDependencies["@dcloudio/vite-plugin-uni"]&&(i=!0),!i&&s.dependencies&&s.dependencies["@dcloudio/vite-plugin-uni"]&&(i=!0),s.scripts&&(!s.scripts[e]&&e.endsWith("app-plus")&&(e=e.substring(0,e.length-8)+"app"),s.scripts[e])))return[process.env.UNI_NPM_PATH||(/^win/.test(process.platform)?"npm.cmd":"npm"),["run",e,"--"]];this.puppet.isVue3=i,["android","ios"].includes(process.env.UNI_OS_NAME)&&(process.env.UNI_APP_PLATFORM=process.env.UNI_OS_NAME);let o=this.puppet.platform;if("app-plus"===this.puppet.platform&&this.puppet.isX&&(o="android"===process.env.UNI_APP_PLATFORM?"app-android":"ios"===process.env.UNI_APP_PLATFORM?"app-ios":"app"),process.env.UNI_INPUT_DIR=t.projectPath,process.env.UNI_OUTPUT_DIR=U.default.join(t.projectPath,`unpackage/dist/${this.puppet.mode}/${o}`),process.env.UNI_HBUILDERX_PLUGINS||T.existsSync(U.default.resolve(n,"../about"))&&(process.env.UNI_HBUILDERX_PLUGINS=U.default.dirname(n)),this.puppet.beforeCompile(),i){const t="app-plus"===this.puppet.platform?"app":this.puppet.platform;return process.env.UNI_PLATFORM=t,[process.env.UNI_NODE_PATH||"node",[require.resolve("@dcloudio/vite-plugin-uni/bin/uni.js",{paths:[n]}),"-p",t]]}return[process.env.UNI_NODE_PATH||"node",[U.default.join(n,"bin/uniapp-cli.js")]]}}const Gt=N.default("automator:launcher"),zt="true"===process.env.UNI_APP_X&&"android"===process.env.UNI_APP_PLATFORM?12e4:24e4;class Yt{async launch(t){const{port:e,cliPath:s,timeout:i,projectPath:o}=await this.validate(t);let r={};"app"===t.platform||"app-plus"===t.platform||"app-harmony"===t.platform?(r=t.app||t["app-plus"],"true"===process.env.UNI_APP_X&&r["uni-app-x"]&&(r=n.recursive(!0,r,r["uni-app-x"])),delete r["uni-app-x"]):r=t[t.platform],r||(r={}),r.projectPath=o,Gt(r),this.puppet=new Bt(t.platform,r.puppet),r=await this.puppet.validateDevtools(r);let a=this.puppet.shouldCompile(o,e,t,r),p=process.env.UNI_OUTPUT_DIR||o;if(a||this.puppet.validateProject(p)||(p=U.default.join(o,"dist/"+this.puppet.mode+"/"+this.puppet.platform),this.puppet.validateProject(p)||(p=U.default.join(o,"unpackage/dist/"+this.puppet.mode+"/"+this.puppet.platform),this.puppet.validateProject(p)||(a=!0))),a){this.puppet.compiled=t.compile=!0,this.compiler=new Jt(this.puppet);const n=await this.compiler.compile({host:t.host,port:e,cliPath:s,projectPath:o,silent:!!t.silent});n.path&&(p=n.path)}const c=[];return c.push(this.createRuntimeConnection(e,i)),c.push(this.puppet.createDevtools(p,r,i)),new Promise(((t,s)=>{Promise.all(c).then((([s,n])=>{s&&this.puppet.setRuntimeConnection(s),n&&this.puppet.setDevtoolConnection(n),N.default("automator:program")("ready");const i=r.teardown||"disconnect";t(new $t(this.puppet,{teardown:i,port:e}))})).catch((t=>s(t)))}))}resolveCliPath(t){if(!t)return t;try{const{dependencies:e,devDependencies:s}=require(U.default.join(t,"package.json"));if(Kt(s)||Kt(e))return t}catch(t){}}resolveProjectPath(t,e){return t||(t=process.env.UNI_INPUT_DIR||process.cwd()),O.default(t)&&(t=U.default.resolve(t)),b.default.existsSync(t)||function(t){throw Error(t)}(`Project path ${t} doesn't exist`),t}async validate(t){const e=this.resolveProjectPath(t.projectPath,t);let s=process.env.UNI_CLI_PATH||t.cliPath;if(s=this.resolveCliPath(s||""),!s&&(s=this.resolveCliPath(process.cwd())),!s&&(s=this.resolveCliPath(e)),!s)throw Error("cliPath is not provided");if("false"!==process.env.UNI_APP_X){const t=this.getManifestJson(e);("true"===process.env.UNI_APP_X||"uni-app-x"in t)&&(process.env.UNI_APP_X="true",t.appid&&(process.env.UNI_APP_ID=t.appid))}process.env.UNI_AUTOMATOR_HOST&&(t.host=process.env.UNI_AUTOMATOR_HOST),process.env.UNI_AUTOMATOR_PORT&&(t.port=parseInt(process.env.UNI_AUTOMATOR_PORT));return{port:await async function(t,e){const s=await H.default(t||e);if(t&&s!==t)throw Error(`Port ${t} is in use, please specify another port`);return s}(t.port||9520),cliPath:s,timeout:t.timeout||zt,projectPath:e}}getManifestJson(t){if(t){const e=U.default.join(t,"manifest.json");if(b.default.existsSync(e))return i.parse(b.default.readFileSync(e,"utf8"))}return{}}async createRuntimeConnection(t,e){return at.createRuntimeConnection(t,this.puppet,e)}}function Kt(t){return!!t&&!(!t["@dcloudio/vue-cli-plugin-uni"]&&!t["@dcloudio/vite-plugin-uni"])}exports.Automator=class{constructor(){this.launcher=new Yt}async launch(t){return this.launcher.launch(t)}},exports.initUni=t=>new Proxy({},{get(e,s){return"connectSocket"===s?async(...e)=>{const n=`${Date.now()}-${Math.random()}`;return e[0].id=n,await t.callUniMethod(s,...e).then((s=>{st(e[0],s),et.set(n,new Map);const i={id:n,onMessage:e=>{t.socketEmitter({id:n,method:"onMessage"}),et.get(n).set("onMessage",e)},send:e=>{t.socketEmitter({id:n,method:"send",data:e.data}).then((t=>{st(e,t)})).catch((t=>{nt(e,t)}))},close:e=>{t.socketEmitter({id:n,method:"close",code:e.code,reason:e.reason}).then((t=>{st(e,t),et.delete(n)})).catch((t=>{nt(e,t)}))},onOpen:e=>{t.socketEmitter({id:n,method:"onOpen"}),et.get(n).set("onOpen",e)},onClose:e=>{t.socketEmitter({id:n,method:"onClose"}),et.get(n).set("onClose",e)},onError:e=>{t.socketEmitter({id:n,method:"onError"}),et.get(n).set("onError",e)}};return et.get(n).set("socketTask",i),i})).catch((t=>(nt(e[0],t),null)))}:(n=s,tt.includes(n)?e=>{Z.has(s)||Z.set(s,new Map);const n=Z.get(s),i=`${Date.now()}-${Math.random()}`;n.set(i,e),t.callUniMethod(s,i)}:function(t){return t.startsWith("off")&&tt.includes(t.replace("off","on"))}(s)?async e=>{const n=s.replace("off","on");if(Z.has(n))if(e){const i=Z.get(n);i.forEach(((n,o)=>{n===e&&(i.delete(o),t.callUniMethod(s,o))}))}else Z.delete(n),t.callUniMethod(s)}:async(...e)=>await t.callUniMethod(s,...e).then((t=>(st(e[0],t),t))).catch((t=>(nt(e[0],t),t))));var n}});

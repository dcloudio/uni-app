{"version":3,"sources":["uni_modules/uts-progressNotification/utssdk/app-android/TransparentActivity.uts","uni_modules/uts-progressNotification/utssdk/app-android/index.uts","uni_modules/uts-progressNotification/utssdk/interface.uts","uni_modules/uts-progressNotification/utssdk/app-android/constant.uts","uni_modules/uts-progressNotification/utssdk/app-android/callbacks.uts"],"sourcesContent":["import Activity from \"android.app.Activity\";\nimport Bundle from 'android.os.Bundle';\nimport Build from 'android.os.Build';\nimport View from 'android.view.View';\nimport Color from 'android.graphics.Color';\nimport WindowManager from 'android.view.WindowManager';\nimport { getGlobalNotificationProgressCallBack, getGlobalNotificationProgressFinishCallBack, setGlobalNotificationProgressCallBack, setGlobalNotificationProgressFinishCallBack} from './callbacks.uts';\nimport { ACTION_DOWNLOAD_FINISH, ACTION_DOWNLOAD_PROGRESS } from \"./constant.uts\"\n\n\nexport class TransparentActivity extends Activity {\n\tconstructor() {\n\t\tsuper()\n\t}\n\n  @Suppress(\"DEPRECATION\")\n\toverride onCreate(savedInstanceState : Bundle | null) {\n\t\tsuper.onCreate(savedInstanceState)\n\t\tthis.fullScreen(this)\n\t\tconst action = this.getIntent().getAction()\n\t\tif (action == ACTION_DOWNLOAD_FINISH) {\n\t\t\tsetTimeout(() => {\n        getGlobalNotificationProgressFinishCallBack()?.()\n        setGlobalNotificationProgressFinishCallBack(() => { })\n\t\t\t}, 100)\n\t\t\tthis.overridePendingTransition(0, 0)\n\t\t}\n\n\t\tif (action == ACTION_DOWNLOAD_PROGRESS) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tgetGlobalNotificationProgressCallBack()?.()\n        setGlobalNotificationProgressCallBack(() => { })\n\t\t\t}, 100)\n\t\t\tthis.overridePendingTransition(0, 0)\n\t\t}\n\n\t\tsetTimeout(() => {\n\t\t\tthis.finish()\n\t\t}, 20)\n\t}\n\n\n\t@Suppress(\"DEPRECATION\")\n\tprivate fullScreen(activity : Activity) {\n\t\tif (Build.VERSION.SDK_INT >= 19) {\n\t\t\tif (Build.VERSION.SDK_INT >= 21) {\n\t\t\t\tconst window = activity.getWindow();\n\t\t\t\tconst decorView = window.getDecorView();\n\t\t\t\tconst option = View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN | View.SYSTEM_UI_FLAG_LAYOUT_STABLE;\n\t\t\t\tdecorView.setSystemUiVisibility(option);\n\t\t\t\twindow.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);\n\t\t\t\twindow.setStatusBarColor(Color.TRANSPARENT);\n\t\t\t} else {\n\t\t\t\tconst window = activity.getWindow();\n\t\t\t\tconst attributes = window.getAttributes();\n\t\t\t\tconst flagTranslucentStatus = WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS;\n\t\t\t\tattributes.flags |= flagTranslucentStatus;\n\t\t\t\twindow.setAttributes(attributes);\n\t\t\t}\n\t\t}\n\t}\n}\n","import Build from 'android.os.Build';\nimport Context from 'android.content.Context';\nimport NotificationManager from 'android.app.NotificationManager';\nimport NotificationChannel from 'android.app.NotificationChannel';\nimport Notification from 'android.app.Notification';\nimport Intent from 'android.content.Intent';\nimport ComponentName from 'android.content.ComponentName';\nimport PendingIntent from 'android.app.PendingIntent';\nimport { CreateNotificationProgressOptions, FinishNotificationProgressOptions } from '../interface.uts';\nimport { ACTION_DOWNLOAD_FINISH, ACTION_DOWNLOAD_PROGRESS } from \"./constant.uts\"\n\nimport { setGlobalNotificationProgressCallBack, setGlobalNotificationProgressFinishCallBack } from './callbacks.uts';\n\nexport { TransparentActivity } from './TransparentActivity.uts';\n\n\nconst DOWNLOAD_PROGRESS_NOTIFICATION_ID : Int = 7890\nconst DC_DOWNLOAD_CHANNEL_ID = \"下载文件\"\nconst DC_DOWNLOAD_CHANNEL_NAME = \"用于显示现在进度的渠道\"\n\n\nlet notificationBuilder : Notification.Builder | null = null\n\nlet timeId = -1\n\nlet histroyProgress = 0\n\nlet isProgress = false\n\n\n\nexport function createNotificationProgress(options : CreateNotificationProgressOptions) : void {\n\tconst { content, progress, onClick } = options\n\n\tif (progress == 100) {\n\t\tclearTimeout(timeId)\n\t\tconst context = UTSAndroid.getAppContext() as Context\n\t\trealCreateNotificationProgress(options.title ?? getAppName(context), content, progress, onClick)\n\t\treset()\n\t\treturn\n\t}\n\n\thistroyProgress = progress\n\tif (timeId != -1) {\n\t\treturn\n\t}\n\n\tconst context = UTSAndroid.getAppContext() as Context\n\tif (!isProgress) {\n\t\trealCreateNotificationProgress(options.title ?? getAppName(context), content, histroyProgress, onClick)\n\t\tisProgress = true\n\t} else {\n\t\ttimeId = setTimeout(() => {\n\t\t\trealCreateNotificationProgress(options.title ?? getAppName(context), content, histroyProgress, onClick)\n\t\t\ttimeId = -1\n\t\t}, 1000)\n\t}\n}\n\n\nexport function cancelNotificationProgress() : void {\n\tconst context = UTSAndroid.getAppContext() as Context\n\tconst notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\n\tnotificationManager.cancel(DOWNLOAD_PROGRESS_NOTIFICATION_ID)\n\treset()\n}\n\n\nfunction realCreateNotificationProgress(title : string, content : string, progress : number, cb : (() => void) | null) : void {\n  setGlobalNotificationProgressCallBack(cb)\n\tconst context = UTSAndroid.getAppContext() as Context\n\tconst notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\n\tcreateDownloadChannel(notificationManager)\n\tconst builder = createNotificationBuilder(context)\n\tbuilder.setProgress(100, progress.toInt(), false)\n\tbuilder.setContentTitle(title)\n\tbuilder.setContentText(content)\n\tbuilder.setContentIntent(createPendingIntent(context, ACTION_DOWNLOAD_PROGRESS));\n\tnotificationManager.notify(DOWNLOAD_PROGRESS_NOTIFICATION_ID, builder.build())\n}\n\n\nexport function finishNotificationProgress(options : FinishNotificationProgressOptions) {\n  setGlobalNotificationProgressFinishCallBack(options.onClick)\n\tconst context = UTSAndroid.getAppContext() as Context\n\tconst notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager\n\tcreateDownloadChannel(notificationManager)\n\tconst builder = createNotificationBuilder(context)\n\tbuilder.setProgress(0, 0, false)\n\tbuilder.setContentTitle(options.title ?? getAppName(context))\n\tbuilder.setContentText(options.content)\n\t//小米rom setOngoing未false的时候，会被通知管理器归为不重要通知\n\t// builder.setOngoing(false)\n\tbuilder.setAutoCancel(true);\n\tbuilder.setContentIntent(createPendingIntent(context, ACTION_DOWNLOAD_FINISH));\n\tnotificationManager.notify(DOWNLOAD_PROGRESS_NOTIFICATION_ID, builder.build())\n\treset()\n}\n\nfunction reset() {\n\tisProgress = false\n\tnotificationBuilder = null\n\thistroyProgress = 0\n\tif (timeId != -1) {\n\t\tclearTimeout(timeId)\n\t\ttimeId = -1\n\t}\n}\n\n\n\nfunction createPendingIntent(context : Context, action : string) : PendingIntent {\n\tconst i = new Intent(action);\n\ti.setComponent(new ComponentName(context.getPackageName(), \"uts.sdk.modules.utsProgressNotification.TransparentActivity\"));\n\tlet flags = PendingIntent.FLAG_ONE_SHOT;\n\tif (Build.VERSION.SDK_INT >= 23) {\n\t\tflags = PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE;\n\t}\n\treturn PendingIntent.getActivity(context, DOWNLOAD_PROGRESS_NOTIFICATION_ID, i, flags);\n}\n\n\nfunction createDownloadChannel(notificationManager : NotificationManager) {\n\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\n\t\tconst channel = new NotificationChannel(\n\t\t\tDC_DOWNLOAD_CHANNEL_ID,\n\t\t\tDC_DOWNLOAD_CHANNEL_NAME,\n\t\t\tNotificationManager.IMPORTANCE_LOW\n\t\t)\n\t\tnotificationManager.createNotificationChannel(channel)\n\t}\n}\n@Suppress(\"DEPRECATION\")\nfunction createNotificationBuilder(context : Context) : Notification.Builder {\n\tif (notificationBuilder == null) {\n\t\tif (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\n\t\t\tnotificationBuilder = new Notification.Builder(context, DC_DOWNLOAD_CHANNEL_ID)\n\t\t} else {\n\t\t\tnotificationBuilder = new Notification.Builder(context)\n\t\t}\n\t\tnotificationBuilder!.setSmallIcon(context.getApplicationInfo().icon)\n\t\tnotificationBuilder!.setOngoing(true)\n\t\tnotificationBuilder!.setSound(null)\n\t}\n\treturn notificationBuilder!\n}\n\n@Suppress(\"DEPRECATION\")\nfunction getAppName(context : Context) : string {\n\tlet appName = \"\"\n\ttry {\n\t\tconst packageManager = context.getPackageManager()\n\t\tconst applicationInfo = packageManager.getApplicationInfo(context.getPackageName(), 0)\n\t\tappName = packageManager.getApplicationLabel(applicationInfo) as string\n\t} catch (e : Exception) {\n\t\te.printStackTrace()\n\t}\n\treturn appName\n}\n","export type CreateNotificationProgressOptions = {\n\t/**\n\t * 通知标题\n\t * @defaultValue 应用名称\n\t */\n\ttitle ?: string | null\n\t/**\n\t * 通知内容\n\t */\n\tcontent : string,\n\t/**\n\t * 进度\n\t */\n\tprogress : number,\n\t/**\n\t * 点击通知消息回调\n\t * @defaultValue null\n\t */\n\tonClick? : (() => void) | null\n}\n\n\nexport type FinishNotificationProgressOptions = {\n\t/**\n\t * 通知标题\n\t * @defaultValue 应用名称\n\t */\n\ttitle ?: string | null\n\t/**\n\t * 通知内容\n\t */\n\tcontent : string,\n\t/**\n\t * 点击通知消息回调\n\t */\n\tonClick : () => void\n}\n\n\nexport type CreateNotificationProgress = (options : CreateNotificationProgressOptions) => void;\n\n\nexport type CancelNotificationProgress = () => void;\n\n\nexport type FinishNotificationProgress = (options: FinishNotificationProgressOptions) => void\n","export const ACTION_DOWNLOAD_FINISH = \"ACTION_DOWNLOAD_FINISH\"\r\nexport const ACTION_DOWNLOAD_PROGRESS = \"ACTION_DOWNLOAD_PROGRESS\"","let globalNotificationProgressCallBack : (() => void) | null = () => { }\nlet globalNotificationProgressFinishCallBack : (() => void) | null = () => { }\n\nexport function setGlobalNotificationProgressCallBack(callBack : (() => void) | null) : void {\n  globalNotificationProgressCallBack = callBack\n}\n\nexport function getGlobalNotificationProgressCallBack() : (() => void) | null {\n  return globalNotificationProgressCallBack\n}\n\n\nexport function setGlobalNotificationProgressFinishCallBack(callBack : (() => void) | null) : void {\n  globalNotificationProgressFinishCallBack = callBack\n}\n\nexport function getGlobalNotificationProgressFinishCallBack() : (() => void) | null {\n  return globalNotificationProgressFinishCallBack\n}\n"],"names":[],"mappings":"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"}
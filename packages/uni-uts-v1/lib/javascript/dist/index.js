"use strict";var e=require("fs"),t=require("path"),r=require("debug"),i=require("module"),s=require("@rollup/pluginutils"),n=require("colors/safe"),o=require("events"),a=require("find-cache-dir"),c=require("lodash"),l=require("semver"),p=require("source-map-js"),u=require("@babel/code-frame"),d=require("fs-extra"),f=require("graphlib"),m=require("object-hash"),h=require("url");function y(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var g=y(e),x=y(t),S=y(c),T=y(d);function v(e){return e.factory.createIdentifier("UTS")}function b(e){return e.replace(/\\/g,"/")}const E=new Map;function N(e){const t=b(e);return E.has(t)?E.get(t):g.existsSync(t)?(E.set(t,!0),!0):(E.set(t,!1),!1)}var _;function C(e,t,r,i,s,n,o){return{code:e,category:t,key:r,message:i,reportsUnnecessary:s,elidedInCompatabilityPyramid:n,reportsDeprecated:o}}!function(e){e[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Suggestion=2]="Suggestion",e[e.Message=3]="Message"}(_||(_={}));const I={Type_literal_property_must_have_a_type_annotation:C(1e5,_.Error,"Type_literal_property_must_have_a_type_annotation_100000","Type literal property must have a type annotation."),Only_one_extends_heritage_clause_is_allowed_for_interface:C(100001,_.Error,"Only_one_extends_heritage_clause_is_allowed_for_interface_100001","Only one extends heritage clause is allowed for interface"),Variable_declaration_must_have_initializer:C(100002,_.Error,"Variable_declaration_must_have_initializer_100002","Variable declaration must have initializer."),Nested_type_literal_is_not_supported:C(100003,_.Error,"Nested_type_literal_is_not_supported_100003","Nested type literal is not supported."),Invalid_generic_type_which_can_not_be_constructed:C(100004,_.Error,"Invalid_generic_type_which_can_not_be_constructed_100004","Invalid generic type which can not be constructed."),script_setup_cannot_contain_ES_module_exports:C(100005,_.Error,"script_setup_cannot_contain_ES_module_exports_100005","`<script setup>` cannot contain ES module exports.")},D=b(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules"));function P(e,r,i){function s(e){return e?.constraintType?.origin?.type||e}function n(e){if(!e)return!1;const t=r.getNullType();return r.isTypeAssignableTo(t,e)}function o(t){return!!(t&&e.isUnionTypeNode(t)&&t.types.some((t=>e.isLiteralTypeNode(t)&&t.literal.kind===e.SyntaxKind.NullKeyword)))}return{ts:e,typeChecker:r,context:i,isImportedSymbol:function(t){return!(!t.declarations||!t.declarations.some((t=>e.isImportSpecifier(t)||e.isImportClause(t)&&t.name)))},isPossibleUTSJSONObjectType:function(e,t=!1){return e?e.isUnion()&&e.types.some((e=>"UTSJSONObject"===s(e).symbol?.escapedName))||"UTSJSONObject"===s(e).symbol?.escapedName:!t},isPossibleNullType:n,isPossiblePromiseNullType:function(e){return!!e&&n(r.getPromisedTypeOfPromise(e))},createTypeNodeWithNullType:function(t,r){const s=i.factory,n=o(t);let a=t;return r&&!n&&(a=e.isUnionTypeNode(t)?s.createUnionTypeNode([...t.types,s.createLiteralTypeNode(s.createNull())]):s.createUnionTypeNode([t,s.createLiteralTypeNode(s.createNull())])),a},isUnionWithNullType:o,isObjectLiteralType:function(t){if(!t)return!1;if("__object"===t.symbol?.escapedName)return!0;const r=t?.objectFlags;if(r&&(r&e.ObjectFlags.ObjectLiteral||r&e.ObjectFlags.FreshLiteral))return!0;const i=t.getSymbol();return!!(i&&i.flags&e.SymbolFlags.ObjectLiteral)},getMethodNameNodeOfObjectLiteral:function(t){if(e.isMethodDeclaration(t))return t.name;const r=t.parent;if(!e.isPropertyAssignment(r))return;const i=r.name;return e.isIdentifier(i)?i:void 0},shouldTransfromToUTSJSONObject:function e(t,i){if(!i||i===r.getAnyType())return!0;if(i.isUnion()||i.isIntersection())return i.types.some((r=>e(t,r)));const s=i.getSymbol()||i.aliasSymbol;return!(!s&&!i.isClassOrInterface())&&(!s||"__object"===s?.escapedName||"UTSJSONObject"===s?.escapedName)},isVueOrNativeParameter:function t(i){if(!i.parent)return!1;if(e.isPropertyAssignment(i.parent)&&i.parent.parent&&e.isObjectLiteralExpression(i.parent.parent))return t(i.parent.parent);if(!e.isCallExpression(i.parent))return!1;if(-1===i.parent.expression.pos)return!0;const s=r.getTypeAtLocation(i.parent.expression);if(!s)return!1;const n=s.getCallSignatures()?.[0]?.declaration;if(!n)return!1;const o=n.getSourceFile().fileName,a=o.replace(/\\/g,"/").split("/").pop();return o.endsWith("runtime-core.d.ts")||a&&/lib\.es(\d+|next)\..*d.ts/.test(a)},isComponentData:function(t){const r=t.parent;if(!r||!e.isReturnStatement(r))return!1;const i=r?.parent?.parent;if(!i||!e.isMethodDeclaration(i))return!1;const s=i.name;if(!s||!e.isIdentifier(s)||"data"!==s.escapedText.toString())return!1;const n=i?.parent?.parent;if(!n||!e.isCallExpression(n))return!1;const o=n.expression;return!(!o||!e.isIdentifier(o)||"defineComponent"!==o.escapedText.toString())},isCreateAppReturnValue:function(r){if(process.env.UNI_INPUT_DIR&&b(t.resolve(process.env.UNI_INPUT_DIR,"main.uts"))===b(r.getSourceFile().fileName)&&r.parent&&e.isReturnStatement(r.parent)){const t=r?.parent?.parent?.parent;if(t&&e.isFunctionDeclaration(t)&&t.name&&e.isIdentifier(t.name)&&"createApp"===t.name.escapedText)return!0}},isSetupReturnValue:function(t){const r=t.parent;return r&&e.isVariableDeclaration(r)&&r.name&&e.isIdentifier(r.name)&&"___returned__"===r.name.escapedText}}}const A=[260,169,172,171,208,219,253,229,223,213,214,170,216,234,226,303,304,305,209,227,239,217,235,238,277,294,291,293,286,285];function O(e,t){const{ts:r}=e,i=t?.declarations;if(1!==i?.length)return!1;const s=i[0];if(r.isClassDeclaration(s)){const t=s.heritageClauses?.some((t=>t.token===r.SyntaxKind.ExtendsKeyword&&t.types.some((t=>$(e,t.expression)||function(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:s}=t;return r.isIdentifier(s)&&"UTS"===s.escapedText&&r.isIdentifier(i)&&"UTSType"===i.escapedText}(e,t.expression)))));return t}return!1}function w(e,t){return t.symbol&&O(e,t.symbol)}function k(e){const t=e.context.factory,r=e.ts;return t.createPropertyAccessExpression(t.createParenthesizedExpression(t.createAsExpression(t.createIdentifier("globalThis"),t.createKeywordTypeNode(r.SyntaxKind.AnyKeyword))),t.createIdentifier("UTSType"))}function $(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:s}=t;return r.isIdentifier(s)&&"UTSType"===s.escapedText&&r.isParenthesizedExpression(i)&&r.isAsExpression(i.expression)&&r.isIdentifier(i.expression.expression)&&"globalThis"===i.expression.expression.escapedText}function U(e,t){const{ts:r}=e,i=e.context,s=i.factory,n=e.typeChecker,o=s.createStringLiteral("Unknown");if(e.isUnionWithNullType(t)&&2===t.types.length&&(t=t.types.find((e=>e.kind!==r.SyntaxKind.NullKeyword))),r.isTypeReferenceNode(t)){const{typeName:i,typeArguments:a}=t;if(!r.isIdentifier(i))return o;const c=n.getSymbolAtLocation(i),l=c?.declarations?.[0];return l&&function(e,t){if(!e.ts.isClassDeclaration(t))return!1;const{heritageClauses:r}=t,i=r?.[0]?.types?.[0]?.expression;return!(!i||!$(e,i))}(e,l)?a?s.createCallExpression(s.createPropertyAccessExpression(k(e),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier(i.escapedText.toString()),s.createArrayLiteralExpression([...a.map((t=>U(e,t)))],!1)]):s.createIdentifier(i.escapedText.toString()):o}if(r.isArrayTypeNode(t))return s.createCallExpression(s.createPropertyAccessExpression(k(e),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier("Array"),s.createArrayLiteralExpression([U(e,t.elementType)],!1)]);if(r.isTypeLiteralNode(t))i.addBindDiagnostic(r.createDiagnosticForNode(t,I.Nested_type_literal_is_not_supported));else{if(t.kind===r.SyntaxKind.NumberKeyword)return s.createIdentifier("Number");if(t.kind===r.SyntaxKind.StringKeyword)return s.createIdentifier("String");if(t.kind===r.SyntaxKind.BooleanKeyword)return s.createIdentifier("Boolean");if(t.kind===r.SyntaxKind.AnyKeyword)return s.createStringLiteral("Any")}return o}function F(e,t,r){const{ts:i}=e,s=e.context.factory;return s.createMethodDeclaration([s.createToken(i.SyntaxKind.StaticKeyword)],void 0,s.createIdentifier("get$UTSMetadata$"),void 0,void 0,t?[...t.map((e=>s.createParameterDeclaration(void 0,void 0,s.createIdentifier(e.name.escapedText.toString()),s.createToken(i.SyntaxKind.QuestionToken),s.createKeywordTypeNode(i.SyntaxKind.AnyKeyword),void 0)))]:[],void 0,s.createBlock([s.createReturnStatement(s.createAsExpression(r,s.createKeywordTypeNode(i.SyntaxKind.AnyKeyword)))],!0))}function R(e,t,r,i){const s=e.context.factory,n=[s.createPropertyAssignment(s.createIdentifier("kind"),s.createNumericLiteral(r)),s.createPropertyAssignment(s.createIdentifier("interfaces"),s.createArrayLiteralExpression(i,!1))];return"development"===process.env.NODE_ENV&&n.push(s.createPropertyAssignment(s.createIdentifier("name"),s.createStringLiteral(t))),[F(e,void 0,s.createObjectLiteralExpression(n,!0))]}globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;function L(e,t){const r=e.ts,i=e.context.factory,{modifiers:s,name:n,typeParameters:o,heritageClauses:a,members:c}=t,l=c.filter((e=>r.isPropertyDeclaration(e))),p=function(e,t,r,i,s){const n=e.context.factory,o=[n.createPropertyAssignment(n.createIdentifier("kind"),n.createNumericLiteral(r)),n.createGetAccessorDeclaration(void 0,n.createIdentifier("fields"),[],void 0,n.createBlock([n.createReturnStatement(n.createObjectLiteralExpression([...i.map((t=>{let r="";(t.jsDoc||[]).forEach((e=>{(e.tags||[]).forEach((e=>{if("JSON_FIELD"===e.tagName.escapedText&&"string"==typeof e.comment){const t=e.comment.length;r="'"===e.comment[0]&&"'"===e.comment[t-1]||'"'===e.comment[0]&&'"'===e.comment[t-1]?e.comment.slice(1,-1):e.comment}}))}));const i=[n.createPropertyAssignment(n.createIdentifier("type"),U(e,t.type)),n.createPropertyAssignment(n.createIdentifier("optional"),t.questionToken||e.isUnionWithNullType(t.type)?n.createTrue():n.createFalse())];return r&&i.push(n.createPropertyAssignment(n.createIdentifier("jsonField"),n.createStringLiteral(r))),n.createPropertyAssignment(n.createIdentifier(t.name.escapedText.toString()),n.createObjectLiteralExpression(i))}))],!0))],!0))];return"development"===process.env.NODE_ENV&&o.push(n.createPropertyAssignment(n.createIdentifier("name"),n.createStringLiteral(t))),[F(e,s,n.createObjectLiteralExpression(o,!0))]}(e,n?n.escapedText.toString():"",2,l,o?[...o]:[]),u=c.find((e=>r.isIndexSignatureDeclaration(e))),d=c.find((e=>r.isConstructorDeclaration(e))),{parameters:f}=d,m=[...f,i.createParameterDeclaration(void 0,void 0,i.createIdentifier("metadata"),void 0,i.createKeywordTypeNode(r.SyntaxKind.AnyKeyword),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier(n.escapedText),i.createIdentifier("get$UTSMetadata$")),void 0,[])),i.createParameterDeclaration(void 0,void 0,i.createIdentifier("isJSONParse"),void 0,i.createKeywordTypeNode(r.SyntaxKind.BooleanKeyword),i.createFalse())],h="__props__",y=i.createConstructorDeclaration(void 0,m,i.createBlock([i.createExpressionStatement(i.createCallExpression(i.createSuper(),void 0,[])),i.createExpressionStatement(i.createBinaryExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(h)),i.createToken(r.SyntaxKind.EqualsToken),i.createCallExpression(i.createPropertyAccessExpression(k(e),i.createIdentifier("initProps")),void 0,[i.createIdentifier("options"),i.createIdentifier("metadata"),i.createIdentifier("isJSONParse")]))),...l.map((e=>{const{name:t}=e,s=t.escapedText;return i.createExpressionStatement(i.createBinaryExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(s)),i.createToken(r.SyntaxKind.EqualsToken),i.createPropertyAccessExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(h)),i.createIdentifier(s))))})),i.createExpressionStatement(i.createDeleteExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(h))))],!0));return i.updateClassDeclaration(t,s,n,o,a,[u,...l,...p,y])}function j(e,t,r,i){return s=>{const n=r(s);return r=>{const o=e.isSourceFile(r);return s.fileName||o&&(s.fileName=r.fileName),t.shouldTransform(s.fileName)?(o&&!r.isUTSFile&&(r.isUTSFile=!0,t.isVueFile?.(s.fileName)&&(r.isVueFile=!0)),o&&"parser"===i&&r.statements.length&&(r.statements[0].parent||e.setParentRecursive(r,!0)),n(r)):r}}}function M(e,t){return t&&t!==e&&!Array.isArray(t)&&(t.__parsedByUtsParser=!0,t.parent=e.parent),t}let K;function W(e,t,r){return function(e){if(!e.ObjectFlags.UTSType){const{Class:t,Interface:r,Reference:i,Anonymous:s,ArrayLiteral:n}=e.ObjectFlags;e.ObjectFlags.UTSType=t|r|i|s|n}if(!e.TypeFlags.UTSType){const{Any:t,String:r,Number:i,Boolean:s,Enum:n,StringLiteral:o,NumberLiteral:a,BooleanLiteral:c,EnumLiteral:l,Void:p,Null:u,Object:d,Union:f,TemplateLiteral:m}=e.TypeFlags;e.TypeFlags.UTSType=t|r|i|s|n|o|a|c|l|p|u|d|f|m,e.TypeFlags.UTSStringLike=r|o|m,e.TypeFlags.UTSNumberLike=i|a}}(e),i=>{const s={},n=[],o=[],a=[];return t.forEach((t=>{let c=t(e,i,r);if("function"==typeof c)n.push(j(e,i,c,"before"));else{if(c.parser){const n=t(function(e){if(K)return K;K={...e};const{visitNode:t,visitEachChild:r}=e;return K.visitNode=(e,r)=>t(e,(e=>M(e,r(e)))),K.visitEachChild=(e,t,i)=>r(e,(e=>M(e,t(e))),i),K}(e),i,r);n.parser&&function(e,t,r,i){i.TypeAliasDeclaration&&(r.TypeAliasDeclaration||(r.TypeAliasDeclaration=[])).push(j(e,t,(e=>{const t=i.TypeAliasDeclaration(e);return e=>M(e,t(e))}),"parser")),i.SourceFile&&(r.SourceFile||(r.SourceFile=[])).push(j(e,t,i.SourceFile,"parser"))}(e,i,s,n.parser)}c.before&&n.push(j(e,i,c.before,"before")),c.after&&o.push(j(e,i,c.after,"after")),c.afterDeclarations&&a.push(j(e,i,c.afterDeclarations,"afterDeclarations"))}})),{parser:s,before:n,after:o,afterDeclarations:a}}}globalThis.__utsHacker__={...globalThis.__utsHacker__},r("uts:transformer:importAndExportDeclaration"),r("uts:transformer:autoImport"),r("uts:transformer:arguments");function z(e,t){return e.isExpressionStatement(t)&&e.isCallExpression(t.expression)&&e.isIdentifier(t.expression.expression)&&"defineExpose"===t.expression.expression.text}function J(e,t){return e.createExportAssignment(void 0,void 0,e.createCallExpression(e.createIdentifier("defineComponent"),void 0,[e.createObjectLiteralExpression([e.createMethodDeclaration(void 0,void 0,e.createIdentifier("setup"),void 0,void 0,[e.createParameterDeclaration(void 0,void 0,e.createIdentifier("props"),void 0,void 0,void 0),e.createParameterDeclaration(void 0,void 0,e.createObjectBindingPattern([e.createBindingElement(void 0,void 0,e.createIdentifier("expose"),void 0)]),void 0,void 0,void 0)],void 0,e.createBlock(t,!0))],!0)]))}r("uts:transformer:generics"),r("uts:transformer:in"),r("uts:transformer:keyof"),r("uts:transformer:narrowType:discriminatedUnion"),r("uts:transformer:narrowType"),r("uts:transformer:narrowType:parameterUnionType"),r("uts:transformer:UTSObjectUnionType"),r("uts:transformer:objectLiteral"),r("uts:transformer:returnType"),r("uts:transformer:UTSJSONObject"),globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;let V=null,B=[];const q=["defineMixin","definePlugin"],H=new Map;H.set("onShow",!1),H.set("onHide",!1),H.set("onAppShow",!0),H.set("onLaunch",!0),H.set("onError",!0),H.set("onThemeChange",!0),H.set("onKeyboardHeightChange",!0),H.set("onPageNotFound",!0),H.set("onUnhandledRejection",!0),H.set("onLastPageBackPress",!1),H.set("onExit",!1),H.set("onLoad",!0),H.set("onShow",!0),H.set("onReady",!1),H.set("onUnload",!1),H.set("onResize",!0),H.set("onBackPress",!0),H.set("onPageScroll",!0),H.set("onTabItemTap",!0),H.set("onReachBottom",!1),H.set("onPullDownRefresh",!1),H.set("beforeCreate",!1),H.set("created",!1),H.set("beforeMount",!1),H.set("mounted",!1),H.set("beforeUpdate",!1),H.set("updated",!1),H.set("beforeUnmount",!1),H.set("unmounted",!1);function G(e,t){const{ts:r}=e;return e.context.factory.createPropertyAccessExpression(r.isQualifiedName(t.left)?G(e,t.left):t.left,t.right)}function Z(e,t,r){const{ts:i}=e,s=e.context.factory,n=i.isQualifiedName(r)?G(e,r):s.createIdentifier(r.escapedText.toString());return s.createNewExpression(n,void 0,[t])}function X(e,t){const{ts:r}=e,i=e.context,s=e.typeChecker,n=i.factory,{type:o,expression:a}=t;if(!r.isObjectLiteralExpression(a))return;if(r.isTypeReferenceNode(o)&&r.isIdentifier(o.typeName)&&"UTSJSONObject"===o.typeName.escapedText)return n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[a]);let c;try{c=s.getContextualType(a)?.symbol}catch(e){}return c?c&&"UTSJSONObject"===c.escapedName?n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[a]):o&&function(e,t){const r=e.typeChecker.getContextualType(t);return!(!r||!w(e,r))}(e,a)&&r.isObjectLiteralExpression(a)?Z(e,a,o.typeName):void 0:void 0}const Q={Array_pop:"arrayPop",Array_shift:"arrayShift",Array_find:"arrayFind",Array_findLast:"arrayFindLast",Array_at:"arrayAt",Map_get:"mapGet",WeakMap_get:"weakMapGet",string_codePointAt:"stringCodePointAt",string_at:"stringAt"},Y=Object.keys(Q).map((e=>e.split("_")[1])),ee=["uni.request","JSON.parse","JSON.parseArray","JSON.parseObject"];function te(e,t){const r=e.ts,i=e.context,s=i.factory;if(r.isArrayTypeNode(t)){const{elementType:r}=t;return s.createCallExpression(s.createPropertyAccessExpression(s.createPropertyAccessExpression(v(i),s.createIdentifier("UTSType")),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier("Array"),s.createArrayLiteralExpression([te(e,r)]),s.createTrue()])}if(r.isTypeReferenceNode(t)){const{typeName:n,typeArguments:o}=t;if(!r.isIdentifier(n)){const e=r.createDiagnosticForNode(n,I.Invalid_generic_type_which_can_not_be_constructed);return i.addBindDiagnostic(e),s.createIdentifier("UTSJSONObject")}return o&&0!==o.length?s.createCallExpression(s.createPropertyAccessExpression(s.createPropertyAccessExpression(v(i),s.createIdentifier("UTSType")),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier(n.escapedText.toString()),s.createArrayLiteralExpression(o.map((t=>te(e,t)))),s.createTrue()]):s.createIdentifier(n.escapedText.toString())}return U(e,t)}const re=["Array","Map","WeakMap","string","String","number","Number","boolean","Boolean","UTSJSONObject"];function ie(e,t,r,i){const s=P(e,t,void 0),n=t.getNullType(),o=t.getUndefinedType(),a=t.getVoidType(),c=t.getStringType();function l(e){let t=e.getBaseTypes();return 1===t?.length&&"String"===t[0].getSymbol()?.getName()}function p(e){return e===o||e===a}return!!(s.isObjectLiteralType(r)&&s.isPossibleUTSJSONObjectType(i)||s.isObjectLiteralType(i)&&s.isPossibleUTSJSONObjectType(r))||(!!(p(r)&&i===n||r===n&&p(i))||(!!(r===c&&l(i)||l(r)&&i===c)||void 0))}const se=b(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules"));const ne=new RegExp("^"+D+"/([a-zA-Z0-9_-]+)/index.d.ts$");const oe="app-ios"===process.env.UNI_UTS_PLATFORM;let ae=[];ae=oe?["app-js/index.uts","app-js/index.ts","app-js/index.js"]:[`${process.env.UNI_UTS_PLATFORM}/index.uts`,`${process.env.UNI_UTS_PLATFORM}/index.ts`,`${process.env.UNI_UTS_PLATFORM}/index.js`];const ce={replaceVueTypes:function(e,t){return e.endsWith("runtime-core.d.ts")&&(t=(t=(t=t.replace(/type ObjectInjectOptions = Record<([\s\S]+?)>;/,"type ObjectInjectOptions<I = Data> = {\n    [K in keyof I]: {\n      type: PropType<I[K]>;\n      from?: string;\n      default?: I[K] | (() => I[K]);\n    }\n  };")).replace(/type InjectToObject<T([\s\S]+?): never;/,"type InjectToObject<T> = T extends string[] ? {\n    [K in T[number]]: unknown;\n  } : T extends ObjectInjectOptions<infer I> ? {\n    [K in keyof I]: I[K];\n  } : never;")).replace(/serverPrefetch\?\(\): void \| Promise<any>;/,"serverPrefetch?(): void | Promise<any | null>;")),e.endsWith("app.d.ts")&&(t=t.replace(/\s\sexport function defineApp<D extends OptionsData = OptionsData.*/,"")),t},isTypeRelatedTo:function(e,t,r,i){return ie(e,t,r,i)},isRelatedTo:ie,tryFileLookup:function(e){if(!process.env.UNI_INPUT_DIR)return;const t=function(e){const t=e.match(ne);return t?t[1]:""}(e);if(t){const e=x.resolve(D,t,"utssdk");for(let t=0;t<ae.length;t++){const r=ae[t],i=x.resolve(e,r);if(N(i))return b(i)}if(oe)return;const r=x.resolve(D,t,"utssdk/index.uts");if(N(r))return b(r)}else if(e.endsWith(".d.ts")&&!N(e)){const t=e.replace(/\.d\.ts$/,""),r=t+".uvue";if(N(r))return r+".ts";const i=t+".vue";if(N(i))return i+".ts"}else if(e.endsWith(".json")&&N(e))return e+".ts"},componentPublicInstancePropertyAccessFallback:function(e,t,r,i,s,n){if(!e.isPropertyAccessExpression(r)||!e.isExpression(i)||!e.isIdentifier(n))return;const o=s.aliasSymbol?.escapedName.toString();if("ComponentPublicInstance"!==o&&"CreateComponentPublicInstance"!==o)return;const a=n.escapedText.toString(),c=globalThis?.__utsUniXGlobalProperties__;if(c&&c.has(a)){const{initializerNode:r}=c.get(a),i=t.getTypeAtLocation(r);return i.isNumberLiteral()?t.getNumberType():i.isStringLiteral()?t.getStringType():i.flags&e.TypeFlags.BooleanLiteral?t.getBooleanType():i}},isRequireIOSNativeUtsSdk:function(e,t){if(!process.env.UNI_INPUT_DIR)return!1;if("app-ios"!==process.env.UNI_UTS_PLATFORM)return!1;let r=t;if(t.startsWith("@/"))r=x.resolve(process.env.UNI_INPUT_DIR,t.slice(2));else if(t.startsWith("."))r=x.resolve(x.dirname(e),t);else if(!x.isAbsolute(t))return!1;const i=x.relative(se,r).replace(/\\/g,"/");return!(i.startsWith(".")||i.indexOf("/")>-1)&&!(!N(x.resolve(se,i,"utssdk"))||N(x.resolve(se,i,"utssdk/app-js")))},isUtsCompiler:!0,hijackAnyNullUnionType:!0,hijackTsLibResolve:!0,hijackDestructuring:!0,ignoreInstanceofLeftType:!0,ignoreInstanceofRightType:!0,useTypeAndInterfaceAsValue:!0,ignoreAllDebugFail:!0};var le=[(e,r)=>{function i(r,i){if(e.isSourceFile(i)){if(!i.__relativeFileName){const e=r.getCompilerOptions();if(e.rootDir&&t.isAbsolute(e.rootDir)){const r=b(e.rootDir),s=b(i.fileName);i.__rootDir=r,s.startsWith(r)?i.__relativeFileName=b(t.relative(r,s)):s.includes("/@dcloudio/")&&(i.__relativeFileName="@dcloudio/"+s.split("/@dcloudio/")[1])}i.__relativeFileName||(i.__relativeFileName=t.basename(i.fileName))}if(!r.printNode){const t=e.createPrinter();r.printNode=(r,i)=>t.printNode(e.EmitHint.Unspecified,r,i)}r.addBindDiagnostic||(r.addBindDiagnostic=e=>{i.bindDiagnostics.push(e)},r.addBindSuggestionDiagnostic=e=>{i.bindSuggestionDiagnostics||(i.bindSuggestionDiagnostics=[]),i.bindSuggestionDiagnostics.push(e)})}return i}return{before:e=>t=>i(e,t),after:e=>t=>i(e,t),afterDeclarations:e=>t=>i(e,t)}},(e,t)=>({parser:{SourceFile(t){const r=t.factory;function i(e){if(e.endsWith(".uts")||e.endsWith(".ts"))return e.replace(/.u?ts$/,"")}let s=[];function n(o){if(e.isImportDeclaration(o)||e.isExportDeclaration(o)){let t=o.moduleSpecifier;if(t&&e.isStringLiteral(t)){const e=t.text,r=/@\/uni_modules\/([a-zA-Z0-9_-]+)/,i=e.match(r)?.[1];if(i){N(x.resolve(D,i,"encrypt"))&&s.push({range:{pos:Math.max(o.pos-1,0),end:o.pos},type:1})}}}if(e.isImportDeclaration(o)&&o.moduleSpecifier&&e.isStringLiteral(o.moduleSpecifier)){const e=i(o.moduleSpecifier.text);e&&(o=r.updateImportDeclaration(o,o.modifiers,o.importClause,r.createStringLiteral(e),o.assertClause))}if(e.isExportDeclaration(o)&&o.moduleSpecifier&&e.isStringLiteral(o.moduleSpecifier)){const e=i(o.moduleSpecifier.text);e?o=r.updateExportDeclaration(o,o.modifiers,!1,o.exportClause,r.createStringLiteral(e),o.assertClause):o.isTypeOnly&&(o=r.updateExportDeclaration(o,o.modifiers,!1,o.exportClause,o.moduleSpecifier,o.assertClause))}return e.isImportClause(o)&&o.isTypeOnly?o=r.updateImportClause(o,!1,o.name,o.namedBindings):e.isImportSpecifier(o)&&o.isTypeOnly?o=r.updateImportSpecifier(o,!1,o.propertyName,o.name):e.isExportSpecifier(o)&&o.isTypeOnly&&(o=r.updateExportSpecifier(o,!1,o.propertyName,o.name)),e.visitEachChild(o,n,t)}return t=>(t=e.visitNode(t,n),s.length>0&&(t.commentDirectives=t.commentDirectives||[],t.commentDirectives.push(...s),s.length=0),t)}}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker();null===V&&i.getGlobalType&&(V=i.getGlobalType("UniApp",0,!1),V&&(B=V.getProperties().map((e=>e.getName()))));const s=t=>{if(V&&B.length){if(e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&e.isIdentifier(t.expression.name)){const r=function(e,t){return e.getContextualType(t)??e.getTypeAtLocation(t)}(i,t.expression.expression);if(r&&r.isIntersection()&&r.types.some((e=>"UniApp"===e.symbol?.name))&&!B.includes(t.expression.name.text)){console.error(`error: '${t.expression.name.text}' 不是 UniApp 对象的方法，请检查是否拼写错误，如果想调用在 App.uvue 文件中定义的 methods 方法，请使用 .vm?.xxx 的方式调用，详情参考：https://doc.dcloud.net.cn/uni-app-x/api/get-app.html#appmethods`);const r=t.getSourceFile();if(r.__relativeFileName){const i=e.getLineAndCharacterOfPosition(r,t.pos),s=r.__relativeFileName.split("?")[0].replace(/\.(vue|uvue|uts).ts$/g,".$1");console.error("at "+s+":"+i.line)}}}return e.visitEachChild(t,s,r)}return t};return t=>e.visitNode(t,s)}}),e=>({parser:{SourceFile:t=>r=>{const i=s=>{if(e.isCallExpression(s)&&e.isPropertyAccessExpression(s.expression)){const t=s.expression.expression,i=s.expression.name;if(e.isIdentifier(t)&&e.isIdentifier(i)){const e=t.text;"uni"!==e&&"uniCloud"!==e||(r.__utsMeta||(r.__utsMeta={}),r.__utsMeta.uniExtApis||(r.__utsMeta.uniExtApis=new Set),r.__utsMeta.uniExtApis.add(e+"."+i.text))}}return e.visitEachChild(s,i,t)};return e.visitNode(r,i)}}}),e=>({parser:{SourceFile(t){const{factory:r}=t;let i=!1,s=!1;const n=o=>{if(e.isSourceFile(o)){if(s&&o.text.startsWith("// @uts-setup\n")){const i=o.statements,s=[],n=[],a=[];for(let o=0;o<i.length;o++){const c=i[o];if(e.isImportDeclaration(c))s.push(c);else if(e.isExportAssignment(c)){if(e.isObjectLiteralExpression(c.expression)&&0===c.expression.properties.length)continue;const r=e.createDiagnosticForNode(c,I.script_setup_cannot_contain_ES_module_exports);t.addBindDiagnostic(r)}else z(e,c)?a.push(r.createReturnStatement(c.expression.arguments[0])):n.push(c)}return r.updateSourceFile(o,[...s,J(r,[...n,...a])])}return e.visitEachChild(o,n,t)}return e.isExportAssignment(o)&&e.isObjectLiteralExpression(o.expression)?r.updateExportAssignment(o,o.modifiers,r.createCallExpression(r.createIdentifier(i?"defineApp":"defineComponent"),void 0,[o.expression])):o};return t=>{if(!t.isVueFile||t.fileName.indexOf("setup=true")>-1)return t;const o=x.basename(t.fileName).split("?")[0].toLowerCase();"app.uvue"!==o&&"app.uvue.ts"!==o||(i=!0),/.u?vue.ts/.test(o)&&(s=!0);const a=e.visitNode(t,n);return a!==t?r.updateSourceFile(a,[r.createImportDeclaration(void 0,r.createImportClause(!1,void 0,r.createNamedImports([r.createImportSpecifier(!1,void 0,r.createIdentifier(i?"defineApp":"defineComponent"))])),r.createStringLiteral("vue")),...a.statements]):a}}},before(t){const{factory:r}=t,i=s=>e.isSourceFile(s)?e.visitEachChild(s,i,t):e.isExportAssignment(s)&&e.isCallExpression(s.expression)?r.updateExportAssignment(s,s.modifiers,r.createCallExpression(r.createIdentifier("defineComponent"),void 0,s.expression.arguments)):e.isImportDeclaration(s)&&s.moduleSpecifier&&e.isStringLiteral(s.moduleSpecifier)&&"vue"===s.moduleSpecifier.text&&s.importClause&&e.isImportClause(s.importClause)&&s.importClause.namedBindings&&e.isNamedImports(s.importClause.namedBindings)&&s.importClause.namedBindings.elements.some((e=>"defineApp"===e.name.text))?r.updateImportDeclaration(s,s.modifiers,r.updateImportClause(s.importClause,!1,void 0,r.createNamedImports(s.importClause.namedBindings.elements.filter((e=>"defineApp"!==e.name.text)))),s.moduleSpecifier,s.assertClause):s;return t=>t.isVueFile?("app.uvue"===x.basename(t.fileName).split("?")[0].toLowerCase()&&(t=e.visitNode(t,i)),t):t}}),(e,t)=>({parser:{SourceFile:t=>{const r=t.factory,i=s=>(e.isMethodDeclaration(s)&&e.isIdentifier(s.name)&&"valueIterator"===s.name.escapedText&&(s=r.updateMethodDeclaration(s,s.modifiers,s.asteriskToken,r.createComputedPropertyName(r.createPropertyAccessExpression(r.createIdentifier("Symbol"),r.createIdentifier("iterator"))),s.questionToken,s.typeParameters,s.parameters,s.type,s.body)),e.isExpressionWithTypeArguments(s)&&e.isIdentifier(s.expression)&&"UTSValueIterable"===s.expression.escapedText&&(s=r.updateExpressionWithTypeArguments(s,r.createIdentifier("Iterable"),s.typeArguments)),e.visitEachChild(s,i,t));return r=>e.visitEachChild(r,i,t)}}}),(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=P(e,void 0,t),s=n=>{if(e.isParameter(n)&&!n.type&&!n.dotDotDotToken){const t=n.parent;if(t&&(e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t))&&0===t.parameters.indexOf(n)){const s=i.getMethodNameNodeOfObjectLiteral(t);if(s&&e.isIdentifier(s)){const t=s.escapedText.toString();if(!0===H.get(t)){const i=s?.parent?.parent?.parent;if(i&&e.isCallExpression(i)){const s=i.expression;if(e.isIdentifier(s)&&("defineApp"===s.escapedText.toString()||"defineComponent"===s.escapedText.toString()))return r.updateParameterDeclaration(n,n.modifiers,n.dotDotDotToken,n.name,n.questionToken,r.createTypeReferenceNode(r.createIdentifier(t.replace(/^(\w)/,(e=>e.toUpperCase()))+"Options"),void 0),n.initializer)}}}}}return e.visitEachChild(n,s,t)};return r=>r.isVueFile?e.visitEachChild(r,s,t):r}}}),(e,t)=>({parser:{TypeAliasDeclaration:t=>function(r){const i=t.factory,{modifiers:s=[],name:n,typeParameters:o=[],type:a}=r;return e.isTypeLiteralNode(a)&&(r=i.updateTypeAliasDeclaration(r,s,n,o,i.updateTypeLiteralNode(a,i.createNodeArray([i.createIndexSignature(void 0,[i.createParameterDeclaration(void 0,void 0,i.createIdentifier("key"),void 0,i.createKeywordTypeNode(e.SyntaxKind.StringKeyword),void 0)],i.createKeywordTypeNode(e.SyntaxKind.AnyKeyword)),...a.members])))),r},SourceFile(t){const r=P(e,void 0,t),i=s=>{if(e.isTypeAliasDeclaration(s)&&e.isTypeLiteralNode(s.type)){const{modifiers:t=[],name:i,typeParameters:n=[],type:o}=s,a=o.members,c=function(e,t,r,i,s){const{ts:n}=e,o=e.context.factory,a=[],c=s?s.map((t=>{const{modifiers:r,name:i,questionToken:s,jsDoc:c}=t;let l;if(n.isPropertySignature(t))l=t.type;else if(n.isMethodSignature(t)){const{type:e,typeParameters:r,parameters:i}=t;l=o.createFunctionTypeNode(r,i,e)}const p=l&&e.createTypeNodeWithNullType(l,!!s);a.push(o.createPropertySignature(void 0,i,s,p));const u=o.createPropertyDeclaration(r,i,s,p,void 0);return u.jsDoc=c,u})):[],l=o.createTypeLiteralNode(a),p=[],u=o.createIndexSignature(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("key"),void 0,o.createKeywordTypeNode(n.SyntaxKind.StringKeyword),void 0)],o.createKeywordTypeNode(n.SyntaxKind.AnyKeyword)),d=o.createConstructorDeclaration(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("options"),void 0,l,void 0)],o.createBlock([o.createExpressionStatement(o.createCallExpression(o.createSuper(),void 0,[])),...(s||[]).map((e=>{const t=e.name.escapedText.toString();return o.createExpressionStatement(o.createBinaryExpression(o.createPropertyAccessExpression(o.createThis(),o.createIdentifier(t)),o.createToken(n.SyntaxKind.EqualsToken),o.createPropertyAccessExpression(o.createIdentifier("options"),o.createIdentifier(t))))}))],!0));return p.push(u,...c,d),o.createClassDeclaration(t,r,i?.length?i:void 0,[o.createHeritageClause(n.SyntaxKind.ExtendsKeyword,[o.createExpressionWithTypeArguments(k(e),void 0)])],p)}(r,[...t],i,[...n],[...a.filter((t=>e.isPropertySignature(t)||e.isMethodSignature(t)))]);c&&(s=c)}else e.isInterfaceDeclaration(s);return s=e.visitEachChild(s,i,t)};return t=>e.visitNode(t,i)}},before(r){const i=t.getProgram().getTypeChecker(),s=P(e,i,r),n=r.factory,o=t=>{if(e.isPropertyAccessExpression(t)&&$(s,t))t=n.createPropertyAccessExpression(v(r),n.createIdentifier("UTSType"));else if(e.isClassDeclaration(t)){const{heritageClauses:e}=t,r=e?.[0]?.types?.[0]?.expression;r&&$(s,r)&&(t=L(s,t))}return t=e.visitEachChild(t,o,r)};return t=>e.visitNode(t,o)}}),(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=P(e,void 0,t),s=n=>{const o=n.parent;if(o&&e.isObjectLiteralExpression(n)){if(i.isSetupReturnValue(n))return n;if(function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isVariableDeclaration(i)&&!i.type}(i,n)||function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isPropertyAccessExpression(i)&&i.expression===t||r.isParenthesizedExpression(i)&&i.parent&&r.isPropertyAccessExpression(i.parent)&&i.parent.expression===i}(i,n)||e.isExportAssignment(o)||!A.includes(o.kind))return r.createAsExpression(n,r.createTypeReferenceNode(r.createIdentifier("UTSJSONObject"),void 0))}return n=e.visitEachChild(n,s,t)};return t=>e.visitNode(t,s)}},before(r){const i=t.getProgram().getTypeChecker(),s=P(e,i,r),n=r.factory,o=new Map,a=t=>{const i=t;if(e.isObjectLiteralExpression(t)){if(s.isSetupReturnValue(t))return t;t=function(e,t,r){const{ts:i}=e,s=e.context,n=e.typeChecker,o=s.factory;if((t.flags&i.NodeFlags.Synthesized)===i.NodeFlags.Synthesized)return;if(t.parent&&i.isAsExpression(t.parent)||e.isComponentData(t)||e.isCreateAppReturnValue(t)||e.isVueOrNativeParameter(t))return;const a=n.getContextualType(t);if(e.shouldTransfromToUTSJSONObject(t,a))return o.createAsExpression(t,o.createTypeReferenceNode("UTSJSONObject",void 0));const c=a.symbol,l=c?.escapedName;if(!l||!w(e,a))return;if(n.isSymbolAccessible(c,t,i.SymbolFlags.Class,!0).accessibility!==i.SymbolAccessibility.Accessible)return n.markSymbolAsNotTypeOnly(c),o.createAsExpression(t,o.createTypeReferenceNode(n.symbolToEntityName(c,i.SymbolFlags.Class,t,void 0),void 0));const p=n.getAccessibleSymbolChain(c,t,c.flags,!1);let u;if(p&&p.length>0)u=n.symbolToEntityName(c,i.SymbolFlags.Class,t,void 0);else{const s=c.declarations;if(!s||1!==s.length)return;const n=s[0].getSourceFile(),a=t.getSourceFile();if(n===a)return;let l,p;if(r.has(c)){const e=r.get(c);l=e.alias,p=e.importDeclaration}else{const t=c.escapedName;if(l=i.getUniqueName(t,a),p=function(e,t,r,i){const{ts:s}=e,n=e.context,o=e.typeChecker;let a="";if(1!==(r?.declarations||[]).length)return;const c=t.symbol?.exports;for(const e of c.keys()){const t=c.get(e).declarations||[];if(1!==t.length)continue;const i=t[0];let n,l;if(s.isClassDeclaration(i)?l=i.name:s.isExportAssignment(i)?l=i.expression:s.isExportSpecifier(i)&&(l=i.name),n=l&&(o.getContextualType(l)?.symbol||o.getTypeAtLocation(l)?.symbol),n===r){a=e;break}}if(!a)return;const l=n.factory,p=l.createIdentifier(i);return"default"===a?l.createImportDeclaration(void 0,l.createImportClause(!1,p,void 0),l.createStringLiteral(t.fileName),void 0):l.createImportDeclaration(void 0,l.createImportClause(!1,void 0,l.createNamedImports([l.createImportSpecifier(!1,a!==i?l.createIdentifier(a):void 0,p)])),l.createStringLiteral(t.fileName),void 0)}(e,n,c,l),!p)return;r.set(c,{symbol:c,alias:l,importDeclaration:p})}u=o.createIdentifier(l)}return n.markSymbolAsNotTypeOnly(c),o.createAsExpression(t,o.createTypeReferenceNode(u,void 0))}(s,t,o)||t}return t=t===i?e.visitEachChild(t,a,r):e.isAsExpression(t)?n.updateAsExpression(t,e.visitEachChild(t.expression,a,r),t.type):e.visitEachChild(t,a,r)};return t=>{const i=e.visitNode(t,a),s=[];for(const e of o.values())s.push(e.importDeclaration),t.locals.set(e.alias,e.symbol);return r.factory.updateSourceFile(i,[...s,...i.statements],i.isDeclarationFile,i.referencedFiles,i.typeReferenceDirectives,i.hasNoDefaultLib,i.libReferenceDirectives)}}}),e=>({parser:{SourceFile:t=>r=>{const i=r.fileName,s=globalThis?.__utsUniXGlobalProperties__;if(s)for(const[e,t]of s)t.file===i&&s.delete(e);return function r(n){if(e.isBinaryExpression(n)){const{left:t,operatorToken:r,right:o}=n;if(r.kind===e.SyntaxKind.EqualsToken&&e.isPropertyAccessExpression(t)){const{expression:r,name:n}=t;if(e.isPropertyAccessExpression(r)){const{expression:t,name:a}=r;if("globalProperties"===a.escapedText.toString()&&e.isPropertyAccessExpression(t)){const{name:e}=t;"config"===e.escapedText.toString()&&s.set(n.escapedText.toString(),{file:i,initializerNode:o})}}}}return e.visitEachChild(n,r,t)}(r)}}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=P(e,i,r),n=t=>(e.isClassDeclaration(t)&&(t=function(e,t){const{ts:r}=e,i=e.context,s=e.typeChecker,n=i.factory,o=t.heritageClauses;if(!o)return t;const a=o.filter((e=>e.token===r.SyntaxKind.ImplementsKeyword));if(1!==a.length)return t;const c=a[0].types,l=[];for(let e=0;e<c.length;e++){const t=c[e];if(!t.expression||!r.isIdentifier(t.expression))continue;const i=s.getSymbolAtLocation(t.expression),n=i?.declarations||[];if(1!==n.length)continue;const o=n[0];r.isClassDeclaration(o)&&l.push(t.expression)}if(0===l.length)return t;const p=t.name?t.name.escapedText.toString():"";return n.updateClassDeclaration(t,t.modifiers,t.name,t.typeParameters,t.heritageClauses,[...R(e,p,0,l),...t.members])}(s,t)),t=e.visitEachChild(t,n,r));return t=>e.visitNode(t,n)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=P(e,i,r),n=r.factory,o=[],a=t=>{if(e.isAsExpression(t)&&t.type){if(o.includes(t.expression))return e.visitEachChild(t,a,r);const i=X(s,t);i&&(o.push(t.expression),t=i)}else if(e.isObjectLiteralExpression(t)&&t.parent&&!e.isAsExpression(t.parent)){if(s.isSetupReturnValue(t))return t;if(o.includes(t))return e.visitEachChild(t,a,r);if(s.isComponentData(t)||s.isCreateAppReturnValue(t)||s.isVueOrNativeParameter(t))return e.visitEachChild(t,a,r);const c=i.getContextualType(t);s.shouldTransfromToUTSJSONObject(t,c)&&(o.push(t),t=n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[t]))}return t=e.visitEachChild(t,a,r)};return t=>(o.splice(0,o.length),e.visitNode(t,a))}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=P(e,i,r),n=t=>{if(e.isIdentifier(t)){if("JSON"===t.escapedText)return function(e){const t=e.context,r=t.factory;return v(t),r.createPropertyAccessExpression(r.createIdentifier("UTS"),r.createIdentifier("JSON"))}(s)}else e.isBinaryExpression(t)?t.operatorToken.kind===e.SyntaxKind.InstanceOfKeyword&&(t=function(e,t){const r=e.context,i=r.factory;return v(r),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier("UTS"),i.createIdentifier("isInstanceOf")),void 0,[t.left,t.right])}(s,t)):e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&(t=function(e,t){const r=e.context,i=r.factory,s=e.typeChecker,n=e.ts,{expression:o,arguments:a}=t;if(!n.isPropertyAccessExpression(o))return t;const{expression:c,name:l}=o;if(n.isIdentifier(c)&&n.isIdentifier(l)&&ee.includes(`${c.escapedText}.${l.escapedText}`)){const r=t.typeArguments?.[0];if(r&&n.isTypeReferenceNode(r)&&r.pos>0&&n.isIdentifier(r.typeName)){const c=re.includes(r.typeName.escapedText.toString());let l;if(!c&&(l=s.getSymbolAtLocation(r),!l)){const e=r.typeName.escapedText;l=s.getSymbolsInScope(t,n.SymbolFlags.Type).find((t=>t.escapedName===e))}if(c||l&&O(e,l))return i.updateCallExpression(t,o,void 0,[...a,te(e,r)])}}if(!n.isIdentifier(l)||!Y.includes(l.escapedText.toString()))return t;if(c.pos<0)return t;const p=s.getTypeAtLocation(c);let u="";s.isArrayType(p)?u="Array":s.isTypeAssignableTo(p,s.getStringType())&&(u="string");const d=p.symbol?.escapedName.toString();"Map"===d?u="Map":"WeakMap"===d&&(u="WeakMap");const f=l.escapedText,m=Q[`${u}_${f}`];return m?(v(r),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier("UTS"),i.createIdentifier(m)),void 0,[c,...a])):t}(s,t));return t=e.visitEachChild(t,n,r)};return t=>e.visitNode(t,n)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=P(e,i,r),n=t=>(!e.isVariableDeclaration(t)||t.initializer||t.parent&&e.isCatchClause(t.parent)||!e.isIdentifier(t.name)?e.isParameter(t)?t=function(e,t){const{modifiers:r,dotDotDotToken:i,name:s,questionToken:n,type:o,initializer:a}=t;if(t.pos<0||a||i)return t;const c=e.context.factory,l=e.typeChecker,p=e.ts;return p.isMethodDeclaration(t.parent)&&p.isIdentifier(t.parent.name)&&"setup"===t.parent.name.text?t:n||e.isPossibleNullType(l.getTypeAtLocation(t))?c.updateParameterDeclaration(t,r,i,s,n,o&&e.createTypeNodeWithNullType(o,!0),a||c.createNull()):t}(s,t):(e.isFunctionDeclaration(t)||e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t)||e.isGetAccessorDeclaration(t))&&(t=function(e,t){const r=e.ts,i=e.context,s=i.factory,n=e.typeChecker,{modifiers:o,type:a}=t,c=o?.some((e=>e.kind===r.SyntaxKind.AsyncKeyword));let l=!1,p=!1;if(a){const r=n.getSignatureFromDeclaration(t)?.getReturnType();if(r&&(l=e.isPossibleNullType(r),p=e.isPossiblePromiseNullType(r),!l&&!p))return t}return r.visitEachChild(t,(function e(t){return r.isFunctionLike(t)?t:r.isReturnStatement(t)&&!t.expression?s.updateReturnStatement(t,c||p?s.createCallExpression(s.createPropertyAccessExpression(s.createIdentifier("Promise"),s.createIdentifier("resolve")),void 0,[s.createNull()]):s.createNull()):r.visitEachChild(t,e,i)}),i)}(s,t)):t=function(e,t){const r=e.context.factory,i=e.typeChecker;return!t.initializer&&t.pos>0&&e.isPossibleNullType(i.getTypeAtLocation(t))?r.updateVariableDeclaration(t,t.name,t.exclamationToken,t.type,r.createNull()):t}(s,t),t=e.visitEachChild(t,n,r));return t=>e.visitNode(t,n)}}),e=>({before:t=>t=>(t.statements.forEach((t=>{if((e.isImportDeclaration(t)||e.isExportDeclaration(t))&&t.moduleSpecifier&&e.isStringLiteral(t.moduleSpecifier)){const e=t.moduleSpecifier.text;(e.endsWith(".uvue.ts")||e.endsWith(".vue.ts"))&&(t.moduleSpecifier.text=e.replace(/.u?ts$/,""))}})),t)}),e=>({before(t){const r=i=>{if(e.isCallExpression(i)&&e.isIdentifier(i.expression)&&i.arguments.length>0){const e=i.expression.escapedText.toString();q.includes(e)&&(i=i.arguments[0])}return e.visitEachChild(i,r,t)};return t=>e.visitNode(t,r)}})];const pe=s.normalizePath(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),ue=new RegExp("^"+pe+"/([a-zA-Z0-9_-]+)/"),de=/\.(u)?vue(.ts)?/;let fe;const me=new Set;function he(e){return de.test(e)}function ye(e,t){if(fe=e,!fe.sys.__rewrited){const{fileExists:e,readFile:r,realpath:i}=fe.sys;fe.sys.realpath=e=>{const t=i?i(e):e;return t.endsWith(".ts")&&me.has(s.normalizePath(e))?e.replace(".ts",".uts"):t},fe.sys.fileExists=t=>{const r=s.normalizePath(t),i=r.match(ue),n=i?i[1]:"";return(!n||!e(x.resolve(pe,n,"encrypt")))&&(r.endsWith(".ts")&&e(r.replace(".ts",".uts"))?(me.add(r),!0):!(!r.endsWith(".vue.ts")&&!r.endsWith(".uvue.ts")||!e(r.replace(/.ts$/,"")))||(!(!r.endsWith(".json.ts")||!e(r.replace(/.ts$/,"")))||e(t)))},fe.sys.readFile=(i,n)=>{if(i.endsWith(".ts")&&me.has(s.normalizePath(i))){const e=i.replace(".ts",".uts"),s=r(e,n);if(null==s)return;return function(e,t){return t.uniCliShared.preUVueJs(t.uniCliShared.preUVueJs(e))}(s,t)}if(i.endsWith(".json.ts")){const o=i.replace(/.ts$/,"");if(e(o)){const e=r(o,n);if(null==e)return;return function(e,t){const r=t.uniCliShared.parseJson(e,!0);return s.dataToEsm(r,{preferConst:!0,compact:!0})}(e,t)}}if(i.endsWith(".vue.ts")||i.endsWith(".uvue.ts")){const s=i.replace(/.ts$/,"");if(e(s)){const e=r(s,n);if(null==e)return;return function(e,t){e=t.uniCliShared.preUVueJs(t.uniCliShared.preUVueHtml(e));const r=t.vueCompilerDom.parse(e).children.find((e=>"script"===e.tag)),i="export default {}";return r?r.props.some((e=>"setup"===e.name))?"// @uts-setup\n"+(r?.children[0]?.content||"")+"\n"+i:r?.children[0]?.content||i:i}(e,t)}}let o=r(i,n);if(null==o)return;i.endsWith("runtime-dom/dist/runtime-dom.d.ts")&&(o=o.replace("runtimeDOMBailTypes: Node | Window;",""));const a=globalThis?.__utsHacker__?.replaceVueTypes;return a?a(i,o):o},fe.sys.__rewrited=!0}}const ge=new class{constructor(){this.getCanonicalFileName=x.normalize,this.getNewLine=()=>fe.sys.newLine}getCurrentDirectory(){return fe.sys.getCurrentDirectory()}};function xe(e,t,r){return t.map((t=>function(e,t,r){const i={flatMessage:fe.flattenDiagnosticMessageText(t.messageText,ge.getNewLine()),formatted:fe.formatDiagnosticsWithColorAndContext([t],ge),category:t.category,code:t.code,type:e};if(t.file&&void 0!==t.start){let{line:e,character:n}=t.file.getLineAndCharacterOfPosition(t.start);if(r){const o=r.originalPositionFor({line:e+1,column:n,bias:p.SourceMapConsumer.LEAST_UPPER_BOUND});if(null!==o.line){if(o.source){const a=r.sourceContentFor(o.source);if(a){const{line:c,character:l}=t.file.getLineAndCharacterOfPosition(t.start+(t.length||0)),p=r.originalPositionFor({line:c+1,column:l});if(null!==p.line){const r=u.codeFrameColumns(a,{start:{line:o.line,column:(o.column||0)+1},end:{line:p.line,column:(p.column||0)+1}});i.rollupError=function(e,t,r,i,s){return{id:e,message:t,frame:s,loc:{file:e,line:r,column:i}}}(t.file.fileName,i.flatMessage,e+1,n+1,r),i.utsCompilerError={type:"UTSCompilerError",file:s.normalizePath(x.relative(process.env.UNI_INPUT_DIR,t.file.fileName.split("?")[0])),line:o.line,column:o.column||0,message:i.flatMessage,frame:r}}}}e=o.line}}i.fileLine=`${t.file.fileName}(${e+1},${n+1})`}return i}(e,t,r)))}function Se(e,t,r=!0){t.forEach((t=>{let i,s,o;switch(t.category){case fe.DiagnosticCategory.Message:i=e.info,s=n.white,o="";break;case fe.DiagnosticCategory.Error:i=e.error,s=n.red,o="error";break;case fe.DiagnosticCategory.Warning:default:i=e.warn,s=n.yellow,o="warning"}const a=t.type+" ";return r?t.utsCompilerError?i.call(e,t.utsCompilerError):t.rollupError?i.call(e,t.rollupError):i.call(e,`${n.enabled?t.formatted:function(e){if("string"!=typeof e)throw new TypeError(`Expected a \`string\`, got \`${typeof e}\``);return e.replace(Te,"")}(t.formatted)}`):void 0!==t.fileLine?i.call(e,`${t.fileLine}: ${a}${o} TS${t.code}: ${s(t.flatMessage)}`):i.call(e,`${a}${o} TS${t.code}: ${s(t.flatMessage)}`)}))}const Te=function({onlyFirst:e=!1}={}){const t=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(t,e?void 0:"g")}();var ve;function be(e){return"string"==typeof e?e:e()}!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Debug=3]="Debug"}(ve||(ve={}));class Ee{constructor(e,t,r,i=""){this.verbosity=e,this.bail=t,this.context=r,this.prefix=i}warn(e){this.verbosity<ve.Warning||this.context.warn(`${be(e)}`)}error(e){this.verbosity<ve.Error||(this.bail?"string"==typeof e||"function"==typeof e?this.context.error(`${be(e)}`):this.context.error(e):"UTSCompilerError"===e.type?(console.warn(`warning: ${e.message}`),console.warn(`at ${e.file}:${e.line}:${e.column}`),console.log(e.frame)):"string"==typeof e||"function"==typeof e?this.context.warn(`${be(e)}`):this.context.warn(e))}info(e){this.verbosity<ve.Info||console.log(`${this.prefix}${be(e)}`)}debug(e){this.verbosity<ve.Debug||console.log(`${this.prefix}${be(e)}`)}}function Ne({useTsconfigDeclarationDir:e,cacheRoot:t},r){const i={noEmitHelpers:!1,importHelpers:!0,noResolve:!1,noEmit:!1,noEmitOnError:!1,inlineSourceMap:!1,outDir:s.normalizePath(`${t}/placeholder`),allowNonTsExtensions:!0};if(!r)return i;r.options.moduleResolution===fe.ModuleResolutionKind.Classic&&(i.moduleResolution=fe.ModuleResolutionKind.Node10),void 0===r.options.module&&(i.module=fe.ModuleKind.ES2015),e||(i.declarationDir=void 0);return r.options.sourceMap||(i.sourceRoot=void 0),i}function _e(e,t){const r=[];return t.forEach((t=>{e instanceof Array?e.forEach((e=>r.push(s.normalizePath(x.join(t,e))))):r.push(s.normalizePath(x.join(t,e)))})),r}class Ce{constructor(e,t,r){this.parsedConfig=e,this.transformers=t,this.cwd=r,this.snapshots={},this.versions={},this.customParser={},this.getScriptFileNames=()=>Array.from(this.fileNames.values()),this.getCompilationSettings=()=>this.parsedConfig.options,this.getTypeRootsVersion=()=>0,this.getCurrentDirectory=()=>this.cwd,this.useCaseSensitiveFileNames=()=>fe.sys.useCaseSensitiveFileNames,this.getDefaultLibFileName=fe.getDefaultLibFilePath,this.readDirectory=fe.sys.readDirectory,this.readFile=fe.sys.readFile,this.fileExists=fe.sys.fileExists,this.directoryExists=fe.sys.directoryExists,this.getDirectories=fe.sys.getDirectories,this.realpath=fe.sys.realpath,this.trace=console.log,this.fileNames=new Set(e.fileNames)}reset(){this.snapshots={},this.versions={}}setLanguageService(e){e.shouldTransform=e=>!!e&&(function(e){return he(e)||e.includes(".uts")||me.has(s.normalizePath(e))}(e)||e.endsWith(".json.ts")||e.endsWith(".d.ts")),e.isVueFile=he,this.service=e,this.customTransformers||this.initTransformers(this.transformers||[])}setSnapshot(e,t){(e=s.normalizePath(e)).endsWith(".uts")&&this.setSnapshot(e.replace(/\.uts$/,".ts"),t);const r=fe.ScriptSnapshot.fromString(t);return this.snapshots[e]=r,this.versions[e]=(this.versions[e]||0)+1,this.fileNames.add(e),r}getScriptSnapshot(e){if((e=s.normalizePath(e))in this.snapshots)return this.snapshots[e];const t=fe.sys.readFile(e);return null!=t?this.setSnapshot(e,t):void 0}getScriptVersion(e){return e=s.normalizePath(e),(this.versions[e]||0).toString()}initTransformers(e){if(void 0===this.service||void 0===e||0===this.transformers.length)return;const t={before:[],after:[],afterDeclarations:[]};for(const r of e){const e=r(this.service);e.parser&&(this.customParser=e.parser),e.before&&(t.before=t.before.concat(e.before)),e.after&&(t.after=t.after.concat(e.after)),e.afterDeclarations&&(t.afterDeclarations=t.afterDeclarations.concat(e.afterDeclarations))}return this.customTransformers=t,globalThis.__utsParser__=this.customParser,t}getCustomTransformers(){return this.customTransformers}setCompilerHost(e){}}class Ie{constructor(e){this.cacheRoot=e,this.rolled=!1,this.oldCacheRoot=`${this.cacheRoot}/cache`,this.newCacheRoot=`${this.cacheRoot}/cache_`,d.emptyDirSync(this.newCacheRoot)}exists(t){return!this.rolled&&(!!e.existsSync(`${this.newCacheRoot}/${t}`)||e.existsSync(`${this.oldCacheRoot}/${t}`))}path(e){return`${this.oldCacheRoot}/${e}`}match(t){return!this.rolled&&(e.existsSync(this.oldCacheRoot)?S.isEqual(e.readdirSync(this.oldCacheRoot).sort(),t.sort()):0===t.length)}read(t){return e.existsSync(`${this.newCacheRoot}/${t}`)?d.readJsonSync(`${this.newCacheRoot}/${t}`,{encoding:"utf8",throws:!1}):d.readJsonSync(`${this.oldCacheRoot}/${t}`,{encoding:"utf8",throws:!1})}write(e,t){this.rolled||void 0!==t&&d.writeJsonSync(`${this.newCacheRoot}/${e}`,t)}touch(e){this.rolled||d.ensureFileSync(`${this.newCacheRoot}/${e}`)}roll(){this.rolled||(this.rolled=!0,d.removeSync(this.oldCacheRoot),e.existsSync(this.newCacheRoot)&&e.renameSync(this.newCacheRoot,this.oldCacheRoot))}}function De(e,t,r){const i={code:"",references:t,uniExtApis:r};return e.outputFiles.forEach((e=>{e.name.endsWith(".d.ts")?i.dts=e:e.name.endsWith(".d.ts.map")?i.dtsmap=e:e.name.endsWith(".map")?i.map=e.text:i.code=e.text})),i}class Pe{constructor(e,t,r,i,s,n,o,a){if(this.noCache=e,this.host=i,this.cacheRoot=s,this.options=n,this.context=a,this.cacheVersion="9",this.cachePrefix="uts_",this.ambientTypesDirty=!1,this.hashOptions={algorithm:"sha1",ignoreUnknown:!1},this.dependencyTree=new f.Graph({directed:!0}),this.dependencyTree.setDefaultNodeLabel((()=>({dirty:!1}))),t&&this.clean(),e)return;this.hashOptions.ignoreUnknown=r,this.cacheDir=`${this.cacheRoot}/${this.cachePrefix}${m({version:this.cacheVersion,rootFilenames:o,options:this.options,tsVersion:fe.version},this.hashOptions)}`,this.init();const c=fe.getAutomaticTypeDirectiveNames(n,fe.sys).map((e=>fe.resolveTypeReferenceDirective(e,void 0,n,fe.sys))).filter((e=>e.resolvedTypeReferenceDirective?.resolvedFileName)).map((e=>e.resolvedTypeReferenceDirective.resolvedFileName));this.ambientTypes=o.filter((e=>e.endsWith(".d.ts"))).concat(c).map((e=>({id:e,snapshot:this.host.getScriptSnapshot(e)}))),this.checkAmbientTypes()}clean(){if(!T.pathExistsSync(this.cacheRoot))return;T.readdirSync(this.cacheRoot).forEach((e=>{const t=`${this.cacheRoot}/${e}`;e.startsWith(this.cachePrefix)?T.statSync(t).isDirectory?(this.context.info(n.blue(`cleaning cache: ${t}`)),T.removeSync(`${t}`)):this.context.debug(`skipping cleaning '${t}' as it is not a directory`):this.context.debug(`skipping cleaning '${t}' as it does not have prefix '${this.cachePrefix}'`)}))}setDependency(e,t){this.context.debug(`${n.blue("dependency")} '${e}'`),this.context.debug(`    imported by '${t}'`),this.dependencyTree.setEdge(t,e)}walkTree(e){if(f.alg.isAcyclic(this.dependencyTree))return f.alg.topsort(this.dependencyTree).forEach((t=>e(t)));this.context.info(n.yellow("import tree has cycles")),this.dependencyTree.nodes().forEach((t=>e(t)))}done(){this.noCache||(this.context.info(n.blue("rolling caches")),this.codeCache.roll(),this.semanticDiagnosticsCache.roll(),this.syntacticDiagnosticsCache.roll(),this.typesCache.roll())}getCompiled(e,t,r){return this.context.info(`${n.blue("transpiling")} '${e}'`),this.getCached(this.codeCache,e,t,Boolean(!this.options.isolatedModules||this.options.declaration),r)}getSyntacticDiagnostics(e,t,r,i){return this.getDiagnostics("syntax",this.syntacticDiagnosticsCache,e,t,r,i)}getSemanticDiagnostics(e,t,r,i){return this.getDiagnostics("semantic",this.semanticDiagnosticsCache,e,t,r,i)}checkAmbientTypes(){this.context.debug(n.blue("Ambient types:"));const e=this.ambientTypes.filter((e=>void 0!==e.snapshot)).map((e=>(this.context.debug(`    ${e.id}`),this.createHash(e.id,e.snapshot))));this.ambientTypesDirty=!this.typesCache.match(e),this.ambientTypesDirty&&this.context.info(n.yellow("ambient types changed, redoing all semantic diagnostics")),e.forEach(this.typesCache.touch,this.typesCache)}getDiagnostics(e,t,r,i,s,n){return this.getCached(t,r,i,"semantic"===e,(()=>xe(e,s(),n)))}getCached(e,t,r,i,s){if(this.noCache)return s();const o=this.createHash(t,r);if(this.context.debug(`    cache: '${e.path(o)}'`),e.exists(o)&&!this.isDirty(t,i)){this.context.debug(n.green("    cache hit"));const t=e.read(o);if(t)return e.write(o,t),t;this.context.warn(n.yellow("    cache broken, discarding"))}this.context.debug(n.yellow("    cache miss"));const a=s();return e.write(o,a),this.markAsDirty(t),a}init(){this.codeCache=new Ie(`${this.cacheDir}/code`),this.typesCache=new Ie(`${this.cacheDir}/types`),this.syntacticDiagnosticsCache=new Ie(`${this.cacheDir}/syntacticDiagnostics`),this.semanticDiagnosticsCache=new Ie(`${this.cacheDir}/semanticDiagnostics`)}markAsDirty(e){this.dependencyTree.setNode(e,{dirty:!0})}isDirty(e,t){const r=this.dependencyTree.node(e);if(!r)return!1;if(!t||r.dirty)return r.dirty;if(this.ambientTypesDirty)return!0;const i=f.alg.dijkstra(this.dependencyTree,e);return Object.keys(i).some((e=>{const t=i[e];if(!e||t.distance===1/0)return!1;const r=this.dependencyTree.node(e),s=void 0===r||r.dirty;return s&&this.context.debug(`    import changed: ${e}`),s}))}createHash(e,t){const r=t.getText(0,t.getLength());return m({data:r,id:e,compilerVersion:process.env.HX_Version||process.env.UNI_COMPILER_VERSION},this.hashOptions)}}const Ae="tslib",Oe="\0tslib.js",we=">=5.0.0",ke=">=3.0.0";class $e extends o.EventEmitter{constructor(){super(),this._codeMap=new Map,this._easycomUsage=new Map,this._easycoms=[]}has(e){return this._codeMap.has(s.normalizePath(e))}set(e,t){const r=s.normalizePath(e);this.get(r)!==t&&(this._codeMap.set(e,t),this.emit("change",{fileName:r,source:t}))}get(e){return this._codeMap.get(s.normalizePath(e))}forEach(e){this._codeMap.forEach(e)}initUts2jsEasycom(e=this._easycoms){this._easycoms=e||[],this.set("/__uts2js_vfs__/shim-uni-easycom.d.ts",function(e){let t="",r="";return e.forEach(((e,i)=>{const s=c.kebabCase(i).replace(e.pattern,e.replacement);t+=`import ${i} from '${s}'\n`,r+=`  type ${i}ComponentPublicInstance = InstanceType<typeof ${i}>\n`})),`${t}\ndeclare global {\n${r}\n}`}(function(e,t){const r=new Map;return t.forEach(((t,i)=>{const s=c.kebabCase(i),n=e.find((e=>e.pattern.test(s)||c.upperFirst(c.camelCase(e.name))===i));n&&r.set(i,n)})),r}(this._easycoms,this._easycomUsage)))}setEasycomUsage(e,t=[]){e=s.normalizePath(e),this._easycomUsage.forEach(((r,i)=>{t.includes(i)||(r.delete(e),0===r.size&&this._easycomUsage.delete(i))}));for(let r=0;r<t.length;r++){const i=t[r];this._easycomUsage.has(i)?this._easycomUsage.get(i)?.add(e):this._easycomUsage.set(i,new Set([e]))}this.initUts2jsEasycom()}}const Ue=e=>{let r,i,o,c,u,d,f,m,h,y,g=!1,x=!1,T=0,v=!0;const b={},N=new Set,_=(e,t,r,i)=>{if(!t)return;e=s.normalizePath(e),N.add(e);const n=((e,t,r)=>h.getSyntacticDiagnostics(e,t,(()=>f.getSyntacticDiagnostics(e)),r).concat(h.getSemanticDiagnostics(e,t,(()=>f.getSemanticDiagnostics(e)),r)))(e,t,i);Se(r,n,!1!==c.options.pretty),n.length>0&&(v=!1)},C=(e,t)=>{if(!t.dts)return;const r=s.normalizePath(e);b[r]={type:t.dts,map:t.dtsmap},i.debug((()=>`${n.blue("generated declarations")} for '${r}'`))},I=e=>!(e.endsWith(".d.ts")||e.endsWith(".d.cts")||e.endsWith(".d.mts"))&&!!o(e),D=()=>{g||v||i.info(n.yellow("there were errors or warnings.")),h?.done()},P=Object.assign({},{check:!0,verbosity:ve.Warning,clean:!1,cacheRoot:a({name:"rollup-plugin-uts"}),include:["*.(|u)ts+(|x)","**/*.(|u)ts+(|x)","**/*.cts","**/*.mts"],exclude:["*.d.ts","**/*.d.ts","**/*.d.cts","**/*.d.mts"],abortOnError:!1,rollupCommonJSResolveHack:!1,tsconfig:void 0,useTsconfigDeclarationDir:!1,tsconfigOverride:{},transformers:[],tsconfigDefaults:{},objectHashIgnoreUnknownHack:!1,cwd:process.cwd()},e);P.typescript||(P.typescript=require("typescript")),ye(P.typescript,e.modules),globalThis.uts2jsSourceCodeMap=new $e;const A={name:"uts",options:e=>(r={...e},e),configureServer(e){e.watcher.addListener("all",((e,t)=>{if("add"===e||"unlink"===e){const e=s.normalizePath(t);E.has(e)&&E.delete(e)}}))},buildStart(){m=fe.createDocumentRegistry(),i=new Ee(P.verbosity,P.abortOnError,this,"uts: "),g="true"===process.env.ROLLUP_WATCH||!!this.meta.watchMode,({parsedTsConfig:c,fileName:u}=function(e,r){const i=fe.findConfigFile(r.cwd,fe.sys.fileExists,r.tsconfig);void 0===r.tsconfig||i||e.error(`failed to open '${r.tsconfig}'`);let s,n={},o=r.cwd,a=!0;if(i){const r=fe.sys.readFile(i),c=fe.parseConfigFileTextToJson(i,r);a=c.config?.pretty??a,void 0!==c.error&&(Se(e,xe("config",[c.error]),a),e.error(`failed to parse '${i}'`)),n=c.config,o=t.dirname(i),s=i}const c={};S.merge(c,r.tsconfigDefaults,n,r.tsconfigOverride);const l=fe.parseJsonConfigFileContent(c,fe.sys,o,Ne(r),s),p=Ne(r,l),u=fe.parseJsonConfigFileContent(c,fe.sys,o,p,s),d=u.options.module;return d!==fe.ModuleKind.ES2015&&d!==fe.ModuleKind.ES2020&&d!==fe.ModuleKind.ES2022&&d!==fe.ModuleKind.ESNext&&e.error(`Incompatible tsconfig option. Module resolves to '${fe.ModuleKind[d]}'. This is incompatible with Rollup, please use 'module: "ES2015"', 'module: "ES2020"', 'module: "ES2022"', or 'module: "ESNext"'.`),Se(e,xe("config",u.errors),a),e.debug(`built-in options overrides: ${JSON.stringify(p,void 0,4)}`),e.debug(`parsed tsconfig: ${JSON.stringify(u,void 0,4)}`),{parsedTsConfig:u,fileName:i}}(i,P)),i.info(`typescript version: ${fe.version}`),i.info(`tslib version: ${P.utsOptions.tslibVersion}`),i.info(`rollup version: ${this.meta.rollupVersion}`),l.satisfies(fe.version,we,{includePrerelease:!0})||i.error(`Installed TypeScript version '${fe.version}' is outside of supported range '${we}'`),l.satisfies(this.meta.rollupVersion,ke,{includePrerelease:!0})||i.error(`Installed Rollup version '${this.meta.rollupVersion}' is outside of supported range '${ke}'`),x=l.satisfies(this.meta.rollupVersion,">=2.60.0",{includePrerelease:!0}),x||i.warn((()=>`${n.yellow("You are using a Rollup version '<2.60.0'")}. This may result in type-only files being ignored.`)),i.info("rollup-plugin-uts version: 1.0.0"),i.debug((()=>`plugin options:\n${JSON.stringify(P,((e,t)=>"typescript"===e?`version ${t.version}`:t),4)}`)),i.debug((()=>`rollup config:\n${JSON.stringify(r,void 0,4)}`)),i.debug((()=>`tsconfig path: ${u}`)),P.objectHashIgnoreUnknownHack&&i.warn((()=>`${n.yellow("You are using 'objectHashIgnoreUnknownHack' option")}. If you enabled it because of async functions, try disabling it now.`)),P.rollupCommonJSResolveHack&&i.warn((()=>`${n.yellow("You are using 'rollupCommonJSResolveHack' option")}. This is no longer needed, try disabling it now.`)),g&&i.info("running in watch mode"),o=function(e,t,r){let i=t.include,n=t.exclude;return r.options.rootDirs&&(i=_e(i,r.options.rootDirs),n=_e(n,r.options.rootDirs)),r.projectReferences&&(i=_e(i,r.projectReferences.map((e=>e.path))).concat(i),n=_e(n,r.projectReferences.map((e=>e.path))).concat(n)),e.debug((()=>`included:\n${JSON.stringify(i,void 0,4)}`)),e.debug((()=>`excluded:\n${JSON.stringify(n,void 0,4)}`)),s.createFilter(i,n,{resolve:r.options.rootDir})}(i,P,c),d=new Ce(c,P.transformers,P.cwd),globalThis.uts2jsSourceCodeMap.forEach(((e,t)=>{d.setSnapshot(t,e)})),d.setSnapshot(Ae,P.utsOptions.tslibSource),globalThis.uts2jsSourceCodeMap.on("change",(function(e){const{fileName:t,source:r}=e||{};d.setSnapshot(t,r)})),f=fe.createLanguageService(d,m),d.setLanguageService(f);const e=P.clean,a=P.noCache||P.clean;if(h=new Pe(a,e,P.objectHashIgnoreUnknownHack,d,P.cacheRoot,c.options,c.fileNames,i),y=new Set,P.check){const e=xe("options",f.getCompilerOptionsDiagnostics());Se(i,e,!1!==c.options.pretty),e.length>0&&(v=!1)}},watchChange(e,t){const r=s.normalizePath(e);if(delete b[r],N.delete(r),"web"===process.env.UNI_UTS_PLATFORM)return;const{event:i}=t||{};"create"!==i&&"delete"!==i||E.has(r)&&E.delete(r)},resolveId(e,r){if(e===Ae)return Oe;if(!r)return;r=s.normalizePath(r);const o=fe.nodeModuleNameResolver(e,r,c.options,fe.sys);let a=o.resolvedModule?.resolvedFileName;if(a){if(me.has(s.normalizePath(a))&&(a=a.replace(".ts",".uts")),/.u?vue.ts$/.test(a))return a=a.replace(/.ts$/,""),t.normalize(a);if(I(a))return h.setDependency(a,r),i.debug((()=>`${n.blue("resolving")} '${e}' imported by '${r}'`)),i.debug((()=>`    to '${a}'`)),t.normalize(a)}},load:e=>e===Oe?P.utsOptions.tslibSource:null,async transform(r,a){y.add(a);const l=r.matchAll(/([a-zA-Z0-9]+)ComponentPublicInstance/g),m=[];for(const e of l)m.push(e[1]);m.length>0&&globalThis.uts2jsSourceCodeMap.setEasycomUsage(s.normalizePath(a),m);let T=a;if(T.endsWith(".json")&&(T=T.replace(/.json$/,".uts")),!o(T))return;const b=d.setSnapshot(T,r),E=h.getCompiled(T,b,(()=>{let r;const o=f.getProgram()?.getSourceFile(T);if("uts"===P.utsOptions.emitType){const e=[];if(o){const r=fe.createPrinter({}).printSourceFile(o,{host:ge,map:{file:s.normalizePath(t.relative(P.utsOptions.inputDir??"",a)),sourceRoot:"",sourcesDirectoryPath:P.utsOptions.inputDir??""}});r.code&&e.push({name:"",writeByteOrderMark:!1,text:r.code}),r.map&&e.push({name:".map",writeByteOrderMark:!1,text:r.map})}else this.error(new Error(`Could not find source file: '${a}'.`));r={outputFiles:e,emitSkipped:!1}}else r=f.getEmitOutput(T);r.emitSkipped&&(v=!1,_(T,b,i,e?.abortOnError?void 0:new p.SourceMapConsumer(this.getCombinedSourcemap())),this.error(n.red(`Emit skipped for '${a}'. See https://github.com/microsoft/TypeScript/issues/49790 for potential reasons why this may occur`)));const l=function(e,t,r){if(!t)return[];const i=fe.preProcessFile(t.getText(0,t.getLength()),!0,!0);return S.compact(i.referencedFiles.concat(i.importedFiles).map((t=>{const i=fe.nodeModuleNameResolver(t.fileName,e,r,fe.sys),n=i.resolvedModule?.resolvedFileName;return n&&me.has(s.normalizePath(n))&&n.endsWith(".ts")?n.replace(/.ts$/,".uts"):n})))}(T,b,c.options);return De(r,l,[...o?.__utsMeta?.uniExtApis||[]])}));if(P.check&&_(T,b,i,new p.SourceMapConsumer(this.getCombinedSourcemap())),!E)return;if(g&&E.references&&(u&&this.addWatchFile(u),E.references.map(this.addWatchFile,this),i.debug((()=>`${n.green("    watching")}: ${E.references.join("\nuts:               ")}`))),C(a,E),E.references&&x)for(const e of E.references){if(!I(e))continue;const t=await this.resolve(e,a);t&&!y.has(t.id)&&await this.load({id:t.id})}if(c.options.emitDeclarationOnly)return void i.debug((()=>`${n.blue("emitDeclarationOnly")} enabled, not transforming TS`));const N={code:E.code,map:{mappings:""},meta:{uniExtApis:E.uniExtApis?[...E.uniExtApis]:[]}};if(E.map){P.sourceMapCallback?.(a,E.map);const e=JSON.parse(E.map);e.sourceRoot&&(e.sources=e.sources.map((r=>t.isAbsolute(r)?r:e.sourceRoot+r))),N.map=e}return N},buildEnd(e){if(T=0,e){D();const t=e.stack?.split(e.message)[1];t?this.error({...e,message:e.message,stack:t}):this.error(e)}if(!P.check)return D();g&&h.walkTree((e=>{if(!o(e))return;const t=d.getScriptSnapshot(e);_(e,t,i)})),c.fileNames.forEach((e=>{const t=s.normalizePath(e);if(N.has(t)||!o(t))return;i.debug((()=>`type-checking missed '${t}'`));const r=d.getScriptSnapshot(t);_(t,r,i)})),D()},generateBundle(e){if(i.debug((()=>`generating target ${T+1}`)),T++,!c.options.declaration)return;c.fileNames.forEach((e=>{const t=s.normalizePath(e);if(t in b||!o(t))return;i.debug((()=>`generating missed declarations for '${t}'`));const r=De(f.getEmitOutput(t,!0));C(t,r)}));const r=(r,o,a)=>{if(!a)return;let c=a.name;if(c.includes("?")&&(c=c.split("?",1)+o),P.useTsconfigDeclarationDir)return i.debug((()=>`${n.blue("emitting declarations")} for '${r}' to '${c}'`)),void fe.sys.writeFile(c,a.text,a.writeByteOrderMark);let l=a.text;const p=`${P.cacheRoot}/placeholder`;if(".d.ts.map"===o&&(e?.file||e?.dir)){const r=e.file?t.dirname(e.file):e.dir,i=JSON.parse(l);i.sources=i.sources.map((e=>{const i=t.resolve(p,e);return s.normalizePath(t.relative(r,i))})),l=JSON.stringify(i)}const u=s.normalizePath(t.relative(p,c));i.debug((()=>`${n.blue("emitting declarations")} for '${r}' to '${u}'`)),this.emitFile({type:"asset",source:l,fileName:u})};Object.keys(b).forEach((e=>{const{type:t,map:i}=b[e];r(e,".d.ts",t),r(e,".d.ts.map",i)}))}};return A},Fe=h.pathToFileURL(__filename).href,Re=t.dirname(h.fileURLToPath(Fe)),Le=i.createRequire(Fe);let je=!1;exports.uts2js=function({inputDir:r,modules:i,...s}){je||(je=!0,globalThis.__utsHacker__={...globalThis.__utsHacker__,...ce});const n=s.include??["**/*.uts","**/*.ts"],o=s.typescript??Le("typescript"),a={...s,modules:i||{},include:n,typescript:o,transformers:[W(o,le,{targetLanguage:"JavaScript",setParentRecursive:!0})],utsOptions:{tslibSource:e.readFileSync(t.resolve(Re,"../lib/runtime/index.js"),"utf8")}};a.tsconfigOverride||(a.tsconfigOverride={compilerOptions:{}}),a.tsconfigOverride.compilerOptions||(a.tsconfigOverride.compilerOptions={});const c=a.tsconfigOverride.compilerOptions,l={baseUrl:r?"src"===t.basename(r)?t.dirname(r):r:".",moduleResolution:"Bundler",importHelpers:!0,mapRoot:c.sourceMap?r:void 0,target:"ES2016"};for(const e in l)c.hasOwnProperty(e)||(c[e]=l[e]);return[Ue(a)]};

"use strict";var e=require("fs"),t=require("path"),r=require("debug"),i=require("module"),n=require("@rollup/pluginutils"),s=require("colors/safe"),o=require("events"),a=require("find-cache-dir"),c=require("lodash"),l=require("semver"),p=require("source-map-js"),d=require("@babel/code-frame"),u=require("fs-extra"),f=require("graphlib"),m=require("object-hash"),y=require("url");function h(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var g=h(e),_=h(t),x=h(c),T=h(u);const S={name:"uts:UTS",importName:"UTS",scoped:!1,text:"",priority:100};function v(e){const t=process.env.UNI_UTS_PLATFORM;return"string"==typeof t&&t.startsWith("mp-")?function(e){return e.requestEmitHelper(S),e.factory.createIdentifier("UTS")}(e):function(e){return e.factory.createIdentifier("UTS")}(e)}const b={name:"uts:UTSJSONObject",importName:"UTSJSONObject",scoped:!1,text:"",priority:100};function E(e){const t=process.env.UNI_UTS_PLATFORM;return"string"==typeof t&&t.startsWith("mp-")?function(e){return e.requestEmitHelper(b),e.factory.createIdentifier("UTSJSONObject")}(e):function(e){return e.factory.createIdentifier("UTSJSONObject")}(e)}function N(e){return e.replace(/\\/g,"/")}const C=new Map;function D(e){const t=N(e);return C.has(t)?C.get(t):g.existsSync(t)?(C.set(t,!0),!0):(C.set(t,!1),!1)}var I;function A(e,t,r,i,n,s,o){return{code:e,category:t,key:r,message:i,reportsUnnecessary:n,elidedInCompatabilityPyramid:s,reportsDeprecated:o}}!function(e){e[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Suggestion=2]="Suggestion",e[e.Message=3]="Message"}(I||(I={}));const P={Type_literal_property_must_have_a_type_annotation:A(1e5,I.Error,"Type_literal_property_must_have_a_type_annotation_100000","Type literal property must have a type annotation."),Only_one_extends_heritage_clause_is_allowed_for_interface:A(100001,I.Error,"Only_one_extends_heritage_clause_is_allowed_for_interface_100001","Only one extends heritage clause is allowed for interface."),Variable_declaration_must_have_initializer:A(100002,I.Error,"Variable_declaration_must_have_initializer_100002","Variable declaration must have initializer."),Nested_type_literal_is_not_supported:A(100003,I.Error,"Nested_type_literal_is_not_supported_100003","Nested type literal is not supported."),Invalid_generic_type_which_can_not_be_constructed:A(100004,I.Error,"Invalid_generic_type_which_can_not_be_constructed_100004","Invalid generic type which can not be constructed."),script_setup_cannot_contain_ES_module_exports:A(100005,I.Error,"script_setup_cannot_contain_ES_module_exports_100005","`<script setup>` cannot contain ES module exports."),Type_aliases_cannot_appear_in_local_scope:A(100006,I.Error,"Type_aliases_cannot_appear_in_local_scope_100006","Type aliases cannot appear in local scope."),Direct_declaration_of_Object_Literal_Type_is_not_supported:A(110111101,I.Error,"Direct_declaration_of_Object_Literal_Type_is_not_supported_110111101","Direct declaration of Object Literal Type is not supported."),Object_literals_only_support_object_types_defined_by_construction_type_and_do_not_support_interfaces:A(110111163,I.Error,"Object_literals_only_support_object_types_defined_by_construction_type_and_do_not_support_interfaces_110111163","Object literals only support object types defined by construction type, and do not support interfaces."),Conditional_statements_must_use_boolean_types:A(110111120,I.Error,"Conditional_statements_must_use_boolean_types_110111120","Conditional statements must use boolean types."),Class_cannot_be_used_as_a_value:A(110111164,I.Error,"Class_cannot_be_used_as_a_value_110111164","Class cannot be used as a value."),Methods_to_modify_objects_are_not_supported:A(110111134,I.Error,"Methods_to_modify_objects_are_not_supported_110111134","Methods to modify objects are not supported."),TypeScript_utility_types_are_not_supported:A(110111125,I.Error,"TypeScript_utility_types_are_not_supported_110111125","TypeScript utility types are not supported."),Undefined_is_not_supported:A(110111119,I.Error,"Undefined_is_not_supported_110111119","Undefined is not supported."),Private_fields_starting_with_are_not_supported:A(110111128,I.Error,"Private_fields_starting_with_are_not_supported_110111128","Private fields starting with #are not supported."),Property_methods_for_type_class_or_interface_do_not_support_defining_generic_information:A(110111161,I.Error,"Property_methods_for_type_class_or_interface_do_not_support_defining_generic_information_110111161","Property methods for type, class, or interface do not support defining generic information."),Declaring_properties_on_functions_is_not_supported:A(110111138,I.Error,"Declaring_properties_on_functions_is_not_supported_110111138","Declaring properties on functions is not supported."),Type_protection_using_instanceof_and_as:A(110111143,I.Error,"Type_protection_using_instanceof_and_as_110111143","Type protection using instanceof and as."),Generator_functions_are_not_supported:A(110111146,I.Error,"Generator_functions_are_not_supported_110111146","Generator functions are not supported."),Delete_operator_is_not_supported:A(110111149,I.Error,"Delete_operator_is_not_supported_110111149","Delete operator is not supported."),You_cannot_assign_a_function_to_an_interface:A(12e7,I.Error,"You_cannot_assign_a_function_to_an_interface_120000000","You cannot assign a function to an interface."),Members_of_an_interface_cannot_be_a_call_signatures:A(120000001,I.Error,"Members_of_an_interface_cannot_be_a_call_signatures_120000001","Members of an interface cannot be a call signatures."),Enum_member_initializer_only_supports_number_or_string_literal:A(120000003,I.Error,"Enum_member_initializer_only_supports_number_or_string_literal_120000003","Enum member initializer only supports number or string literal."),Enum_declarations_must_be_at_top_level_in_Kotlin:A(120000004,I.Error,"Enum_declarations_must_be_at_top_level_in_Kotlin_120000004","Enum declarations must be at top level in Kotlin."),Recursive_calls_on_function_expressions_are_not_supported_Define_the_function_separately_before_invoking_it:A(110111165,I.Error,"Recursive_calls_on_function_expressions_are_not_supported_Define_the_function_separately_before_invo_110111165","Recursive calls on function expressions are not supported. Define the function separately before invoking it."),The_type_could_not_be_inferred:A(100007,I.Error,"The_type_could_not_be_inferred_100007","The type could not be inferred.")},O=N(_.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),w=["defineComponent","defineVaporComponent","defineVaporSharedDataComponent","defineApp","defineAsyncComponent","defineMixin"];function k(e){return w.some((t=>e===t||e==="_"+t))}function U(e,r,i){function n(e){return e?.constraintType?.origin?.type||e}function s(e){if(!e)return!1;const t=r.getNullType();return r.isTypeAssignableTo(t,e)}function o(t){return!!(t&&e.isUnionTypeNode(t)&&t.types.some((t=>e.isLiteralTypeNode(t)&&t.literal.kind===e.SyntaxKind.NullKeyword)))}function a(t){if(!t||!e.isCallExpression(t))return!1;const r=t.expression;return!!(r&&e.isIdentifier(r)&&k(r.escapedText.toString()))}function c(e){const t=e?.parent?.parent?.parent;return t&&a(t)}return{ts:e,typeChecker:r,context:i,isImportedSymbol:function(t){return!(!t.declarations||!t.declarations.some((t=>e.isImportSpecifier(t)||e.isImportClause(t)&&t.name)))},isPossibleUTSJSONObjectType:function(e,t=!1){return e?e.isUnion()&&e.types.some((e=>"UTSJSONObject"===n(e).symbol?.escapedName))||"UTSJSONObject"===n(e).symbol?.escapedName:!t},isPossibleNullType:s,isPossiblePromiseNullType:function(e){return!!e&&s(r.getPromisedTypeOfPromise(e))},createTypeNodeWithNullType:function(t,r){const n=i.factory,s=o(t);let a=t;return r&&!s&&(a=e.isUnionTypeNode(t)?n.createUnionTypeNode([...t.types,n.createLiteralTypeNode(n.createNull())]):n.createUnionTypeNode([t,n.createLiteralTypeNode(n.createNull())])),a},isUnionWithNullType:o,isObjectLiteralType:function(t){if(!t)return!1;if("__object"===t.symbol?.escapedName)return!0;const r=t?.objectFlags;if(r&&(r&e.ObjectFlags.ObjectLiteral||r&e.ObjectFlags.FreshLiteral))return!0;const i=t.getSymbol();return!!(i&&i.flags&e.SymbolFlags.ObjectLiteral)},getMethodNameNodeOfObjectLiteral:function(t){if(e.isMethodDeclaration(t))return t.name;const r=t.parent;if(!e.isPropertyAssignment(r))return;const i=r.name;return e.isIdentifier(i)?i:void 0},shouldTransfromToUTSJSONObject:function e(t,i){if(!i||i===r.getAnyType())return!0;if(i.isUnion())return i.types.some((r=>e(t,r)));if(i.isIntersection())return i.types.every((e=>r.isTypeAssignableTo(r.getGlobalType("UTSJSONObject",0,!0),i)));const n=i.getSymbol()||i.aliasSymbol;return!(!n&&!i.isClassOrInterface())&&(!n||"__object"===n?.escapedName||"UTSJSONObject"===n?.escapedName||r.isTypeAssignableTo(r.getGlobalType("UTSJSONObject",0,!0),i))},isVueOrNativeParameter:function t(i){if(!i.parent)return!1;if(e.isPropertyAssignment(i.parent)&&i.parent.parent&&e.isObjectLiteralExpression(i.parent.parent))return t(i.parent.parent);if(!e.isCallExpression(i.parent))return!1;if(-1===i.parent.expression.pos)return!0;const n=r.getTypeAtLocation(i.parent.expression);if(!n)return!1;const s=n.getCallSignatures()?.[0]?.declaration;if(!s)return!1;const o=s.getSourceFile().fileName,a=o.replace(/\\/g,"/").split("/").pop();return o.endsWith("runtime-core.d.ts")||a&&/lib\.es(\d+|next)\..*d.ts/.test(a)},isComponentDataOrProvide:function(t){const r=t.parent;if(!r||!e.isReturnStatement(r))return!1;const i=r?.parent?.parent;if(!i||!e.isMethodDeclaration(i))return!1;const n=i.name;if(!n||!e.isIdentifier(n)||"data"!==n.escapedText.toString()&&"provide"!==n.escapedText.toString())return!1;const s=i?.parent?.parent;return a(s)},isComponentOptions:function(e){const t=e?.parent;return t&&a(t)},isComponentOptionsProperty:c,isComponentProp:function(t){const r=t.parent?.parent,i=r?.parent;return r&&i&&e.isObjectLiteralExpression(r)&&e.isPropertyAssignment(i)&&e.isIdentifier(i.name)&&"props"===i.name.escapedText.toString()&&c(r)},isCreateAppReturnValue:function(r){if(process.env.UNI_INPUT_DIR&&N(t.resolve(process.env.UNI_INPUT_DIR,"main.uts"))===N(r.getSourceFile().fileName)&&r.parent&&e.isReturnStatement(r.parent)){const t=r?.parent?.parent?.parent;if(t&&e.isFunctionDeclaration(t)&&t.name&&e.isIdentifier(t.name)&&"createApp"===t.name.escapedText.toString())return!0}},isSetupReturnValue:function(t){const r=t.parent;return r&&e.isVariableDeclaration(r)&&r.name&&e.isIdentifier(r.name)&&"___returned__"===r.name.escapedText.toString()},isDefineExpose:function(t){if(!t||!e.isCallExpression(t))return!1;const r=t.expression;if(!r||!e.isIdentifier(r))return!1;const i=r.escapedText.toString();return"defineExpose"===i||"___expose"===i}}}const F=[260,169,172,171,208,219,253,229,223,213,214,170,216,234,226,303,304,305,209,227,239,217,235,238,277,294,291,293,286,285];function L(e,t){const{ts:r}=e,i=t?.declarations;if(1!==i?.length)return!1;const n=i[0];if(r.isClassDeclaration(n)){const t=n.heritageClauses?.some((t=>t.token===r.SyntaxKind.ExtendsKeyword&&t.types.some((t=>j(e,t.expression)||function(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:n}=t;return r.isIdentifier(n)&&"UTS"===n.escapedText&&r.isIdentifier(i)&&"UTSType"===i.escapedText}(e,t.expression)))));return t}return!1}function R(e,t){return t.symbol&&L(e,t.symbol)}function $(e){const t=e.context.factory,r=e.ts;return t.createPropertyAccessExpression(t.createParenthesizedExpression(t.createAsExpression(t.createIdentifier("globalThis"),t.createKeywordTypeNode(r.SyntaxKind.AnyKeyword))),t.createIdentifier("UTSType"))}function j(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:n}=t;return r.isIdentifier(n)&&"UTSType"===n.escapedText&&r.isParenthesizedExpression(i)&&r.isAsExpression(i.expression)&&r.isIdentifier(i.expression.expression)&&"globalThis"===i.expression.expression.escapedText}function M(e,t){const{ts:r}=e,i=e.context,n=i.factory,s=e.typeChecker,o=n.createStringLiteral("Unknown");if(e.isUnionWithNullType(t)&&2===t.types.length&&(t=t.types.find((e=>e.kind!==r.SyntaxKind.NullKeyword))),r.isTypeReferenceNode(t)){const{typeName:i,typeArguments:a}=t;if(!r.isIdentifier(i))return o;const c=s.getSymbolAtLocation(i),l=c?.declarations?.[0];return l&&function(e,t){if(!e.ts.isClassDeclaration(t))return!1;const{heritageClauses:r}=t,i=r?.[0]?.types?.[0]?.expression;return!(!i||!j(e,i))}(e,l)?a?n.createCallExpression(n.createPropertyAccessExpression($(e),n.createIdentifier("withGenerics")),void 0,[n.createIdentifier(i.escapedText.toString()),n.createArrayLiteralExpression([...a.map((t=>M(e,t)))],!1)]):n.createIdentifier(i.escapedText.toString()):o}if(r.isArrayTypeNode(t))return n.createCallExpression(n.createPropertyAccessExpression($(e),n.createIdentifier("withGenerics")),void 0,[n.createIdentifier("Array"),n.createArrayLiteralExpression([M(e,t.elementType)],!1)]);if(r.isTypeLiteralNode(t))i.addSemanticDiagnostic(r.createDiagnosticForNode(t,P.Nested_type_literal_is_not_supported));else{if(t.kind===r.SyntaxKind.NumberKeyword)return n.createIdentifier("Number");if(t.kind===r.SyntaxKind.StringKeyword)return n.createIdentifier("String");if(t.kind===r.SyntaxKind.BooleanKeyword)return n.createIdentifier("Boolean");if(t.kind===r.SyntaxKind.AnyKeyword)return n.createStringLiteral("Any")}return o}function K(e,t,r){const{ts:i}=e,n=e.context.factory;return n.createMethodDeclaration([n.createToken(i.SyntaxKind.StaticKeyword)],void 0,n.createIdentifier("get$UTSMetadata$"),void 0,void 0,t?[...t.map((e=>n.createParameterDeclaration(void 0,void 0,n.createIdentifier(e.name.escapedText.toString()),n.createToken(i.SyntaxKind.QuestionToken),n.createKeywordTypeNode(i.SyntaxKind.AnyKeyword),void 0)))]:[],void 0,n.createBlock([n.createReturnStatement(n.createAsExpression(r,n.createKeywordTypeNode(i.SyntaxKind.AnyKeyword)))],!0))}function W(e,t,r,i){const n=e.context.factory,s=[n.createPropertyAssignment(n.createIdentifier("kind"),n.createNumericLiteral(r)),n.createPropertyAssignment(n.createIdentifier("interfaces"),n.createArrayLiteralExpression(i,!1))];return"development"===process.env.NODE_ENV&&s.push(n.createPropertyAssignment(n.createIdentifier("name"),n.createStringLiteral(t))),[K(e,void 0,n.createObjectLiteralExpression(s,!0))]}const z=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),n=U(e,i,r),s=t=>(e.isClassDeclaration(t)&&(t=function(e,t){const{ts:r}=e,i=e.context,n=e.typeChecker,s=i.factory,o=t.heritageClauses;if(!o)return t;const a=o.filter((e=>e.token===r.SyntaxKind.ImplementsKeyword));if(1!==a.length)return t;const c=a[0].types,l=[];for(let e=0;e<c.length;e++){const t=c[e];if(!t.expression||!r.isIdentifier(t.expression))continue;const i=n.getSymbolAtLocation(t.expression),s=i?.declarations||[];if(1!==s.length)continue;const o=s[0];r.isClassDeclaration(o)&&l.push(t.expression)}if(0===l.length)return t;const p=t.name?t.name.escapedText.toString():"";return s.updateClassDeclaration(t,t.modifiers,t.name,t.typeParameters,t.heritageClauses,[...W(e,p,0,l),...t.members])}(n,t)),t=e.visitEachChild(t,s,r));return t=>e.visitNode(t,s)}});globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;const J=e=>({parser:{SourceFile:t=>r=>{const i=r.fileName,n=globalThis?.__utsUniXGlobalProperties__;if(n)for(const[e,t]of n)t.file===i&&n.delete(e);return function r(s){const o=e.visitEachChild(s,r,t);if(e.isBinaryExpression(o)){const{left:t,operatorToken:r,right:s}=o;if(r.kind===e.SyntaxKind.EqualsToken&&e.isPropertyAccessExpression(t)){const{expression:r,name:o}=t;if(e.isPropertyAccessExpression(r)){const{expression:t,name:a}=r;if("globalProperties"===a.escapedText.toString()&&e.isPropertyAccessExpression(t)){const{name:e}=t;"config"===e.escapedText.toString()&&n.set(o.escapedText.toString(),{file:i,initializerNode:s})}}}}return o}(r)}}}),V=(e,t)=>({parser:{SourceFile(t){const r=t.factory;function i(e){if(e.endsWith(".uts")||e.endsWith(".ts"))return e.replace(/.u?ts$/,"")}let n=[];function s(o){const a=e.visitEachChild(o,s,t);if(e.isImportDeclaration(a)||e.isExportDeclaration(a)){let t=a.moduleSpecifier;if(t&&e.isStringLiteral(t)){const e=t.text,r=/@\/uni_modules\/([a-zA-Z0-9_-]+)/,i=e.match(r)?.[1];if(i){D(_.resolve(O,i,"encrypt"))&&n.push({range:{pos:Math.max(a.pos-1,0),end:a.pos},type:1})}}}if(e.isImportDeclaration(a)&&a.moduleSpecifier&&e.isStringLiteral(a.moduleSpecifier)){const e=i(a.moduleSpecifier.text);if(e)return r.createImportDeclaration(a.modifiers,a.importClause,r.createStringLiteral(e),a.assertClause)}if(e.isExportDeclaration(a)&&a.moduleSpecifier&&e.isStringLiteral(a.moduleSpecifier)){const e=i(a.moduleSpecifier.text);if(e)return r.createExportDeclaration(a.modifiers,!1,a.exportClause,r.createStringLiteral(e),a.assertClause);if(a.isTypeOnly)return r.createExportDeclaration(a.modifiers,!1,a.exportClause,a.moduleSpecifier,a.assertClause)}return e.isImportClause(a)&&a.isTypeOnly?r.createImportClause(!1,a.name,a.namedBindings):e.isImportSpecifier(a)&&a.isTypeOnly?r.createImportSpecifier(!1,a.propertyName,a.name):e.isExportSpecifier(a)&&a.isTypeOnly?r.createExportSpecifier(!1,a.propertyName,a.name):a}return t=>(t=e.visitNode(t,s),n.length>0&&(t.commentDirectives=t.commentDirectives||[],t.commentDirectives.push(...n),n.length=0),t)}}});const B=(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=U(e,void 0,t),n=s=>{const o=e.visitEachChild(s,n,t),a=o.parent;if(a&&e.isObjectLiteralExpression(o)){if(i.isSetupReturnValue(o))return o;if(i.isDefineExpose(a))return o;if(function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isVariableDeclaration(i)&&!i.type}(i,o)||function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isPropertyAccessExpression(i)&&i.expression===t||r.isParenthesizedExpression(i)&&i.parent&&r.isPropertyAccessExpression(i.parent)&&i.parent.expression===i}(i,o)||e.isExportAssignment(a)||!F.includes(a.kind))return r.createAsExpression(o,r.createTypeReferenceNode(E(i.context),void 0))}return o};return t=>e.visitNode(t,n)}},before(r){const{factory:i}=r,n=t.getProgram().getTypeChecker(),s=U(e,n,r),o=new Map,a=t=>{if(e.isObjectLiteralExpression(t)){const n=e.getOriginalNode(t)||t;if(e.isObjectLiteralExpression(n)){if(s.isSetupReturnValue(n))return t;const e=n.parent;if(e&&s.isDefineExpose(e))return t}const c=function(e,t,r){const{ts:i}=e,n=e.context,s=e.typeChecker,o=n.factory,a=i.getOriginalNode(t)||t;if((a.flags&i.NodeFlags.Synthesized)===i.NodeFlags.Synthesized)return;const c=a?.parent;if(c&&i.isAsExpression(c)||e.isComponentDataOrProvide(a)||e.isComponentOptions(a)||e.isComponentOptionsProperty(a)||e.isComponentProp(a)||e.isCreateAppReturnValue(a))return;const l=i.getContainerNode(a);if(l&&i.isMethodDeclaration(l)&&l.modifiers&&l.modifiers.some((e=>e.kind===i.SyntaxKind.StaticKeyword))&&i.isIdentifier(l.name)&&"get$UTSMetadata$"===l.name.escapedText)return;let p;try{p=s.getContextualType(a)}catch(e){try{p=s.getContextualType(t)}catch(e){}}if(e.shouldTransfromToUTSJSONObject(t,p))return o.createTypeReferenceNode(E(e.context),void 0);const d=p.symbol,u=d?.escapedName;if(!u||!R(e,p))return;if(s.isSymbolAccessible(d,a,i.SymbolFlags.Class,!0).accessibility!==i.SymbolAccessibility.Accessible)return s.markSymbolAsNotTypeOnly(d),o.createTypeReferenceNode(s.symbolToEntityName(d,i.SymbolFlags.Class,t,void 0),void 0);const f=s.getAccessibleSymbolChain(d,a,d.flags,!1);let m;if(f&&f.length>0)m=s.symbolToEntityName(d,i.SymbolFlags.Class,a,void 0);else{const t=d.declarations;if(!t||1!==t.length)return;const n=t[0].getSourceFile(),s=a.getSourceFile();if(n===s)return;let c,l;if(r.has(d)){const e=r.get(d);c=e.alias,l=e.importDeclaration}else{const t=d.escapedName;if(c=i.getUniqueName(t,s),l=function(e,t,r,i){const{ts:n}=e,s=e.context,o=e.typeChecker;let a="";if(1!==(r?.declarations||[]).length)return;const c=t.symbol?.exports;for(const e of c.keys()){const t=c.get(e).declarations||[];if(1!==t.length)continue;const i=t[0];let s,l;if(n.isClassDeclaration(i)?l=i.name:n.isExportAssignment(i)?l=i.expression:n.isExportSpecifier(i)&&(l=i.name),s=l&&(o.getContextualType(l)?.symbol||o.getTypeAtLocation(l)?.symbol),s===r){a=e;break}}if(!a)return;const l=s.factory,p=l.createIdentifier(i);return"default"===a?l.createImportDeclaration(void 0,l.createImportClause(!1,p,void 0),l.createStringLiteral(t.fileName),void 0):l.createImportDeclaration(void 0,l.createImportClause(!1,void 0,l.createNamedImports([l.createImportSpecifier(!1,a!==i?l.createIdentifier(a):void 0,p)])),l.createStringLiteral(t.fileName),void 0)}(e,n,d,c),!l)return;r.set(d,{symbol:d,alias:c,importDeclaration:l})}m=o.createIdentifier(c)}return s.markSymbolAsNotTypeOnly(d),o.createTypeReferenceNode(m,void 0)}(s,t,o);if(c)return i.createAsExpression(e.visitEachChild(t,a,r),c)}return e.visitEachChild(t,a,r)};return t=>{const r=e.visitNode(t,a),n=[];for(const e of o.values())n.push(e.importDeclaration),t.locals.set(e.alias,e.symbol);const s=Array.from(r.statements);let c=0;for(let t=0;t<s.length;t++){const r=s[t];if(!e.isImportDeclaration(r))break;c=t+1}return s.splice(c,0,...n),i.updateSourceFile(r,s,r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}),q=e=>({before:t=>t=>(t.statements.forEach((t=>{if((e.isImportDeclaration(t)||e.isExportDeclaration(t))&&t.moduleSpecifier&&e.isStringLiteral(t.moduleSpecifier)){const e=t.moduleSpecifier.text;(e.endsWith(".uvue.ts")||e.endsWith(".vue.ts"))&&(t.moduleSpecifier.text=e.replace(/.u?ts$/,""))}})),t)});function H(e,t){const r=e.ts,i=e.context.factory,{modifiers:n,name:s,typeParameters:o,heritageClauses:a,members:c}=t,l=c.filter((e=>r.isPropertyDeclaration(e))),p=function(e,t,r,i,n){const s=e.context,o=e.ts,a=s.factory,c=[a.createPropertyAssignment(a.createIdentifier("kind"),a.createNumericLiteral(r)),a.createGetAccessorDeclaration(void 0,a.createIdentifier("fields"),[],void 0,a.createBlock([a.createReturnStatement(a.createObjectLiteralExpression([...i.map((t=>{let r="";(t.jsDoc||[]).forEach((e=>{(e.tags||[]).forEach((e=>{if("JSON_FIELD"===e.tagName.escapedText&&"string"==typeof e.comment){const t=e.comment.length;r="'"===e.comment[0]&&"'"===e.comment[t-1]||'"'===e.comment[0]&&'"'===e.comment[t-1]?e.comment.slice(1,-1):e.comment}}))}));const i=[a.createPropertyAssignment(a.createIdentifier("type"),M(e,t.type)),a.createPropertyAssignment(a.createIdentifier("optional"),t.questionToken||e.isUnionWithNullType(t.type)?a.createTrue():a.createFalse())];r&&i.push(a.createPropertyAssignment(a.createIdentifier("jsonField"),a.createStringLiteral(r)));let n="";const s=o.isStringLiteral(t.name)||o.isNumericLiteral(t.name);return(o.isIdentifier(t.name)||s)&&(n=t.name.text),a.createPropertyAssignment(s?a.createStringLiteral(n):a.createIdentifier(n),a.createObjectLiteralExpression(i))}))],!0))],!0))];return"development"===process.env.NODE_ENV&&c.push(a.createPropertyAssignment(a.createIdentifier("name"),a.createStringLiteral(t))),[K(e,n,a.createObjectLiteralExpression(c,!0))]}(e,s?s.escapedText.toString():"",2,l,o?[...o]:[]),d=c.find((e=>r.isIndexSignatureDeclaration(e))),u=c.find((e=>r.isConstructorDeclaration(e))),{parameters:f}=u,m=[...f,i.createParameterDeclaration(void 0,void 0,i.createIdentifier("metadata"),void 0,i.createKeywordTypeNode(r.SyntaxKind.AnyKeyword),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier(s.escapedText),i.createIdentifier("get$UTSMetadata$")),void 0,[])),i.createParameterDeclaration(void 0,void 0,i.createIdentifier("isJSONParse"),void 0,i.createKeywordTypeNode(r.SyntaxKind.BooleanKeyword),i.createFalse())],y="__props__",h=i.createConstructorDeclaration(void 0,m,i.createBlock([i.createExpressionStatement(i.createCallExpression(i.createSuper(),void 0,[])),i.createExpressionStatement(i.createBinaryExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y)),i.createToken(r.SyntaxKind.EqualsToken),i.createCallExpression(i.createPropertyAccessExpression($(e),i.createIdentifier("initProps")),void 0,[i.createIdentifier("options"),i.createIdentifier("metadata"),i.createIdentifier("isJSONParse")]))),...l.map((e=>{const{name:t}=e;let n="";const s=r.isStringLiteral(t)||r.isNumericLiteral(t);return(r.isIdentifier(t)||s)&&(n=t.text),i.createExpressionStatement(i.createBinaryExpression(s?i.createElementAccessExpression(i.createThis(),i.createStringLiteral(n)):i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(n)),i.createToken(r.SyntaxKind.EqualsToken),s?i.createElementAccessExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y)),i.createStringLiteral(n)):i.createPropertyAccessExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y)),i.createIdentifier(n))))})),i.createExpressionStatement(i.createDeleteExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y))))],!0));return i.updateClassDeclaration(t,n,s,o,a,[d,...l,...p,h])}const G=(e,t)=>({parser:{TypeAliasDeclaration:t=>function(r){const i=t.factory,{modifiers:n=[],name:s,typeParameters:o=[],type:a}=r;return e.isTypeLiteralNode(a)?i.createTypeAliasDeclaration(n,s,o,i.createTypeLiteralNode(i.createNodeArray([i.createIndexSignature(void 0,[i.createParameterDeclaration(void 0,void 0,i.createIdentifier("key"),void 0,i.createKeywordTypeNode(e.SyntaxKind.StringKeyword),void 0)],i.createKeywordTypeNode(e.SyntaxKind.AnyKeyword)),...a.members]))):r},SourceFile(t){const r=U(e,void 0,t),i=n=>{if(e.isTypeAliasDeclaration(n)&&e.isTypeLiteralNode(n.type)){const{modifiers:t=[],name:i,typeParameters:s=[],type:o}=n,a=o.members,c=function(e,t,r,i,n){const{ts:s}=e,o=e.context.factory,a=[],c=n?n.map((t=>{const{modifiers:r,name:i,questionToken:n,jsDoc:c}=t;let l;if(s.isPropertySignature(t))l=t.type;else if(s.isMethodSignature(t)){const{type:e,typeParameters:r,parameters:i}=t;l=o.createFunctionTypeNode(r,i,e)}const p=l&&e.createTypeNodeWithNullType(l,!!n);a.push(o.createPropertySignature(void 0,i,n,p));const d=o.createPropertyDeclaration(r,i,n,p,void 0);return d.jsDoc=c,d})):[],l=o.createTypeLiteralNode(a),p=[],d=o.createIndexSignature(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("key"),void 0,o.createKeywordTypeNode(s.SyntaxKind.StringKeyword),void 0)],o.createKeywordTypeNode(s.SyntaxKind.AnyKeyword)),u=o.createConstructorDeclaration(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("options"),void 0,l,void 0)],o.createBlock([o.createExpressionStatement(o.createCallExpression(o.createSuper(),void 0,[])),...(n||[]).map((e=>{let t="";const r=e.name,i=s.isStringLiteral(r)||s.isNumericLiteral(r);return(s.isIdentifier(r)||i)&&(t=r.text),o.createExpressionStatement(o.createBinaryExpression(i?o.createElementAccessExpression(o.createThis(),o.createStringLiteral(t)):o.createPropertyAccessExpression(o.createThis(),o.createIdentifier(t)),o.createToken(s.SyntaxKind.EqualsToken),i?o.createElementAccessExpression(o.createIdentifier("options"),o.createStringLiteral(t)):o.createPropertyAccessExpression(o.createIdentifier("options"),o.createIdentifier(t))))}))],!0));return p.push(d,...c,u),o.createClassDeclaration(t,r,i?.length?i:void 0,[o.createHeritageClause(s.SyntaxKind.ExtendsKeyword,[o.createExpressionWithTypeArguments($(e),void 0)])],p)}(r,[...t],i,[...s],[...a.filter((t=>e.isPropertySignature(t)||e.isMethodSignature(t)))]);c&&(n=c)}else e.isInterfaceDeclaration(n);return n=e.visitEachChild(n,i,t)};return t=>e.visitNode(t,i)}},before(r){const i=t.getProgram().getTypeChecker(),n=U(e,i,r),s=r.factory,o=t=>{if(e.isPropertyAccessExpression(t)&&j(n,t))t=s.createPropertyAccessExpression(v(r),s.createIdentifier("UTSType"));else if(e.isClassDeclaration(t)){const{heritageClauses:e}=t,r=e?.[0]?.types?.[0]?.expression;r&&j(n,r)&&(t=H(n,t))}return t=e.visitEachChild(t,o,r)};return t=>e.visitNode(t,o)}}),Z=e=>({parser:{SourceFile:t=>r=>{const i=n=>{const s=e.visitEachChild(n,i,t);if(e.isCallExpression(s)&&e.isPropertyAccessExpression(s.expression)){const t=s.expression.expression,i=s.expression.name;if(e.isIdentifier(t)&&e.isIdentifier(i)){const e=t.text;"uni"!==e&&"uniCloud"!==e||(r.__utsMeta||(r.__utsMeta={}),r.__utsMeta.uniExtApis||(r.__utsMeta.uniExtApis=new Set),r.__utsMeta.uniExtApis.add(e+"."+i.text))}}return s};return e.visitNode(r,i)}}});function Q(e,t,r,i){return n=>{const s=r(n);return r=>{const o=e.isSourceFile(r);return n.fileName||o&&(n.fileName=r.fileName,r.__utsMeta||(r.__utsMeta={})),t.shouldTransform(n.fileName)?(o&&!r.isUTSFile&&(r.isUTSFile=!0,t.isVueFile?.(n.fileName)&&(r.isVueFile=!0)),o&&"parser"===i&&r.statements.length&&(r.statements[0].parent||e.setParentRecursive(r,!0)),s(r)):r}}}function X(e,t){return t&&t!==e&&!Array.isArray(t)&&(t.__parsedByUtsParser=!0,t.parent=e.parent),t}let Y;function ee(e,t,r){return function(e){if(!e.ObjectFlags.UTSType){const{Class:t,Interface:r,Reference:i,Anonymous:n,ArrayLiteral:s}=e.ObjectFlags;e.ObjectFlags.UTSType=t|r|i|n|s}if(!e.TypeFlags.UTSType){const{Any:t,String:r,Number:i,Boolean:n,Enum:s,StringLiteral:o,NumberLiteral:a,BooleanLiteral:c,EnumLiteral:l,Void:p,Null:d,Object:u,Union:f,TemplateLiteral:m}=e.TypeFlags;e.TypeFlags.UTSType=t|r|i|n|s|o|a|c|l|p|d|u|f|m,e.TypeFlags.UTSStringLike=r|o|m,e.TypeFlags.UTSNumberLike=i|a}}(e),i=>{const n={},s=[],o=[],a=[];return t.forEach((t=>{let c=t(e,i,r);if("function"==typeof c)s.push(Q(e,i,c,"before"));else{if(c.parser){const s=t(function(e){if(Y)return Y;Y={...e};const{visitNode:t,visitEachChild:r}=e;return Y.visitNode=(e,r)=>t(e,(e=>X(e,r(e)))),Y.visitEachChild=(e,t,i)=>r(e,(e=>X(e,t(e))),i),Y}(e),i,r);s.parser&&function(e,t,r,i){i.TypeAliasDeclaration&&(r.TypeAliasDeclaration||(r.TypeAliasDeclaration=[])).push(Q(e,t,(e=>{const t=i.TypeAliasDeclaration(e);return e=>X(e,t(e))}),"parser")),i.SourceFile&&(r.SourceFile||(r.SourceFile=[])).push(Q(e,t,i.SourceFile,"parser"))}(e,i,n,s.parser)}c.before&&s.push(Q(e,i,c.before,"before")),c.after&&o.push(Q(e,i,c.after,"after")),c.afterDeclarations&&a.push(Q(e,i,c.afterDeclarations,"afterDeclarations"))}})),{parser:n,before:s,after:o,afterDeclarations:a}}}function te(e,t){return!!t.isImportTypeNode(e)||(t.forEachChild(e,(e=>te(e,t)))||!1)}function re(e,t,r,i){const n=function(e,t){for(t=e.getOriginalNode(t);;){if(!(t=t.parent))return;switch((t=e.getOriginalNode(t)).kind){case e.SyntaxKind.SourceFile:case e.SyntaxKind.MethodDeclaration:case e.SyntaxKind.MethodSignature:case e.SyntaxKind.FunctionDeclaration:case e.SyntaxKind.FunctionExpression:case e.SyntaxKind.GetAccessor:case e.SyntaxKind.SetAccessor:case e.SyntaxKind.ClassDeclaration:case e.SyntaxKind.InterfaceDeclaration:case e.SyntaxKind.EnumDeclaration:case e.SyntaxKind.ModuleDeclaration:return t}}}(r,t);let s=i.typeToTypeNode(e,n,r.NodeBuilderFlags.None);if(!s&&n&&(s=i.typeToTypeNode(e,void 0,r.NodeBuilderFlags.None)),s)return te(s,r)?i.typeToTypeNode(e,void 0,r.NodeBuilderFlags.None):r.isTypeLiteralNode(s)?r.factory.createTypeReferenceNode(r.factory.createIdentifier("UTSJSONObject"),void 0):(r.isTypeReferenceNode(s)&&s.typeArguments&&(s=ie(r,s)),s)}function ie(e,t){if(e.isTypeReferenceNode(t)&&t.typeArguments){let r=!1;const i=t.typeArguments.map((t=>{if(e.isTypeLiteralNode(t))return r=!0,e.factory.createTypeReferenceNode(e.factory.createIdentifier("UTSJSONObject"),void 0);if(e.isTypeReferenceNode(t)){const i=ie(e,t);return i!==t&&(r=!0),i}return t}));if(r)return e.factory.createTypeReferenceNode(t.typeName,i)}return t}globalThis.__utsHacker__={...globalThis.__utsHacker__},r("uts:transformer:importAndExportDeclaration"),r("uts:transformer:autoImport"),r("uts:transformer:arguments"),r("uts:transformer:checker");const ne=(e,r,i)=>{function n(n,s){if(e.isSourceFile(s)){if(function(e){if(e&&!e.getUTSJSONObjectType&&e.getGlobalType){const t=e.getGlobalType("UTSJSONObject",0,!0);e.getUTSJSONObjectType=()=>t;const r=e.getGlobalType("String",0,!0);e.getUTSStringType=()=>r;const i=e.getGlobalType("Number",0,!0);e.getUTSNumberType=()=>i}}(r.getProgram()?.getTypeChecker()),!s.__relativeFileName){const e=n.getCompilerOptions();if(e.rootDir&&t.isAbsolute(e.rootDir)){const r=N(e.rootDir),i=N(s.fileName);s.__rootDir=r,i.startsWith(r)?s.__relativeFileName=N(t.relative(r,i)):i.includes("/@dcloudio/")&&(s.__relativeFileName="@dcloudio/"+i.split("/@dcloudio/")[1])}s.__relativeFileName||(s.__relativeFileName=t.basename(s.fileName))}if(!n.printNode){const t=e.createPrinter();n.printNode=(r,i)=>t.printNode(e.EmitHint.Unspecified,r,i)}n.addSyntacticDiagnostic||(n.addSyntacticDiagnostic=e=>{s.parseDiagnostics.push(e)},n.addSemanticDiagnostic=e=>{s.bindDiagnostics.push(e)}),n.error||(n.error=e=>{if(i.watch)return e.__throwError=!0,void n.addSyntacticDiagnostic(e);const t=new Error(e.messageText.toString());throw t.diagnostic=e,Object.defineProperty(t,"id",{get:()=>e.file.fileName,set(e){}}),t})}return s}return{before:e=>t=>n(e,t),after:e=>t=>n(e,t),afterDeclarations:e=>t=>n(e,t)}};function se(e,t,r,i){const{addEmitFlags:n,cast:s,chainBundle:o,Debug:a,EmitFlags:c,isCallChain:l,isExpression:p,isGeneratedIdentifier:d,isIdentifier:u,isNonNullChain:f,isOptionalChain:m,isParenthesizedExpression:y,isSimpleCopiableExpression:h,isSyntheticReference:g,isTaggedTemplateExpression:_,OuterExpressionKinds:x,setOriginalNode:T,setTextRange:S,skipParentheses:v,skipPartiallyEmittedExpressions:b,SyntaxKind:E,TransformFlags:N,visitEachChild:C,visitNode:D,visitNodes:I}=t,{factory:A,hoistVariableDeclaration:P}=r;return o(r,(function(e){if(e.isDeclarationFile)return e;return C(e,O,r)}));function O(e){if(!(e.transformFlags&N.ContainsES2020))return e;switch(e.kind){case E.CallExpression:{const t=k(e,!1);return a.assertNotNode(t,g),t}case E.PropertyAccessExpression:case E.ElementAccessExpression:if(m(e)){const t=F(e,!1,!1);return a.assertNotNode(t,g),t}return C(e,O,r);case E.BinaryExpression:return e.operatorToken.kind===E.QuestionQuestionToken?function(e){let t=D(e.left,O,p),r=t;h(t)||(r=A.createTempVariable(P),t=A.createAssignment(r,t));return S(A.createConditionalExpression(L(t,r),void 0,r,void 0,D(e.right,O,p)),e)}(e):C(e,O,r);case E.DeleteExpression:return function(e){return m(v(e.expression))?T(U(e.expression,!1,!0),e):A.updateDeleteExpression(e,D(e.expression,O,p))}(e);default:return C(e,O,r)}}function w(e,t,r){const i=U(e.expression,t,r);return g(i)?A.createSyntheticReferenceExpression(A.updateParenthesizedExpression(e,i.expression),i.thisArg):A.updateParenthesizedExpression(e,i)}function k(e,t){if(m(e))return F(e,t,!1);if(y(e.expression)&&m(v(e.expression))){const t=w(e.expression,!0,!1),r=I(e.arguments,O,p);return g(t)?S(A.createFunctionCallCall(t.expression,t.thisArg,r),e):A.updateCallExpression(e,t,void 0,r)}return C(e,O,r)}function U(r,n,s){switch(r.kind){case E.ParenthesizedExpression:return w(r,n,s);case E.PropertyAccessExpression:case E.ElementAccessExpression:return function(r,n,s){if(m(r))return F(r,n,s);const o=i.getTypeAtLocation(r.expression);let c,l=D(r.expression,O,p);return a.assertNotNode(l,g),n&&(h(l)?c=l:(c=A.createTempVariable(P,void 0,void 0,void 0,e?re(o,r,t,i):void 0),l=A.createAssignment(c,l))),l=r.kind===E.PropertyAccessExpression?A.updatePropertyAccessExpression(r,l,D(r.name,O,u)):A.updateElementAccessExpression(r,l,D(r.argumentExpression,O,p)),c?A.createSyntheticReferenceExpression(l,c):l}(r,n,s);case E.CallExpression:return k(r,n);default:return D(r,O,p)}}function F(r,o,y){const{expression:v,chain:N}=function(e){if(a.assertNotNode(e,f),f(e))throw new Error("Unexpected non-null chain");const t=[e];for(;!e.questionDotToken&&!_(e);)e=s(b(e.expression),m),a.assertNotNode(e,f),t.unshift(e);return{expression:e.expression,chain:t}}(r),C=i.getTypeAtLocation(v),w=U(b(v),l(N[0]),!1);let k=g(w)?w.thisArg:void 0,F=g(w)?w.expression:w,R=A.restoreOuterExpressions(v,F,x.PartiallyEmittedExpressions);h(F)||(F=A.createTempVariable(P,void 0,void 0,void 0,e?re(C,r,t,i):void 0),R=A.createAssignment(F,R));let $,j=F;for(let r=0;r<N.length;r++){const s=N[r];switch(s.kind){case E.PropertyAccessExpression:case E.ElementAccessExpression:if(r===N.length-1&&o)if(h(j))$=j;else{const r=i.getTypeAtLocation(s.expression);$=A.createTempVariable(P,void 0,void 0,void 0,e?re(r,s,t,i):void 0),j=A.createAssignment($,j)}j=s.kind===E.PropertyAccessExpression?A.createPropertyAccessExpression(j,D(s.name,O,u)):A.createElementAccessExpression(j,D(s.argumentExpression,O,p));break;case E.CallExpression:0===r&&k?(d(k)||(k=A.cloneNode(k),n(k,c.NoComments)),j=A.createFunctionCallCall(j,k.kind===E.SuperKeyword?A.createThis():k,I(s.arguments,O,p))):j=A.createCallExpression(j,void 0,I(s.arguments,O,p))}T(j,s)}const M=y?A.createConditionalExpression(L(R,F,!0),void 0,A.createTrue(),void 0,A.createDeleteExpression(j)):A.createConditionalExpression(L(R,F,!0),void 0,A.createNull(),void 0,j);return S(M,r),$?A.createSyntheticReferenceExpression(M,$):M}function L(e,t,r){return A.createBinaryExpression(A.createBinaryExpression(e,A.createToken(r?E.EqualsEqualsEqualsToken:E.ExclamationEqualsEqualsToken),A.createNull()),A.createToken(r?E.BarBarToken:E.AmpersandAmpersandToken),A.createBinaryExpression(t,A.createToken(r?E.EqualsEqualsEqualsToken:E.ExclamationEqualsEqualsToken),A.createVoidZero()))}}r("uts:transformer:generics"),r("uts:transformer:in"),r("uts:transformer:keyof"),r("uts:transformer:narrowType:discriminatedUnion"),r("uts:transformer:narrowType:nonNullable"),r("uts:transformer:narrowType"),r("uts:transformer:narrowType:parameterUnionType"),r("uts:transformer:UTSObjectUnionType"),r("uts:transformer:objectLiteral");const oe=(e,t,r)=>({before(i){const n=t.getProgram().getTypeChecker(),s=se("ArkTS"===r.targetLanguage,e,i,n);return e=>s(e)}});function ae(e,t,r,i){return{code:e,category:t,key:r,message:i}}r("uts:transformer:returnType"),r("uts:transformer:UTSJSONObject"),globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;const ce=(e,t,r)=>{const{extname:i,resolveWorkers:n,rewriteRootDir:s}=r.transformCreateWorker||{resolveWorkers:()=>({})},o={Worker_Path_Expected_a_string_literal:ae(0,e.DiagnosticCategory.Error,"Worker_Path_Expected_a_string_literal_0","uni.createWorker(workerPath) 的 workerPath 参数必须是字符串字面量"),Worker_Path_Not_Found:ae(0,e.DiagnosticCategory.Error,"Worker_Path_Not_Found_0","Worker[{0}]路径不存在或未正确实现"),Worker_Not_Supported_on_App_IOS_Uvue:ae(0,e.DiagnosticCategory.Error,"Worker_Not_Supported_on_App_IOS_Uvue_0","app-ios平台，目前仅 uts 插件中支持使用 uni.createWorker 创建 worker")};return{before(t){const{factory:a}=t,c=new Map,l=n(),p=n=>{if(e.isCallExpression(n)&&n.arguments.length>=1&&e.isPropertyAccessExpression(n.expression)&&"createWorker"===n.expression.name.escapedText&&e.isIdentifier(n.expression.expression)&&"uni"===n.expression.expression.escapedText){"JavaScript"===r.targetLanguage&&"app-ios"===r.platform&&t.error(e.createDiagnosticForNode(n,o.Worker_Not_Supported_on_App_IOS_Uvue));const p=n.arguments[0];let d="";if(e.isStringLiteral(p)||e.isNoSubstitutionTemplateLiteral(p)?d=p.text:t.error(e.createDiagnosticForNode(p,o.Worker_Path_Expected_a_string_literal)),d)if(d.startsWith("/")&&(d=d.slice(1)),l[d]){if("Kotlin"===r.targetLanguage||"Swift"===r.targetLanguage){const t=a.createIdentifier(l[d]);if(!c.has(d)){const e=a.createImportDeclaration(void 0,a.createImportClause(!1,void 0,a.createNamedImports([a.createImportSpecifier(!1,void 0,t)])),a.createStringLiteral(`@/${d}`),void 0);c.set(d,e)}const r=[a.createArrowFunction(void 0,void 0,[],a.createTypeReferenceNode(a.createIdentifier("WorkerTaskImpl"),void 0),a.createToken(e.SyntaxKind.EqualsGreaterThanToken),a.createNewExpression(t,void 0,[]))];for(let e=1;e<n.arguments.length;e++)r.push(n.arguments[e]);return a.updateCallExpression(n,n.expression,n.typeArguments,r)}if(i){let e=d.replace(".uts",i);s&&e.includes("uni_modules/")&&(e="/"+s+(e.startsWith("/")?"":"/")+e);const t=[a.createStringLiteral(e)];for(let e=1;e<n.arguments.length;e++)t.push(n.arguments[e]);return a.updateCallExpression(n,n.expression,n.typeArguments,t)}}else t.error(e.createDiagnosticForNode(p,o.Worker_Path_Not_Found,d))}return e.visitEachChild(n,p,t)};return t=>{const r=e.visitNode(t,p);return 0===c.size?r:a.updateSourceFile(r,[...c.values(),...r.statements],r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}};function le(e,t){return e.isExpressionStatement(t)&&e.isCallExpression(t.expression)&&e.isIdentifier(t.expression.expression)&&"defineExpose"===t.expression.expression.text}function pe(e,t){return e.createExportAssignment(void 0,void 0,e.createCallExpression(e.createIdentifier("defineComponent"),void 0,[e.createObjectLiteralExpression([e.createMethodDeclaration(void 0,void 0,e.createIdentifier("setup"),void 0,void 0,[e.createParameterDeclaration(void 0,void 0,e.createIdentifier("props"),void 0,void 0,void 0),e.createParameterDeclaration(void 0,void 0,e.createObjectBindingPattern([e.createBindingElement(void 0,void 0,e.createIdentifier("expose"),void 0)]),void 0,void 0,void 0)],void 0,e.createBlock(t,!0))],!0)]))}const de=e=>({parser:{SourceFile(t){const{factory:r}=t;let i=!1,n=!1;const s=o=>{if(e.isSourceFile(o)){if(n&&o.text.startsWith("// @uts-setup\n")){const i=o.statements,n=[],s=[],a=[];for(let o=0;o<i.length;o++){const c=i[o];if(e.isImportDeclaration(c))n.push(c);else if(e.isExportAssignment(c)){if(e.isObjectLiteralExpression(c.expression)&&0===c.expression.properties.length)continue;const r=e.createDiagnosticForNode(c,P.script_setup_cannot_contain_ES_module_exports);t.addSyntacticDiagnostic(r)}else le(e,c)?a.push(r.createReturnStatement(c.expression.arguments[0])):s.push(c)}return r.updateSourceFile(o,[...n,pe(r,[...s,...a])])}return e.visitEachChild(o,s,t)}return e.isExportAssignment(o)&&e.isObjectLiteralExpression(o.expression)?r.updateExportAssignment(o,o.modifiers,r.createCallExpression(r.createIdentifier(i?"defineApp":"defineComponent"),void 0,[o.expression])):o};return t=>{if(!t.isVueFile||t.fileName.indexOf("setup=true")>-1)return t;const o=_.basename(t.fileName).split("?")[0].toLowerCase();"app.uvue"!==o&&"app.uvue.ts"!==o||(i=!0),/.u?vue.ts/.test(o)&&(n=!0);const a=e.visitNode(t,s);return a!==t?r.updateSourceFile(a,[r.createImportDeclaration(void 0,r.createImportClause(!1,void 0,r.createNamedImports([r.createImportSpecifier(!1,void 0,r.createIdentifier(i?"defineApp":"defineComponent"))])),r.createStringLiteral("vue")),...a.statements]):a}}},before(t){const{factory:r}=t,i=n=>e.isSourceFile(n)?e.visitEachChild(n,i,t):e.isExportAssignment(n)&&e.isCallExpression(n.expression)?r.updateExportAssignment(n,n.modifiers,r.createCallExpression(r.createIdentifier("defineComponent"),void 0,n.expression.arguments)):e.isImportDeclaration(n)&&n.moduleSpecifier&&e.isStringLiteral(n.moduleSpecifier)&&"vue"===n.moduleSpecifier.text&&n.importClause&&e.isImportClause(n.importClause)&&n.importClause.namedBindings&&e.isNamedImports(n.importClause.namedBindings)&&n.importClause.namedBindings.elements.some((e=>"defineApp"===e.name.text))?r.updateImportDeclaration(n,n.modifiers,r.updateImportClause(n.importClause,!1,void 0,r.createNamedImports(n.importClause.namedBindings.elements.filter((e=>"defineApp"!==e.name.text)))),n.moduleSpecifier,n.assertClause):n;return t=>t.isVueFile?("app.uvue"===_.basename(t.fileName).split("?")[0].toLowerCase()&&(t=e.visitNode(t,i)),t):t}});let ue=null,fe=[];const me=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker();null===ue&&i.getGlobalType&&(ue=i.getGlobalType("UniApp",0,!1),ue&&(fe=ue.getProperties().map((e=>e.getName()))));const n=t=>{if(ue&&fe.length){if(e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&e.isIdentifier(t.expression.name)){const r=function(e,t){return e.getContextualType(t)??e.getTypeAtLocation(t)}(i,t.expression.expression);if(r&&r.isIntersection()&&r.types.some((e=>"UniApp"===e.symbol?.name))&&!fe.includes(t.expression.name.text)){console.error(`error: '${t.expression.name.text}' 不是 UniApp 对象的方法，请检查是否拼写错误，如果想调用在 App.uvue 文件中定义的 methods 方法，请使用 .vm?.xxx 的方式调用，详情参考：https://doc.dcloud.net.cn/uni-app-x/api/get-app.html#appmethods`);const r=t.getSourceFile();if(r.__relativeFileName){const i=e.getLineAndCharacterOfPosition(r,t.pos),n=r.__relativeFileName.split("?")[0].replace(/\.(vue|uvue|uts).ts$/g,".$1");console.error("at "+n+":"+i.line)}}}return e.visitEachChild(t,n,r)}return t};return t=>e.visitNode(t,n)}}),ye=["defineMixin","definePlugin"],he=e=>({before(t){const r=i=>{if(e.isCallExpression(i)&&e.isIdentifier(i.expression)&&i.arguments.length>0){const e=i.expression.escapedText.toString();ye.includes(e)&&(i=i.arguments[0])}return e.visitEachChild(i,r,t)};return t=>e.visitNode(t,r)}}),ge={useSharedData:"Data",useSharedDataComponent:"Component",useSharedDataPage:"Page"},_e=Object.keys(ge),xe=Object.keys({_withSharedData:"Data",_withSharedDataComponent:"Component",_withSharedDataPage:"Page"}),Te={_defineEmits:"__emit"},Se="useSharedData",ve=["setSharedData","setSharedDataDynamicProps","setSharedDataEvents","setSharedDataClass","setSharedDataStyle","setSharedDataAttr","setSharedDataEvent","setSharedDataModel","setSharedDataTemplateRef","setSharedDataDynamicEvents"].map((e=>"_"+e)),be=["createSharedDataComponent","createSharedDataDynamicComponent","createSharedDataComponentWithFallback"].map((e=>"_"+e));function Ee(e,t,r,i){const n=t.getTypeAtLocation(e);if(n===t.getErrorType()){const t=r.createDiagnosticForNode(e,P.The_type_could_not_be_inferred);i.error(t)}return n}function Ne(e,t,r,i){const n=i.createTypeReferenceNode("UniSharedDataAny");if(e.flags&r.TypeFlags.EnumLiteral)return i.createTypeReferenceNode("UniSharedDataEnum",[i.createTypeReferenceNode(t.typeToString(e))]);if(e.isUnion()&&(2===e.types.length||3===e.types.length))if(e.types.some((e=>e.flags&r.TypeFlags.Null))||e.types.some((e=>e.flags&r.TypeFlags.Undefined))){const n=e.types.filter((e=>!(e.flags&r.TypeFlags.Null||e.flags&r.TypeFlags.Undefined)));if(1===n.length)return i.createUnionTypeNode([Ne(n[0],t,r,i),i.createLiteralTypeNode(i.createNull())]);if(2===n.length&&n.every((e=>Ie(e,t))))return i.createUnionTypeNode([i.createTypeReferenceNode("UniSharedDataComponent"),i.createLiteralTypeNode(i.createNull())])}else if(e.types.every((e=>Ie(e,t))))return i.createTypeReferenceNode("UniSharedDataComponent");const s=t.getErrorType(),o=t.getAnyType();if(e===t.getBooleanType())return i.createKeywordTypeNode(r.SyntaxKind.BooleanKeyword);if(e.isUnionOrIntersection()||e===s||e===o)return n;if(e===t.getStringType())return i.createKeywordTypeNode(r.SyntaxKind.StringKeyword);if(e===t.getNumberType())return i.createKeywordTypeNode(r.SyntaxKind.NumberKeyword);if(e===t.getNullType()||e===t.getUndefinedType())return i.createLiteralTypeNode(i.createNull());if(t.isArrayType(e))return i.createTypeReferenceNode("UniSharedDataArray");if(e===t.getAnyType())return n;function a(e,r){return e===t.getGlobalType(r,0,!0)}return t.isTypeAssignableTo(e,t.getGlobalType("UniSharedData",0,!0))||a(e,"UniSharedDataFunctionSetTemplateRef")||a(e,"UniSharedDataFunctionEventListener")||a(e,"UniElementStyles")?i.createTypeReferenceNode(t.typeToString(e)):i.createTypeReferenceNode("UniSharedDataJSONObject")}function Ce(e,t,r){return r.createMethodDeclaration(void 0,void 0,r.createIdentifier("get_"+e),void 0,void 0,[r.createParameterDeclaration(void 0,void 0,r.createIdentifier("reactivity"),void 0,r.createTypeReferenceNode(r.createIdentifier("VueReactivity"),void 0),void 0)],r.cloneNode(t),void 0)}function De(e,t,r,i){if(r.isLiteralTypeNode(e)){if(!r.isStringLiteral(e.literal))return;return e.literal.text}if(r.isTemplateLiteralTypeNode(e)||r.isTypeReferenceNode(e)){const n=Ee(e,t,r,i);if(!n.isStringLiteral())return;return n.value}}function Ie(e,t){const r=t.typeToString(e);return"UniSharedDataComponent"===r||"UniSharedDataPage"===r}const Ae="|null",Pe={createUniSharedData:(e,t)=>({decls:e,getDeclsText:()=>t})},Oe=(e,t,r)=>({before(i){const n=r.sharedDataLibName,s=t.getProgram().getTypeChecker(),o=i.factory;let a=!1,c={},l={},p={};const d=new Set;function u(e){n&&d.add(e)}const f=t=>{let r=!1;if(a||(r=e.isMethodDeclaration(t)&&e.isIdentifier(t.name)&&"setup"===t.name.text,r&&(a=!0)),a&&e.isVariableDeclaration(t)&&t.initializer&&e.isCallExpression(t.initializer)&&e.isIdentifier(t.initializer.expression)){const r=t.initializer.expression.text;if(r in Te&&e.isIdentifier(t.name))return o.updateVariableDeclaration(t,t.name,t.exclamationToken,t.type,o.createIdentifier(Te[r]))}if(a){if(e.isVariableDeclaration(t)&&e.isIdentifier(t.name)&&t.initializer&&e.isCallExpression(t.initializer)&&e.isIdentifier(t.initializer.expression)){const r=t.initializer.expression.text,n=t.name.text;let a=null,l=xe.includes(r),d=_e.includes(r);if(l){const r=t.initializer.arguments[0];e.isCallExpression(r)&&(a=r)}else d&&(a=t.initializer);if(a&&e.isIdentifier(a.expression)){const l=a.typeArguments,p=a.expression.text;if(l&&1===l.length){const f=l[0];if(e.isLiteralTypeNode(f)||e.isTemplateLiteralTypeNode(f)||e.isTypeReferenceNode(f)){const l=De(f,s,e,i);if(l){c[n]={className:l,type:ge[p]||"Data"},u(l);const e=o.createNewExpression(o.createIdentifier(l),void 0,a.arguments);return o.updateVariableDeclaration(t,t.name,t.exclamationToken,t.type,d?e:o.createCallExpression(o.createIdentifier(r),void 0,[e]))}}}}else if(be.includes(r))p[n]="UniSharedDataComponent"+Ae;else if("resolveEasycom"===r){t.initializer.arguments.length}}if(e.isCallExpression(t)&&e.isIdentifier(t.expression)){const r=t.expression.text,n=t.arguments;if(ve.includes(r)){const[a,d,u]=n;if(a&&d&&u&&e.isIdentifier(a)&&e.isStringLiteral(d)){const f=a.text,m=d.text;if("_setSharedDataClass"===r)l[f]=l[f]||{},l[f][m]=o.createArrayTypeNode(o.createKeywordTypeNode(e.SyntaxKind.StringKeyword));else if(e.isCallExpression(u)&&e.isIdentifier(u.expression)&&"_createSharedDataVFor"===u.expression.text){const t=u.arguments?.[1];if(t&&e.isArrowFunction(t)){const r=t.body;if(e.isCallExpression(r)&&e.isIdentifier(r.expression)&&r.expression.text===Se&&r.typeArguments&&1===r.typeArguments.length){const t=r.typeArguments[0];if(e.isLiteralTypeNode(t)||e.isTemplateLiteralTypeNode(t)||e.isTypeReferenceNode(t)){const r=De(t,s,e,i);if(r){const e=r.match(/_(VFor\d*)$/);if(e){const t=`__sharedData_${e[1]}`;c[t]={className:r,type:"Data"},l[f]=l[f]||{},l[f][m]=o.createTypeReferenceNode(o.createIdentifier("UniSharedDataVFor"),[o.createTypeReferenceNode(o.createIdentifier(r))])}}}}}}else if(u&&e.isPropertyAccessExpression(u)&&u.expression&&e.isIdentifier(u.expression)&&u.name&&e.isIdentifier(u.name)&&"sharedData"===u.name.text&&u.expression.text&&p[u.expression.text]){const e=u.expression.text;let t=p[e];if(t){let e=t.includes(Ae);l[f]=l[f]||{},l[f][m]=e?o.createUnionTypeNode([o.createTypeReferenceNode(o.createIdentifier(t.replace(Ae,""))),o.createLiteralTypeNode(o.createNull())]):o.createTypeReferenceNode(o.createIdentifier(t))}}else if("_setSharedDataModel"===r&&n[2]){const t=n[2],r=Ee(e.getOriginalNode(t)||t,s,e,i);if(r&&r.getCallSignatures().length>0){const e=r.getCallSignatures()[0].getReturnType();e&&(l[f]=l[f]||{},l[f][m]=s.getBaseTypeOfLiteralType(e))}}else{const r=Ee(e.getOriginalNode(t)||t,s,e,i);r&&(l[f]=l[f]||{},l[f][m]=s.getBaseTypeOfLiteralType(r))}}}else if(r===Se&&t.typeArguments&&1===t.typeArguments.length){const r=t.typeArguments[0];if(e.isLiteralTypeNode(r)||e.isTemplateLiteralTypeNode(r)||e.isTypeReferenceNode(r)){const n=De(r,s,e,i);if(n){if(n.match(/_(VFor\d*)$/))return u(n),o.createNewExpression(o.createIdentifier(n),void 0,t.arguments)}}}}}const n=e.visitEachChild(t,f,i);return a&&r&&(a=!1),n};return f.ignoreRawJsLabel=!0,t=>{if(c={},l={},t=e.visitNode(t,f),d.size>0){const e=o.createImportDeclaration(void 0,o.createImportClause(!1,void 0,o.createNamedImports(Array.from(d).map((e=>o.createImportSpecifier(!1,void 0,o.createIdentifier(e)))))),o.createStringLiteral(n));t=o.updateSourceFile(t,[e,...t.statements])}t.__utsMeta||(t.__utsMeta={});const r=function(e,t,r,i,n){const s=[],o=Object.keys(t).sort(((e,t)=>t.length-e.length));for(const a of o){const{className:o,type:c}=t[a];e[a]||(e[a]={});const l=[],p=e[a],d=Object.keys(p).sort();for(const e of d){const t=p[e];if(i.isTypeNode(t)){const r=t;let s=!1;i.isUnionTypeNode(r)&&(s=r.types.some((e=>e.kind===i.SyntaxKind.UndefinedKeyword||i.isLiteralTypeNode(e)&&e.literal.kind===i.SyntaxKind.NullKeyword))),l.push(n.createPropertyDeclaration([],n.createIdentifier(e),s?n.createToken(i.SyntaxKind.QuestionToken):void 0,r,void 0)),l.push(Ce(e,r,n));continue}const s=t;if(!r.typeToTypeNode(s,void 0,i.NodeBuilderFlags.UseAliasDefinedOutsideCurrentScope))continue;let o=!1;s.isUnion()&&(o=s.types.some((e=>!!(e.flags&i.TypeFlags.Null)||!!(e.flags&i.TypeFlags.Undefined))));const a=Ne(s,r,i,n);l.push(n.createPropertyDeclaration([],n.createIdentifier(e),o?n.createToken(i.SyntaxKind.QuestionToken):void 0,a,void 0)),l.push(Ce(e,a,n))}const u=n.createClassDeclaration([n.createToken(i.SyntaxKind.DeclareKeyword)],n.createIdentifier(o),void 0,[n.createHeritageClause(i.SyntaxKind.ExtendsKeyword,[n.createExpressionWithTypeArguments(n.createIdentifier("Page"===c?"UniSharedDataPage":"Component"===c?"UniSharedDataComponent":"UniSharedData"),void 0)])],l);s.push(u)}return s}(l,c,s,e,i.factory);let a="";return(process.env.TS_JEST&&process.env.JEST_WORKER_ID&&process.env.JEST_PROJET_ROOT||"true"===process.env.UNI_SHARED_DATA_TEST)&&(a=r.map((e=>i.printNode(e,t))).join("\n")),t.__utsMeta.uniSharedData=Pe.createUniSharedData(r,a),t}}}),we=new Map;we.set("onShow",!1),we.set("onHide",!1),we.set("onAppShow",!0),we.set("onLaunch",!0),we.set("onError",!0),we.set("onThemeChange",!0),we.set("onKeyboardHeightChange",!0),we.set("onPageNotFound",!0),we.set("onUnhandledRejection",!0),we.set("onLastPageBackPress",!1),we.set("onExit",!1),we.set("onLoad",!0),we.set("onShow",!0),we.set("onReady",!1),we.set("onUnload",!1),we.set("onResize",!0),we.set("onBackPress",!0),we.set("onPageScroll",!0),we.set("onTabItemTap",!0),we.set("onReachBottom",!1),we.set("onPullDownRefresh",!1),we.set("beforeCreate",!1),we.set("created",!1),we.set("beforeMount",!1),we.set("mounted",!1),we.set("beforeUpdate",!1),we.set("updated",!1),we.set("beforeUnmount",!1),we.set("unmounted",!1);const ke=(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=U(e,void 0,t),n=s=>{const o=e.visitEachChild(s,n,t);if(e.isParameter(o)&&!o.type&&!o.dotDotDotToken){const t=o.parent;if(t&&(e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t))&&0===t.parameters.indexOf(o)){const n=i.getMethodNameNodeOfObjectLiteral(t);if(n&&e.isIdentifier(n)){const t=n.escapedText.toString();if(!0===we.get(t)){const i=n?.parent?.parent?.parent;if(i&&e.isCallExpression(i)){const n=i.expression;if(e.isIdentifier(n)&&k(n.escapedText.toString()))return r.createParameterDeclaration(o.modifiers,o.dotDotDotToken,o.name,o.questionToken,r.createTypeReferenceNode(r.createIdentifier(t.replace(/^(\w)/,(e=>e.toUpperCase()))+"Options"),void 0),o.initializer)}}}}}return o};return r=>r.isVueFile?e.visitEachChild(r,n,t):r}}});function Ue(e,t){const{ts:r}=e;return e.context.factory.createPropertyAccessExpression(r.isQualifiedName(t.left)?Ue(e,t.left):t.left,t.right)}function Fe(e,t,r){const{ts:i}=e,n=e.context,s=n.factory,o=i.isQualifiedName(r)?Ue(e,r):"UTSJSONObject"===r.escapedText.toString()?E(n):s.createIdentifier(r.escapedText.toString());return s.createNewExpression(o,void 0,[t])}function Le(e,t){const{ts:r}=e,i=e.context,n=e.typeChecker,s=i.factory,{type:o,expression:a}=t;if(!r.isObjectLiteralExpression(a))return;if(r.isTypeReferenceNode(o)&&r.isIdentifier(o.typeName)&&"UTSJSONObject"===o.typeName.escapedText)return s.createNewExpression(E(e.context),void 0,[a]);let c;try{c=n.getContextualType(a)?.symbol}catch(e){}return c?c&&"UTSJSONObject"===c.escapedName?s.createNewExpression(E(e.context),void 0,[a]):o&&function(e,t){const r=e.typeChecker.getContextualType(t);return!(!r||!R(e,r))}(e,a)&&r.isObjectLiteralExpression(a)?Fe(e,a,o.typeName):void 0:void 0}const Re=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),n=U(e,i,r),s=t=>(t=e.visitEachChild(t,s,r),e.isAsExpression(t)&&t.type&&Le(n,t)||t);return t=>e.visitNode(t,s)}});const $e=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),n=U(e,i,r),s=t=>(!e.isVariableDeclaration(t)||t.initializer||t.parent&&e.isCatchClause(t.parent)||!e.isIdentifier(t.name)?e.isParameter(t)?t=function(e,t){const{modifiers:r,dotDotDotToken:i,name:n,questionToken:s,type:o,initializer:a}=t;if(t.pos<0||a||i)return t;const c=e.context.factory,l=e.typeChecker,p=e.ts;return p.isMethodDeclaration(t.parent)&&p.isIdentifier(t.parent.name)&&"setup"===t.parent.name.text?t:s||e.isPossibleNullType(l.getTypeAtLocation(t))?c.updateParameterDeclaration(t,r,i,n,s,o&&e.createTypeNodeWithNullType(o,!0),a||c.createNull()):t}(n,t):(e.isFunctionDeclaration(t)||e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t)||e.isGetAccessorDeclaration(t))&&(t=function(e,t){const r=e.ts,i=e.context,n=i.factory,s=e.typeChecker,{modifiers:o,type:a}=t,c=o?.some((e=>e.kind===r.SyntaxKind.AsyncKeyword));let l=!1,p=!1;if(a){const r=s.getSignatureFromDeclaration(t)?.getReturnType();if(r&&(l=e.isPossibleNullType(r),p=e.isPossiblePromiseNullType(r),!l&&!p))return t}return r.visitEachChild(t,(function e(t){return r.isFunctionLike(t)?t:r.isReturnStatement(t)&&!t.expression?n.updateReturnStatement(t,c||p?n.createCallExpression(n.createPropertyAccessExpression(n.createIdentifier("Promise"),n.createIdentifier("resolve")),void 0,[n.createNull()]):n.createNull()):r.visitEachChild(t,e,i)}),i)}(n,t)):t=function(e,t){const r=e.context.factory,i=e.typeChecker;return!t.initializer&&t.pos>0&&e.isPossibleNullType(i.getTypeAtLocation(t))?r.updateVariableDeclaration(t,t.name,t.exclamationToken,t.type,r.createNull()):t}(n,t),t=e.visitEachChild(t,s,r));return t=>e.visitNode(t,s)}});const je={Array_pop:"arrayPop",Array_shift:"arrayShift",Array_find:"arrayFind",Array_findLast:"arrayFindLast",Array_at:"arrayAt",Map_get:"mapGet",WeakMap_get:"weakMapGet",string_codePointAt:"stringCodePointAt",string_at:"stringAt"},Me=Object.keys(je).map((e=>e.split("_")[1])),Ke=["uni.request","JSON.parse","JSON.parseArray","JSON.parseObject"];function We(e,t){const r=e.ts,i=e.context,n=i.factory;if(r.isArrayTypeNode(t)){const{elementType:r}=t;return n.createCallExpression(n.createPropertyAccessExpression(n.createPropertyAccessExpression(v(i),n.createIdentifier("UTSType")),n.createIdentifier("withGenerics")),void 0,[n.createIdentifier("Array"),n.createArrayLiteralExpression([We(e,r)]),n.createTrue()])}if(r.isTypeReferenceNode(t)){const{typeName:s,typeArguments:o}=t;if(!r.isIdentifier(s)){const t=r.createDiagnosticForNode(s,P.Invalid_generic_type_which_can_not_be_constructed);return i.addSemanticDiagnostic(t),E(e.context)}return o&&0!==o.length?n.createCallExpression(n.createPropertyAccessExpression(n.createPropertyAccessExpression(v(i),n.createIdentifier("UTSType")),n.createIdentifier("withGenerics")),void 0,[n.createIdentifier(s.escapedText.toString()),n.createArrayLiteralExpression(o.map((t=>We(e,t)))),n.createTrue()]):n.createIdentifier(s.escapedText.toString())}return M(e,t)}const ze=["Array","Map","WeakMap","string","String","number","Number","boolean","Boolean","UTSJSONObject"];const Je=(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),n=U(e,i,r),s=t=>{if(e.isIdentifier(t)){if("JSON"===t.escapedText)return function(e){const t=e.context,r=t.factory;return r.createPropertyAccessExpression(v(t),r.createIdentifier("JSON"))}(n)}else e.isBinaryExpression(t)?t.operatorToken.kind===e.SyntaxKind.InstanceOfKeyword&&(t=function(e,t){const r=e.context,i=r.factory;return v(r),i.createCallExpression(i.createPropertyAccessExpression(v(r),i.createIdentifier("isInstanceOf")),void 0,[t.left,t.right])}(n,t)):e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&(t=function(e,t){const r=e.context,i=r.factory,n=e.typeChecker,s=e.ts,{expression:o,arguments:a}=t;if(!s.isPropertyAccessExpression(o))return t;const{expression:c,name:l}=o;if(s.isIdentifier(c)&&s.isIdentifier(l)&&Ke.includes(`${c.escapedText}.${l.escapedText}`)){const r=t.typeArguments?.[0];if(r&&s.isTypeReferenceNode(r)&&r.pos>0&&s.isIdentifier(r.typeName)){const c=ze.includes(r.typeName.escapedText.toString());let l;if(!c&&(l=n.getSymbolAtLocation(r),!l)){const e=r.typeName.escapedText;l=n.getSymbolsInScope(t,s.SymbolFlags.Type).find((t=>t.escapedName===e))}if(c||l&&L(e,l))return i.updateCallExpression(t,o,void 0,[...a,We(e,r)])}}if(!s.isIdentifier(l)||!Me.includes(l.escapedText.toString()))return t;if(c.pos<0)return t;const p=n.getTypeAtLocation(c);let d="";n.isArrayType(p)?d="Array":n.isTypeAssignableTo(p,n.getStringType())&&(d="string");const u=p.symbol?.escapedName.toString();"Map"===u?d="Map":"WeakMap"===u&&(d="WeakMap");const f=l.escapedText,m=je[`${d}_${f}`];return m?(v(r),i.createCallExpression(i.createPropertyAccessExpression(v(r),i.createIdentifier(m)),void 0,[c,...a])):t}(n,t));return t=e.visitEachChild(t,s,r)};return t=>e.visitNode(t,s)}}),Ve=(e,t)=>({parser:{SourceFile:t=>{const r=t.factory,i=n=>{let s=e.visitEachChild(n,i,t);return e.isMethodDeclaration(s)&&e.isIdentifier(s.name)&&"valueIterator"===s.name.escapedText?r.createMethodDeclaration(s.modifiers,s.asteriskToken,r.createComputedPropertyName(r.createPropertyAccessExpression(r.createIdentifier("Symbol"),r.createIdentifier("iterator"))),s.questionToken,s.typeParameters,s.parameters,s.type,s.body):e.isExpressionWithTypeArguments(n)&&e.isIdentifier(n.expression)&&"UTSValueIterable"===n.expression.escapedText?r.createExpressionWithTypeArguments(r.createIdentifier("Iterable"),n.typeArguments):s};return r=>e.visitEachChild(r,i,t)}}});function Be(e,t,r,i){const n=U(e,t,void 0),s=t.getNullType(),o=t.getUndefinedType(),a=t.getVoidType(),c=t.getStringType();function l(e){let t=e.getBaseTypes();return 1===t?.length&&"String"===t[0].getSymbol()?.getName()}function p(e){return e===o||e===a}return!!(n.isObjectLiteralType(r)&&n.isPossibleUTSJSONObjectType(i)||n.isObjectLiteralType(i)&&n.isPossibleUTSJSONObjectType(r))||(!!(p(r)&&i===s||r===s&&p(i))||(!!(r===c&&l(i)||l(r)&&i===c)||void 0))}const qe=N(_.resolve(process.env.UNI_INPUT_DIR||"","uni_modules"));const He=new RegExp("^"+O+"/([a-zA-Z0-9_-]+)/index.d.ts$");const Ge=process.env.UNI_UTS_PLATFORM,Ze="app-ios"===Ge,Qe="app-harmony"===Ge;let Xe=[];Xe=Ze||Qe?["app-js/index.uts","app-js/index.ts","app-js/index.js"]:[`${Ge}/index.uts`,`${Ge}/index.ts`,`${Ge}/index.js`];const Ye={replaceVueTypes:function(e,t){return e.endsWith("runtime-core.d.ts")&&(t=(t=(t=t.replace(/type ObjectInjectOptions = Record<([\s\S]+?)>;/,"type ObjectInjectOptions<I = Data> = {\n    [K in keyof I]: {\n      type: PropType<I[K]>;\n      from?: string;\n      default?: I[K] | (() => I[K]);\n    }\n  };")).replace(/type InjectToObject<T([\s\S]+?): never;/,"type InjectToObject<T> = T extends string[] ? {\n    [K in T[number]]: unknown;\n  } : T extends ObjectInjectOptions<infer I> ? {\n    [K in keyof I]: I[K];\n  } : never;")).replace(/serverPrefetch\?\(\): void \| Promise<any>;/,"serverPrefetch?(): void | Promise<any | null>;")),e.endsWith("app.d.ts")&&(t=t.replace(/\s\sexport function defineApp<D extends OptionsData = OptionsData.*/,"")),t},isTypeRelatedTo:function(e,t,r,i){return Be(e,t,r,i)},isRelatedTo:Be,tryFileLookup:function(e){if(!process.env.UNI_INPUT_DIR)return;const t=function(e){const t=e.match(He);return t?t[1]:""}(e);if(t){const e=_.resolve(O,t,"utssdk");if(Qe){if(D(_.resolve(e,"app-harmony/index.uts")))return}for(let t=0;t<Xe.length;t++){const r=Xe[t],i=_.resolve(e,r);if(D(i))return N(i)}if(Ze||Qe)return;const r=_.resolve(O,t,"utssdk/index.uts");if(D(r))return N(r)}else if(e.endsWith(".d.ts")&&!D(e)){const t=e.replace(/\.d\.ts$/,""),r=t+".uvue";if(D(r))return r+".ts";const i=t+".vue";if(D(i))return i+".ts"}else if(e.endsWith(".json")&&D(e))return e+".ts"},componentPublicInstancePropertyAccessFallback:function(e,t,r,i,n,s){if(!e.isPropertyAccessExpression(r)||!e.isExpression(i)||!e.isIdentifier(s))return;const o=n.aliasSymbol?.escapedName.toString();if("ComponentPublicInstance"!==o&&"CreateComponentPublicInstance"!==o)return;const a=s.escapedText.toString(),c=globalThis?.__utsUniXGlobalProperties__;if(c&&c.has(a)){const{initializerNode:r}=c.get(a),i=t.getTypeAtLocation(r);return i.isNumberLiteral()?t.getNumberType():i.isStringLiteral()?t.getStringType():i.flags&e.TypeFlags.BooleanLiteral?t.getBooleanType():i}},isRequireIOSNativeUtsSdk:function(e,t){if(!process.env.UNI_INPUT_DIR)return!1;if("app-ios"!==process.env.UNI_UTS_PLATFORM&&"app-harmony"!==process.env.UNI_UTS_PLATFORM)return!1;let r=t;if(t.startsWith("@/"))r=_.resolve(process.env.UNI_INPUT_DIR,t.slice(2));else if(t.startsWith("."))r=_.resolve(_.dirname(e),t);else if(!_.isAbsolute(t))return!1;const i=_.relative(qe,r).replace(/\\/g,"/");if(i.startsWith(".")||i.indexOf("/")>-1)return!1;if("app-ios"===process.env.UNI_UTS_PLATFORM){if(D(_.resolve(qe,i,"utssdk"))&&!D(_.resolve(qe,i,"utssdk/app-js")))return!0}else if("app-harmony"===process.env.UNI_UTS_PLATFORM&&D(_.resolve(qe,i,"utssdk"))&&D(_.resolve(qe,i,"utssdk","app-harmony"))&&!D(_.resolve(qe,i,"utssdk/app-js")))return!0;return!1},isUtsCompiler:!0,hijackAnyNullUnionType:!0,hijackTsLibResolve:!0,hijackDestructuring:!0,ignoreInstanceofLeftType:!0,ignoreInstanceofRightType:!0,useTypeAndInterfaceAsValue:!0,ignoreAllDebugFail:!0};function et(e=!1){const t=[oe,ne,V,me,Z,de,Ve,ke,G,B,J,z,Re,Je,$e,q,he,ce];return e&&t.push(Oe),t}const tt=n.normalizePath(_.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),rt=new RegExp("^"+tt+"/([a-zA-Z0-9_-]+)/"),it=/\.(u)?vue(.ts)?/;let nt;const st=new Set;function ot(e){return it.test(e)}function at(e,t){if(nt=e,!nt.sys.__rewrited){const{fileExists:e,readFile:r,realpath:i}=nt.sys;nt.sys.realpath=e=>{const t=i?i(e):e;return t.endsWith(".ts")&&st.has(n.normalizePath(e))?e.replace(".ts",".uts"):t},nt.sys.fileExists=t=>{const r=n.normalizePath(t),i=r.match(rt),s=i?i[1]:"";return(!s||!e(_.resolve(tt,s,"encrypt")))&&(r.endsWith(".ts")&&e(r.replace(".ts",".uts"))?(st.add(r),!0):!(!r.endsWith(".vue.ts")&&!r.endsWith(".uvue.ts")||!e(r.replace(/.ts$/,"")))||(!(!r.endsWith(".json.ts")||!e(r.replace(/.ts$/,"")))||e(t)))},nt.sys.readFile=(i,s)=>{if(i.endsWith(".ts")&&st.has(n.normalizePath(i))){const e=i.replace(".ts",".uts"),n=r(e,s);if(null==n)return;return function(e,t){return t.uniCliShared.preUVueJs(t.uniCliShared.preUVueJs(e))}(n,t)}if(i.endsWith(".json.ts")){const o=i.replace(/.ts$/,"");if(e(o)){const e=r(o,s);if(null==e)return;return function(e,t){const r=t.uniCliShared.parseJson(e,!0);return n.dataToEsm(r,{preferConst:!0,compact:!0})}(e,t)}}if(i.endsWith(".vue.ts")||i.endsWith(".uvue.ts")){const n=i.replace(/.ts$/,"");if(e(n)){const e=r(n,s);if(null==e)return;return function(e,t){e=t.uniCliShared.preUVueJs(t.uniCliShared.preUVueHtml(e));const r=t.vueCompilerDom.parse(e).children.find((e=>"script"===e.tag)),i="export default {}";return r?r.props.some((e=>"setup"===e.name))?"// @uts-setup\n"+(r?.children[0]?.content||"")+"\n"+i:r?.children[0]?.content||i:i}(e,t)}}let o=r(i,s);if(null==o)return;i.endsWith("runtime-dom/dist/runtime-dom.d.ts")&&(o=o.replace("runtimeDOMBailTypes: Node | Window;",""));const a=globalThis?.__utsHacker__?.replaceVueTypes;return a?a(i,o):o},nt.sys.__rewrited=!0}}const ct=new class{constructor(){this.getCanonicalFileName=_.normalize,this.getNewLine=()=>nt.sys.newLine}getCurrentDirectory(){return nt.sys.getCurrentDirectory()}};function lt(e,t,r){const i={flatMessage:nt.flattenDiagnosticMessageText(t.messageText,ct.getNewLine()),formatted:nt.formatDiagnosticsWithColorAndContext([t],ct),category:t.category,code:t.code,type:e};if(t.file&&void 0!==t.start){let{line:e,character:s}=t.file.getLineAndCharacterOfPosition(t.start);if(r){const o=r.originalPositionFor({line:e+1,column:s,bias:p.SourceMapConsumer.LEAST_UPPER_BOUND});if(null!==o.line){if(o.source){const a=r.sourceContentFor(o.source);if(a){const{line:c,character:l}=t.file.getLineAndCharacterOfPosition(t.start+(t.length||0)),p=r.originalPositionFor({line:c+1,column:l});if(null!==p.line){const r=d.codeFrameColumns(a,{start:{line:o.line,column:(o.column||0)+1},end:{line:p.line,column:(p.column||0)+1}});i.rollupError=function(e,t,r,i,n){const s={id:e,message:t,frame:n,loc:{file:e,line:r,column:i}};return s}(t.file.fileName,i.flatMessage,e+1,s+1,r),i.finalRollupError=function(e,t,r,i,n){const s=new Error(t);return Object.assign(s,{message:t,frame:n,loc:{file:e,line:r,column:i}}),Object.defineProperty(s,"id",{get:()=>e,set(e){}}),s}(t.file.fileName,i.flatMessage,o.line,o.column||0,r),i.utsCompilerError={type:"UTSCompilerError",file:n.normalizePath(_.relative(process.env.UNI_INPUT_DIR,t.file.fileName.split("?")[0])),line:o.line,column:o.column||0,message:i.flatMessage,frame:r}}}}e=o.line}}i.fileLine=`${t.file.fileName}(${e+1},${s+1})`}return i}function pt(e,t,r){return t.map((t=>lt(e,t,r)))}function dt(e,t,r=!0){t.forEach((t=>{let i,n,o;switch(t.category){case nt.DiagnosticCategory.Message:i=e.info,n=s.white,o="";break;case nt.DiagnosticCategory.Error:i=e.error,n=s.red,o="error";break;case nt.DiagnosticCategory.Warning:default:i=e.warn,n=s.yellow,o="warning"}const a=t.type+" ";return r?t.utsCompilerError?i.call(e,t.utsCompilerError):t.rollupError?i.call(e,t.rollupError):i.call(e,`${s.enabled?t.formatted:function(e){if("string"!=typeof e)throw new TypeError(`Expected a \`string\`, got \`${typeof e}\``);return e.replace(ut,"")}(t.formatted)}`):void 0!==t.fileLine?i.call(e,`${t.fileLine}: ${a}${o} TS${t.code}: ${n(t.flatMessage)}`):i.call(e,`${a}${o} TS${t.code}: ${n(t.flatMessage)}`)}))}const ut=function({onlyFirst:e=!1}={}){const t=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(t,e?void 0:"g")}();var ft;function mt(e){return"string"==typeof e?e:e()}!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Debug=3]="Debug"}(ft||(ft={}));class yt{constructor(e,t,r,i=""){this.verbosity=e,this.bail=t,this.context=r,this.prefix=i}warn(e){this.verbosity<ft.Warning||this.context.warn(`${mt(e)}`)}error(e){this.verbosity<ft.Error||(this.bail?"string"==typeof e||"function"==typeof e?this.context.error(`${mt(e)}`):this.context.error(e):"UTSCompilerError"===e.type?(console.warn(`warning: ${e.message}`),console.warn(`at ${e.file}:${e.line}:${e.column}`),console.log(e.frame)):"string"==typeof e||"function"==typeof e?this.context.warn(`${mt(e)}`):this.context.warn(e))}info(e){this.verbosity<ft.Info||console.log(`${this.prefix}${mt(e)}`)}debug(e){this.verbosity<ft.Debug||console.log(`${this.prefix}${mt(e)}`)}}function ht({useTsconfigDeclarationDir:e,cacheRoot:t},r){const i={noEmitHelpers:!1,importHelpers:!0,noResolve:!1,noEmit:!1,noEmitOnError:!1,inlineSourceMap:!1,outDir:n.normalizePath(`${t}/placeholder`),allowNonTsExtensions:!0};if(!r)return i;r.options.moduleResolution===nt.ModuleResolutionKind.Classic&&(i.moduleResolution=nt.ModuleResolutionKind.Node10),void 0===r.options.module&&(i.module=nt.ModuleKind.ES2015),e||(i.declarationDir=void 0);return r.options.sourceMap||(i.sourceRoot=void 0),i}function gt(e,t){const r=[];return t.forEach((t=>{e instanceof Array?e.forEach((e=>r.push(n.normalizePath(_.join(t,e))))):r.push(n.normalizePath(_.join(t,e)))})),r}class _t{constructor(e,t,r){this.parsedConfig=e,this.transformers=t,this.cwd=r,this.snapshots={},this.versions={},this.customParser={},this.getScriptFileNames=()=>Array.from(this.fileNames.values()),this.getCompilationSettings=()=>this.parsedConfig.options,this.getTypeRootsVersion=()=>0,this.getCurrentDirectory=()=>this.cwd,this.useCaseSensitiveFileNames=()=>nt.sys.useCaseSensitiveFileNames,this.getDefaultLibFileName=nt.getDefaultLibFilePath,this.readDirectory=nt.sys.readDirectory,this.readFile=nt.sys.readFile,this.fileExists=nt.sys.fileExists,this.directoryExists=nt.sys.directoryExists,this.getDirectories=nt.sys.getDirectories,this.realpath=nt.sys.realpath,this.trace=console.log,this.fileNames=new Set(e.fileNames)}reset(){this.snapshots={},this.versions={}}setLanguageService(e){e.shouldTransform=e=>!!e&&(function(e){return ot(e)||e.includes(".uts")||st.has(n.normalizePath(e))}(e)||e.endsWith(".json.ts")||e.endsWith(".d.ts")),e.isVueFile=ot,this.service=e,this.customTransformers||this.initTransformers(this.transformers||[])}setSnapshot(e,t){(e=n.normalizePath(e)).endsWith(".uts")&&this.setSnapshot(e.replace(/\.uts$/,".ts"),t);const r=nt.ScriptSnapshot.fromString(t);return this.snapshots[e]=r,this.versions[e]=(this.versions[e]||0)+1,this.fileNames.add(e),r}getScriptSnapshot(e){if((e=n.normalizePath(e))in this.snapshots)return this.snapshots[e];const t=nt.sys.readFile(e);return null!=t?this.setSnapshot(e,t):void 0}getScriptVersion(e){return e=n.normalizePath(e),(this.versions[e]||0).toString()}initTransformers(e){if(void 0===this.service||void 0===e||0===this.transformers.length)return;const t={before:[],after:[],afterDeclarations:[]};for(const r of e){const e=r(this.service);e.parser&&(this.customParser=e.parser),e.before&&(t.before=t.before.concat(e.before)),e.after&&(t.after=t.after.concat(e.after)),e.afterDeclarations&&(t.afterDeclarations=t.afterDeclarations.concat(e.afterDeclarations))}return this.customTransformers=t,globalThis.__utsParser__=this.customParser,t}getCustomTransformers(){return this.customTransformers}setCompilerHost(e){}}class xt{constructor(e){this.cacheRoot=e,this.rolled=!1,this.oldCacheRoot=`${this.cacheRoot}/cache`,this.newCacheRoot=`${this.cacheRoot}/cache_`,u.emptyDirSync(this.newCacheRoot)}exists(t){return!this.rolled&&(!!e.existsSync(`${this.newCacheRoot}/${t}`)||e.existsSync(`${this.oldCacheRoot}/${t}`))}path(e){return`${this.oldCacheRoot}/${e}`}match(t){return!this.rolled&&(e.existsSync(this.oldCacheRoot)?x.isEqual(e.readdirSync(this.oldCacheRoot).sort(),t.sort()):0===t.length)}read(t){return e.existsSync(`${this.newCacheRoot}/${t}`)?u.readJsonSync(`${this.newCacheRoot}/${t}`,{encoding:"utf8",throws:!1}):u.readJsonSync(`${this.oldCacheRoot}/${t}`,{encoding:"utf8",throws:!1})}write(e,t){this.rolled||void 0!==t&&u.writeJsonSync(`${this.newCacheRoot}/${e}`,t)}touch(e){this.rolled||u.ensureFileSync(`${this.newCacheRoot}/${e}`)}roll(){this.rolled||(this.rolled=!0,u.removeSync(this.oldCacheRoot),e.existsSync(this.newCacheRoot)&&e.renameSync(this.newCacheRoot,this.oldCacheRoot))}}function Tt(e,t,r){const i={code:"",references:t,utsMeta:r};return e.outputFiles.forEach((e=>{e.name.endsWith(".d.ts")?i.dts=e:e.name.endsWith(".d.ts.map")?i.dtsmap=e:e.name.endsWith(".map")?i.map=e.text:i.code=e.text})),i}class St{constructor(e,t,r,i,n,s,o,a){if(this.noCache=e,this.host=i,this.cacheRoot=n,this.options=s,this.context=a,this.cacheVersion="9",this.cachePrefix="uts_",this.ambientTypesDirty=!1,this.hashOptions={algorithm:"sha1",ignoreUnknown:!1},this.dependencyTree=new f.Graph({directed:!0}),this.dependencyTree.setDefaultNodeLabel((()=>({dirty:!1}))),t&&this.clean(),e)return;this.hashOptions.ignoreUnknown=r,this.cacheDir=`${this.cacheRoot}/${this.cachePrefix}${m({version:this.cacheVersion,rootFilenames:o,options:this.options,tsVersion:nt.version},this.hashOptions)}`,this.init();const c=nt.getAutomaticTypeDirectiveNames(s,nt.sys).map((e=>nt.resolveTypeReferenceDirective(e,void 0,s,nt.sys))).filter((e=>e.resolvedTypeReferenceDirective?.resolvedFileName)).map((e=>e.resolvedTypeReferenceDirective.resolvedFileName));this.ambientTypes=o.filter((e=>e.endsWith(".d.ts"))).concat(c).map((e=>({id:e,snapshot:this.host.getScriptSnapshot(e)}))),this.checkAmbientTypes()}clean(){if(!T.pathExistsSync(this.cacheRoot))return;T.readdirSync(this.cacheRoot).forEach((e=>{const t=`${this.cacheRoot}/${e}`;e.startsWith(this.cachePrefix)?T.statSync(t).isDirectory?(this.context.info(s.blue(`cleaning cache: ${t}`)),T.removeSync(`${t}`)):this.context.debug(`skipping cleaning '${t}' as it is not a directory`):this.context.debug(`skipping cleaning '${t}' as it does not have prefix '${this.cachePrefix}'`)}))}setDependency(e,t){this.context.debug(`${s.blue("dependency")} '${e}'`),this.context.debug(`    imported by '${t}'`),this.dependencyTree.setEdge(t,e)}walkTree(e){if(f.alg.isAcyclic(this.dependencyTree))return f.alg.topsort(this.dependencyTree).forEach((t=>e(t)));this.context.info(s.yellow("import tree has cycles")),this.dependencyTree.nodes().forEach((t=>e(t)))}done(){this.noCache||(this.context.info(s.blue("rolling caches")),this.codeCache.roll(),this.semanticDiagnosticsCache.roll(),this.syntacticDiagnosticsCache.roll(),this.typesCache.roll())}getCompiled(e,t,r){return this.context.info(`${s.blue("transpiling")} '${e}'`),this.getCached(this.codeCache,e,t,Boolean(!this.options.isolatedModules||this.options.declaration),r)}getSyntacticDiagnostics(e,t,r,i){return this.getDiagnostics("syntax",this.syntacticDiagnosticsCache,e,t,r,i)}getSemanticDiagnostics(e,t,r,i){return this.getDiagnostics("semantic",this.semanticDiagnosticsCache,e,t,r,i)}checkAmbientTypes(){this.context.debug(s.blue("Ambient types:"));const e=this.ambientTypes.filter((e=>void 0!==e.snapshot)).map((e=>(this.context.debug(`    ${e.id}`),this.createHash(e.id,e.snapshot))));this.ambientTypesDirty=!this.typesCache.match(e),this.ambientTypesDirty&&this.context.info(s.yellow("ambient types changed, redoing all semantic diagnostics")),e.forEach(this.typesCache.touch,this.typesCache)}getDiagnostics(e,t,r,i,n,s){return this.getCached(t,r,i,"semantic"===e,(()=>pt(e,n(),s)))}getCached(e,t,r,i,n){if(this.noCache)return n();const o=this.createHash(t,r);if(this.context.debug(`    cache: '${e.path(o)}'`),e.exists(o)&&!this.isDirty(t,i)){this.context.debug(s.green("    cache hit"));const t=e.read(o);if(t)return e.write(o,t),t;this.context.warn(s.yellow("    cache broken, discarding"))}this.context.debug(s.yellow("    cache miss"));const a=n();return e.write(o,a),this.markAsDirty(t),a}init(){this.codeCache=new xt(`${this.cacheDir}/code`),this.typesCache=new xt(`${this.cacheDir}/types`),this.syntacticDiagnosticsCache=new xt(`${this.cacheDir}/syntacticDiagnostics`),this.semanticDiagnosticsCache=new xt(`${this.cacheDir}/semanticDiagnostics`)}markAsDirty(e){this.dependencyTree.setNode(e,{dirty:!0})}isDirty(e,t){const r=this.dependencyTree.node(e);if(!r)return!1;if(!t||r.dirty)return r.dirty;if(this.ambientTypesDirty)return!0;const i=f.alg.dijkstra(this.dependencyTree,e);return Object.keys(i).some((e=>{const t=i[e];if(!e||t.distance===1/0)return!1;const r=this.dependencyTree.node(e),n=void 0===r||r.dirty;return n&&this.context.debug(`    import changed: ${e}`),n}))}createHash(e,t){const r=t.getText(0,t.getLength());return m({data:r,id:e,compilerVersion:process.env.HX_Version||process.env.UNI_COMPILER_VERSION},this.hashOptions)}}const vt="tslib",bt="\0tslib.js",Et=">=5.0.0",Nt=">=3.0.0";class Ct extends o.EventEmitter{constructor(){super(),this._codeMap=new Map,this._easycomUsage=new Map,this._easycoms=[]}has(e){return this._codeMap.has(n.normalizePath(e))}set(e,t){const r=n.normalizePath(e);this.get(r)!==t&&(this._codeMap.set(e,t),this.emit("change",{fileName:r,source:t}))}get(e){return this._codeMap.get(n.normalizePath(e))}forEach(e){this._codeMap.forEach(e)}initUts2jsEasycom(e=this._easycoms){this._easycoms=e||[],this.set("/__uts2js_vfs__/shim-uni-easycom.d.ts",function(e){let t="",r="";return e.forEach(((e,i)=>{const n=c.kebabCase(i).replace(e.pattern,e.replacement);t+=`import ${i} from '${n}'\n`,r+=`  type ${i}ComponentPublicInstance = InstanceType<typeof ${i}>\n`})),`${t}\ndeclare global {\n${r}\n}`}(function(e,t){const r=new Map;return t.forEach(((t,i)=>{const n=c.kebabCase(i),s=e.find((e=>e.pattern.test(n)||c.upperFirst(c.camelCase(e.name))===i));s&&r.set(i,s)})),r}(this._easycoms,this._easycomUsage)))}setEasycomUsage(e,t=[]){e=n.normalizePath(e),this._easycomUsage.forEach(((r,i)=>{t.includes(i)||(r.delete(e),0===r.size&&this._easycomUsage.delete(i))}));for(let r=0;r<t.length;r++){const i=t[r];this._easycomUsage.has(i)?this._easycomUsage.get(i)?.add(e):this._easycomUsage.set(i,new Set([e]))}this.initUts2jsEasycom()}}const Dt=e=>{let r,i,o,c,d,u,f,m,y,h,g=!1,_=!1,T=0,S=!0;const v={},b=new Set,E=(e,t,r,i)=>{if(!t)return;e=n.normalizePath(e),b.add(e);const s=((e,t,r)=>y.getSyntacticDiagnostics(e,t,(()=>f.getSyntacticDiagnostics(e)),r).concat(y.getSemanticDiagnostics(e,t,(()=>f.getSemanticDiagnostics(e)),r)))(e,t,i);dt(r,s,!1!==c.options.pretty),s.length>0&&(S=!1)},N=(e,t)=>{if(!t.dts)return;const r=n.normalizePath(e);v[r]={type:t.dts,map:t.dtsmap},i.debug((()=>`${s.blue("generated declarations")} for '${r}'`))},D=e=>!(e.endsWith(".d.ts")||e.endsWith(".d.cts")||e.endsWith(".d.mts"))&&!!o(e),I=()=>{g||S||i.info(s.yellow("there were errors or warnings.")),y?.done()},A=Object.assign({},{check:!0,verbosity:ft.Warning,clean:!1,cacheRoot:a({name:"rollup-plugin-uts"}),include:["*.(|u)ts+(|x)","**/*.(|u)ts+(|x)","**/*.cts","**/*.mts"],exclude:["*.d.ts","**/*.d.ts","**/*.d.cts","**/*.d.mts"],abortOnError:!1,rollupCommonJSResolveHack:!1,tsconfig:void 0,useTsconfigDeclarationDir:!1,tsconfigOverride:{},transformers:[],tsconfigDefaults:{},objectHashIgnoreUnknownHack:!1,cwd:process.cwd()},e);A.typescript||(A.typescript=require("typescript")),at(A.typescript,e.modules),globalThis.uts2jsSourceCodeMap=new Ct;const P={name:"uts",options:e=>(r={...e},e),configureServer(e){e.watcher.addListener("all",((e,t)=>{if("add"===e||"unlink"===e){const e=n.normalizePath(t);C.has(e)&&C.delete(e)}}))},buildStart(){m=nt.createDocumentRegistry(),i=new yt(A.verbosity,A.abortOnError,this,"uts: "),g="true"===process.env.ROLLUP_WATCH||!!this.meta.watchMode,({parsedTsConfig:c,fileName:d}=function(e,r){const i=nt.findConfigFile(r.cwd,nt.sys.fileExists,r.tsconfig);void 0===r.tsconfig||i||e.error(`failed to open '${r.tsconfig}'`);let n,s={},o=r.cwd,a=!0;if(i){const r=nt.sys.readFile(i),c=nt.parseConfigFileTextToJson(i,r);a=c.config?.pretty??a,void 0!==c.error&&(dt(e,pt("config",[c.error]),a),e.error(`failed to parse '${i}'`)),s=c.config,o=t.dirname(i),n=i}const c={};x.merge(c,r.tsconfigDefaults,s,r.tsconfigOverride);const l=nt.parseJsonConfigFileContent(c,nt.sys,o,ht(r),n),p=ht(r,l),d=nt.parseJsonConfigFileContent(c,nt.sys,o,p,n),u=d.options.module;return u!==nt.ModuleKind.ES2015&&u!==nt.ModuleKind.ES2020&&u!==nt.ModuleKind.ES2022&&u!==nt.ModuleKind.ESNext&&e.error(`Incompatible tsconfig option. Module resolves to '${nt.ModuleKind[u]}'. This is incompatible with Rollup, please use 'module: "ES2015"', 'module: "ES2020"', 'module: "ES2022"', or 'module: "ESNext"'.`),dt(e,pt("config",d.errors),a),e.debug(`built-in options overrides: ${JSON.stringify(p,void 0,4)}`),e.debug(`parsed tsconfig: ${JSON.stringify(d,void 0,4)}`),{parsedTsConfig:d,fileName:i}}(i,A)),i.info(`typescript version: ${nt.version}`),i.info(`tslib version: ${A.utsOptions.tslibVersion}`),i.info(`rollup version: ${this.meta.rollupVersion}`),l.satisfies(nt.version,Et,{includePrerelease:!0})||i.error(`Installed TypeScript version '${nt.version}' is outside of supported range '${Et}'`),l.satisfies(this.meta.rollupVersion,Nt,{includePrerelease:!0})||i.error(`Installed Rollup version '${this.meta.rollupVersion}' is outside of supported range '${Nt}'`),_=l.satisfies(this.meta.rollupVersion,">=2.60.0",{includePrerelease:!0}),_||i.warn((()=>`${s.yellow("You are using a Rollup version '<2.60.0'")}. This may result in type-only files being ignored.`)),i.info("rollup-plugin-uts version: 1.0.0"),i.debug((()=>`plugin options:\n${JSON.stringify(A,((e,t)=>"typescript"===e?`version ${t.version}`:t),4)}`)),i.debug((()=>`rollup config:\n${JSON.stringify(r,void 0,4)}`)),i.debug((()=>`tsconfig path: ${d}`)),A.objectHashIgnoreUnknownHack&&i.warn((()=>`${s.yellow("You are using 'objectHashIgnoreUnknownHack' option")}. If you enabled it because of async functions, try disabling it now.`)),A.rollupCommonJSResolveHack&&i.warn((()=>`${s.yellow("You are using 'rollupCommonJSResolveHack' option")}. This is no longer needed, try disabling it now.`)),g&&i.info("running in watch mode"),o=function(e,t,r){let i=t.include,s=t.exclude;return r.options.rootDirs&&(i=gt(i,r.options.rootDirs),s=gt(s,r.options.rootDirs)),r.projectReferences&&(i=gt(i,r.projectReferences.map((e=>e.path))).concat(i),s=gt(s,r.projectReferences.map((e=>e.path))).concat(s)),e.debug((()=>`included:\n${JSON.stringify(i,void 0,4)}`)),e.debug((()=>`excluded:\n${JSON.stringify(s,void 0,4)}`)),n.createFilter(i,s,{resolve:r.options.rootDir})}(i,A,c),u=new _t(c,A.transformers,A.cwd),globalThis.uts2jsSourceCodeMap.forEach(((e,t)=>{u.setSnapshot(t,e)})),u.setSnapshot(vt,A.utsOptions.tslibSource),globalThis.uts2jsSourceCodeMap.on("change",(function(e){const{fileName:t,source:r}=e||{};u.setSnapshot(t,r)})),f=nt.createLanguageService(u,m),u.setLanguageService(f);const e=A.clean,a=A.noCache||A.clean;if(y=new St(a,e,A.objectHashIgnoreUnknownHack,u,A.cacheRoot,c.options,c.fileNames,i),h=new Set,A.check){const e=pt("options",f.getCompilerOptionsDiagnostics());dt(i,e,!1!==c.options.pretty),e.length>0&&(S=!1)}},watchChange(e,t){const r=n.normalizePath(e);if(delete v[r],b.delete(r),"web"===process.env.UNI_UTS_PLATFORM)return;const{event:i}=t||{};"create"!==i&&"delete"!==i||C.has(r)&&C.delete(r)},resolveId(e,r){if(e===vt)return bt;if(!r)return;r=n.normalizePath(r);const o=nt.nodeModuleNameResolver(e,r,c.options,nt.sys);let a=o.resolvedModule?.resolvedFileName;if(a){if(st.has(n.normalizePath(a))&&(a=a.replace(".ts",".uts")),/.u?vue.ts$/.test(a))return a=a.replace(/.ts$/,""),t.normalize(a);if(D(a))return y.setDependency(a,r),i.debug((()=>`${s.blue("resolving")} '${e}' imported by '${r}'`)),i.debug((()=>`    to '${a}'`)),t.normalize(a)}},load:e=>e===bt?A.utsOptions.tslibSource:null,async transform(r,a){h.add(a);const l=r.matchAll(/([a-zA-Z0-9]+)ComponentPublicInstance/g),m=[];for(const e of l)m.push(e[1]);m.length>0&&globalThis.uts2jsSourceCodeMap.setEasycomUsage(n.normalizePath(a),m);let T=a;const v=T.endsWith(".json"),b=/\/locale\/.*\.json$/.test(T);if(v&&(T=T.replace(/.json$/,".uts")),!o(T)||b)return;const C=u.setSnapshot(T,r),I=y.getCompiled(T,C,(()=>{let r;const o=f.getProgram()?.getSourceFile(T);if("uts"===A.utsOptions.emitType){const e=[];if(o){const r=nt.createPrinter({}).printSourceFile(o,{host:ct,map:{file:n.normalizePath(t.relative(A.utsOptions.inputDir??"",a)),sourceRoot:"",sourcesDirectoryPath:A.utsOptions.inputDir??""}});r.code&&e.push({name:"",writeByteOrderMark:!1,text:r.code}),r.map&&e.push({name:".map",writeByteOrderMark:!1,text:r.map})}else this.error(new Error(`Could not find source file: '${a}'.`));r={outputFiles:e,emitSkipped:!1}}else try{r=f.getEmitOutput(T)}catch(e){if(e instanceof Error&&e.diagnostic){const t=pt("transform",[e.diagnostic],new p.SourceMapConsumer(this.getCombinedSourcemap())),r="web"===A.utsOptions.platform?"rollupError":"finalRollupError";t[0][r]&&this.error(t[0][r])}throw e}r.emitSkipped&&(S=!1,E(T,C,i,e?.abortOnError?void 0:new p.SourceMapConsumer(this.getCombinedSourcemap())),this.error(s.red(`Emit skipped for '${a}'. See https://github.com/microsoft/TypeScript/issues/49790 for potential reasons why this may occur`)));const l=function(e,t,r){if(!t)return[];const i=nt.preProcessFile(t.getText(0,t.getLength()),!0,!0);return x.compact(i.referencedFiles.concat(i.importedFiles).map((t=>{const i=nt.nodeModuleNameResolver(t.fileName,e,r,nt.sys),s=i.resolvedModule?.resolvedFileName;return s&&st.has(n.normalizePath(s))&&s.endsWith(".ts")?s.replace(/.ts$/,".uts"):s})))}(T,C,c.options);return Tt(r,l,o?.__utsMeta)}));if(A.check&&E(T,C,i,new p.SourceMapConsumer(this.getCombinedSourcemap())),!I)return;if(g&&I.references&&(d&&this.addWatchFile(d),I.references.map(this.addWatchFile,this),i.debug((()=>`${s.green("    watching")}: ${I.references.join("\nuts:               ")}`))),N(a,I),I.references&&_)for(const e of I.references){if(!D(e))continue;const t=await this.resolve(e,a);t&&!h.has(t.id)&&await this.load({id:t.id})}if(c.options.emitDeclarationOnly)return void i.debug((()=>`${s.blue("emitDeclarationOnly")} enabled, not transforming TS`));const P={code:I.code,map:{mappings:""},meta:I.utsMeta||{uniExtApis:[]}};if(I.map){A.sourceMapCallback?.(a,I.map);const e=JSON.parse(I.map);e.sourceRoot&&(e.sources=e.sources.map((r=>t.isAbsolute(r)?r:e.sourceRoot+r))),P.map=e}return P},buildEnd(e){if(T=0,e&&(I(),this.error(e)),!A.check)return I();g&&y.walkTree((e=>{if(!o(e))return;const t=u.getScriptSnapshot(e);E(e,t,i)})),c.fileNames.forEach((e=>{const t=n.normalizePath(e);if(b.has(t)||!o(t))return;i.debug((()=>`type-checking missed '${t}'`));const r=u.getScriptSnapshot(t);E(t,r,i)})),I()},generateBundle(e){if(i.debug((()=>`generating target ${T+1}`)),T++,!c.options.declaration)return;c.fileNames.forEach((e=>{const t=n.normalizePath(e);if(t in v||!o(t))return;i.debug((()=>`generating missed declarations for '${t}'`));const r=Tt(f.getEmitOutput(t,!0));N(t,r)}));const r=(r,o,a)=>{if(!a)return;let c=a.name;if(c.includes("?")&&(c=c.split("?",1)+o),A.useTsconfigDeclarationDir)return i.debug((()=>`${s.blue("emitting declarations")} for '${r}' to '${c}'`)),void nt.sys.writeFile(c,a.text,a.writeByteOrderMark);let l=a.text;const p=`${A.cacheRoot}/placeholder`;if(".d.ts.map"===o&&(e?.file||e?.dir)){const r=e.file?t.dirname(e.file):e.dir,i=JSON.parse(l);i.sources=i.sources.map((e=>{const i=t.resolve(p,e);return n.normalizePath(t.relative(r,i))})),l=JSON.stringify(i)}const d=n.normalizePath(t.relative(p,c));i.debug((()=>`${s.blue("emitting declarations")} for '${r}' to '${d}'`)),this.emitFile({type:"asset",source:l,fileName:d})};Object.keys(v).forEach((e=>{const{type:t,map:i}=v[e];r(e,".d.ts",t),r(e,".d.ts.map",i)}))}};return P},It=y.pathToFileURL(__filename).href,At=t.dirname(y.fileURLToPath(It)),Pt=i.createRequire(It);let Ot=!1;exports.uts2js=function({inputDir:r,modules:i,...n}){Ot||(Ot=!0,globalThis.__utsHacker__={...globalThis.__utsHacker__,...Ye});const s=n.include??["**/*.uts","**/*.ts"],o=n.typescript??Pt("typescript");let a=e.readFileSync(t.resolve(At,"../lib/runtime/index.js"),"utf8");a+="\nexport {\n  UTS, UTSJSONObject, UTSValueIterable, UniError\n} from '@dcloudio/uni-shared';\n";const c={...n,modules:i||{},include:s,typescript:o,transformers:[ee(o,et(n.dom2),{platform:n.platform,targetLanguage:"JavaScript",setParentRecursive:!0,sharedDataLibName:n.sharedDataLibName,transformCreateWorker:{extname:n.workers?.extname,rewriteRootDir:n.workers?.rewriteRootDir,resolveWorkers:n.workers?.resolve||(()=>({}))}})],utsOptions:{platform:n.platform,tslibSource:a}};c.tsconfigOverride||(c.tsconfigOverride={compilerOptions:{}}),c.tsconfigOverride.compilerOptions||(c.tsconfigOverride.compilerOptions={});const l=c.tsconfigOverride.compilerOptions,p={baseUrl:r?"src"===t.basename(r)?t.dirname(r):r:".",moduleResolution:"Bundler",importHelpers:!0,mapRoot:l.sourceMap?r:void 0,target:"ES2016"};for(const e in p)l.hasOwnProperty(e)||(l[e]=p[e]);return[Dt(c)]};

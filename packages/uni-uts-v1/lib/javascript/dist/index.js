"use strict";var e=require("fs"),t=require("path"),r=require("debug"),i=require("module"),s=require("@rollup/pluginutils"),n=require("colors/safe"),o=require("events"),a=require("find-cache-dir"),c=require("lodash"),l=require("semver"),p=require("source-map-js"),u=require("@babel/code-frame"),d=require("fs-extra"),f=require("graphlib"),m=require("object-hash"),y=require("url");function h(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var g=h(e),x=h(t),_=h(c),T=h(d);function S(e){return e.factory.createIdentifier("UTS")}function v(e){return e.replace(/\\/g,"/")}const E=new Map;function b(e){const t=v(e);return E.has(t)?E.get(t):g.existsSync(t)?(E.set(t,!0),!0):(E.set(t,!1),!1)}var N;function C(e,t,r,i,s,n,o){return{code:e,category:t,key:r,message:i,reportsUnnecessary:s,elidedInCompatabilityPyramid:n,reportsDeprecated:o}}!function(e){e[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Suggestion=2]="Suggestion",e[e.Message=3]="Message"}(N||(N={}));const D={Type_literal_property_must_have_a_type_annotation:C(1e5,N.Error,"Type_literal_property_must_have_a_type_annotation_100000","Type literal property must have a type annotation."),Only_one_extends_heritage_clause_is_allowed_for_interface:C(100001,N.Error,"Only_one_extends_heritage_clause_is_allowed_for_interface_100001","Only one extends heritage clause is allowed for interface"),Variable_declaration_must_have_initializer:C(100002,N.Error,"Variable_declaration_must_have_initializer_100002","Variable declaration must have initializer."),Nested_type_literal_is_not_supported:C(100003,N.Error,"Nested_type_literal_is_not_supported_100003","Nested type literal is not supported."),Invalid_generic_type_which_can_not_be_constructed:C(100004,N.Error,"Invalid_generic_type_which_can_not_be_constructed_100004","Invalid generic type which can not be constructed."),script_setup_cannot_contain_ES_module_exports:C(100005,N.Error,"script_setup_cannot_contain_ES_module_exports_100005","`<script setup>` cannot contain ES module exports."),Type_aliases_cannot_appear_in_local_scope:C(100006,N.Error,"Type_aliases_cannot_appear_in_local_scope_100006","Type aliases cannot appear in local scope"),direct_declaration_of_Object_Literal_Type_is_not_supported:C(110111101,N.Error,"direct_declaration_of_Object_Literal_Type_is_not_supported_110111101","direct declaration of Object Literal Type is not supported."),Object_literals_only_support_object_types_defined_by_construction_type_and_do_not_support_interfaces:C(110111163,N.Error,"Object_literals_only_support_object_types_defined_by_construction_type_and_do_not_support_interfaces_110111163","Object literals only support object types defined by construction type, and do not support interfaces"),Conditional_statements_must_use_boolean_types:C(110111120,N.Error,"Conditional_statements_must_use_boolean_types_110111120","Conditional statements must use boolean types"),Class_cannot_be_used_as_a_value:C(110111164,N.Error,"Class_cannot_be_used_as_a_value_110111164","Class cannot be used as a value"),Methods_to_modify_objects_are_not_supported:C(110111134,N.Error,"Methods_to_modify_objects_are_not_supported_110111134","Methods to modify objects are not supported"),Undefined_is_not_supported:C(110111119,N.Error,"Undefined_is_not_supported_110111119","Undefined is not supported"),Private_fields_starting_with_are_not_supported:C(110111128,N.Error,"Private_fields_starting_with_are_not_supported_110111128","Private fields starting with #are not supported"),Property_methods_for_type_class_or_interface_do_not_support_defining_generic_information:C(110111161,N.Error,"Property_methods_for_type_class_or_interface_do_not_support_defining_generic_information_110111161","Property methods for type, class, or interface do not support defining generic information"),Declaring_properties_on_functions_is_not_supported:C(110111138,N.Error,"Declaring_properties_on_functions_is_not_supported_110111138","Declaring properties on functions is not supported"),Type_protection_using_instanceof_and_as:C(110111143,N.Error,"Type_protection_using_instanceof_and_as_110111143","Type protection using instanceof and as"),Generator_functions_are_not_supported:C(110111146,N.Error,"Generator_functions_are_not_supported_110111146","Generator functions are not supported"),Delete_operator_is_not_supported:C(110111149,N.Error,"Delete_operator_is_not_supported_110111149","Delete operator is not supported")},I=v(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),P=["defineComponent","defineVaporComponent","defineApp","defineAsyncComponent","defineMixin"];function A(e){return P.some((t=>e===t||e==="_"+t))}function O(e,r,i){function s(e){return e?.constraintType?.origin?.type||e}function n(e){if(!e)return!1;const t=r.getNullType();return r.isTypeAssignableTo(t,e)}function o(t){return!!(t&&e.isUnionTypeNode(t)&&t.types.some((t=>e.isLiteralTypeNode(t)&&t.literal.kind===e.SyntaxKind.NullKeyword)))}function a(t){if(!t||!e.isCallExpression(t))return!1;const r=t.expression;return!!(r&&e.isIdentifier(r)&&A(r.escapedText.toString()))}function c(e){const t=e?.parent?.parent?.parent;return t&&a(t)}return{ts:e,typeChecker:r,context:i,isImportedSymbol:function(t){return!(!t.declarations||!t.declarations.some((t=>e.isImportSpecifier(t)||e.isImportClause(t)&&t.name)))},isPossibleUTSJSONObjectType:function(e,t=!1){return e?e.isUnion()&&e.types.some((e=>"UTSJSONObject"===s(e).symbol?.escapedName))||"UTSJSONObject"===s(e).symbol?.escapedName:!t},isPossibleNullType:n,isPossiblePromiseNullType:function(e){return!!e&&n(r.getPromisedTypeOfPromise(e))},createTypeNodeWithNullType:function(t,r){const s=i.factory,n=o(t);let a=t;return r&&!n&&(a=e.isUnionTypeNode(t)?s.createUnionTypeNode([...t.types,s.createLiteralTypeNode(s.createNull())]):s.createUnionTypeNode([t,s.createLiteralTypeNode(s.createNull())])),a},isUnionWithNullType:o,isObjectLiteralType:function(t){if(!t)return!1;if("__object"===t.symbol?.escapedName)return!0;const r=t?.objectFlags;if(r&&(r&e.ObjectFlags.ObjectLiteral||r&e.ObjectFlags.FreshLiteral))return!0;const i=t.getSymbol();return!!(i&&i.flags&e.SymbolFlags.ObjectLiteral)},getMethodNameNodeOfObjectLiteral:function(t){if(e.isMethodDeclaration(t))return t.name;const r=t.parent;if(!e.isPropertyAssignment(r))return;const i=r.name;return e.isIdentifier(i)?i:void 0},shouldTransfromToUTSJSONObject:function e(t,i){if(!i||i===r.getAnyType())return!0;if(i.isUnion())return i.types.some((r=>e(t,r)));if(i.isIntersection())return i.types.every((e=>r.isTypeAssignableTo(r.getGlobalType("UTSJSONObject",0,!0),i)));const s=i.getSymbol()||i.aliasSymbol;return!(!s&&!i.isClassOrInterface())&&(!s||"__object"===s?.escapedName||"UTSJSONObject"===s?.escapedName||r.isTypeAssignableTo(r.getGlobalType("UTSJSONObject",0,!0),i))},isVueOrNativeParameter:function t(i){if(!i.parent)return!1;if(e.isPropertyAssignment(i.parent)&&i.parent.parent&&e.isObjectLiteralExpression(i.parent.parent))return t(i.parent.parent);if(!e.isCallExpression(i.parent))return!1;if(-1===i.parent.expression.pos)return!0;const s=r.getTypeAtLocation(i.parent.expression);if(!s)return!1;const n=s.getCallSignatures()?.[0]?.declaration;if(!n)return!1;const o=n.getSourceFile().fileName,a=o.replace(/\\/g,"/").split("/").pop();return o.endsWith("runtime-core.d.ts")||a&&/lib\.es(\d+|next)\..*d.ts/.test(a)},isComponentDataOrProvide:function(t){const r=t.parent;if(!r||!e.isReturnStatement(r))return!1;const i=r?.parent?.parent;if(!i||!e.isMethodDeclaration(i))return!1;const s=i.name;if(!s||!e.isIdentifier(s)||"data"!==s.escapedText.toString()&&"provide"!==s.escapedText.toString())return!1;const n=i?.parent?.parent;return a(n)},isComponentOptions:function(e){const t=e?.parent;return t&&a(t)},isComponentOptionsProperty:c,isComponentProp:function(t){const r=t.parent?.parent,i=r?.parent;return r&&i&&e.isObjectLiteralExpression(r)&&e.isPropertyAssignment(i)&&e.isIdentifier(i.name)&&"props"===i.name.escapedText.toString()&&c(r)},isCreateAppReturnValue:function(r){if(process.env.UNI_INPUT_DIR&&v(t.resolve(process.env.UNI_INPUT_DIR,"main.uts"))===v(r.getSourceFile().fileName)&&r.parent&&e.isReturnStatement(r.parent)){const t=r?.parent?.parent?.parent;if(t&&e.isFunctionDeclaration(t)&&t.name&&e.isIdentifier(t.name)&&"createApp"===t.name.escapedText.toString())return!0}},isSetupReturnValue:function(t){const r=t.parent;return r&&e.isVariableDeclaration(r)&&r.name&&e.isIdentifier(r.name)&&"___returned__"===r.name.escapedText.toString()},isDefineExpose:function(t){if(!t||!e.isCallExpression(t))return!1;const r=t.expression;if(!r||!e.isIdentifier(r))return!1;const i=r.escapedText.toString();return"defineExpose"===i||"___expose"===i}}}const w=[260,169,172,171,208,219,253,229,223,213,214,170,216,234,226,303,304,305,209,227,239,217,235,238,277,294,291,293,286,285];function k(e,t){const{ts:r}=e,i=t?.declarations;if(1!==i?.length)return!1;const s=i[0];if(r.isClassDeclaration(s)){const t=s.heritageClauses?.some((t=>t.token===r.SyntaxKind.ExtendsKeyword&&t.types.some((t=>L(e,t.expression)||function(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:s}=t;return r.isIdentifier(s)&&"UTS"===s.escapedText&&r.isIdentifier(i)&&"UTSType"===i.escapedText}(e,t.expression)))));return t}return!1}function F(e,t){return t.symbol&&k(e,t.symbol)}function U(e){const t=e.context.factory,r=e.ts;return t.createPropertyAccessExpression(t.createParenthesizedExpression(t.createAsExpression(t.createIdentifier("globalThis"),t.createKeywordTypeNode(r.SyntaxKind.AnyKeyword))),t.createIdentifier("UTSType"))}function L(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:s}=t;return r.isIdentifier(s)&&"UTSType"===s.escapedText&&r.isParenthesizedExpression(i)&&r.isAsExpression(i.expression)&&r.isIdentifier(i.expression.expression)&&"globalThis"===i.expression.expression.escapedText}function $(e,t){const{ts:r}=e,i=e.context,s=i.factory,n=e.typeChecker,o=s.createStringLiteral("Unknown");if(e.isUnionWithNullType(t)&&2===t.types.length&&(t=t.types.find((e=>e.kind!==r.SyntaxKind.NullKeyword))),r.isTypeReferenceNode(t)){const{typeName:i,typeArguments:a}=t;if(!r.isIdentifier(i))return o;const c=n.getSymbolAtLocation(i),l=c?.declarations?.[0];return l&&function(e,t){if(!e.ts.isClassDeclaration(t))return!1;const{heritageClauses:r}=t,i=r?.[0]?.types?.[0]?.expression;return!(!i||!L(e,i))}(e,l)?a?s.createCallExpression(s.createPropertyAccessExpression(U(e),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier(i.escapedText.toString()),s.createArrayLiteralExpression([...a.map((t=>$(e,t)))],!1)]):s.createIdentifier(i.escapedText.toString()):o}if(r.isArrayTypeNode(t))return s.createCallExpression(s.createPropertyAccessExpression(U(e),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier("Array"),s.createArrayLiteralExpression([$(e,t.elementType)],!1)]);if(r.isTypeLiteralNode(t))i.addSemanticDiagnostic(r.createDiagnosticForNode(t,D.Nested_type_literal_is_not_supported));else{if(t.kind===r.SyntaxKind.NumberKeyword)return s.createIdentifier("Number");if(t.kind===r.SyntaxKind.StringKeyword)return s.createIdentifier("String");if(t.kind===r.SyntaxKind.BooleanKeyword)return s.createIdentifier("Boolean");if(t.kind===r.SyntaxKind.AnyKeyword)return s.createStringLiteral("Any")}return o}function R(e,t,r){const{ts:i}=e,s=e.context.factory;return s.createMethodDeclaration([s.createToken(i.SyntaxKind.StaticKeyword)],void 0,s.createIdentifier("get$UTSMetadata$"),void 0,void 0,t?[...t.map((e=>s.createParameterDeclaration(void 0,void 0,s.createIdentifier(e.name.escapedText.toString()),s.createToken(i.SyntaxKind.QuestionToken),s.createKeywordTypeNode(i.SyntaxKind.AnyKeyword),void 0)))]:[],void 0,s.createBlock([s.createReturnStatement(s.createAsExpression(r,s.createKeywordTypeNode(i.SyntaxKind.AnyKeyword)))],!0))}function j(e,t,r,i){const s=e.context.factory,n=[s.createPropertyAssignment(s.createIdentifier("kind"),s.createNumericLiteral(r)),s.createPropertyAssignment(s.createIdentifier("interfaces"),s.createArrayLiteralExpression(i,!1))];return"development"===process.env.NODE_ENV&&n.push(s.createPropertyAssignment(s.createIdentifier("name"),s.createStringLiteral(t))),[R(e,void 0,s.createObjectLiteralExpression(n,!0))]}globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;function M(e,t){const r=e.ts,i=e.context.factory,{modifiers:s,name:n,typeParameters:o,heritageClauses:a,members:c}=t,l=c.filter((e=>r.isPropertyDeclaration(e))),p=function(e,t,r,i,s){const n=e.context,o=e.ts,a=n.factory,c=[a.createPropertyAssignment(a.createIdentifier("kind"),a.createNumericLiteral(r)),a.createGetAccessorDeclaration(void 0,a.createIdentifier("fields"),[],void 0,a.createBlock([a.createReturnStatement(a.createObjectLiteralExpression([...i.map((t=>{let r="";(t.jsDoc||[]).forEach((e=>{(e.tags||[]).forEach((e=>{if("JSON_FIELD"===e.tagName.escapedText&&"string"==typeof e.comment){const t=e.comment.length;r="'"===e.comment[0]&&"'"===e.comment[t-1]||'"'===e.comment[0]&&'"'===e.comment[t-1]?e.comment.slice(1,-1):e.comment}}))}));const i=[a.createPropertyAssignment(a.createIdentifier("type"),$(e,t.type)),a.createPropertyAssignment(a.createIdentifier("optional"),t.questionToken||e.isUnionWithNullType(t.type)?a.createTrue():a.createFalse())];r&&i.push(a.createPropertyAssignment(a.createIdentifier("jsonField"),a.createStringLiteral(r)));let s="";const n=o.isStringLiteral(t.name)||o.isNumericLiteral(t.name);return(o.isIdentifier(t.name)||n)&&(s=t.name.text),a.createPropertyAssignment(n?a.createStringLiteral(s):a.createIdentifier(s),a.createObjectLiteralExpression(i))}))],!0))],!0))];return"development"===process.env.NODE_ENV&&c.push(a.createPropertyAssignment(a.createIdentifier("name"),a.createStringLiteral(t))),[R(e,s,a.createObjectLiteralExpression(c,!0))]}(e,n?n.escapedText.toString():"",2,l,o?[...o]:[]),u=c.find((e=>r.isIndexSignatureDeclaration(e))),d=c.find((e=>r.isConstructorDeclaration(e))),{parameters:f}=d,m=[...f,i.createParameterDeclaration(void 0,void 0,i.createIdentifier("metadata"),void 0,i.createKeywordTypeNode(r.SyntaxKind.AnyKeyword),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier(n.escapedText),i.createIdentifier("get$UTSMetadata$")),void 0,[])),i.createParameterDeclaration(void 0,void 0,i.createIdentifier("isJSONParse"),void 0,i.createKeywordTypeNode(r.SyntaxKind.BooleanKeyword),i.createFalse())],y="__props__",h=i.createConstructorDeclaration(void 0,m,i.createBlock([i.createExpressionStatement(i.createCallExpression(i.createSuper(),void 0,[])),i.createExpressionStatement(i.createBinaryExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y)),i.createToken(r.SyntaxKind.EqualsToken),i.createCallExpression(i.createPropertyAccessExpression(U(e),i.createIdentifier("initProps")),void 0,[i.createIdentifier("options"),i.createIdentifier("metadata"),i.createIdentifier("isJSONParse")]))),...l.map((e=>{const{name:t}=e;let s="";const n=r.isStringLiteral(t)||r.isNumericLiteral(t);return(r.isIdentifier(t)||n)&&(s=t.text),i.createExpressionStatement(i.createBinaryExpression(n?i.createElementAccessExpression(i.createThis(),i.createStringLiteral(s)):i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(s)),i.createToken(r.SyntaxKind.EqualsToken),n?i.createElementAccessExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y)),i.createStringLiteral(s)):i.createPropertyAccessExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y)),i.createIdentifier(s))))})),i.createExpressionStatement(i.createDeleteExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(y))))],!0));return i.updateClassDeclaration(t,s,n,o,a,[u,...l,...p,h])}function K(e,t,r,i){return s=>{const n=r(s);return r=>{const o=e.isSourceFile(r);return s.fileName||o&&(s.fileName=r.fileName),t.shouldTransform(s.fileName)?(o&&!r.isUTSFile&&(r.isUTSFile=!0,t.isVueFile?.(s.fileName)&&(r.isVueFile=!0)),o&&"parser"===i&&r.statements.length&&(r.statements[0].parent||e.setParentRecursive(r,!0)),n(r)):r}}}function W(e,t){return t&&t!==e&&!Array.isArray(t)&&(t.__parsedByUtsParser=!0,t.parent=e.parent),t}let z;function J(e,t,r){return function(e){if(!e.ObjectFlags.UTSType){const{Class:t,Interface:r,Reference:i,Anonymous:s,ArrayLiteral:n}=e.ObjectFlags;e.ObjectFlags.UTSType=t|r|i|s|n}if(!e.TypeFlags.UTSType){const{Any:t,String:r,Number:i,Boolean:s,Enum:n,StringLiteral:o,NumberLiteral:a,BooleanLiteral:c,EnumLiteral:l,Void:p,Null:u,Object:d,Union:f,TemplateLiteral:m}=e.TypeFlags;e.TypeFlags.UTSType=t|r|i|s|n|o|a|c|l|p|u|d|f|m,e.TypeFlags.UTSStringLike=r|o|m,e.TypeFlags.UTSNumberLike=i|a}}(e),i=>{const s={},n=[],o=[],a=[];return t.forEach((t=>{let c=t(e,i,r);if("function"==typeof c)n.push(K(e,i,c,"before"));else{if(c.parser){const n=t(function(e){if(z)return z;z={...e};const{visitNode:t,visitEachChild:r}=e;return z.visitNode=(e,r)=>t(e,(e=>W(e,r(e)))),z.visitEachChild=(e,t,i)=>r(e,(e=>W(e,t(e))),i),z}(e),i,r);n.parser&&function(e,t,r,i){i.TypeAliasDeclaration&&(r.TypeAliasDeclaration||(r.TypeAliasDeclaration=[])).push(K(e,t,(e=>{const t=i.TypeAliasDeclaration(e);return e=>W(e,t(e))}),"parser")),i.SourceFile&&(r.SourceFile||(r.SourceFile=[])).push(K(e,t,i.SourceFile,"parser"))}(e,i,s,n.parser)}c.before&&n.push(K(e,i,c.before,"before")),c.after&&o.push(K(e,i,c.after,"after")),c.afterDeclarations&&a.push(K(e,i,c.afterDeclarations,"afterDeclarations"))}})),{parser:s,before:n,after:o,afterDeclarations:a}}}function V(e,t){return!!t.isImportTypeNode(e)||(t.forEachChild(e,(e=>V(e,t)))||!1)}function B(e,t,r,i){const s=function(e,t){for(t=e.getOriginalNode(t);;){if(!(t=t.parent))return;switch((t=e.getOriginalNode(t)).kind){case e.SyntaxKind.SourceFile:case e.SyntaxKind.MethodDeclaration:case e.SyntaxKind.MethodSignature:case e.SyntaxKind.FunctionDeclaration:case e.SyntaxKind.FunctionExpression:case e.SyntaxKind.GetAccessor:case e.SyntaxKind.SetAccessor:case e.SyntaxKind.ClassDeclaration:case e.SyntaxKind.InterfaceDeclaration:case e.SyntaxKind.EnumDeclaration:case e.SyntaxKind.ModuleDeclaration:return t}}}(r,t);let n=i.typeToTypeNode(e,s,r.NodeBuilderFlags.None);if(!n&&s&&(n=i.typeToTypeNode(e,void 0,r.NodeBuilderFlags.None)),n)return V(n,r)?i.typeToTypeNode(e,void 0,r.NodeBuilderFlags.None):r.isTypeLiteralNode(n)?r.factory.createTypeReferenceNode(r.factory.createIdentifier("UTSJSONObject"),void 0):(r.isTypeReferenceNode(n)&&n.typeArguments&&(n=q(r,n)),n)}function q(e,t){if(e.isTypeReferenceNode(t)&&t.typeArguments){let r=!1;const i=t.typeArguments.map((t=>{if(e.isTypeLiteralNode(t))return r=!0,e.factory.createTypeReferenceNode(e.factory.createIdentifier("UTSJSONObject"),void 0);if(e.isTypeReferenceNode(t)){const i=q(e,t);return i!==t&&(r=!0),i}return t}));if(r)return e.factory.createTypeReferenceNode(t.typeName,i)}return t}globalThis.__utsHacker__={...globalThis.__utsHacker__},r("uts:transformer:importAndExportDeclaration"),r("uts:transformer:autoImport"),r("uts:transformer:arguments"),r("uts:transformer:checker");function H(e,t,r,i){const{addEmitFlags:s,cast:n,chainBundle:o,Debug:a,EmitFlags:c,isCallChain:l,isExpression:p,isGeneratedIdentifier:u,isIdentifier:d,isNonNullChain:f,isOptionalChain:m,isParenthesizedExpression:y,isSimpleCopiableExpression:h,isSyntheticReference:g,isTaggedTemplateExpression:x,OuterExpressionKinds:_,setOriginalNode:T,setTextRange:S,skipParentheses:v,skipPartiallyEmittedExpressions:E,SyntaxKind:b,TransformFlags:N,visitEachChild:C,visitNode:D,visitNodes:I}=t,{factory:P,hoistVariableDeclaration:A}=r;return o(r,(function(e){if(e.isDeclarationFile)return e;return C(e,O,r)}));function O(e){if(!(e.transformFlags&N.ContainsES2020))return e;switch(e.kind){case b.CallExpression:{const t=k(e,!1);return a.assertNotNode(t,g),t}case b.PropertyAccessExpression:case b.ElementAccessExpression:if(m(e)){const t=U(e,!1,!1);return a.assertNotNode(t,g),t}return C(e,O,r);case b.BinaryExpression:return e.operatorToken.kind===b.QuestionQuestionToken?function(e){let t=D(e.left,O,p),r=t;h(t)||(r=P.createTempVariable(A),t=P.createAssignment(r,t));return S(P.createConditionalExpression(L(t,r),void 0,r,void 0,D(e.right,O,p)),e)}(e):C(e,O,r);case b.DeleteExpression:return function(e){return m(v(e.expression))?T(F(e.expression,!1,!0),e):P.updateDeleteExpression(e,D(e.expression,O,p))}(e);default:return C(e,O,r)}}function w(e,t,r){const i=F(e.expression,t,r);return g(i)?P.createSyntheticReferenceExpression(P.updateParenthesizedExpression(e,i.expression),i.thisArg):P.updateParenthesizedExpression(e,i)}function k(e,t){if(m(e))return U(e,t,!1);if(y(e.expression)&&m(v(e.expression))){const t=w(e.expression,!0,!1),r=I(e.arguments,O,p);return g(t)?S(P.createFunctionCallCall(t.expression,t.thisArg,r),e):P.updateCallExpression(e,t,void 0,r)}return C(e,O,r)}function F(r,s,n){switch(r.kind){case b.ParenthesizedExpression:return w(r,s,n);case b.PropertyAccessExpression:case b.ElementAccessExpression:return function(r,s,n){if(m(r))return U(r,s,n);const o=i.getTypeAtLocation(r.expression);let c,l=D(r.expression,O,p);return a.assertNotNode(l,g),s&&(h(l)?c=l:(c=P.createTempVariable(A,void 0,void 0,void 0,e?B(o,r,t,i):void 0),l=P.createAssignment(c,l))),l=r.kind===b.PropertyAccessExpression?P.updatePropertyAccessExpression(r,l,D(r.name,O,d)):P.updateElementAccessExpression(r,l,D(r.argumentExpression,O,p)),c?P.createSyntheticReferenceExpression(l,c):l}(r,s,n);case b.CallExpression:return k(r,s);default:return D(r,O,p)}}function U(r,o,y){const{expression:v,chain:N}=function(e){if(a.assertNotNode(e,f),f(e))throw new Error("Unexpected non-null chain");const t=[e];for(;!e.questionDotToken&&!x(e);)e=n(E(e.expression),m),a.assertNotNode(e,f),t.unshift(e);return{expression:e.expression,chain:t}}(r),C=i.getTypeAtLocation(v),w=F(E(v),l(N[0]),!1);let k=g(w)?w.thisArg:void 0,U=g(w)?w.expression:w,$=P.restoreOuterExpressions(v,U,_.PartiallyEmittedExpressions);h(U)||(U=P.createTempVariable(A,void 0,void 0,void 0,e?B(C,r,t,i):void 0),$=P.createAssignment(U,$));let R,j=U;for(let r=0;r<N.length;r++){const n=N[r];switch(n.kind){case b.PropertyAccessExpression:case b.ElementAccessExpression:if(r===N.length-1&&o)if(h(j))R=j;else{const r=i.getTypeAtLocation(n.expression);R=P.createTempVariable(A,void 0,void 0,void 0,e?B(r,n,t,i):void 0),j=P.createAssignment(R,j)}j=n.kind===b.PropertyAccessExpression?P.createPropertyAccessExpression(j,D(n.name,O,d)):P.createElementAccessExpression(j,D(n.argumentExpression,O,p));break;case b.CallExpression:0===r&&k?(u(k)||(k=P.cloneNode(k),s(k,c.NoComments)),j=P.createFunctionCallCall(j,k.kind===b.SuperKeyword?P.createThis():k,I(n.arguments,O,p))):j=P.createCallExpression(j,void 0,I(n.arguments,O,p))}T(j,n)}const M=y?P.createConditionalExpression(L($,U,!0),void 0,P.createTrue(),void 0,P.createDeleteExpression(j)):P.createConditionalExpression(L($,U,!0),void 0,P.createNull(),void 0,j);return S(M,r),R?P.createSyntheticReferenceExpression(M,R):M}function L(e,t,r){return P.createBinaryExpression(P.createBinaryExpression(e,P.createToken(r?b.EqualsEqualsEqualsToken:b.ExclamationEqualsEqualsToken),P.createNull()),P.createToken(r?b.BarBarToken:b.AmpersandAmpersandToken),P.createBinaryExpression(t,P.createToken(r?b.EqualsEqualsEqualsToken:b.ExclamationEqualsEqualsToken),P.createVoidZero()))}}r("uts:transformer:generics"),r("uts:transformer:in"),r("uts:transformer:keyof"),r("uts:transformer:narrowType:discriminatedUnion"),r("uts:transformer:narrowType:nonNullable"),r("uts:transformer:narrowType"),r("uts:transformer:narrowType:parameterUnionType"),r("uts:transformer:UTSObjectUnionType"),r("uts:transformer:objectLiteral");function G(e,t,r,i){return{code:e,category:t,key:r,message:i}}r("uts:transformer:returnType"),r("uts:transformer:UTSJSONObject"),globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;function Z(e,t){return e.isExpressionStatement(t)&&e.isCallExpression(t.expression)&&e.isIdentifier(t.expression.expression)&&"defineExpose"===t.expression.expression.text}function X(e,t){return e.createExportAssignment(void 0,void 0,e.createCallExpression(e.createIdentifier("defineComponent"),void 0,[e.createObjectLiteralExpression([e.createMethodDeclaration(void 0,void 0,e.createIdentifier("setup"),void 0,void 0,[e.createParameterDeclaration(void 0,void 0,e.createIdentifier("props"),void 0,void 0,void 0),e.createParameterDeclaration(void 0,void 0,e.createObjectBindingPattern([e.createBindingElement(void 0,void 0,e.createIdentifier("expose"),void 0)]),void 0,void 0,void 0)],void 0,e.createBlock(t,!0))],!0)]))}let Q=null,Y=[];const ee=["defineMixin","definePlugin"],te=new Map;te.set("onShow",!1),te.set("onHide",!1),te.set("onAppShow",!0),te.set("onLaunch",!0),te.set("onError",!0),te.set("onThemeChange",!0),te.set("onKeyboardHeightChange",!0),te.set("onPageNotFound",!0),te.set("onUnhandledRejection",!0),te.set("onLastPageBackPress",!1),te.set("onExit",!1),te.set("onLoad",!0),te.set("onShow",!0),te.set("onReady",!1),te.set("onUnload",!1),te.set("onResize",!0),te.set("onBackPress",!0),te.set("onPageScroll",!0),te.set("onTabItemTap",!0),te.set("onReachBottom",!1),te.set("onPullDownRefresh",!1),te.set("beforeCreate",!1),te.set("created",!1),te.set("beforeMount",!1),te.set("mounted",!1),te.set("beforeUpdate",!1),te.set("updated",!1),te.set("beforeUnmount",!1),te.set("unmounted",!1);function re(e,t){const{ts:r}=e;return e.context.factory.createPropertyAccessExpression(r.isQualifiedName(t.left)?re(e,t.left):t.left,t.right)}function ie(e,t,r){const{ts:i}=e,s=e.context.factory,n=i.isQualifiedName(r)?re(e,r):s.createIdentifier(r.escapedText.toString());return s.createNewExpression(n,void 0,[t])}function se(e,t){const{ts:r}=e,i=e.context,s=e.typeChecker,n=i.factory,{type:o,expression:a}=t;if(!r.isObjectLiteralExpression(a))return;if(r.isTypeReferenceNode(o)&&r.isIdentifier(o.typeName)&&"UTSJSONObject"===o.typeName.escapedText)return n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[a]);let c;try{c=s.getContextualType(a)?.symbol}catch(e){}return c?c&&"UTSJSONObject"===c.escapedName?n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[a]):o&&function(e,t){const r=e.typeChecker.getContextualType(t);return!(!r||!F(e,r))}(e,a)&&r.isObjectLiteralExpression(a)?ie(e,a,o.typeName):void 0:void 0}const ne={Array_pop:"arrayPop",Array_shift:"arrayShift",Array_find:"arrayFind",Array_findLast:"arrayFindLast",Array_at:"arrayAt",Map_get:"mapGet",WeakMap_get:"weakMapGet",string_codePointAt:"stringCodePointAt",string_at:"stringAt"},oe=Object.keys(ne).map((e=>e.split("_")[1])),ae=["uni.request","JSON.parse","JSON.parseArray","JSON.parseObject"];function ce(e,t){const r=e.ts,i=e.context,s=i.factory;if(r.isArrayTypeNode(t)){const{elementType:r}=t;return s.createCallExpression(s.createPropertyAccessExpression(s.createPropertyAccessExpression(S(i),s.createIdentifier("UTSType")),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier("Array"),s.createArrayLiteralExpression([ce(e,r)]),s.createTrue()])}if(r.isTypeReferenceNode(t)){const{typeName:n,typeArguments:o}=t;if(!r.isIdentifier(n)){const e=r.createDiagnosticForNode(n,D.Invalid_generic_type_which_can_not_be_constructed);return i.addSemanticDiagnostic(e),s.createIdentifier("UTSJSONObject")}return o&&0!==o.length?s.createCallExpression(s.createPropertyAccessExpression(s.createPropertyAccessExpression(S(i),s.createIdentifier("UTSType")),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier(n.escapedText.toString()),s.createArrayLiteralExpression(o.map((t=>ce(e,t)))),s.createTrue()]):s.createIdentifier(n.escapedText.toString())}return $(e,t)}const le=["Array","Map","WeakMap","string","String","number","Number","boolean","Boolean","UTSJSONObject"];function pe(e,t,r,i){const s=O(e,t,void 0),n=t.getNullType(),o=t.getUndefinedType(),a=t.getVoidType(),c=t.getStringType();function l(e){let t=e.getBaseTypes();return 1===t?.length&&"String"===t[0].getSymbol()?.getName()}function p(e){return e===o||e===a}return!!(s.isObjectLiteralType(r)&&s.isPossibleUTSJSONObjectType(i)||s.isObjectLiteralType(i)&&s.isPossibleUTSJSONObjectType(r))||(!!(p(r)&&i===n||r===n&&p(i))||(!!(r===c&&l(i)||l(r)&&i===c)||void 0))}const ue=v(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules"));const de=new RegExp("^"+I+"/([a-zA-Z0-9_-]+)/index.d.ts$");const fe=process.env.UNI_UTS_PLATFORM,me="app-ios"===fe,ye="app-harmony"===fe;let he=[];he=me||ye?["app-js/index.uts","app-js/index.ts","app-js/index.js"]:[`${fe}/index.uts`,`${fe}/index.ts`,`${fe}/index.js`];const ge={replaceVueTypes:function(e,t){return e.endsWith("runtime-core.d.ts")&&(t=(t=(t=t.replace(/type ObjectInjectOptions = Record<([\s\S]+?)>;/,"type ObjectInjectOptions<I = Data> = {\n    [K in keyof I]: {\n      type: PropType<I[K]>;\n      from?: string;\n      default?: I[K] | (() => I[K]);\n    }\n  };")).replace(/type InjectToObject<T([\s\S]+?): never;/,"type InjectToObject<T> = T extends string[] ? {\n    [K in T[number]]: unknown;\n  } : T extends ObjectInjectOptions<infer I> ? {\n    [K in keyof I]: I[K];\n  } : never;")).replace(/serverPrefetch\?\(\): void \| Promise<any>;/,"serverPrefetch?(): void | Promise<any | null>;")),e.endsWith("app.d.ts")&&(t=t.replace(/\s\sexport function defineApp<D extends OptionsData = OptionsData.*/,"")),t},isTypeRelatedTo:function(e,t,r,i){return pe(e,t,r,i)},isRelatedTo:pe,tryFileLookup:function(e){if(!process.env.UNI_INPUT_DIR)return;const t=function(e){const t=e.match(de);return t?t[1]:""}(e);if(t){const e=x.resolve(I,t,"utssdk");if(ye){if(b(x.resolve(e,"app-harmony/index.uts")))return}for(let t=0;t<he.length;t++){const r=he[t],i=x.resolve(e,r);if(b(i))return v(i)}if(me||ye)return;const r=x.resolve(I,t,"utssdk/index.uts");if(b(r))return v(r)}else if(e.endsWith(".d.ts")&&!b(e)){const t=e.replace(/\.d\.ts$/,""),r=t+".uvue";if(b(r))return r+".ts";const i=t+".vue";if(b(i))return i+".ts"}else if(e.endsWith(".json")&&b(e))return e+".ts"},componentPublicInstancePropertyAccessFallback:function(e,t,r,i,s,n){if(!e.isPropertyAccessExpression(r)||!e.isExpression(i)||!e.isIdentifier(n))return;const o=s.aliasSymbol?.escapedName.toString();if("ComponentPublicInstance"!==o&&"CreateComponentPublicInstance"!==o)return;const a=n.escapedText.toString(),c=globalThis?.__utsUniXGlobalProperties__;if(c&&c.has(a)){const{initializerNode:r}=c.get(a),i=t.getTypeAtLocation(r);return i.isNumberLiteral()?t.getNumberType():i.isStringLiteral()?t.getStringType():i.flags&e.TypeFlags.BooleanLiteral?t.getBooleanType():i}},isRequireIOSNativeUtsSdk:function(e,t){if(!process.env.UNI_INPUT_DIR)return!1;if("app-ios"!==process.env.UNI_UTS_PLATFORM&&"app-harmony"!==process.env.UNI_UTS_PLATFORM)return!1;let r=t;if(t.startsWith("@/"))r=x.resolve(process.env.UNI_INPUT_DIR,t.slice(2));else if(t.startsWith("."))r=x.resolve(x.dirname(e),t);else if(!x.isAbsolute(t))return!1;const i=x.relative(ue,r).replace(/\\/g,"/");if(i.startsWith(".")||i.indexOf("/")>-1)return!1;if("app-ios"===process.env.UNI_UTS_PLATFORM){if(b(x.resolve(ue,i,"utssdk"))&&!b(x.resolve(ue,i,"utssdk/app-js")))return!0}else if("app-harmony"===process.env.UNI_UTS_PLATFORM&&b(x.resolve(ue,i,"utssdk"))&&b(x.resolve(ue,i,"utssdk","app-harmony"))&&!b(x.resolve(ue,i,"utssdk/app-js")))return!0;return!1},isUtsCompiler:!0,hijackAnyNullUnionType:!0,hijackTsLibResolve:!0,hijackDestructuring:!0,ignoreInstanceofLeftType:!0,ignoreInstanceofRightType:!0,useTypeAndInterfaceAsValue:!0,ignoreAllDebugFail:!0};var xe=[(e,t,r)=>({before(i){const s=t.getProgram().getTypeChecker(),n=H("ArkTS"===r.targetLanguage,e,i,s);return e=>n(e)}}),(e,r,i)=>{function s(s,n){if(e.isSourceFile(n)){if(function(e){if(e&&!e.getUTSJSONObjectType&&e.getGlobalType){const t=e.getGlobalType("UTSJSONObject",0,!0);e.getUTSJSONObjectType=()=>t;const r=e.getGlobalType("String",0,!0);e.getUTSStringType=()=>r;const i=e.getGlobalType("Number",0,!0);e.getUTSNumberType=()=>i}}(r.getProgram()?.getTypeChecker()),!n.__relativeFileName){const e=s.getCompilerOptions();if(e.rootDir&&t.isAbsolute(e.rootDir)){const r=v(e.rootDir),i=v(n.fileName);n.__rootDir=r,i.startsWith(r)?n.__relativeFileName=v(t.relative(r,i)):i.includes("/@dcloudio/")&&(n.__relativeFileName="@dcloudio/"+i.split("/@dcloudio/")[1])}n.__relativeFileName||(n.__relativeFileName=t.basename(n.fileName))}if(!s.printNode){const t=e.createPrinter();s.printNode=(r,i)=>t.printNode(e.EmitHint.Unspecified,r,i)}s.addSyntacticDiagnostic||(s.addSyntacticDiagnostic=e=>{n.parseDiagnostics.push(e)},s.addSemanticDiagnostic=e=>{n.bindDiagnostics.push(e)}),s.error||(s.error=e=>{if(i.watch)return e.__throwError=!0,void s.addSyntacticDiagnostic(e);const t=new Error(e.messageText.toString());throw t.diagnostic=e,Object.defineProperty(t,"id",{get:()=>e.file.fileName,set(e){}}),t})}return n}return{before:e=>t=>s(e,t),after:e=>t=>s(e,t),afterDeclarations:e=>t=>s(e,t)}},(e,t)=>({parser:{SourceFile(t){const r=t.factory;function i(e){if(e.endsWith(".uts")||e.endsWith(".ts"))return e.replace(/.u?ts$/,"")}let s=[];function n(o){const a=e.visitEachChild(o,n,t);if(e.isImportDeclaration(a)||e.isExportDeclaration(a)){let t=a.moduleSpecifier;if(t&&e.isStringLiteral(t)){const e=t.text,r=/@\/uni_modules\/([a-zA-Z0-9_-]+)/,i=e.match(r)?.[1];if(i){b(x.resolve(I,i,"encrypt"))&&s.push({range:{pos:Math.max(a.pos-1,0),end:a.pos},type:1})}}}if(e.isImportDeclaration(a)&&a.moduleSpecifier&&e.isStringLiteral(a.moduleSpecifier)){const e=i(a.moduleSpecifier.text);if(e)return r.createImportDeclaration(a.modifiers,a.importClause,r.createStringLiteral(e),a.assertClause)}if(e.isExportDeclaration(a)&&a.moduleSpecifier&&e.isStringLiteral(a.moduleSpecifier)){const e=i(a.moduleSpecifier.text);if(e)return r.createExportDeclaration(a.modifiers,!1,a.exportClause,r.createStringLiteral(e),a.assertClause);if(a.isTypeOnly)return r.createExportDeclaration(a.modifiers,!1,a.exportClause,a.moduleSpecifier,a.assertClause)}return e.isImportClause(a)&&a.isTypeOnly?r.createImportClause(!1,a.name,a.namedBindings):e.isImportSpecifier(a)&&a.isTypeOnly?r.createImportSpecifier(!1,a.propertyName,a.name):e.isExportSpecifier(a)&&a.isTypeOnly?r.createExportSpecifier(!1,a.propertyName,a.name):a}return t=>(t=e.visitNode(t,n),s.length>0&&(t.commentDirectives=t.commentDirectives||[],t.commentDirectives.push(...s),s.length=0),t)}}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker();null===Q&&i.getGlobalType&&(Q=i.getGlobalType("UniApp",0,!1),Q&&(Y=Q.getProperties().map((e=>e.getName()))));const s=t=>{if(Q&&Y.length){if(e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&e.isIdentifier(t.expression.name)){const r=function(e,t){return e.getContextualType(t)??e.getTypeAtLocation(t)}(i,t.expression.expression);if(r&&r.isIntersection()&&r.types.some((e=>"UniApp"===e.symbol?.name))&&!Y.includes(t.expression.name.text)){console.error(`error: '${t.expression.name.text}' 不是 UniApp 对象的方法，请检查是否拼写错误，如果想调用在 App.uvue 文件中定义的 methods 方法，请使用 .vm?.xxx 的方式调用，详情参考：https://doc.dcloud.net.cn/uni-app-x/api/get-app.html#appmethods`);const r=t.getSourceFile();if(r.__relativeFileName){const i=e.getLineAndCharacterOfPosition(r,t.pos),s=r.__relativeFileName.split("?")[0].replace(/\.(vue|uvue|uts).ts$/g,".$1");console.error("at "+s+":"+i.line)}}}return e.visitEachChild(t,s,r)}return t};return t=>e.visitNode(t,s)}}),e=>({parser:{SourceFile:t=>r=>{const i=s=>{const n=e.visitEachChild(s,i,t);if(e.isCallExpression(n)&&e.isPropertyAccessExpression(n.expression)){const t=n.expression.expression,i=n.expression.name;if(e.isIdentifier(t)&&e.isIdentifier(i)){const e=t.text;"uni"!==e&&"uniCloud"!==e||(r.__utsMeta||(r.__utsMeta={}),r.__utsMeta.uniExtApis||(r.__utsMeta.uniExtApis=new Set),r.__utsMeta.uniExtApis.add(e+"."+i.text))}}return n};return e.visitNode(r,i)}}}),e=>({parser:{SourceFile(t){const{factory:r}=t;let i=!1,s=!1;const n=o=>{if(e.isSourceFile(o)){if(s&&o.text.startsWith("// @uts-setup\n")){const i=o.statements,s=[],n=[],a=[];for(let o=0;o<i.length;o++){const c=i[o];if(e.isImportDeclaration(c))s.push(c);else if(e.isExportAssignment(c)){if(e.isObjectLiteralExpression(c.expression)&&0===c.expression.properties.length)continue;const r=e.createDiagnosticForNode(c,D.script_setup_cannot_contain_ES_module_exports);t.addSyntacticDiagnostic(r)}else Z(e,c)?a.push(r.createReturnStatement(c.expression.arguments[0])):n.push(c)}return r.updateSourceFile(o,[...s,X(r,[...n,...a])])}return e.visitEachChild(o,n,t)}return e.isExportAssignment(o)&&e.isObjectLiteralExpression(o.expression)?r.updateExportAssignment(o,o.modifiers,r.createCallExpression(r.createIdentifier(i?"defineApp":"defineComponent"),void 0,[o.expression])):o};return t=>{if(!t.isVueFile||t.fileName.indexOf("setup=true")>-1)return t;const o=x.basename(t.fileName).split("?")[0].toLowerCase();"app.uvue"!==o&&"app.uvue.ts"!==o||(i=!0),/.u?vue.ts/.test(o)&&(s=!0);const a=e.visitNode(t,n);return a!==t?r.updateSourceFile(a,[r.createImportDeclaration(void 0,r.createImportClause(!1,void 0,r.createNamedImports([r.createImportSpecifier(!1,void 0,r.createIdentifier(i?"defineApp":"defineComponent"))])),r.createStringLiteral("vue")),...a.statements]):a}}},before(t){const{factory:r}=t,i=s=>e.isSourceFile(s)?e.visitEachChild(s,i,t):e.isExportAssignment(s)&&e.isCallExpression(s.expression)?r.updateExportAssignment(s,s.modifiers,r.createCallExpression(r.createIdentifier("defineComponent"),void 0,s.expression.arguments)):e.isImportDeclaration(s)&&s.moduleSpecifier&&e.isStringLiteral(s.moduleSpecifier)&&"vue"===s.moduleSpecifier.text&&s.importClause&&e.isImportClause(s.importClause)&&s.importClause.namedBindings&&e.isNamedImports(s.importClause.namedBindings)&&s.importClause.namedBindings.elements.some((e=>"defineApp"===e.name.text))?r.updateImportDeclaration(s,s.modifiers,r.updateImportClause(s.importClause,!1,void 0,r.createNamedImports(s.importClause.namedBindings.elements.filter((e=>"defineApp"!==e.name.text)))),s.moduleSpecifier,s.assertClause):s;return t=>t.isVueFile?("app.uvue"===x.basename(t.fileName).split("?")[0].toLowerCase()&&(t=e.visitNode(t,i)),t):t}}),(e,t)=>({parser:{SourceFile:t=>{const r=t.factory,i=s=>{let n=e.visitEachChild(s,i,t);return e.isMethodDeclaration(n)&&e.isIdentifier(n.name)&&"valueIterator"===n.name.escapedText?r.createMethodDeclaration(n.modifiers,n.asteriskToken,r.createComputedPropertyName(r.createPropertyAccessExpression(r.createIdentifier("Symbol"),r.createIdentifier("iterator"))),n.questionToken,n.typeParameters,n.parameters,n.type,n.body):e.isExpressionWithTypeArguments(s)&&e.isIdentifier(s.expression)&&"UTSValueIterable"===s.expression.escapedText?r.createExpressionWithTypeArguments(r.createIdentifier("Iterable"),s.typeArguments):n};return r=>e.visitEachChild(r,i,t)}}}),(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=O(e,void 0,t),s=n=>{const o=e.visitEachChild(n,s,t);if(e.isParameter(o)&&!o.type&&!o.dotDotDotToken){const t=o.parent;if(t&&(e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t))&&0===t.parameters.indexOf(o)){const s=i.getMethodNameNodeOfObjectLiteral(t);if(s&&e.isIdentifier(s)){const t=s.escapedText.toString();if(!0===te.get(t)){const i=s?.parent?.parent?.parent;if(i&&e.isCallExpression(i)){const s=i.expression;if(e.isIdentifier(s)&&A(s.escapedText.toString()))return r.createParameterDeclaration(o.modifiers,o.dotDotDotToken,o.name,o.questionToken,r.createTypeReferenceNode(r.createIdentifier(t.replace(/^(\w)/,(e=>e.toUpperCase()))+"Options"),void 0),o.initializer)}}}}}return o};return r=>r.isVueFile?e.visitEachChild(r,s,t):r}}}),(e,t)=>({parser:{TypeAliasDeclaration:t=>function(r){const i=t.factory,{modifiers:s=[],name:n,typeParameters:o=[],type:a}=r;return e.isTypeLiteralNode(a)?i.createTypeAliasDeclaration(s,n,o,i.createTypeLiteralNode(i.createNodeArray([i.createIndexSignature(void 0,[i.createParameterDeclaration(void 0,void 0,i.createIdentifier("key"),void 0,i.createKeywordTypeNode(e.SyntaxKind.StringKeyword),void 0)],i.createKeywordTypeNode(e.SyntaxKind.AnyKeyword)),...a.members]))):r},SourceFile(t){const r=O(e,void 0,t),i=s=>{if(e.isTypeAliasDeclaration(s)&&e.isTypeLiteralNode(s.type)){const{modifiers:t=[],name:i,typeParameters:n=[],type:o}=s,a=o.members,c=function(e,t,r,i,s){const{ts:n}=e,o=e.context.factory,a=[],c=s?s.map((t=>{const{modifiers:r,name:i,questionToken:s,jsDoc:c}=t;let l;if(n.isPropertySignature(t))l=t.type;else if(n.isMethodSignature(t)){const{type:e,typeParameters:r,parameters:i}=t;l=o.createFunctionTypeNode(r,i,e)}const p=l&&e.createTypeNodeWithNullType(l,!!s);a.push(o.createPropertySignature(void 0,i,s,p));const u=o.createPropertyDeclaration(r,i,s,p,void 0);return u.jsDoc=c,u})):[],l=o.createTypeLiteralNode(a),p=[],u=o.createIndexSignature(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("key"),void 0,o.createKeywordTypeNode(n.SyntaxKind.StringKeyword),void 0)],o.createKeywordTypeNode(n.SyntaxKind.AnyKeyword)),d=o.createConstructorDeclaration(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("options"),void 0,l,void 0)],o.createBlock([o.createExpressionStatement(o.createCallExpression(o.createSuper(),void 0,[])),...(s||[]).map((e=>{let t="";const r=e.name,i=n.isStringLiteral(r)||n.isNumericLiteral(r);return(n.isIdentifier(r)||i)&&(t=r.text),o.createExpressionStatement(o.createBinaryExpression(i?o.createElementAccessExpression(o.createThis(),o.createStringLiteral(t)):o.createPropertyAccessExpression(o.createThis(),o.createIdentifier(t)),o.createToken(n.SyntaxKind.EqualsToken),i?o.createElementAccessExpression(o.createIdentifier("options"),o.createStringLiteral(t)):o.createPropertyAccessExpression(o.createIdentifier("options"),o.createIdentifier(t))))}))],!0));return p.push(u,...c,d),o.createClassDeclaration(t,r,i?.length?i:void 0,[o.createHeritageClause(n.SyntaxKind.ExtendsKeyword,[o.createExpressionWithTypeArguments(U(e),void 0)])],p)}(r,[...t],i,[...n],[...a.filter((t=>e.isPropertySignature(t)||e.isMethodSignature(t)))]);c&&(s=c)}else e.isInterfaceDeclaration(s);return s=e.visitEachChild(s,i,t)};return t=>e.visitNode(t,i)}},before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=r.factory,o=t=>{if(e.isPropertyAccessExpression(t)&&L(s,t))t=n.createPropertyAccessExpression(S(r),n.createIdentifier("UTSType"));else if(e.isClassDeclaration(t)){const{heritageClauses:e}=t,r=e?.[0]?.types?.[0]?.expression;r&&L(s,r)&&(t=M(s,t))}return t=e.visitEachChild(t,o,r)};return t=>e.visitNode(t,o)}}),(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=O(e,void 0,t),s=n=>{const o=e.visitEachChild(n,s,t),a=o.parent;if(a&&e.isObjectLiteralExpression(o)){if(i.isSetupReturnValue(o))return o;if(i.isDefineExpose(a))return o;if(function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isVariableDeclaration(i)&&!i.type}(i,o)||function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isPropertyAccessExpression(i)&&i.expression===t||r.isParenthesizedExpression(i)&&i.parent&&r.isPropertyAccessExpression(i.parent)&&i.parent.expression===i}(i,o)||e.isExportAssignment(a)||!w.includes(a.kind))return r.createAsExpression(o,r.createTypeReferenceNode(r.createIdentifier("UTSJSONObject"),void 0))}return o};return t=>e.visitNode(t,s)}},before(r){const{factory:i}=r,s=t.getProgram().getTypeChecker(),n=O(e,s,r),o=new Map,a=t=>{if(e.isObjectLiteralExpression(t)){const s=e.getOriginalNode(t)||t;if(e.isObjectLiteralExpression(s)){if(n.isSetupReturnValue(s))return t;const e=s.parent;if(e&&n.isDefineExpose(e))return t}const c=function(e,t,r){const{ts:i}=e,s=e.context,n=e.typeChecker,o=s.factory,a=i.getOriginalNode(t)||t;if((a.flags&i.NodeFlags.Synthesized)===i.NodeFlags.Synthesized)return;const c=a?.parent;if(c&&i.isAsExpression(c)||e.isComponentDataOrProvide(a)||e.isComponentOptions(a)||e.isComponentOptionsProperty(a)||e.isComponentProp(a)||e.isCreateAppReturnValue(a))return;const l=i.getContainerNode(a);if(l&&i.isMethodDeclaration(l)&&l.modifiers&&l.modifiers.some((e=>e.kind===i.SyntaxKind.StaticKeyword))&&i.isIdentifier(l.name)&&"get$UTSMetadata$"===l.name.escapedText)return;let p;try{p=n.getContextualType(a)}catch(e){try{p=n.getContextualType(t)}catch(e){}}if(e.shouldTransfromToUTSJSONObject(t,p))return o.createTypeReferenceNode("UTSJSONObject",void 0);const u=p.symbol,d=u?.escapedName;if(!d||!F(e,p))return;if(n.isSymbolAccessible(u,a,i.SymbolFlags.Class,!0).accessibility!==i.SymbolAccessibility.Accessible)return n.markSymbolAsNotTypeOnly(u),o.createTypeReferenceNode(n.symbolToEntityName(u,i.SymbolFlags.Class,t,void 0),void 0);const f=n.getAccessibleSymbolChain(u,a,u.flags,!1);let m;if(f&&f.length>0)m=n.symbolToEntityName(u,i.SymbolFlags.Class,a,void 0);else{const t=u.declarations;if(!t||1!==t.length)return;const s=t[0].getSourceFile(),n=a.getSourceFile();if(s===n)return;let c,l;if(r.has(u)){const e=r.get(u);c=e.alias,l=e.importDeclaration}else{const t=u.escapedName;if(c=i.getUniqueName(t,n),l=function(e,t,r,i){const{ts:s}=e,n=e.context,o=e.typeChecker;let a="";if(1!==(r?.declarations||[]).length)return;const c=t.symbol?.exports;for(const e of c.keys()){const t=c.get(e).declarations||[];if(1!==t.length)continue;const i=t[0];let n,l;if(s.isClassDeclaration(i)?l=i.name:s.isExportAssignment(i)?l=i.expression:s.isExportSpecifier(i)&&(l=i.name),n=l&&(o.getContextualType(l)?.symbol||o.getTypeAtLocation(l)?.symbol),n===r){a=e;break}}if(!a)return;const l=n.factory,p=l.createIdentifier(i);return"default"===a?l.createImportDeclaration(void 0,l.createImportClause(!1,p,void 0),l.createStringLiteral(t.fileName),void 0):l.createImportDeclaration(void 0,l.createImportClause(!1,void 0,l.createNamedImports([l.createImportSpecifier(!1,a!==i?l.createIdentifier(a):void 0,p)])),l.createStringLiteral(t.fileName),void 0)}(e,s,u,c),!l)return;r.set(u,{symbol:u,alias:c,importDeclaration:l})}m=o.createIdentifier(c)}return n.markSymbolAsNotTypeOnly(u),o.createTypeReferenceNode(m,void 0)}(n,t,o);if(c)return i.createAsExpression(e.visitEachChild(t,a,r),c)}return e.visitEachChild(t,a,r)};return t=>{const r=e.visitNode(t,a),s=[];for(const e of o.values())s.push(e.importDeclaration),t.locals.set(e.alias,e.symbol);const n=Array.from(r.statements);let c=0;for(let t=0;t<n.length;t++){const r=n[t];if(!e.isImportDeclaration(r))break;c=t+1}return n.splice(c,0,...s),i.updateSourceFile(r,n,r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}),e=>({parser:{SourceFile:t=>r=>{const i=r.fileName,s=globalThis?.__utsUniXGlobalProperties__;if(s)for(const[e,t]of s)t.file===i&&s.delete(e);return function r(n){const o=e.visitEachChild(n,r,t);if(e.isBinaryExpression(o)){const{left:t,operatorToken:r,right:n}=o;if(r.kind===e.SyntaxKind.EqualsToken&&e.isPropertyAccessExpression(t)){const{expression:r,name:o}=t;if(e.isPropertyAccessExpression(r)){const{expression:t,name:a}=r;if("globalProperties"===a.escapedText.toString()&&e.isPropertyAccessExpression(t)){const{name:e}=t;"config"===e.escapedText.toString()&&s.set(o.escapedText.toString(),{file:i,initializerNode:n})}}}}return o}(r)}}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=t=>(e.isClassDeclaration(t)&&(t=function(e,t){const{ts:r}=e,i=e.context,s=e.typeChecker,n=i.factory,o=t.heritageClauses;if(!o)return t;const a=o.filter((e=>e.token===r.SyntaxKind.ImplementsKeyword));if(1!==a.length)return t;const c=a[0].types,l=[];for(let e=0;e<c.length;e++){const t=c[e];if(!t.expression||!r.isIdentifier(t.expression))continue;const i=s.getSymbolAtLocation(t.expression),n=i?.declarations||[];if(1!==n.length)continue;const o=n[0];r.isClassDeclaration(o)&&l.push(t.expression)}if(0===l.length)return t;const p=t.name?t.name.escapedText.toString():"";return n.updateClassDeclaration(t,t.modifiers,t.name,t.typeParameters,t.heritageClauses,[...j(e,p,0,l),...t.members])}(s,t)),t=e.visitEachChild(t,n,r));return t=>e.visitNode(t,n)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=r.factory,o=t=>{if(e.isAsExpression(t)&&t.type){const i=se(s,t);if(i)return n.createNewExpression(i.expression,i.typeArguments,[e.visitEachChild(t,o,r)])}return t=e.visitEachChild(t,o,r)};return t=>e.visitNode(t,o)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=t=>{if(e.isIdentifier(t)){if("JSON"===t.escapedText)return function(e){const t=e.context,r=t.factory;return S(t),r.createPropertyAccessExpression(r.createIdentifier("UTS"),r.createIdentifier("JSON"))}(s)}else e.isBinaryExpression(t)?t.operatorToken.kind===e.SyntaxKind.InstanceOfKeyword&&(t=function(e,t){const r=e.context,i=r.factory;return S(r),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier("UTS"),i.createIdentifier("isInstanceOf")),void 0,[t.left,t.right])}(s,t)):e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&(t=function(e,t){const r=e.context,i=r.factory,s=e.typeChecker,n=e.ts,{expression:o,arguments:a}=t;if(!n.isPropertyAccessExpression(o))return t;const{expression:c,name:l}=o;if(n.isIdentifier(c)&&n.isIdentifier(l)&&ae.includes(`${c.escapedText}.${l.escapedText}`)){const r=t.typeArguments?.[0];if(r&&n.isTypeReferenceNode(r)&&r.pos>0&&n.isIdentifier(r.typeName)){const c=le.includes(r.typeName.escapedText.toString());let l;if(!c&&(l=s.getSymbolAtLocation(r),!l)){const e=r.typeName.escapedText;l=s.getSymbolsInScope(t,n.SymbolFlags.Type).find((t=>t.escapedName===e))}if(c||l&&k(e,l))return i.updateCallExpression(t,o,void 0,[...a,ce(e,r)])}}if(!n.isIdentifier(l)||!oe.includes(l.escapedText.toString()))return t;if(c.pos<0)return t;const p=s.getTypeAtLocation(c);let u="";s.isArrayType(p)?u="Array":s.isTypeAssignableTo(p,s.getStringType())&&(u="string");const d=p.symbol?.escapedName.toString();"Map"===d?u="Map":"WeakMap"===d&&(u="WeakMap");const f=l.escapedText,m=ne[`${u}_${f}`];return m?(S(r),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier("UTS"),i.createIdentifier(m)),void 0,[c,...a])):t}(s,t));return t=e.visitEachChild(t,n,r)};return t=>e.visitNode(t,n)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=t=>(!e.isVariableDeclaration(t)||t.initializer||t.parent&&e.isCatchClause(t.parent)||!e.isIdentifier(t.name)?e.isParameter(t)?t=function(e,t){const{modifiers:r,dotDotDotToken:i,name:s,questionToken:n,type:o,initializer:a}=t;if(t.pos<0||a||i)return t;const c=e.context.factory,l=e.typeChecker,p=e.ts;return p.isMethodDeclaration(t.parent)&&p.isIdentifier(t.parent.name)&&"setup"===t.parent.name.text?t:n||e.isPossibleNullType(l.getTypeAtLocation(t))?c.updateParameterDeclaration(t,r,i,s,n,o&&e.createTypeNodeWithNullType(o,!0),a||c.createNull()):t}(s,t):(e.isFunctionDeclaration(t)||e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t)||e.isGetAccessorDeclaration(t))&&(t=function(e,t){const r=e.ts,i=e.context,s=i.factory,n=e.typeChecker,{modifiers:o,type:a}=t,c=o?.some((e=>e.kind===r.SyntaxKind.AsyncKeyword));let l=!1,p=!1;if(a){const r=n.getSignatureFromDeclaration(t)?.getReturnType();if(r&&(l=e.isPossibleNullType(r),p=e.isPossiblePromiseNullType(r),!l&&!p))return t}return r.visitEachChild(t,(function e(t){return r.isFunctionLike(t)?t:r.isReturnStatement(t)&&!t.expression?s.updateReturnStatement(t,c||p?s.createCallExpression(s.createPropertyAccessExpression(s.createIdentifier("Promise"),s.createIdentifier("resolve")),void 0,[s.createNull()]):s.createNull()):r.visitEachChild(t,e,i)}),i)}(s,t)):t=function(e,t){const r=e.context.factory,i=e.typeChecker;return!t.initializer&&t.pos>0&&e.isPossibleNullType(i.getTypeAtLocation(t))?r.updateVariableDeclaration(t,t.name,t.exclamationToken,t.type,r.createNull()):t}(s,t),t=e.visitEachChild(t,n,r));return t=>e.visitNode(t,n)}}),e=>({before:t=>t=>(t.statements.forEach((t=>{if((e.isImportDeclaration(t)||e.isExportDeclaration(t))&&t.moduleSpecifier&&e.isStringLiteral(t.moduleSpecifier)){const e=t.moduleSpecifier.text;(e.endsWith(".uvue.ts")||e.endsWith(".vue.ts"))&&(t.moduleSpecifier.text=e.replace(/.u?ts$/,""))}})),t)}),e=>({before(t){const r=i=>{if(e.isCallExpression(i)&&e.isIdentifier(i.expression)&&i.arguments.length>0){const e=i.expression.escapedText.toString();ee.includes(e)&&(i=i.arguments[0])}return e.visitEachChild(i,r,t)};return t=>e.visitNode(t,r)}}),(e,t,r)=>{const{extname:i,resolveWorkers:s,rewriteRootDir:n}=r.transformCreateWorker||{resolveWorkers:()=>({})},o={Worker_Path_Expected_a_string_literal:G(0,e.DiagnosticCategory.Error,"Worker_Path_Expected_a_string_literal_0","uni.createWorker(workerPath) 的 workerPath 参数必须是字符串字面量"),Worker_Path_Not_Found:G(0,e.DiagnosticCategory.Error,"Worker_Path_Not_Found_0","Worker[{0}]路径不存在或未正确实现"),Worker_Not_Supported_on_App_IOS_Uvue:G(0,e.DiagnosticCategory.Error,"Worker_Not_Supported_on_App_IOS_Uvue_0","app-ios平台，目前仅 uts 插件中支持使用 uni.createWorker 创建 worker")};return{before(t){const{factory:a}=t,c=new Map,l=s(),p=s=>{if(e.isCallExpression(s)&&s.arguments.length>=1&&e.isPropertyAccessExpression(s.expression)&&"createWorker"===s.expression.name.escapedText&&e.isIdentifier(s.expression.expression)&&"uni"===s.expression.expression.escapedText){"JavaScript"===r.targetLanguage&&"app-ios"===r.platform&&t.error(e.createDiagnosticForNode(s,o.Worker_Not_Supported_on_App_IOS_Uvue));const p=s.arguments[0];let u="";if(e.isStringLiteral(p)||e.isNoSubstitutionTemplateLiteral(p)?u=p.text:t.error(e.createDiagnosticForNode(p,o.Worker_Path_Expected_a_string_literal)),u)if(u.startsWith("/")&&(u=u.slice(1)),l[u]){if("Kotlin"===r.targetLanguage||"Swift"===r.targetLanguage){const t=a.createIdentifier(l[u]);if(!c.has(u)){const e=a.createImportDeclaration(void 0,a.createImportClause(!1,void 0,a.createNamedImports([a.createImportSpecifier(!1,void 0,t)])),a.createStringLiteral(`@/${u}`),void 0);c.set(u,e)}const r=[a.createArrowFunction(void 0,void 0,[],a.createTypeReferenceNode(a.createIdentifier("WorkerTaskImpl"),void 0),a.createToken(e.SyntaxKind.EqualsGreaterThanToken),a.createNewExpression(t,void 0,[]))];for(let e=1;e<s.arguments.length;e++)r.push(s.arguments[e]);return a.updateCallExpression(s,s.expression,s.typeArguments,r)}if(i){let e=u.replace(".uts",i);n&&e.includes("uni_modules/")&&(e="/"+n+(e.startsWith("/")?"":"/")+e);const t=[a.createStringLiteral(e)];for(let e=1;e<s.arguments.length;e++)t.push(s.arguments[e]);return a.updateCallExpression(s,s.expression,s.typeArguments,t)}}else t.error(e.createDiagnosticForNode(p,o.Worker_Path_Not_Found,u))}return e.visitEachChild(s,p,t)};return t=>{const r=e.visitNode(t,p);return 0===c.size?r:a.updateSourceFile(r,[...c.values(),...r.statements],r.isDeclarationFile,r.referencedFiles,r.typeReferenceDirectives,r.hasNoDefaultLib,r.libReferenceDirectives)}}}}];const _e=s.normalizePath(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),Te=new RegExp("^"+_e+"/([a-zA-Z0-9_-]+)/"),Se=/\.(u)?vue(.ts)?/;let ve;const Ee=new Set;function be(e){return Se.test(e)}function Ne(e,t){if(ve=e,!ve.sys.__rewrited){const{fileExists:e,readFile:r,realpath:i}=ve.sys;ve.sys.realpath=e=>{const t=i?i(e):e;return t.endsWith(".ts")&&Ee.has(s.normalizePath(e))?e.replace(".ts",".uts"):t},ve.sys.fileExists=t=>{const r=s.normalizePath(t),i=r.match(Te),n=i?i[1]:"";return(!n||!e(x.resolve(_e,n,"encrypt")))&&(r.endsWith(".ts")&&e(r.replace(".ts",".uts"))?(Ee.add(r),!0):!(!r.endsWith(".vue.ts")&&!r.endsWith(".uvue.ts")||!e(r.replace(/.ts$/,"")))||(!(!r.endsWith(".json.ts")||!e(r.replace(/.ts$/,"")))||e(t)))},ve.sys.readFile=(i,n)=>{if(i.endsWith(".ts")&&Ee.has(s.normalizePath(i))){const e=i.replace(".ts",".uts"),s=r(e,n);if(null==s)return;return function(e,t){return t.uniCliShared.preUVueJs(t.uniCliShared.preUVueJs(e))}(s,t)}if(i.endsWith(".json.ts")){const o=i.replace(/.ts$/,"");if(e(o)){const e=r(o,n);if(null==e)return;return function(e,t){const r=t.uniCliShared.parseJson(e,!0);return s.dataToEsm(r,{preferConst:!0,compact:!0})}(e,t)}}if(i.endsWith(".vue.ts")||i.endsWith(".uvue.ts")){const s=i.replace(/.ts$/,"");if(e(s)){const e=r(s,n);if(null==e)return;return function(e,t){e=t.uniCliShared.preUVueJs(t.uniCliShared.preUVueHtml(e));const r=t.vueCompilerDom.parse(e).children.find((e=>"script"===e.tag)),i="export default {}";return r?r.props.some((e=>"setup"===e.name))?"// @uts-setup\n"+(r?.children[0]?.content||"")+"\n"+i:r?.children[0]?.content||i:i}(e,t)}}let o=r(i,n);if(null==o)return;i.endsWith("runtime-dom/dist/runtime-dom.d.ts")&&(o=o.replace("runtimeDOMBailTypes: Node | Window;",""));const a=globalThis?.__utsHacker__?.replaceVueTypes;return a?a(i,o):o},ve.sys.__rewrited=!0}}const Ce=new class{constructor(){this.getCanonicalFileName=x.normalize,this.getNewLine=()=>ve.sys.newLine}getCurrentDirectory(){return ve.sys.getCurrentDirectory()}};function De(e,t,r){const i={flatMessage:ve.flattenDiagnosticMessageText(t.messageText,Ce.getNewLine()),formatted:ve.formatDiagnosticsWithColorAndContext([t],Ce),category:t.category,code:t.code,type:e};if(t.file&&void 0!==t.start){let{line:e,character:n}=t.file.getLineAndCharacterOfPosition(t.start);if(r){const o=r.originalPositionFor({line:e+1,column:n,bias:p.SourceMapConsumer.LEAST_UPPER_BOUND});if(null!==o.line){if(o.source){const a=r.sourceContentFor(o.source);if(a){const{line:c,character:l}=t.file.getLineAndCharacterOfPosition(t.start+(t.length||0)),p=r.originalPositionFor({line:c+1,column:l});if(null!==p.line){const r=u.codeFrameColumns(a,{start:{line:o.line,column:(o.column||0)+1},end:{line:p.line,column:(p.column||0)+1}});i.rollupError=function(e,t,r,i,s){const n={id:e,message:t,frame:s,loc:{file:e,line:r,column:i}};return n}(t.file.fileName,i.flatMessage,e+1,n+1,r),i.finalRollupError=function(e,t,r,i,s){const n=new Error(t);return Object.assign(n,{message:t,frame:s,loc:{file:e,line:r,column:i}}),Object.defineProperty(n,"id",{get:()=>e,set(e){}}),n}(t.file.fileName,i.flatMessage,o.line,o.column||0,r),i.utsCompilerError={type:"UTSCompilerError",file:s.normalizePath(x.relative(process.env.UNI_INPUT_DIR,t.file.fileName.split("?")[0])),line:o.line,column:o.column||0,message:i.flatMessage,frame:r}}}}e=o.line}}i.fileLine=`${t.file.fileName}(${e+1},${n+1})`}return i}function Ie(e,t,r){return t.map((t=>De(e,t,r)))}function Pe(e,t,r=!0){t.forEach((t=>{let i,s,o;switch(t.category){case ve.DiagnosticCategory.Message:i=e.info,s=n.white,o="";break;case ve.DiagnosticCategory.Error:i=e.error,s=n.red,o="error";break;case ve.DiagnosticCategory.Warning:default:i=e.warn,s=n.yellow,o="warning"}const a=t.type+" ";return r?t.utsCompilerError?i.call(e,t.utsCompilerError):t.rollupError?i.call(e,t.rollupError):i.call(e,`${n.enabled?t.formatted:function(e){if("string"!=typeof e)throw new TypeError(`Expected a \`string\`, got \`${typeof e}\``);return e.replace(Ae,"")}(t.formatted)}`):void 0!==t.fileLine?i.call(e,`${t.fileLine}: ${a}${o} TS${t.code}: ${s(t.flatMessage)}`):i.call(e,`${a}${o} TS${t.code}: ${s(t.flatMessage)}`)}))}const Ae=function({onlyFirst:e=!1}={}){const t=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(t,e?void 0:"g")}();var Oe;function we(e){return"string"==typeof e?e:e()}!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Debug=3]="Debug"}(Oe||(Oe={}));class ke{constructor(e,t,r,i=""){this.verbosity=e,this.bail=t,this.context=r,this.prefix=i}warn(e){this.verbosity<Oe.Warning||this.context.warn(`${we(e)}`)}error(e){this.verbosity<Oe.Error||(this.bail?"string"==typeof e||"function"==typeof e?this.context.error(`${we(e)}`):this.context.error(e):"UTSCompilerError"===e.type?(console.warn(`warning: ${e.message}`),console.warn(`at ${e.file}:${e.line}:${e.column}`),console.log(e.frame)):"string"==typeof e||"function"==typeof e?this.context.warn(`${we(e)}`):this.context.warn(e))}info(e){this.verbosity<Oe.Info||console.log(`${this.prefix}${we(e)}`)}debug(e){this.verbosity<Oe.Debug||console.log(`${this.prefix}${we(e)}`)}}function Fe({useTsconfigDeclarationDir:e,cacheRoot:t},r){const i={noEmitHelpers:!1,importHelpers:!0,noResolve:!1,noEmit:!1,noEmitOnError:!1,inlineSourceMap:!1,outDir:s.normalizePath(`${t}/placeholder`),allowNonTsExtensions:!0};if(!r)return i;r.options.moduleResolution===ve.ModuleResolutionKind.Classic&&(i.moduleResolution=ve.ModuleResolutionKind.Node10),void 0===r.options.module&&(i.module=ve.ModuleKind.ES2015),e||(i.declarationDir=void 0);return r.options.sourceMap||(i.sourceRoot=void 0),i}function Ue(e,t){const r=[];return t.forEach((t=>{e instanceof Array?e.forEach((e=>r.push(s.normalizePath(x.join(t,e))))):r.push(s.normalizePath(x.join(t,e)))})),r}class Le{constructor(e,t,r){this.parsedConfig=e,this.transformers=t,this.cwd=r,this.snapshots={},this.versions={},this.customParser={},this.getScriptFileNames=()=>Array.from(this.fileNames.values()),this.getCompilationSettings=()=>this.parsedConfig.options,this.getTypeRootsVersion=()=>0,this.getCurrentDirectory=()=>this.cwd,this.useCaseSensitiveFileNames=()=>ve.sys.useCaseSensitiveFileNames,this.getDefaultLibFileName=ve.getDefaultLibFilePath,this.readDirectory=ve.sys.readDirectory,this.readFile=ve.sys.readFile,this.fileExists=ve.sys.fileExists,this.directoryExists=ve.sys.directoryExists,this.getDirectories=ve.sys.getDirectories,this.realpath=ve.sys.realpath,this.trace=console.log,this.fileNames=new Set(e.fileNames)}reset(){this.snapshots={},this.versions={}}setLanguageService(e){e.shouldTransform=e=>!!e&&(function(e){return be(e)||e.includes(".uts")||Ee.has(s.normalizePath(e))}(e)||e.endsWith(".json.ts")||e.endsWith(".d.ts")),e.isVueFile=be,this.service=e,this.customTransformers||this.initTransformers(this.transformers||[])}setSnapshot(e,t){(e=s.normalizePath(e)).endsWith(".uts")&&this.setSnapshot(e.replace(/\.uts$/,".ts"),t);const r=ve.ScriptSnapshot.fromString(t);return this.snapshots[e]=r,this.versions[e]=(this.versions[e]||0)+1,this.fileNames.add(e),r}getScriptSnapshot(e){if((e=s.normalizePath(e))in this.snapshots)return this.snapshots[e];const t=ve.sys.readFile(e);return null!=t?this.setSnapshot(e,t):void 0}getScriptVersion(e){return e=s.normalizePath(e),(this.versions[e]||0).toString()}initTransformers(e){if(void 0===this.service||void 0===e||0===this.transformers.length)return;const t={before:[],after:[],afterDeclarations:[]};for(const r of e){const e=r(this.service);e.parser&&(this.customParser=e.parser),e.before&&(t.before=t.before.concat(e.before)),e.after&&(t.after=t.after.concat(e.after)),e.afterDeclarations&&(t.afterDeclarations=t.afterDeclarations.concat(e.afterDeclarations))}return this.customTransformers=t,globalThis.__utsParser__=this.customParser,t}getCustomTransformers(){return this.customTransformers}setCompilerHost(e){}}class $e{constructor(e){this.cacheRoot=e,this.rolled=!1,this.oldCacheRoot=`${this.cacheRoot}/cache`,this.newCacheRoot=`${this.cacheRoot}/cache_`,d.emptyDirSync(this.newCacheRoot)}exists(t){return!this.rolled&&(!!e.existsSync(`${this.newCacheRoot}/${t}`)||e.existsSync(`${this.oldCacheRoot}/${t}`))}path(e){return`${this.oldCacheRoot}/${e}`}match(t){return!this.rolled&&(e.existsSync(this.oldCacheRoot)?_.isEqual(e.readdirSync(this.oldCacheRoot).sort(),t.sort()):0===t.length)}read(t){return e.existsSync(`${this.newCacheRoot}/${t}`)?d.readJsonSync(`${this.newCacheRoot}/${t}`,{encoding:"utf8",throws:!1}):d.readJsonSync(`${this.oldCacheRoot}/${t}`,{encoding:"utf8",throws:!1})}write(e,t){this.rolled||void 0!==t&&d.writeJsonSync(`${this.newCacheRoot}/${e}`,t)}touch(e){this.rolled||d.ensureFileSync(`${this.newCacheRoot}/${e}`)}roll(){this.rolled||(this.rolled=!0,d.removeSync(this.oldCacheRoot),e.existsSync(this.newCacheRoot)&&e.renameSync(this.newCacheRoot,this.oldCacheRoot))}}function Re(e,t,r){const i={code:"",references:t,uniExtApis:r};return e.outputFiles.forEach((e=>{e.name.endsWith(".d.ts")?i.dts=e:e.name.endsWith(".d.ts.map")?i.dtsmap=e:e.name.endsWith(".map")?i.map=e.text:i.code=e.text})),i}class je{constructor(e,t,r,i,s,n,o,a){if(this.noCache=e,this.host=i,this.cacheRoot=s,this.options=n,this.context=a,this.cacheVersion="9",this.cachePrefix="uts_",this.ambientTypesDirty=!1,this.hashOptions={algorithm:"sha1",ignoreUnknown:!1},this.dependencyTree=new f.Graph({directed:!0}),this.dependencyTree.setDefaultNodeLabel((()=>({dirty:!1}))),t&&this.clean(),e)return;this.hashOptions.ignoreUnknown=r,this.cacheDir=`${this.cacheRoot}/${this.cachePrefix}${m({version:this.cacheVersion,rootFilenames:o,options:this.options,tsVersion:ve.version},this.hashOptions)}`,this.init();const c=ve.getAutomaticTypeDirectiveNames(n,ve.sys).map((e=>ve.resolveTypeReferenceDirective(e,void 0,n,ve.sys))).filter((e=>e.resolvedTypeReferenceDirective?.resolvedFileName)).map((e=>e.resolvedTypeReferenceDirective.resolvedFileName));this.ambientTypes=o.filter((e=>e.endsWith(".d.ts"))).concat(c).map((e=>({id:e,snapshot:this.host.getScriptSnapshot(e)}))),this.checkAmbientTypes()}clean(){if(!T.pathExistsSync(this.cacheRoot))return;T.readdirSync(this.cacheRoot).forEach((e=>{const t=`${this.cacheRoot}/${e}`;e.startsWith(this.cachePrefix)?T.statSync(t).isDirectory?(this.context.info(n.blue(`cleaning cache: ${t}`)),T.removeSync(`${t}`)):this.context.debug(`skipping cleaning '${t}' as it is not a directory`):this.context.debug(`skipping cleaning '${t}' as it does not have prefix '${this.cachePrefix}'`)}))}setDependency(e,t){this.context.debug(`${n.blue("dependency")} '${e}'`),this.context.debug(`    imported by '${t}'`),this.dependencyTree.setEdge(t,e)}walkTree(e){if(f.alg.isAcyclic(this.dependencyTree))return f.alg.topsort(this.dependencyTree).forEach((t=>e(t)));this.context.info(n.yellow("import tree has cycles")),this.dependencyTree.nodes().forEach((t=>e(t)))}done(){this.noCache||(this.context.info(n.blue("rolling caches")),this.codeCache.roll(),this.semanticDiagnosticsCache.roll(),this.syntacticDiagnosticsCache.roll(),this.typesCache.roll())}getCompiled(e,t,r){return this.context.info(`${n.blue("transpiling")} '${e}'`),this.getCached(this.codeCache,e,t,Boolean(!this.options.isolatedModules||this.options.declaration),r)}getSyntacticDiagnostics(e,t,r,i){return this.getDiagnostics("syntax",this.syntacticDiagnosticsCache,e,t,r,i)}getSemanticDiagnostics(e,t,r,i){return this.getDiagnostics("semantic",this.semanticDiagnosticsCache,e,t,r,i)}checkAmbientTypes(){this.context.debug(n.blue("Ambient types:"));const e=this.ambientTypes.filter((e=>void 0!==e.snapshot)).map((e=>(this.context.debug(`    ${e.id}`),this.createHash(e.id,e.snapshot))));this.ambientTypesDirty=!this.typesCache.match(e),this.ambientTypesDirty&&this.context.info(n.yellow("ambient types changed, redoing all semantic diagnostics")),e.forEach(this.typesCache.touch,this.typesCache)}getDiagnostics(e,t,r,i,s,n){return this.getCached(t,r,i,"semantic"===e,(()=>Ie(e,s(),n)))}getCached(e,t,r,i,s){if(this.noCache)return s();const o=this.createHash(t,r);if(this.context.debug(`    cache: '${e.path(o)}'`),e.exists(o)&&!this.isDirty(t,i)){this.context.debug(n.green("    cache hit"));const t=e.read(o);if(t)return e.write(o,t),t;this.context.warn(n.yellow("    cache broken, discarding"))}this.context.debug(n.yellow("    cache miss"));const a=s();return e.write(o,a),this.markAsDirty(t),a}init(){this.codeCache=new $e(`${this.cacheDir}/code`),this.typesCache=new $e(`${this.cacheDir}/types`),this.syntacticDiagnosticsCache=new $e(`${this.cacheDir}/syntacticDiagnostics`),this.semanticDiagnosticsCache=new $e(`${this.cacheDir}/semanticDiagnostics`)}markAsDirty(e){this.dependencyTree.setNode(e,{dirty:!0})}isDirty(e,t){const r=this.dependencyTree.node(e);if(!r)return!1;if(!t||r.dirty)return r.dirty;if(this.ambientTypesDirty)return!0;const i=f.alg.dijkstra(this.dependencyTree,e);return Object.keys(i).some((e=>{const t=i[e];if(!e||t.distance===1/0)return!1;const r=this.dependencyTree.node(e),s=void 0===r||r.dirty;return s&&this.context.debug(`    import changed: ${e}`),s}))}createHash(e,t){const r=t.getText(0,t.getLength());return m({data:r,id:e,compilerVersion:process.env.HX_Version||process.env.UNI_COMPILER_VERSION},this.hashOptions)}}const Me="tslib",Ke="\0tslib.js",We=">=5.0.0",ze=">=3.0.0";class Je extends o.EventEmitter{constructor(){super(),this._codeMap=new Map,this._easycomUsage=new Map,this._easycoms=[]}has(e){return this._codeMap.has(s.normalizePath(e))}set(e,t){const r=s.normalizePath(e);this.get(r)!==t&&(this._codeMap.set(e,t),this.emit("change",{fileName:r,source:t}))}get(e){return this._codeMap.get(s.normalizePath(e))}forEach(e){this._codeMap.forEach(e)}initUts2jsEasycom(e=this._easycoms){this._easycoms=e||[],this.set("/__uts2js_vfs__/shim-uni-easycom.d.ts",function(e){let t="",r="";return e.forEach(((e,i)=>{const s=c.kebabCase(i).replace(e.pattern,e.replacement);t+=`import ${i} from '${s}'\n`,r+=`  type ${i}ComponentPublicInstance = InstanceType<typeof ${i}>\n`})),`${t}\ndeclare global {\n${r}\n}`}(function(e,t){const r=new Map;return t.forEach(((t,i)=>{const s=c.kebabCase(i),n=e.find((e=>e.pattern.test(s)||c.upperFirst(c.camelCase(e.name))===i));n&&r.set(i,n)})),r}(this._easycoms,this._easycomUsage)))}setEasycomUsage(e,t=[]){e=s.normalizePath(e),this._easycomUsage.forEach(((r,i)=>{t.includes(i)||(r.delete(e),0===r.size&&this._easycomUsage.delete(i))}));for(let r=0;r<t.length;r++){const i=t[r];this._easycomUsage.has(i)?this._easycomUsage.get(i)?.add(e):this._easycomUsage.set(i,new Set([e]))}this.initUts2jsEasycom()}}const Ve=e=>{let r,i,o,c,u,d,f,m,y,h,g=!1,x=!1,T=0,S=!0;const v={},b=new Set,N=(e,t,r,i)=>{if(!t)return;e=s.normalizePath(e),b.add(e);const n=((e,t,r)=>y.getSyntacticDiagnostics(e,t,(()=>f.getSyntacticDiagnostics(e)),r).concat(y.getSemanticDiagnostics(e,t,(()=>f.getSemanticDiagnostics(e)),r)))(e,t,i);Pe(r,n,!1!==c.options.pretty),n.length>0&&(S=!1)},C=(e,t)=>{if(!t.dts)return;const r=s.normalizePath(e);v[r]={type:t.dts,map:t.dtsmap},i.debug((()=>`${n.blue("generated declarations")} for '${r}'`))},D=e=>!(e.endsWith(".d.ts")||e.endsWith(".d.cts")||e.endsWith(".d.mts"))&&!!o(e),I=()=>{g||S||i.info(n.yellow("there were errors or warnings.")),y?.done()},P=Object.assign({},{check:!0,verbosity:Oe.Warning,clean:!1,cacheRoot:a({name:"rollup-plugin-uts"}),include:["*.(|u)ts+(|x)","**/*.(|u)ts+(|x)","**/*.cts","**/*.mts"],exclude:["*.d.ts","**/*.d.ts","**/*.d.cts","**/*.d.mts"],abortOnError:!1,rollupCommonJSResolveHack:!1,tsconfig:void 0,useTsconfigDeclarationDir:!1,tsconfigOverride:{},transformers:[],tsconfigDefaults:{},objectHashIgnoreUnknownHack:!1,cwd:process.cwd()},e);P.typescript||(P.typescript=require("typescript")),Ne(P.typescript,e.modules),globalThis.uts2jsSourceCodeMap=new Je;const A={name:"uts",options:e=>(r={...e},e),configureServer(e){e.watcher.addListener("all",((e,t)=>{if("add"===e||"unlink"===e){const e=s.normalizePath(t);E.has(e)&&E.delete(e)}}))},buildStart(){m=ve.createDocumentRegistry(),i=new ke(P.verbosity,P.abortOnError,this,"uts: "),g="true"===process.env.ROLLUP_WATCH||!!this.meta.watchMode,({parsedTsConfig:c,fileName:u}=function(e,r){const i=ve.findConfigFile(r.cwd,ve.sys.fileExists,r.tsconfig);void 0===r.tsconfig||i||e.error(`failed to open '${r.tsconfig}'`);let s,n={},o=r.cwd,a=!0;if(i){const r=ve.sys.readFile(i),c=ve.parseConfigFileTextToJson(i,r);a=c.config?.pretty??a,void 0!==c.error&&(Pe(e,Ie("config",[c.error]),a),e.error(`failed to parse '${i}'`)),n=c.config,o=t.dirname(i),s=i}const c={};_.merge(c,r.tsconfigDefaults,n,r.tsconfigOverride);const l=ve.parseJsonConfigFileContent(c,ve.sys,o,Fe(r),s),p=Fe(r,l),u=ve.parseJsonConfigFileContent(c,ve.sys,o,p,s),d=u.options.module;return d!==ve.ModuleKind.ES2015&&d!==ve.ModuleKind.ES2020&&d!==ve.ModuleKind.ES2022&&d!==ve.ModuleKind.ESNext&&e.error(`Incompatible tsconfig option. Module resolves to '${ve.ModuleKind[d]}'. This is incompatible with Rollup, please use 'module: "ES2015"', 'module: "ES2020"', 'module: "ES2022"', or 'module: "ESNext"'.`),Pe(e,Ie("config",u.errors),a),e.debug(`built-in options overrides: ${JSON.stringify(p,void 0,4)}`),e.debug(`parsed tsconfig: ${JSON.stringify(u,void 0,4)}`),{parsedTsConfig:u,fileName:i}}(i,P)),i.info(`typescript version: ${ve.version}`),i.info(`tslib version: ${P.utsOptions.tslibVersion}`),i.info(`rollup version: ${this.meta.rollupVersion}`),l.satisfies(ve.version,We,{includePrerelease:!0})||i.error(`Installed TypeScript version '${ve.version}' is outside of supported range '${We}'`),l.satisfies(this.meta.rollupVersion,ze,{includePrerelease:!0})||i.error(`Installed Rollup version '${this.meta.rollupVersion}' is outside of supported range '${ze}'`),x=l.satisfies(this.meta.rollupVersion,">=2.60.0",{includePrerelease:!0}),x||i.warn((()=>`${n.yellow("You are using a Rollup version '<2.60.0'")}. This may result in type-only files being ignored.`)),i.info("rollup-plugin-uts version: 1.0.0"),i.debug((()=>`plugin options:\n${JSON.stringify(P,((e,t)=>"typescript"===e?`version ${t.version}`:t),4)}`)),i.debug((()=>`rollup config:\n${JSON.stringify(r,void 0,4)}`)),i.debug((()=>`tsconfig path: ${u}`)),P.objectHashIgnoreUnknownHack&&i.warn((()=>`${n.yellow("You are using 'objectHashIgnoreUnknownHack' option")}. If you enabled it because of async functions, try disabling it now.`)),P.rollupCommonJSResolveHack&&i.warn((()=>`${n.yellow("You are using 'rollupCommonJSResolveHack' option")}. This is no longer needed, try disabling it now.`)),g&&i.info("running in watch mode"),o=function(e,t,r){let i=t.include,n=t.exclude;return r.options.rootDirs&&(i=Ue(i,r.options.rootDirs),n=Ue(n,r.options.rootDirs)),r.projectReferences&&(i=Ue(i,r.projectReferences.map((e=>e.path))).concat(i),n=Ue(n,r.projectReferences.map((e=>e.path))).concat(n)),e.debug((()=>`included:\n${JSON.stringify(i,void 0,4)}`)),e.debug((()=>`excluded:\n${JSON.stringify(n,void 0,4)}`)),s.createFilter(i,n,{resolve:r.options.rootDir})}(i,P,c),d=new Le(c,P.transformers,P.cwd),globalThis.uts2jsSourceCodeMap.forEach(((e,t)=>{d.setSnapshot(t,e)})),d.setSnapshot(Me,P.utsOptions.tslibSource),globalThis.uts2jsSourceCodeMap.on("change",(function(e){const{fileName:t,source:r}=e||{};d.setSnapshot(t,r)})),f=ve.createLanguageService(d,m),d.setLanguageService(f);const e=P.clean,a=P.noCache||P.clean;if(y=new je(a,e,P.objectHashIgnoreUnknownHack,d,P.cacheRoot,c.options,c.fileNames,i),h=new Set,P.check){const e=Ie("options",f.getCompilerOptionsDiagnostics());Pe(i,e,!1!==c.options.pretty),e.length>0&&(S=!1)}},watchChange(e,t){const r=s.normalizePath(e);if(delete v[r],b.delete(r),"web"===process.env.UNI_UTS_PLATFORM)return;const{event:i}=t||{};"create"!==i&&"delete"!==i||E.has(r)&&E.delete(r)},resolveId(e,r){if(e===Me)return Ke;if(!r)return;r=s.normalizePath(r);const o=ve.nodeModuleNameResolver(e,r,c.options,ve.sys);let a=o.resolvedModule?.resolvedFileName;if(a){if(Ee.has(s.normalizePath(a))&&(a=a.replace(".ts",".uts")),/.u?vue.ts$/.test(a))return a=a.replace(/.ts$/,""),t.normalize(a);if(D(a))return y.setDependency(a,r),i.debug((()=>`${n.blue("resolving")} '${e}' imported by '${r}'`)),i.debug((()=>`    to '${a}'`)),t.normalize(a)}},load:e=>e===Ke?P.utsOptions.tslibSource:null,async transform(r,a){h.add(a);const l=r.matchAll(/([a-zA-Z0-9]+)ComponentPublicInstance/g),m=[];for(const e of l)m.push(e[1]);m.length>0&&globalThis.uts2jsSourceCodeMap.setEasycomUsage(s.normalizePath(a),m);let T=a;if(T.endsWith(".json")&&(T=T.replace(/.json$/,".uts")),!o(T))return;const v=d.setSnapshot(T,r),E=y.getCompiled(T,v,(()=>{let r;const o=f.getProgram()?.getSourceFile(T);if("uts"===P.utsOptions.emitType){const e=[];if(o){const r=ve.createPrinter({}).printSourceFile(o,{host:Ce,map:{file:s.normalizePath(t.relative(P.utsOptions.inputDir??"",a)),sourceRoot:"",sourcesDirectoryPath:P.utsOptions.inputDir??""}});r.code&&e.push({name:"",writeByteOrderMark:!1,text:r.code}),r.map&&e.push({name:".map",writeByteOrderMark:!1,text:r.map})}else this.error(new Error(`Could not find source file: '${a}'.`));r={outputFiles:e,emitSkipped:!1}}else try{r=f.getEmitOutput(T)}catch(e){if(e instanceof Error&&e.diagnostic){const t=Ie("transform",[e.diagnostic],new p.SourceMapConsumer(this.getCombinedSourcemap())),r="web"===P.utsOptions.platform?"rollupError":"finalRollupError";t[0][r]&&this.error(t[0][r])}throw e}r.emitSkipped&&(S=!1,N(T,v,i,e?.abortOnError?void 0:new p.SourceMapConsumer(this.getCombinedSourcemap())),this.error(n.red(`Emit skipped for '${a}'. See https://github.com/microsoft/TypeScript/issues/49790 for potential reasons why this may occur`)));const l=function(e,t,r){if(!t)return[];const i=ve.preProcessFile(t.getText(0,t.getLength()),!0,!0);return _.compact(i.referencedFiles.concat(i.importedFiles).map((t=>{const i=ve.nodeModuleNameResolver(t.fileName,e,r,ve.sys),n=i.resolvedModule?.resolvedFileName;return n&&Ee.has(s.normalizePath(n))&&n.endsWith(".ts")?n.replace(/.ts$/,".uts"):n})))}(T,v,c.options);return Re(r,l,[...o?.__utsMeta?.uniExtApis||[]])}));if(P.check&&N(T,v,i,new p.SourceMapConsumer(this.getCombinedSourcemap())),!E)return;if(g&&E.references&&(u&&this.addWatchFile(u),E.references.map(this.addWatchFile,this),i.debug((()=>`${n.green("    watching")}: ${E.references.join("\nuts:               ")}`))),C(a,E),E.references&&x)for(const e of E.references){if(!D(e))continue;const t=await this.resolve(e,a);t&&!h.has(t.id)&&await this.load({id:t.id})}if(c.options.emitDeclarationOnly)return void i.debug((()=>`${n.blue("emitDeclarationOnly")} enabled, not transforming TS`));const b={code:E.code,map:{mappings:""},meta:{uniExtApis:E.uniExtApis?[...E.uniExtApis]:[]}};if(E.map){P.sourceMapCallback?.(a,E.map);const e=JSON.parse(E.map);e.sourceRoot&&(e.sources=e.sources.map((r=>t.isAbsolute(r)?r:e.sourceRoot+r))),b.map=e}return b},buildEnd(e){if(T=0,e&&(I(),this.error(e)),!P.check)return I();g&&y.walkTree((e=>{if(!o(e))return;const t=d.getScriptSnapshot(e);N(e,t,i)})),c.fileNames.forEach((e=>{const t=s.normalizePath(e);if(b.has(t)||!o(t))return;i.debug((()=>`type-checking missed '${t}'`));const r=d.getScriptSnapshot(t);N(t,r,i)})),I()},generateBundle(e){if(i.debug((()=>`generating target ${T+1}`)),T++,!c.options.declaration)return;c.fileNames.forEach((e=>{const t=s.normalizePath(e);if(t in v||!o(t))return;i.debug((()=>`generating missed declarations for '${t}'`));const r=Re(f.getEmitOutput(t,!0));C(t,r)}));const r=(r,o,a)=>{if(!a)return;let c=a.name;if(c.includes("?")&&(c=c.split("?",1)+o),P.useTsconfigDeclarationDir)return i.debug((()=>`${n.blue("emitting declarations")} for '${r}' to '${c}'`)),void ve.sys.writeFile(c,a.text,a.writeByteOrderMark);let l=a.text;const p=`${P.cacheRoot}/placeholder`;if(".d.ts.map"===o&&(e?.file||e?.dir)){const r=e.file?t.dirname(e.file):e.dir,i=JSON.parse(l);i.sources=i.sources.map((e=>{const i=t.resolve(p,e);return s.normalizePath(t.relative(r,i))})),l=JSON.stringify(i)}const u=s.normalizePath(t.relative(p,c));i.debug((()=>`${n.blue("emitting declarations")} for '${r}' to '${u}'`)),this.emitFile({type:"asset",source:l,fileName:u})};Object.keys(v).forEach((e=>{const{type:t,map:i}=v[e];r(e,".d.ts",t),r(e,".d.ts.map",i)}))}};return A},Be=y.pathToFileURL(__filename).href,qe=t.dirname(y.fileURLToPath(Be)),He=i.createRequire(Be);let Ge=!1;exports.uts2js=function({inputDir:r,modules:i,...s}){Ge||(Ge=!0,globalThis.__utsHacker__={...globalThis.__utsHacker__,...ge});const n=s.include??["**/*.uts","**/*.ts"],o=s.typescript??He("typescript"),a={...s,modules:i||{},include:n,typescript:o,transformers:[J(o,xe,{platform:s.platform,targetLanguage:"JavaScript",setParentRecursive:!0,transformCreateWorker:{extname:s.workers?.extname,rewriteRootDir:s.workers?.rewriteRootDir,resolveWorkers:s.workers?.resolve||(()=>({}))}})],utsOptions:{platform:s.platform,tslibSource:e.readFileSync(t.resolve(qe,"../lib/runtime/index.js"),"utf8")}};a.tsconfigOverride||(a.tsconfigOverride={compilerOptions:{}}),a.tsconfigOverride.compilerOptions||(a.tsconfigOverride.compilerOptions={});const c=a.tsconfigOverride.compilerOptions,l={baseUrl:r?"src"===t.basename(r)?t.dirname(r):r:".",moduleResolution:"Bundler",importHelpers:!0,mapRoot:c.sourceMap?r:void 0,target:"ES2016"};for(const e in l)c.hasOwnProperty(e)||(c[e]=l[e]);return[Ve(a)]};

"use strict";var e=require("fs"),t=require("path"),r=require("debug"),i=require("module"),s=require("@rollup/pluginutils"),n=require("colors/safe"),o=require("events"),a=require("find-cache-dir"),c=require("lodash"),l=require("semver"),p=require("source-map-js"),d=require("@babel/code-frame"),u=require("fs-extra"),f=require("graphlib"),m=require("object-hash"),h=require("url");function y(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var g=y(e),x=y(t),T=y(c),S=y(u);function v(e){return e.factory.createIdentifier("UTS")}function b(e){return e.replace(/\\/g,"/")}const E=new Map;function N(e){const t=b(e);return E.has(t)?E.get(t):g.existsSync(t)?(E.set(t,!0),!0):(E.set(t,!1),!1)}var C;function _(e,t,r,i,s,n,o){return{code:e,category:t,key:r,message:i,reportsUnnecessary:s,elidedInCompatabilityPyramid:n,reportsDeprecated:o}}!function(e){e[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Suggestion=2]="Suggestion",e[e.Message=3]="Message"}(C||(C={}));const I={Type_literal_property_must_have_a_type_annotation:_(1e5,C.Error,"Type_literal_property_must_have_a_type_annotation_100000","Type literal property must have a type annotation."),Only_one_extends_heritage_clause_is_allowed_for_interface:_(100001,C.Error,"Only_one_extends_heritage_clause_is_allowed_for_interface_100001","Only one extends heritage clause is allowed for interface"),Variable_declaration_must_have_initializer:_(100002,C.Error,"Variable_declaration_must_have_initializer_100002","Variable declaration must have initializer."),Nested_type_literal_is_not_supported:_(100003,C.Error,"Nested_type_literal_is_not_supported_100003","Nested type literal is not supported."),Invalid_generic_type_which_can_not_be_constructed:_(100004,C.Error,"Invalid_generic_type_which_can_not_be_constructed_100004","Invalid generic type which can not be constructed."),script_setup_cannot_contain_ES_module_exports:_(100005,C.Error,"script_setup_cannot_contain_ES_module_exports_100005","`<script setup>` cannot contain ES module exports.")},D=b(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),A=["defineComponent","defineVaporComponent","defineApp","defineAsyncComponent","defineMixin"];function P(e){return A.some((t=>e===t||e==="_"+t))}function O(e,r,i){function s(e){return e?.constraintType?.origin?.type||e}function n(e){if(!e)return!1;const t=r.getNullType();return r.isTypeAssignableTo(t,e)}function o(t){return!!(t&&e.isUnionTypeNode(t)&&t.types.some((t=>e.isLiteralTypeNode(t)&&t.literal.kind===e.SyntaxKind.NullKeyword)))}function a(t){if(!t||!e.isCallExpression(t))return!1;const r=t.expression;return!!(r&&e.isIdentifier(r)&&P(r.escapedText.toString()))}function c(e){const t=e?.parent?.parent?.parent;return t&&a(t)}return{ts:e,typeChecker:r,context:i,isImportedSymbol:function(t){return!(!t.declarations||!t.declarations.some((t=>e.isImportSpecifier(t)||e.isImportClause(t)&&t.name)))},isPossibleUTSJSONObjectType:function(e,t=!1){return e?e.isUnion()&&e.types.some((e=>"UTSJSONObject"===s(e).symbol?.escapedName))||"UTSJSONObject"===s(e).symbol?.escapedName:!t},isPossibleNullType:n,isPossiblePromiseNullType:function(e){return!!e&&n(r.getPromisedTypeOfPromise(e))},createTypeNodeWithNullType:function(t,r){const s=i.factory,n=o(t);let a=t;return r&&!n&&(a=e.isUnionTypeNode(t)?s.createUnionTypeNode([...t.types,s.createLiteralTypeNode(s.createNull())]):s.createUnionTypeNode([t,s.createLiteralTypeNode(s.createNull())])),a},isUnionWithNullType:o,isObjectLiteralType:function(t){if(!t)return!1;if("__object"===t.symbol?.escapedName)return!0;const r=t?.objectFlags;if(r&&(r&e.ObjectFlags.ObjectLiteral||r&e.ObjectFlags.FreshLiteral))return!0;const i=t.getSymbol();return!!(i&&i.flags&e.SymbolFlags.ObjectLiteral)},getMethodNameNodeOfObjectLiteral:function(t){if(e.isMethodDeclaration(t))return t.name;const r=t.parent;if(!e.isPropertyAssignment(r))return;const i=r.name;return e.isIdentifier(i)?i:void 0},shouldTransfromToUTSJSONObject:function e(t,i){if(!i||i===r.getAnyType())return!0;if(i.isUnion())return i.types.some((r=>e(t,r)));if(i.isIntersection())return i.types.every((e=>r.isTypeAssignableTo(r.getGlobalType("UTSJSONObject",0,!0),i)));const s=i.getSymbol()||i.aliasSymbol;return!(!s&&!i.isClassOrInterface())&&(!s||"__object"===s?.escapedName||"UTSJSONObject"===s?.escapedName||r.isTypeAssignableTo(r.getGlobalType("UTSJSONObject",0,!0),i))},isVueOrNativeParameter:function t(i){if(!i.parent)return!1;if(e.isPropertyAssignment(i.parent)&&i.parent.parent&&e.isObjectLiteralExpression(i.parent.parent))return t(i.parent.parent);if(!e.isCallExpression(i.parent))return!1;if(-1===i.parent.expression.pos)return!0;const s=r.getTypeAtLocation(i.parent.expression);if(!s)return!1;const n=s.getCallSignatures()?.[0]?.declaration;if(!n)return!1;const o=n.getSourceFile().fileName,a=o.replace(/\\/g,"/").split("/").pop();return o.endsWith("runtime-core.d.ts")||a&&/lib\.es(\d+|next)\..*d.ts/.test(a)},isComponentDataOrProvide:function(t){const r=t.parent;if(!r||!e.isReturnStatement(r))return!1;const i=r?.parent?.parent;if(!i||!e.isMethodDeclaration(i))return!1;const s=i.name;if(!s||!e.isIdentifier(s)||"data"!==s.escapedText.toString()&&"provide"!==s.escapedText.toString())return!1;const n=i?.parent?.parent;return a(n)},isComponentOptions:function(e){const t=e?.parent;return t&&a(t)},isComponentOptionsProperty:c,isComponentProp:function(t){const r=t.parent?.parent,i=r?.parent;return r&&i&&e.isObjectLiteralExpression(r)&&e.isPropertyAssignment(i)&&e.isIdentifier(i.name)&&"props"===i.name.escapedText.toString()&&c(r)},isCreateAppReturnValue:function(r){if(process.env.UNI_INPUT_DIR&&b(t.resolve(process.env.UNI_INPUT_DIR,"main.uts"))===b(r.getSourceFile().fileName)&&r.parent&&e.isReturnStatement(r.parent)){const t=r?.parent?.parent?.parent;if(t&&e.isFunctionDeclaration(t)&&t.name&&e.isIdentifier(t.name)&&"createApp"===t.name.escapedText.toString())return!0}},isSetupReturnValue:function(t){const r=t.parent;return r&&e.isVariableDeclaration(r)&&r.name&&e.isIdentifier(r.name)&&"___returned__"===r.name.escapedText.toString()}}}const w=[260,169,172,171,208,219,253,229,223,213,214,170,216,234,226,303,304,305,209,227,239,217,235,238,277,294,291,293,286,285];function k(e,t){const{ts:r}=e,i=t?.declarations;if(1!==i?.length)return!1;const s=i[0];if(r.isClassDeclaration(s)){const t=s.heritageClauses?.some((t=>t.token===r.SyntaxKind.ExtendsKeyword&&t.types.some((t=>U(e,t.expression)||function(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:s}=t;return r.isIdentifier(s)&&"UTS"===s.escapedText&&r.isIdentifier(i)&&"UTSType"===i.escapedText}(e,t.expression)))));return t}return!1}function F(e,t){return t.symbol&&k(e,t.symbol)}function $(e){const t=e.context.factory,r=e.ts;return t.createPropertyAccessExpression(t.createParenthesizedExpression(t.createAsExpression(t.createIdentifier("globalThis"),t.createKeywordTypeNode(r.SyntaxKind.AnyKeyword))),t.createIdentifier("UTSType"))}function U(e,t){const r=e.ts;if(!r.isPropertyAccessExpression(t))return!1;const{expression:i,name:s}=t;return r.isIdentifier(s)&&"UTSType"===s.escapedText&&r.isParenthesizedExpression(i)&&r.isAsExpression(i.expression)&&r.isIdentifier(i.expression.expression)&&"globalThis"===i.expression.expression.escapedText}function R(e,t){const{ts:r}=e,i=e.context,s=i.factory,n=e.typeChecker,o=s.createStringLiteral("Unknown");if(e.isUnionWithNullType(t)&&2===t.types.length&&(t=t.types.find((e=>e.kind!==r.SyntaxKind.NullKeyword))),r.isTypeReferenceNode(t)){const{typeName:i,typeArguments:a}=t;if(!r.isIdentifier(i))return o;const c=n.getSymbolAtLocation(i),l=c?.declarations?.[0];return l&&function(e,t){if(!e.ts.isClassDeclaration(t))return!1;const{heritageClauses:r}=t,i=r?.[0]?.types?.[0]?.expression;return!(!i||!U(e,i))}(e,l)?a?s.createCallExpression(s.createPropertyAccessExpression($(e),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier(i.escapedText.toString()),s.createArrayLiteralExpression([...a.map((t=>R(e,t)))],!1)]):s.createIdentifier(i.escapedText.toString()):o}if(r.isArrayTypeNode(t))return s.createCallExpression(s.createPropertyAccessExpression($(e),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier("Array"),s.createArrayLiteralExpression([R(e,t.elementType)],!1)]);if(r.isTypeLiteralNode(t))i.addBindDiagnostic(r.createDiagnosticForNode(t,I.Nested_type_literal_is_not_supported));else{if(t.kind===r.SyntaxKind.NumberKeyword)return s.createIdentifier("Number");if(t.kind===r.SyntaxKind.StringKeyword)return s.createIdentifier("String");if(t.kind===r.SyntaxKind.BooleanKeyword)return s.createIdentifier("Boolean");if(t.kind===r.SyntaxKind.AnyKeyword)return s.createStringLiteral("Any")}return o}function L(e,t,r){const{ts:i}=e,s=e.context.factory;return s.createMethodDeclaration([s.createToken(i.SyntaxKind.StaticKeyword)],void 0,s.createIdentifier("get$UTSMetadata$"),void 0,void 0,t?[...t.map((e=>s.createParameterDeclaration(void 0,void 0,s.createIdentifier(e.name.escapedText.toString()),s.createToken(i.SyntaxKind.QuestionToken),s.createKeywordTypeNode(i.SyntaxKind.AnyKeyword),void 0)))]:[],void 0,s.createBlock([s.createReturnStatement(s.createAsExpression(r,s.createKeywordTypeNode(i.SyntaxKind.AnyKeyword)))],!0))}function j(e,t,r,i){const s=e.context.factory,n=[s.createPropertyAssignment(s.createIdentifier("kind"),s.createNumericLiteral(r)),s.createPropertyAssignment(s.createIdentifier("interfaces"),s.createArrayLiteralExpression(i,!1))];return"development"===process.env.NODE_ENV&&n.push(s.createPropertyAssignment(s.createIdentifier("name"),s.createStringLiteral(t))),[L(e,void 0,s.createObjectLiteralExpression(n,!0))]}globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;function M(e,t){const r=e.ts,i=e.context.factory,{modifiers:s,name:n,typeParameters:o,heritageClauses:a,members:c}=t,l=c.filter((e=>r.isPropertyDeclaration(e))),p=function(e,t,r,i,s){const n=e.context.factory,o=[n.createPropertyAssignment(n.createIdentifier("kind"),n.createNumericLiteral(r)),n.createGetAccessorDeclaration(void 0,n.createIdentifier("fields"),[],void 0,n.createBlock([n.createReturnStatement(n.createObjectLiteralExpression([...i.map((t=>{let r="";(t.jsDoc||[]).forEach((e=>{(e.tags||[]).forEach((e=>{if("JSON_FIELD"===e.tagName.escapedText&&"string"==typeof e.comment){const t=e.comment.length;r="'"===e.comment[0]&&"'"===e.comment[t-1]||'"'===e.comment[0]&&'"'===e.comment[t-1]?e.comment.slice(1,-1):e.comment}}))}));const i=[n.createPropertyAssignment(n.createIdentifier("type"),R(e,t.type)),n.createPropertyAssignment(n.createIdentifier("optional"),t.questionToken||e.isUnionWithNullType(t.type)?n.createTrue():n.createFalse())];return r&&i.push(n.createPropertyAssignment(n.createIdentifier("jsonField"),n.createStringLiteral(r))),n.createPropertyAssignment(n.createIdentifier(t.name.escapedText.toString()),n.createObjectLiteralExpression(i))}))],!0))],!0))];return"development"===process.env.NODE_ENV&&o.push(n.createPropertyAssignment(n.createIdentifier("name"),n.createStringLiteral(t))),[L(e,s,n.createObjectLiteralExpression(o,!0))]}(e,n?n.escapedText.toString():"",2,l,o?[...o]:[]),d=c.find((e=>r.isIndexSignatureDeclaration(e))),u=c.find((e=>r.isConstructorDeclaration(e))),{parameters:f}=u,m=[...f,i.createParameterDeclaration(void 0,void 0,i.createIdentifier("metadata"),void 0,i.createKeywordTypeNode(r.SyntaxKind.AnyKeyword),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier(n.escapedText),i.createIdentifier("get$UTSMetadata$")),void 0,[])),i.createParameterDeclaration(void 0,void 0,i.createIdentifier("isJSONParse"),void 0,i.createKeywordTypeNode(r.SyntaxKind.BooleanKeyword),i.createFalse())],h="__props__",y=i.createConstructorDeclaration(void 0,m,i.createBlock([i.createExpressionStatement(i.createCallExpression(i.createSuper(),void 0,[])),i.createExpressionStatement(i.createBinaryExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(h)),i.createToken(r.SyntaxKind.EqualsToken),i.createCallExpression(i.createPropertyAccessExpression($(e),i.createIdentifier("initProps")),void 0,[i.createIdentifier("options"),i.createIdentifier("metadata"),i.createIdentifier("isJSONParse")]))),...l.map((e=>{const{name:t}=e,s=t.escapedText;return i.createExpressionStatement(i.createBinaryExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(s)),i.createToken(r.SyntaxKind.EqualsToken),i.createPropertyAccessExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(h)),i.createIdentifier(s))))})),i.createExpressionStatement(i.createDeleteExpression(i.createPropertyAccessExpression(i.createThis(),i.createIdentifier(h))))],!0));return i.updateClassDeclaration(t,s,n,o,a,[d,...l,...p,y])}function K(e,t,r,i){return s=>{const n=r(s);return r=>{const o=e.isSourceFile(r);return s.fileName||o&&(s.fileName=r.fileName),t.shouldTransform(s.fileName)?(o&&!r.isUTSFile&&(r.isUTSFile=!0,t.isVueFile?.(s.fileName)&&(r.isVueFile=!0)),o&&"parser"===i&&r.statements.length&&(r.statements[0].parent||e.setParentRecursive(r,!0)),n(r)):r}}}function W(e,t){return t&&t!==e&&!Array.isArray(t)&&(t.__parsedByUtsParser=!0,t.parent=e.parent),t}let z;function B(e,t,r){return function(e){if(!e.ObjectFlags.UTSType){const{Class:t,Interface:r,Reference:i,Anonymous:s,ArrayLiteral:n}=e.ObjectFlags;e.ObjectFlags.UTSType=t|r|i|s|n}if(!e.TypeFlags.UTSType){const{Any:t,String:r,Number:i,Boolean:s,Enum:n,StringLiteral:o,NumberLiteral:a,BooleanLiteral:c,EnumLiteral:l,Void:p,Null:d,Object:u,Union:f,TemplateLiteral:m}=e.TypeFlags;e.TypeFlags.UTSType=t|r|i|s|n|o|a|c|l|p|d|u|f|m,e.TypeFlags.UTSStringLike=r|o|m,e.TypeFlags.UTSNumberLike=i|a}}(e),i=>{const s={},n=[],o=[],a=[];return t.forEach((t=>{let c=t(e,i,r);if("function"==typeof c)n.push(K(e,i,c,"before"));else{if(c.parser){const n=t(function(e){if(z)return z;z={...e};const{visitNode:t,visitEachChild:r}=e;return z.visitNode=(e,r)=>t(e,(e=>W(e,r(e)))),z.visitEachChild=(e,t,i)=>r(e,(e=>W(e,t(e))),i),z}(e),i,r);n.parser&&function(e,t,r,i){i.TypeAliasDeclaration&&(r.TypeAliasDeclaration||(r.TypeAliasDeclaration=[])).push(K(e,t,(e=>{const t=i.TypeAliasDeclaration(e);return e=>W(e,t(e))}),"parser")),i.SourceFile&&(r.SourceFile||(r.SourceFile=[])).push(K(e,t,i.SourceFile,"parser"))}(e,i,s,n.parser)}c.before&&n.push(K(e,i,c.before,"before")),c.after&&o.push(K(e,i,c.after,"after")),c.afterDeclarations&&a.push(K(e,i,c.afterDeclarations,"afterDeclarations"))}})),{parser:s,before:n,after:o,afterDeclarations:a}}}function V(e,t){return!!t.isImportTypeNode(e)||(t.forEachChild(e,(e=>V(e,t)))||!1)}function J(e,t,r,i){const s=function(e,t){for(t=e.getOriginalNode(t);;){if(!(t=t.parent))return;switch((t=e.getOriginalNode(t)).kind){case e.SyntaxKind.SourceFile:case e.SyntaxKind.MethodDeclaration:case e.SyntaxKind.MethodSignature:case e.SyntaxKind.FunctionDeclaration:case e.SyntaxKind.FunctionExpression:case e.SyntaxKind.GetAccessor:case e.SyntaxKind.SetAccessor:case e.SyntaxKind.ClassDeclaration:case e.SyntaxKind.InterfaceDeclaration:case e.SyntaxKind.EnumDeclaration:case e.SyntaxKind.ModuleDeclaration:return t}}}(r,t);let n=i.typeToTypeNode(e,s,r.NodeBuilderFlags.None);if(!n&&s&&(n=i.typeToTypeNode(e,void 0,r.NodeBuilderFlags.None)),n)return V(n,r)?i.typeToTypeNode(e,void 0,r.NodeBuilderFlags.None):n}globalThis.__utsHacker__={...globalThis.__utsHacker__},r("uts:transformer:importAndExportDeclaration"),r("uts:transformer:autoImport"),r("uts:transformer:arguments");function q(e,t,r,i){const{addEmitFlags:s,cast:n,chainBundle:o,Debug:a,EmitFlags:c,isCallChain:l,isExpression:p,isGeneratedIdentifier:d,isIdentifier:u,isNonNullChain:f,isOptionalChain:m,isParenthesizedExpression:h,isSimpleCopiableExpression:y,isSyntheticReference:g,isTaggedTemplateExpression:x,OuterExpressionKinds:T,setOriginalNode:S,setTextRange:v,skipParentheses:b,skipPartiallyEmittedExpressions:E,SyntaxKind:N,TransformFlags:C,visitEachChild:_,visitNode:I,visitNodes:D}=t,{factory:A,hoistVariableDeclaration:P}=r;return o(r,(function(e){if(e.isDeclarationFile)return e;return _(e,O,r)}));function O(e){if(!(e.transformFlags&C.ContainsES2020))return e;switch(e.kind){case N.CallExpression:{const t=k(e,!1);return a.assertNotNode(t,g),t}case N.PropertyAccessExpression:case N.ElementAccessExpression:if(m(e)){const t=$(e,!1,!1);return a.assertNotNode(t,g),t}return _(e,O,r);case N.BinaryExpression:return e.operatorToken.kind===N.QuestionQuestionToken?function(e){let t=I(e.left,O,p),r=t;y(t)||(r=A.createTempVariable(P),t=A.createAssignment(r,t));return v(A.createConditionalExpression(U(t,r),void 0,r,void 0,I(e.right,O,p)),e)}(e):_(e,O,r);case N.DeleteExpression:return function(e){return m(b(e.expression))?S(F(e.expression,!1,!0),e):A.updateDeleteExpression(e,I(e.expression,O,p))}(e);default:return _(e,O,r)}}function w(e,t,r){const i=F(e.expression,t,r);return g(i)?A.createSyntheticReferenceExpression(A.updateParenthesizedExpression(e,i.expression),i.thisArg):A.updateParenthesizedExpression(e,i)}function k(e,t){if(m(e))return $(e,t,!1);if(h(e.expression)&&m(b(e.expression))){const t=w(e.expression,!0,!1),r=D(e.arguments,O,p);return g(t)?v(A.createFunctionCallCall(t.expression,t.thisArg,r),e):A.updateCallExpression(e,t,void 0,r)}return _(e,O,r)}function F(r,s,n){switch(r.kind){case N.ParenthesizedExpression:return w(r,s,n);case N.PropertyAccessExpression:case N.ElementAccessExpression:return function(r,s,n){if(m(r))return $(r,s,n);const o=i.getTypeAtLocation(r.expression);let c,l=I(r.expression,O,p);return a.assertNotNode(l,g),s&&(y(l)?c=l:(c=A.createTempVariable(P,void 0,void 0,void 0,e?J(o,r,t,i):void 0),l=A.createAssignment(c,l))),l=r.kind===N.PropertyAccessExpression?A.updatePropertyAccessExpression(r,l,I(r.name,O,u)):A.updateElementAccessExpression(r,l,I(r.argumentExpression,O,p)),c?A.createSyntheticReferenceExpression(l,c):l}(r,s,n);case N.CallExpression:return k(r,s);default:return I(r,O,p)}}function $(r,o,h){const{expression:b,chain:C}=function(e){if(a.assertNotNode(e,f),f(e))throw new Error("Unexpected non-null chain");const t=[e];for(;!e.questionDotToken&&!x(e);)e=n(E(e.expression),m),a.assertNotNode(e,f),t.unshift(e);return{expression:e.expression,chain:t}}(r),_=i.getTypeAtLocation(b),w=F(E(b),l(C[0]),!1);let k=g(w)?w.thisArg:void 0,$=g(w)?w.expression:w,R=A.restoreOuterExpressions(b,$,T.PartiallyEmittedExpressions);y($)||($=A.createTempVariable(P,void 0,void 0,void 0,e?J(_,r,t,i):void 0),R=A.createAssignment($,R));let L,j=$;for(let r=0;r<C.length;r++){const n=C[r];switch(n.kind){case N.PropertyAccessExpression:case N.ElementAccessExpression:if(r===C.length-1&&o)if(y(j))L=j;else{const r=i.getTypeAtLocation(n.expression);L=A.createTempVariable(P,void 0,void 0,void 0,e?J(r,n,t,i):void 0),j=A.createAssignment(L,j)}j=n.kind===N.PropertyAccessExpression?A.createPropertyAccessExpression(j,I(n.name,O,u)):A.createElementAccessExpression(j,I(n.argumentExpression,O,p));break;case N.CallExpression:0===r&&k?(d(k)||(k=A.cloneNode(k),s(k,c.NoComments)),j=A.createFunctionCallCall(j,k.kind===N.SuperKeyword?A.createThis():k,D(n.arguments,O,p))):j=A.createCallExpression(j,void 0,D(n.arguments,O,p))}S(j,n)}const M=h?A.createConditionalExpression(U(R,$,!0),void 0,A.createTrue(),void 0,A.createDeleteExpression(j)):A.createConditionalExpression(U(R,$,!0),void 0,A.createNull(),void 0,j);return v(M,r),L?A.createSyntheticReferenceExpression(M,L):M}function U(e,t,r){return A.createBinaryExpression(A.createBinaryExpression(e,A.createToken(r?N.EqualsEqualsEqualsToken:N.ExclamationEqualsEqualsToken),A.createNull()),A.createToken(r?N.BarBarToken:N.AmpersandAmpersandToken),A.createBinaryExpression(t,A.createToken(r?N.EqualsEqualsEqualsToken:N.ExclamationEqualsEqualsToken),A.createVoidZero()))}}r("uts:transformer:generics"),r("uts:transformer:in"),r("uts:transformer:keyof"),r("uts:transformer:narrowType:discriminatedUnion"),r("uts:transformer:narrowType:nonNullable"),r("uts:transformer:narrowType"),r("uts:transformer:narrowType:parameterUnionType"),r("uts:transformer:UTSObjectUnionType"),r("uts:transformer:objectLiteral");function H(e,t){return e.isExpressionStatement(t)&&e.isCallExpression(t.expression)&&e.isIdentifier(t.expression.expression)&&"defineExpose"===t.expression.expression.text}function G(e,t){return e.createExportAssignment(void 0,void 0,e.createCallExpression(e.createIdentifier("defineComponent"),void 0,[e.createObjectLiteralExpression([e.createMethodDeclaration(void 0,void 0,e.createIdentifier("setup"),void 0,void 0,[e.createParameterDeclaration(void 0,void 0,e.createIdentifier("props"),void 0,void 0,void 0),e.createParameterDeclaration(void 0,void 0,e.createObjectBindingPattern([e.createBindingElement(void 0,void 0,e.createIdentifier("expose"),void 0)]),void 0,void 0,void 0)],void 0,e.createBlock(t,!0))],!0)]))}r("uts:transformer:returnType"),r("uts:transformer:UTSJSONObject"),globalThis.__utsUniXGlobalProperties__=globalThis.__utsUniXGlobalProperties__||new Map;let Z=null,X=[];const Q=["defineMixin","definePlugin"],Y=new Map;Y.set("onShow",!1),Y.set("onHide",!1),Y.set("onAppShow",!0),Y.set("onLaunch",!0),Y.set("onError",!0),Y.set("onThemeChange",!0),Y.set("onKeyboardHeightChange",!0),Y.set("onPageNotFound",!0),Y.set("onUnhandledRejection",!0),Y.set("onLastPageBackPress",!1),Y.set("onExit",!1),Y.set("onLoad",!0),Y.set("onShow",!0),Y.set("onReady",!1),Y.set("onUnload",!1),Y.set("onResize",!0),Y.set("onBackPress",!0),Y.set("onPageScroll",!0),Y.set("onTabItemTap",!0),Y.set("onReachBottom",!1),Y.set("onPullDownRefresh",!1),Y.set("beforeCreate",!1),Y.set("created",!1),Y.set("beforeMount",!1),Y.set("mounted",!1),Y.set("beforeUpdate",!1),Y.set("updated",!1),Y.set("beforeUnmount",!1),Y.set("unmounted",!1);function ee(e,t){const{ts:r}=e;return e.context.factory.createPropertyAccessExpression(r.isQualifiedName(t.left)?ee(e,t.left):t.left,t.right)}function te(e,t,r){const{ts:i}=e,s=e.context.factory,n=i.isQualifiedName(r)?ee(e,r):s.createIdentifier(r.escapedText.toString());return s.createNewExpression(n,void 0,[t])}function re(e,t){const{ts:r}=e,i=e.context,s=e.typeChecker,n=i.factory,{type:o,expression:a}=t;if(!r.isObjectLiteralExpression(a))return;if(r.isTypeReferenceNode(o)&&r.isIdentifier(o.typeName)&&"UTSJSONObject"===o.typeName.escapedText)return n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[a]);let c;try{c=s.getContextualType(a)?.symbol}catch(e){}return c?c&&"UTSJSONObject"===c.escapedName?n.createNewExpression(n.createIdentifier("UTSJSONObject"),void 0,[a]):o&&function(e,t){const r=e.typeChecker.getContextualType(t);return!(!r||!F(e,r))}(e,a)&&r.isObjectLiteralExpression(a)?te(e,a,o.typeName):void 0:void 0}const ie={Array_pop:"arrayPop",Array_shift:"arrayShift",Array_find:"arrayFind",Array_findLast:"arrayFindLast",Array_at:"arrayAt",Map_get:"mapGet",WeakMap_get:"weakMapGet",string_codePointAt:"stringCodePointAt",string_at:"stringAt"},se=Object.keys(ie).map((e=>e.split("_")[1])),ne=["uni.request","JSON.parse","JSON.parseArray","JSON.parseObject"];function oe(e,t){const r=e.ts,i=e.context,s=i.factory;if(r.isArrayTypeNode(t)){const{elementType:r}=t;return s.createCallExpression(s.createPropertyAccessExpression(s.createPropertyAccessExpression(v(i),s.createIdentifier("UTSType")),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier("Array"),s.createArrayLiteralExpression([oe(e,r)]),s.createTrue()])}if(r.isTypeReferenceNode(t)){const{typeName:n,typeArguments:o}=t;if(!r.isIdentifier(n)){const e=r.createDiagnosticForNode(n,I.Invalid_generic_type_which_can_not_be_constructed);return i.addBindDiagnostic(e),s.createIdentifier("UTSJSONObject")}return o&&0!==o.length?s.createCallExpression(s.createPropertyAccessExpression(s.createPropertyAccessExpression(v(i),s.createIdentifier("UTSType")),s.createIdentifier("withGenerics")),void 0,[s.createIdentifier(n.escapedText.toString()),s.createArrayLiteralExpression(o.map((t=>oe(e,t)))),s.createTrue()]):s.createIdentifier(n.escapedText.toString())}return R(e,t)}const ae=["Array","Map","WeakMap","string","String","number","Number","boolean","Boolean","UTSJSONObject"];function ce(e,t,r,i){const s=O(e,t,void 0),n=t.getNullType(),o=t.getUndefinedType(),a=t.getVoidType(),c=t.getStringType();function l(e){let t=e.getBaseTypes();return 1===t?.length&&"String"===t[0].getSymbol()?.getName()}function p(e){return e===o||e===a}return!!(s.isObjectLiteralType(r)&&s.isPossibleUTSJSONObjectType(i)||s.isObjectLiteralType(i)&&s.isPossibleUTSJSONObjectType(r))||(!!(p(r)&&i===n||r===n&&p(i))||(!!(r===c&&l(i)||l(r)&&i===c)||void 0))}const le=b(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules"));const pe=new RegExp("^"+D+"/([a-zA-Z0-9_-]+)/index.d.ts$");const de="app-ios"===process.env.UNI_UTS_PLATFORM;let ue=[];ue=de?["app-js/index.uts","app-js/index.ts","app-js/index.js"]:[`${process.env.UNI_UTS_PLATFORM}/index.uts`,`${process.env.UNI_UTS_PLATFORM}/index.ts`,`${process.env.UNI_UTS_PLATFORM}/index.js`];const fe={replaceVueTypes:function(e,t){return e.endsWith("runtime-core.d.ts")&&(t=(t=(t=t.replace(/type ObjectInjectOptions = Record<([\s\S]+?)>;/,"type ObjectInjectOptions<I = Data> = {\n    [K in keyof I]: {\n      type: PropType<I[K]>;\n      from?: string;\n      default?: I[K] | (() => I[K]);\n    }\n  };")).replace(/type InjectToObject<T([\s\S]+?): never;/,"type InjectToObject<T> = T extends string[] ? {\n    [K in T[number]]: unknown;\n  } : T extends ObjectInjectOptions<infer I> ? {\n    [K in keyof I]: I[K];\n  } : never;")).replace(/serverPrefetch\?\(\): void \| Promise<any>;/,"serverPrefetch?(): void | Promise<any | null>;")),e.endsWith("app.d.ts")&&(t=t.replace(/\s\sexport function defineApp<D extends OptionsData = OptionsData.*/,"")),t},isTypeRelatedTo:function(e,t,r,i){return ce(e,t,r,i)},isRelatedTo:ce,tryFileLookup:function(e){if(!process.env.UNI_INPUT_DIR)return;const t=function(e){const t=e.match(pe);return t?t[1]:""}(e);if(t){const e=x.resolve(D,t,"utssdk");for(let t=0;t<ue.length;t++){const r=ue[t],i=x.resolve(e,r);if(N(i))return b(i)}if(de)return;const r=x.resolve(D,t,"utssdk/index.uts");if(N(r))return b(r)}else if(e.endsWith(".d.ts")&&!N(e)){const t=e.replace(/\.d\.ts$/,""),r=t+".uvue";if(N(r))return r+".ts";const i=t+".vue";if(N(i))return i+".ts"}else if(e.endsWith(".json")&&N(e))return e+".ts"},componentPublicInstancePropertyAccessFallback:function(e,t,r,i,s,n){if(!e.isPropertyAccessExpression(r)||!e.isExpression(i)||!e.isIdentifier(n))return;const o=s.aliasSymbol?.escapedName.toString();if("ComponentPublicInstance"!==o&&"CreateComponentPublicInstance"!==o)return;const a=n.escapedText.toString(),c=globalThis?.__utsUniXGlobalProperties__;if(c&&c.has(a)){const{initializerNode:r}=c.get(a),i=t.getTypeAtLocation(r);return i.isNumberLiteral()?t.getNumberType():i.isStringLiteral()?t.getStringType():i.flags&e.TypeFlags.BooleanLiteral?t.getBooleanType():i}},isRequireIOSNativeUtsSdk:function(e,t){if(!process.env.UNI_INPUT_DIR)return!1;if("app-ios"!==process.env.UNI_UTS_PLATFORM)return!1;let r=t;if(t.startsWith("@/"))r=x.resolve(process.env.UNI_INPUT_DIR,t.slice(2));else if(t.startsWith("."))r=x.resolve(x.dirname(e),t);else if(!x.isAbsolute(t))return!1;const i=x.relative(le,r).replace(/\\/g,"/");return!(i.startsWith(".")||i.indexOf("/")>-1)&&!(!N(x.resolve(le,i,"utssdk"))||N(x.resolve(le,i,"utssdk/app-js")))},isUtsCompiler:!0,hijackAnyNullUnionType:!0,hijackTsLibResolve:!0,hijackDestructuring:!0,ignoreInstanceofLeftType:!0,ignoreInstanceofRightType:!0,useTypeAndInterfaceAsValue:!0,ignoreAllDebugFail:!0};var me=[(e,t,r)=>({before(i){const s=t.getProgram().getTypeChecker(),n=q("ArkTS"===r.targetLanguage,e,i,s);return e=>n(e)}}),(e,r)=>{function i(r,i){if(e.isSourceFile(i)){if(!i.__relativeFileName){const e=r.getCompilerOptions();if(e.rootDir&&t.isAbsolute(e.rootDir)){const r=b(e.rootDir),s=b(i.fileName);i.__rootDir=r,s.startsWith(r)?i.__relativeFileName=b(t.relative(r,s)):s.includes("/@dcloudio/")&&(i.__relativeFileName="@dcloudio/"+s.split("/@dcloudio/")[1])}i.__relativeFileName||(i.__relativeFileName=t.basename(i.fileName))}if(!r.printNode){const t=e.createPrinter();r.printNode=(r,i)=>t.printNode(e.EmitHint.Unspecified,r,i)}r.addBindDiagnostic||(r.addBindDiagnostic=e=>{i.bindDiagnostics.push(e)},r.addBindSuggestionDiagnostic=e=>{i.bindSuggestionDiagnostics||(i.bindSuggestionDiagnostics=[]),i.bindSuggestionDiagnostics.push(e)})}return i}return{before:e=>t=>i(e,t),after:e=>t=>i(e,t),afterDeclarations:e=>t=>i(e,t)}},(e,t)=>({parser:{SourceFile(t){const r=t.factory;function i(e){if(e.endsWith(".uts")||e.endsWith(".ts"))return e.replace(/.u?ts$/,"")}let s=[];function n(o){if(e.isImportDeclaration(o)||e.isExportDeclaration(o)){let t=o.moduleSpecifier;if(t&&e.isStringLiteral(t)){const e=t.text,r=/@\/uni_modules\/([a-zA-Z0-9_-]+)/,i=e.match(r)?.[1];if(i){N(x.resolve(D,i,"encrypt"))&&s.push({range:{pos:Math.max(o.pos-1,0),end:o.pos},type:1})}}}if(e.isImportDeclaration(o)&&o.moduleSpecifier&&e.isStringLiteral(o.moduleSpecifier)){const e=i(o.moduleSpecifier.text);e&&(o=r.updateImportDeclaration(o,o.modifiers,o.importClause,r.createStringLiteral(e),o.assertClause))}if(e.isExportDeclaration(o)&&o.moduleSpecifier&&e.isStringLiteral(o.moduleSpecifier)){const e=i(o.moduleSpecifier.text);e?o=r.updateExportDeclaration(o,o.modifiers,!1,o.exportClause,r.createStringLiteral(e),o.assertClause):o.isTypeOnly&&(o=r.updateExportDeclaration(o,o.modifiers,!1,o.exportClause,o.moduleSpecifier,o.assertClause))}return e.isImportClause(o)&&o.isTypeOnly?o=r.updateImportClause(o,!1,o.name,o.namedBindings):e.isImportSpecifier(o)&&o.isTypeOnly?o=r.updateImportSpecifier(o,!1,o.propertyName,o.name):e.isExportSpecifier(o)&&o.isTypeOnly&&(o=r.updateExportSpecifier(o,!1,o.propertyName,o.name)),e.visitEachChild(o,n,t)}return t=>(t=e.visitNode(t,n),s.length>0&&(t.commentDirectives=t.commentDirectives||[],t.commentDirectives.push(...s),s.length=0),t)}}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker();null===Z&&i.getGlobalType&&(Z=i.getGlobalType("UniApp",0,!1),Z&&(X=Z.getProperties().map((e=>e.getName()))));const s=t=>{if(Z&&X.length){if(e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&e.isIdentifier(t.expression.name)){const r=function(e,t){return e.getContextualType(t)??e.getTypeAtLocation(t)}(i,t.expression.expression);if(r&&r.isIntersection()&&r.types.some((e=>"UniApp"===e.symbol?.name))&&!X.includes(t.expression.name.text)){console.error(`error: '${t.expression.name.text}' 不是 UniApp 对象的方法，请检查是否拼写错误，如果想调用在 App.uvue 文件中定义的 methods 方法，请使用 .vm?.xxx 的方式调用，详情参考：https://doc.dcloud.net.cn/uni-app-x/api/get-app.html#appmethods`);const r=t.getSourceFile();if(r.__relativeFileName){const i=e.getLineAndCharacterOfPosition(r,t.pos),s=r.__relativeFileName.split("?")[0].replace(/\.(vue|uvue|uts).ts$/g,".$1");console.error("at "+s+":"+i.line)}}}return e.visitEachChild(t,s,r)}return t};return t=>e.visitNode(t,s)}}),e=>({parser:{SourceFile:t=>r=>{const i=s=>{if(e.isCallExpression(s)&&e.isPropertyAccessExpression(s.expression)){const t=s.expression.expression,i=s.expression.name;if(e.isIdentifier(t)&&e.isIdentifier(i)){const e=t.text;"uni"!==e&&"uniCloud"!==e||(r.__utsMeta||(r.__utsMeta={}),r.__utsMeta.uniExtApis||(r.__utsMeta.uniExtApis=new Set),r.__utsMeta.uniExtApis.add(e+"."+i.text))}}return e.visitEachChild(s,i,t)};return e.visitNode(r,i)}}}),e=>({parser:{SourceFile(t){const{factory:r}=t;let i=!1,s=!1;const n=o=>{if(e.isSourceFile(o)){if(s&&o.text.startsWith("// @uts-setup\n")){const i=o.statements,s=[],n=[],a=[];for(let o=0;o<i.length;o++){const c=i[o];if(e.isImportDeclaration(c))s.push(c);else if(e.isExportAssignment(c)){if(e.isObjectLiteralExpression(c.expression)&&0===c.expression.properties.length)continue;const r=e.createDiagnosticForNode(c,I.script_setup_cannot_contain_ES_module_exports);t.addBindDiagnostic(r)}else H(e,c)?a.push(r.createReturnStatement(c.expression.arguments[0])):n.push(c)}return r.updateSourceFile(o,[...s,G(r,[...n,...a])])}return e.visitEachChild(o,n,t)}return e.isExportAssignment(o)&&e.isObjectLiteralExpression(o.expression)?r.updateExportAssignment(o,o.modifiers,r.createCallExpression(r.createIdentifier(i?"defineApp":"defineComponent"),void 0,[o.expression])):o};return t=>{if(!t.isVueFile||t.fileName.indexOf("setup=true")>-1)return t;const o=x.basename(t.fileName).split("?")[0].toLowerCase();"app.uvue"!==o&&"app.uvue.ts"!==o||(i=!0),/.u?vue.ts/.test(o)&&(s=!0);const a=e.visitNode(t,n);return a!==t?r.updateSourceFile(a,[r.createImportDeclaration(void 0,r.createImportClause(!1,void 0,r.createNamedImports([r.createImportSpecifier(!1,void 0,r.createIdentifier(i?"defineApp":"defineComponent"))])),r.createStringLiteral("vue")),...a.statements]):a}}},before(t){const{factory:r}=t,i=s=>e.isSourceFile(s)?e.visitEachChild(s,i,t):e.isExportAssignment(s)&&e.isCallExpression(s.expression)?r.updateExportAssignment(s,s.modifiers,r.createCallExpression(r.createIdentifier("defineComponent"),void 0,s.expression.arguments)):e.isImportDeclaration(s)&&s.moduleSpecifier&&e.isStringLiteral(s.moduleSpecifier)&&"vue"===s.moduleSpecifier.text&&s.importClause&&e.isImportClause(s.importClause)&&s.importClause.namedBindings&&e.isNamedImports(s.importClause.namedBindings)&&s.importClause.namedBindings.elements.some((e=>"defineApp"===e.name.text))?r.updateImportDeclaration(s,s.modifiers,r.updateImportClause(s.importClause,!1,void 0,r.createNamedImports(s.importClause.namedBindings.elements.filter((e=>"defineApp"!==e.name.text)))),s.moduleSpecifier,s.assertClause):s;return t=>t.isVueFile?("app.uvue"===x.basename(t.fileName).split("?")[0].toLowerCase()&&(t=e.visitNode(t,i)),t):t}}),(e,t)=>({parser:{SourceFile:t=>{const r=t.factory,i=s=>(e.isMethodDeclaration(s)&&e.isIdentifier(s.name)&&"valueIterator"===s.name.escapedText&&(s=r.updateMethodDeclaration(s,s.modifiers,s.asteriskToken,r.createComputedPropertyName(r.createPropertyAccessExpression(r.createIdentifier("Symbol"),r.createIdentifier("iterator"))),s.questionToken,s.typeParameters,s.parameters,s.type,s.body)),e.isExpressionWithTypeArguments(s)&&e.isIdentifier(s.expression)&&"UTSValueIterable"===s.expression.escapedText&&(s=r.updateExpressionWithTypeArguments(s,r.createIdentifier("Iterable"),s.typeArguments)),e.visitEachChild(s,i,t));return r=>e.visitEachChild(r,i,t)}}}),(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=O(e,void 0,t),s=n=>{if(e.isParameter(n)&&!n.type&&!n.dotDotDotToken){const t=n.parent;if(t&&(e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t))&&0===t.parameters.indexOf(n)){const s=i.getMethodNameNodeOfObjectLiteral(t);if(s&&e.isIdentifier(s)){const t=s.escapedText.toString();if(!0===Y.get(t)){const i=s?.parent?.parent?.parent;if(i&&e.isCallExpression(i)){const s=i.expression;if(e.isIdentifier(s)&&P(s.escapedText.toString()))return r.updateParameterDeclaration(n,n.modifiers,n.dotDotDotToken,n.name,n.questionToken,r.createTypeReferenceNode(r.createIdentifier(t.replace(/^(\w)/,(e=>e.toUpperCase()))+"Options"),void 0),n.initializer)}}}}}return e.visitEachChild(n,s,t)};return r=>r.isVueFile?e.visitEachChild(r,s,t):r}}}),(e,t)=>({parser:{TypeAliasDeclaration:t=>function(r){const i=t.factory,{modifiers:s=[],name:n,typeParameters:o=[],type:a}=r;return e.isTypeLiteralNode(a)&&(r=i.updateTypeAliasDeclaration(r,s,n,o,i.updateTypeLiteralNode(a,i.createNodeArray([i.createIndexSignature(void 0,[i.createParameterDeclaration(void 0,void 0,i.createIdentifier("key"),void 0,i.createKeywordTypeNode(e.SyntaxKind.StringKeyword),void 0)],i.createKeywordTypeNode(e.SyntaxKind.AnyKeyword)),...a.members])))),r},SourceFile(t){const r=O(e,void 0,t),i=s=>{if(e.isTypeAliasDeclaration(s)&&e.isTypeLiteralNode(s.type)){const{modifiers:t=[],name:i,typeParameters:n=[],type:o}=s,a=o.members,c=function(e,t,r,i,s){const{ts:n}=e,o=e.context.factory,a=[],c=s?s.map((t=>{const{modifiers:r,name:i,questionToken:s,jsDoc:c}=t;let l;if(n.isPropertySignature(t))l=t.type;else if(n.isMethodSignature(t)){const{type:e,typeParameters:r,parameters:i}=t;l=o.createFunctionTypeNode(r,i,e)}const p=l&&e.createTypeNodeWithNullType(l,!!s);a.push(o.createPropertySignature(void 0,i,s,p));const d=o.createPropertyDeclaration(r,i,s,p,void 0);return d.jsDoc=c,d})):[],l=o.createTypeLiteralNode(a),p=[],d=o.createIndexSignature(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("key"),void 0,o.createKeywordTypeNode(n.SyntaxKind.StringKeyword),void 0)],o.createKeywordTypeNode(n.SyntaxKind.AnyKeyword)),u=o.createConstructorDeclaration(void 0,[o.createParameterDeclaration(void 0,void 0,o.createIdentifier("options"),void 0,l,void 0)],o.createBlock([o.createExpressionStatement(o.createCallExpression(o.createSuper(),void 0,[])),...(s||[]).map((e=>{const t=e.name.escapedText.toString();return o.createExpressionStatement(o.createBinaryExpression(o.createPropertyAccessExpression(o.createThis(),o.createIdentifier(t)),o.createToken(n.SyntaxKind.EqualsToken),o.createPropertyAccessExpression(o.createIdentifier("options"),o.createIdentifier(t))))}))],!0));return p.push(d,...c,u),o.createClassDeclaration(t,r,i?.length?i:void 0,[o.createHeritageClause(n.SyntaxKind.ExtendsKeyword,[o.createExpressionWithTypeArguments($(e),void 0)])],p)}(r,[...t],i,[...n],[...a.filter((t=>e.isPropertySignature(t)||e.isMethodSignature(t)))]);c&&(s=c)}else e.isInterfaceDeclaration(s);return s=e.visitEachChild(s,i,t)};return t=>e.visitNode(t,i)}},before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=r.factory,o=t=>{if(e.isPropertyAccessExpression(t)&&U(s,t))t=n.createPropertyAccessExpression(v(r),n.createIdentifier("UTSType"));else if(e.isClassDeclaration(t)){const{heritageClauses:e}=t,r=e?.[0]?.types?.[0]?.expression;r&&U(s,r)&&(t=M(s,t))}return t=e.visitEachChild(t,o,r)};return t=>e.visitNode(t,o)}}),(e,t)=>({parser:{SourceFile(t){const r=t.factory,i=O(e,void 0,t),s=n=>{const o=n.parent;if(o&&e.isObjectLiteralExpression(n)){if(i.isSetupReturnValue(n))return n;if(function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isVariableDeclaration(i)&&!i.type}(i,n)||function(e,t){const{ts:r}=e,i=t.parent;return i&&r.isPropertyAccessExpression(i)&&i.expression===t||r.isParenthesizedExpression(i)&&i.parent&&r.isPropertyAccessExpression(i.parent)&&i.parent.expression===i}(i,n)||e.isExportAssignment(o)||!w.includes(o.kind))return r.createAsExpression(n,r.createTypeReferenceNode(r.createIdentifier("UTSJSONObject"),void 0))}return n=e.visitEachChild(n,s,t)};return t=>e.visitNode(t,s)}},before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=new Map,o=t=>{let i=e.visitEachChild(t,o,r);if(e.isObjectLiteralExpression(i)){if(s.isSetupReturnValue(i))return i;i=function(e,t,r){const{ts:i}=e,s=e.context,n=e.typeChecker,o=s.factory,a=i.getOriginalNode(t)||t;if((a.flags&i.NodeFlags.Synthesized)===i.NodeFlags.Synthesized)return;const c=a?.parent;if(c&&i.isAsExpression(c)||e.isComponentDataOrProvide(a)||e.isComponentOptions(a)||e.isComponentOptionsProperty(a)||e.isComponentProp(a)||e.isCreateAppReturnValue(a))return;const l=i.getContainerNode(a);if(l&&i.isMethodDeclaration(l)&&l.modifiers&&l.modifiers.some((e=>e.kind===i.SyntaxKind.StaticKeyword))&&i.isIdentifier(l.name)&&"get$UTSMetadata$"===l.name.escapedText)return;const p=n.getContextualType(t);if(e.shouldTransfromToUTSJSONObject(t,p))return o.createAsExpression(t,o.createTypeReferenceNode("UTSJSONObject",void 0));const d=p.symbol,u=d?.escapedName;if(!u||!F(e,p))return;if(n.isSymbolAccessible(d,t,i.SymbolFlags.Class,!0).accessibility!==i.SymbolAccessibility.Accessible)return n.markSymbolAsNotTypeOnly(d),o.createAsExpression(t,o.createTypeReferenceNode(n.symbolToEntityName(d,i.SymbolFlags.Class,t,void 0),void 0));const f=n.getAccessibleSymbolChain(d,t,d.flags,!1);let m;if(f&&f.length>0)m=n.symbolToEntityName(d,i.SymbolFlags.Class,t,void 0);else{const s=d.declarations;if(!s||1!==s.length)return;const n=s[0].getSourceFile(),a=t.getSourceFile();if(n===a)return;let c,l;if(r.has(d)){const e=r.get(d);c=e.alias,l=e.importDeclaration}else{const t=d.escapedName;if(c=i.getUniqueName(t,a),l=function(e,t,r,i){const{ts:s}=e,n=e.context,o=e.typeChecker;let a="";if(1!==(r?.declarations||[]).length)return;const c=t.symbol?.exports;for(const e of c.keys()){const t=c.get(e).declarations||[];if(1!==t.length)continue;const i=t[0];let n,l;if(s.isClassDeclaration(i)?l=i.name:s.isExportAssignment(i)?l=i.expression:s.isExportSpecifier(i)&&(l=i.name),n=l&&(o.getContextualType(l)?.symbol||o.getTypeAtLocation(l)?.symbol),n===r){a=e;break}}if(!a)return;const l=n.factory,p=l.createIdentifier(i);return"default"===a?l.createImportDeclaration(void 0,l.createImportClause(!1,p,void 0),l.createStringLiteral(t.fileName),void 0):l.createImportDeclaration(void 0,l.createImportClause(!1,void 0,l.createNamedImports([l.createImportSpecifier(!1,a!==i?l.createIdentifier(a):void 0,p)])),l.createStringLiteral(t.fileName),void 0)}(e,n,d,c),!l)return;r.set(d,{symbol:d,alias:c,importDeclaration:l})}m=o.createIdentifier(c)}return n.markSymbolAsNotTypeOnly(d),o.createAsExpression(t,o.createTypeReferenceNode(m,void 0))}(s,i,n)||i}return i};return t=>{const i=e.visitNode(t,o),s=[];for(const e of n.values())s.push(e.importDeclaration),t.locals.set(e.alias,e.symbol);const a=Array.from(i.statements);let c=0;for(let t=0;t<a.length;t++){const r=a[t];if(!e.isImportDeclaration(r))break;c=t+1}return a.splice(c,0,...s),r.factory.updateSourceFile(i,a,i.isDeclarationFile,i.referencedFiles,i.typeReferenceDirectives,i.hasNoDefaultLib,i.libReferenceDirectives)}}}),e=>({parser:{SourceFile:t=>r=>{const i=r.fileName,s=globalThis?.__utsUniXGlobalProperties__;if(s)for(const[e,t]of s)t.file===i&&s.delete(e);return function r(n){if(e.isBinaryExpression(n)){const{left:t,operatorToken:r,right:o}=n;if(r.kind===e.SyntaxKind.EqualsToken&&e.isPropertyAccessExpression(t)){const{expression:r,name:n}=t;if(e.isPropertyAccessExpression(r)){const{expression:t,name:a}=r;if("globalProperties"===a.escapedText.toString()&&e.isPropertyAccessExpression(t)){const{name:e}=t;"config"===e.escapedText.toString()&&s.set(n.escapedText.toString(),{file:i,initializerNode:o})}}}}return e.visitEachChild(n,r,t)}(r)}}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=t=>(e.isClassDeclaration(t)&&(t=function(e,t){const{ts:r}=e,i=e.context,s=e.typeChecker,n=i.factory,o=t.heritageClauses;if(!o)return t;const a=o.filter((e=>e.token===r.SyntaxKind.ImplementsKeyword));if(1!==a.length)return t;const c=a[0].types,l=[];for(let e=0;e<c.length;e++){const t=c[e];if(!t.expression||!r.isIdentifier(t.expression))continue;const i=s.getSymbolAtLocation(t.expression),n=i?.declarations||[];if(1!==n.length)continue;const o=n[0];r.isClassDeclaration(o)&&l.push(t.expression)}if(0===l.length)return t;const p=t.name?t.name.escapedText.toString():"";return n.updateClassDeclaration(t,t.modifiers,t.name,t.typeParameters,t.heritageClauses,[...j(e,p,0,l),...t.members])}(s,t)),t=e.visitEachChild(t,n,r));return t=>e.visitNode(t,n)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=r.factory,o=t=>{if(e.isAsExpression(t)&&t.type){const i=re(s,t);if(i)return n.createNewExpression(i.expression,i.typeArguments,[e.visitEachChild(t,o,r)])}return t=e.visitEachChild(t,o,r)};return t=>e.visitNode(t,o)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=t=>{if(e.isIdentifier(t)){if("JSON"===t.escapedText)return function(e){const t=e.context,r=t.factory;return v(t),r.createPropertyAccessExpression(r.createIdentifier("UTS"),r.createIdentifier("JSON"))}(s)}else e.isBinaryExpression(t)?t.operatorToken.kind===e.SyntaxKind.InstanceOfKeyword&&(t=function(e,t){const r=e.context,i=r.factory;return v(r),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier("UTS"),i.createIdentifier("isInstanceOf")),void 0,[t.left,t.right])}(s,t)):e.isCallExpression(t)&&e.isPropertyAccessExpression(t.expression)&&(t=function(e,t){const r=e.context,i=r.factory,s=e.typeChecker,n=e.ts,{expression:o,arguments:a}=t;if(!n.isPropertyAccessExpression(o))return t;const{expression:c,name:l}=o;if(n.isIdentifier(c)&&n.isIdentifier(l)&&ne.includes(`${c.escapedText}.${l.escapedText}`)){const r=t.typeArguments?.[0];if(r&&n.isTypeReferenceNode(r)&&r.pos>0&&n.isIdentifier(r.typeName)){const c=ae.includes(r.typeName.escapedText.toString());let l;if(!c&&(l=s.getSymbolAtLocation(r),!l)){const e=r.typeName.escapedText;l=s.getSymbolsInScope(t,n.SymbolFlags.Type).find((t=>t.escapedName===e))}if(c||l&&k(e,l))return i.updateCallExpression(t,o,void 0,[...a,oe(e,r)])}}if(!n.isIdentifier(l)||!se.includes(l.escapedText.toString()))return t;if(c.pos<0)return t;const p=s.getTypeAtLocation(c);let d="";s.isArrayType(p)?d="Array":s.isTypeAssignableTo(p,s.getStringType())&&(d="string");const u=p.symbol?.escapedName.toString();"Map"===u?d="Map":"WeakMap"===u&&(d="WeakMap");const f=l.escapedText,m=ie[`${d}_${f}`];return m?(v(r),i.createCallExpression(i.createPropertyAccessExpression(i.createIdentifier("UTS"),i.createIdentifier(m)),void 0,[c,...a])):t}(s,t));return t=e.visitEachChild(t,n,r)};return t=>e.visitNode(t,n)}}),(e,t)=>({before(r){const i=t.getProgram().getTypeChecker(),s=O(e,i,r),n=t=>(!e.isVariableDeclaration(t)||t.initializer||t.parent&&e.isCatchClause(t.parent)||!e.isIdentifier(t.name)?e.isParameter(t)?t=function(e,t){const{modifiers:r,dotDotDotToken:i,name:s,questionToken:n,type:o,initializer:a}=t;if(t.pos<0||a||i)return t;const c=e.context.factory,l=e.typeChecker,p=e.ts;return p.isMethodDeclaration(t.parent)&&p.isIdentifier(t.parent.name)&&"setup"===t.parent.name.text?t:n||e.isPossibleNullType(l.getTypeAtLocation(t))?c.updateParameterDeclaration(t,r,i,s,n,o&&e.createTypeNodeWithNullType(o,!0),a||c.createNull()):t}(s,t):(e.isFunctionDeclaration(t)||e.isMethodDeclaration(t)||e.isArrowFunction(t)||e.isFunctionExpression(t)||e.isGetAccessorDeclaration(t))&&(t=function(e,t){const r=e.ts,i=e.context,s=i.factory,n=e.typeChecker,{modifiers:o,type:a}=t,c=o?.some((e=>e.kind===r.SyntaxKind.AsyncKeyword));let l=!1,p=!1;if(a){const r=n.getSignatureFromDeclaration(t)?.getReturnType();if(r&&(l=e.isPossibleNullType(r),p=e.isPossiblePromiseNullType(r),!l&&!p))return t}return r.visitEachChild(t,(function e(t){return r.isFunctionLike(t)?t:r.isReturnStatement(t)&&!t.expression?s.updateReturnStatement(t,c||p?s.createCallExpression(s.createPropertyAccessExpression(s.createIdentifier("Promise"),s.createIdentifier("resolve")),void 0,[s.createNull()]):s.createNull()):r.visitEachChild(t,e,i)}),i)}(s,t)):t=function(e,t){const r=e.context.factory,i=e.typeChecker;return!t.initializer&&t.pos>0&&e.isPossibleNullType(i.getTypeAtLocation(t))?r.updateVariableDeclaration(t,t.name,t.exclamationToken,t.type,r.createNull()):t}(s,t),t=e.visitEachChild(t,n,r));return t=>e.visitNode(t,n)}}),e=>({before:t=>t=>(t.statements.forEach((t=>{if((e.isImportDeclaration(t)||e.isExportDeclaration(t))&&t.moduleSpecifier&&e.isStringLiteral(t.moduleSpecifier)){const e=t.moduleSpecifier.text;(e.endsWith(".uvue.ts")||e.endsWith(".vue.ts"))&&(t.moduleSpecifier.text=e.replace(/.u?ts$/,""))}})),t)}),e=>({before(t){const r=i=>{if(e.isCallExpression(i)&&e.isIdentifier(i.expression)&&i.arguments.length>0){const e=i.expression.escapedText.toString();Q.includes(e)&&(i=i.arguments[0])}return e.visitEachChild(i,r,t)};return t=>e.visitNode(t,r)}})];const he=s.normalizePath(x.resolve(process.env.UNI_INPUT_DIR||"","uni_modules")),ye=new RegExp("^"+he+"/([a-zA-Z0-9_-]+)/"),ge=/\.(u)?vue(.ts)?/;let xe;const Te=new Set;function Se(e){return ge.test(e)}function ve(e,t){if(xe=e,!xe.sys.__rewrited){const{fileExists:e,readFile:r,realpath:i}=xe.sys;xe.sys.realpath=e=>{const t=i?i(e):e;return t.endsWith(".ts")&&Te.has(s.normalizePath(e))?e.replace(".ts",".uts"):t},xe.sys.fileExists=t=>{const r=s.normalizePath(t),i=r.match(ye),n=i?i[1]:"";return(!n||!e(x.resolve(he,n,"encrypt")))&&(r.endsWith(".ts")&&e(r.replace(".ts",".uts"))?(Te.add(r),!0):!(!r.endsWith(".vue.ts")&&!r.endsWith(".uvue.ts")||!e(r.replace(/.ts$/,"")))||(!(!r.endsWith(".json.ts")||!e(r.replace(/.ts$/,"")))||e(t)))},xe.sys.readFile=(i,n)=>{if(i.endsWith(".ts")&&Te.has(s.normalizePath(i))){const e=i.replace(".ts",".uts"),s=r(e,n);if(null==s)return;return function(e,t){return t.uniCliShared.preUVueJs(t.uniCliShared.preUVueJs(e))}(s,t)}if(i.endsWith(".json.ts")){const o=i.replace(/.ts$/,"");if(e(o)){const e=r(o,n);if(null==e)return;return function(e,t){const r=t.uniCliShared.parseJson(e,!0);return s.dataToEsm(r,{preferConst:!0,compact:!0})}(e,t)}}if(i.endsWith(".vue.ts")||i.endsWith(".uvue.ts")){const s=i.replace(/.ts$/,"");if(e(s)){const e=r(s,n);if(null==e)return;return function(e,t){e=t.uniCliShared.preUVueJs(t.uniCliShared.preUVueHtml(e));const r=t.vueCompilerDom.parse(e).children.find((e=>"script"===e.tag)),i="export default {}";return r?r.props.some((e=>"setup"===e.name))?"// @uts-setup\n"+(r?.children[0]?.content||"")+"\n"+i:r?.children[0]?.content||i:i}(e,t)}}let o=r(i,n);if(null==o)return;i.endsWith("runtime-dom/dist/runtime-dom.d.ts")&&(o=o.replace("runtimeDOMBailTypes: Node | Window;",""));const a=globalThis?.__utsHacker__?.replaceVueTypes;return a?a(i,o):o},xe.sys.__rewrited=!0}}const be=new class{constructor(){this.getCanonicalFileName=x.normalize,this.getNewLine=()=>xe.sys.newLine}getCurrentDirectory(){return xe.sys.getCurrentDirectory()}};function Ee(e,t,r){return t.map((t=>function(e,t,r){const i={flatMessage:xe.flattenDiagnosticMessageText(t.messageText,be.getNewLine()),formatted:xe.formatDiagnosticsWithColorAndContext([t],be),category:t.category,code:t.code,type:e};if(t.file&&void 0!==t.start){let{line:e,character:n}=t.file.getLineAndCharacterOfPosition(t.start);if(r){const o=r.originalPositionFor({line:e+1,column:n,bias:p.SourceMapConsumer.LEAST_UPPER_BOUND});if(null!==o.line){if(o.source){const a=r.sourceContentFor(o.source);if(a){const{line:c,character:l}=t.file.getLineAndCharacterOfPosition(t.start+(t.length||0)),p=r.originalPositionFor({line:c+1,column:l});if(null!==p.line){const r=d.codeFrameColumns(a,{start:{line:o.line,column:(o.column||0)+1},end:{line:p.line,column:(p.column||0)+1}});i.rollupError=function(e,t,r,i,s){return{id:e,message:t,frame:s,loc:{file:e,line:r,column:i}}}(t.file.fileName,i.flatMessage,e+1,n+1,r),i.utsCompilerError={type:"UTSCompilerError",file:s.normalizePath(x.relative(process.env.UNI_INPUT_DIR,t.file.fileName.split("?")[0])),line:o.line,column:o.column||0,message:i.flatMessage,frame:r}}}}e=o.line}}i.fileLine=`${t.file.fileName}(${e+1},${n+1})`}return i}(e,t,r)))}function Ne(e,t,r=!0){t.forEach((t=>{let i,s,o;switch(t.category){case xe.DiagnosticCategory.Message:i=e.info,s=n.white,o="";break;case xe.DiagnosticCategory.Error:i=e.error,s=n.red,o="error";break;case xe.DiagnosticCategory.Warning:default:i=e.warn,s=n.yellow,o="warning"}const a=t.type+" ";return r?t.utsCompilerError?i.call(e,t.utsCompilerError):t.rollupError?i.call(e,t.rollupError):i.call(e,`${n.enabled?t.formatted:function(e){if("string"!=typeof e)throw new TypeError(`Expected a \`string\`, got \`${typeof e}\``);return e.replace(Ce,"")}(t.formatted)}`):void 0!==t.fileLine?i.call(e,`${t.fileLine}: ${a}${o} TS${t.code}: ${s(t.flatMessage)}`):i.call(e,`${a}${o} TS${t.code}: ${s(t.flatMessage)}`)}))}const Ce=function({onlyFirst:e=!1}={}){const t=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(t,e?void 0:"g")}();var _e;function Ie(e){return"string"==typeof e?e:e()}!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Debug=3]="Debug"}(_e||(_e={}));class De{constructor(e,t,r,i=""){this.verbosity=e,this.bail=t,this.context=r,this.prefix=i}warn(e){this.verbosity<_e.Warning||this.context.warn(`${Ie(e)}`)}error(e){this.verbosity<_e.Error||(this.bail?"string"==typeof e||"function"==typeof e?this.context.error(`${Ie(e)}`):this.context.error(e):"UTSCompilerError"===e.type?(console.warn(`warning: ${e.message}`),console.warn(`at ${e.file}:${e.line}:${e.column}`),console.log(e.frame)):"string"==typeof e||"function"==typeof e?this.context.warn(`${Ie(e)}`):this.context.warn(e))}info(e){this.verbosity<_e.Info||console.log(`${this.prefix}${Ie(e)}`)}debug(e){this.verbosity<_e.Debug||console.log(`${this.prefix}${Ie(e)}`)}}function Ae({useTsconfigDeclarationDir:e,cacheRoot:t},r){const i={noEmitHelpers:!1,importHelpers:!0,noResolve:!1,noEmit:!1,noEmitOnError:!1,inlineSourceMap:!1,outDir:s.normalizePath(`${t}/placeholder`),allowNonTsExtensions:!0};if(!r)return i;r.options.moduleResolution===xe.ModuleResolutionKind.Classic&&(i.moduleResolution=xe.ModuleResolutionKind.Node10),void 0===r.options.module&&(i.module=xe.ModuleKind.ES2015),e||(i.declarationDir=void 0);return r.options.sourceMap||(i.sourceRoot=void 0),i}function Pe(e,t){const r=[];return t.forEach((t=>{e instanceof Array?e.forEach((e=>r.push(s.normalizePath(x.join(t,e))))):r.push(s.normalizePath(x.join(t,e)))})),r}class Oe{constructor(e,t,r){this.parsedConfig=e,this.transformers=t,this.cwd=r,this.snapshots={},this.versions={},this.customParser={},this.getScriptFileNames=()=>Array.from(this.fileNames.values()),this.getCompilationSettings=()=>this.parsedConfig.options,this.getTypeRootsVersion=()=>0,this.getCurrentDirectory=()=>this.cwd,this.useCaseSensitiveFileNames=()=>xe.sys.useCaseSensitiveFileNames,this.getDefaultLibFileName=xe.getDefaultLibFilePath,this.readDirectory=xe.sys.readDirectory,this.readFile=xe.sys.readFile,this.fileExists=xe.sys.fileExists,this.directoryExists=xe.sys.directoryExists,this.getDirectories=xe.sys.getDirectories,this.realpath=xe.sys.realpath,this.trace=console.log,this.fileNames=new Set(e.fileNames)}reset(){this.snapshots={},this.versions={}}setLanguageService(e){e.shouldTransform=e=>!!e&&(function(e){return Se(e)||e.includes(".uts")||Te.has(s.normalizePath(e))}(e)||e.endsWith(".json.ts")||e.endsWith(".d.ts")),e.isVueFile=Se,this.service=e,this.customTransformers||this.initTransformers(this.transformers||[])}setSnapshot(e,t){(e=s.normalizePath(e)).endsWith(".uts")&&this.setSnapshot(e.replace(/\.uts$/,".ts"),t);const r=xe.ScriptSnapshot.fromString(t);return this.snapshots[e]=r,this.versions[e]=(this.versions[e]||0)+1,this.fileNames.add(e),r}getScriptSnapshot(e){if((e=s.normalizePath(e))in this.snapshots)return this.snapshots[e];const t=xe.sys.readFile(e);return null!=t?this.setSnapshot(e,t):void 0}getScriptVersion(e){return e=s.normalizePath(e),(this.versions[e]||0).toString()}initTransformers(e){if(void 0===this.service||void 0===e||0===this.transformers.length)return;const t={before:[],after:[],afterDeclarations:[]};for(const r of e){const e=r(this.service);e.parser&&(this.customParser=e.parser),e.before&&(t.before=t.before.concat(e.before)),e.after&&(t.after=t.after.concat(e.after)),e.afterDeclarations&&(t.afterDeclarations=t.afterDeclarations.concat(e.afterDeclarations))}return this.customTransformers=t,globalThis.__utsParser__=this.customParser,t}getCustomTransformers(){return this.customTransformers}setCompilerHost(e){}}class we{constructor(e){this.cacheRoot=e,this.rolled=!1,this.oldCacheRoot=`${this.cacheRoot}/cache`,this.newCacheRoot=`${this.cacheRoot}/cache_`,u.emptyDirSync(this.newCacheRoot)}exists(t){return!this.rolled&&(!!e.existsSync(`${this.newCacheRoot}/${t}`)||e.existsSync(`${this.oldCacheRoot}/${t}`))}path(e){return`${this.oldCacheRoot}/${e}`}match(t){return!this.rolled&&(e.existsSync(this.oldCacheRoot)?T.isEqual(e.readdirSync(this.oldCacheRoot).sort(),t.sort()):0===t.length)}read(t){return e.existsSync(`${this.newCacheRoot}/${t}`)?u.readJsonSync(`${this.newCacheRoot}/${t}`,{encoding:"utf8",throws:!1}):u.readJsonSync(`${this.oldCacheRoot}/${t}`,{encoding:"utf8",throws:!1})}write(e,t){this.rolled||void 0!==t&&u.writeJsonSync(`${this.newCacheRoot}/${e}`,t)}touch(e){this.rolled||u.ensureFileSync(`${this.newCacheRoot}/${e}`)}roll(){this.rolled||(this.rolled=!0,u.removeSync(this.oldCacheRoot),e.existsSync(this.newCacheRoot)&&e.renameSync(this.newCacheRoot,this.oldCacheRoot))}}function ke(e,t,r){const i={code:"",references:t,uniExtApis:r};return e.outputFiles.forEach((e=>{e.name.endsWith(".d.ts")?i.dts=e:e.name.endsWith(".d.ts.map")?i.dtsmap=e:e.name.endsWith(".map")?i.map=e.text:i.code=e.text})),i}class Fe{constructor(e,t,r,i,s,n,o,a){if(this.noCache=e,this.host=i,this.cacheRoot=s,this.options=n,this.context=a,this.cacheVersion="9",this.cachePrefix="uts_",this.ambientTypesDirty=!1,this.hashOptions={algorithm:"sha1",ignoreUnknown:!1},this.dependencyTree=new f.Graph({directed:!0}),this.dependencyTree.setDefaultNodeLabel((()=>({dirty:!1}))),t&&this.clean(),e)return;this.hashOptions.ignoreUnknown=r,this.cacheDir=`${this.cacheRoot}/${this.cachePrefix}${m({version:this.cacheVersion,rootFilenames:o,options:this.options,tsVersion:xe.version},this.hashOptions)}`,this.init();const c=xe.getAutomaticTypeDirectiveNames(n,xe.sys).map((e=>xe.resolveTypeReferenceDirective(e,void 0,n,xe.sys))).filter((e=>e.resolvedTypeReferenceDirective?.resolvedFileName)).map((e=>e.resolvedTypeReferenceDirective.resolvedFileName));this.ambientTypes=o.filter((e=>e.endsWith(".d.ts"))).concat(c).map((e=>({id:e,snapshot:this.host.getScriptSnapshot(e)}))),this.checkAmbientTypes()}clean(){if(!S.pathExistsSync(this.cacheRoot))return;S.readdirSync(this.cacheRoot).forEach((e=>{const t=`${this.cacheRoot}/${e}`;e.startsWith(this.cachePrefix)?S.statSync(t).isDirectory?(this.context.info(n.blue(`cleaning cache: ${t}`)),S.removeSync(`${t}`)):this.context.debug(`skipping cleaning '${t}' as it is not a directory`):this.context.debug(`skipping cleaning '${t}' as it does not have prefix '${this.cachePrefix}'`)}))}setDependency(e,t){this.context.debug(`${n.blue("dependency")} '${e}'`),this.context.debug(`    imported by '${t}'`),this.dependencyTree.setEdge(t,e)}walkTree(e){if(f.alg.isAcyclic(this.dependencyTree))return f.alg.topsort(this.dependencyTree).forEach((t=>e(t)));this.context.info(n.yellow("import tree has cycles")),this.dependencyTree.nodes().forEach((t=>e(t)))}done(){this.noCache||(this.context.info(n.blue("rolling caches")),this.codeCache.roll(),this.semanticDiagnosticsCache.roll(),this.syntacticDiagnosticsCache.roll(),this.typesCache.roll())}getCompiled(e,t,r){return this.context.info(`${n.blue("transpiling")} '${e}'`),this.getCached(this.codeCache,e,t,Boolean(!this.options.isolatedModules||this.options.declaration),r)}getSyntacticDiagnostics(e,t,r,i){return this.getDiagnostics("syntax",this.syntacticDiagnosticsCache,e,t,r,i)}getSemanticDiagnostics(e,t,r,i){return this.getDiagnostics("semantic",this.semanticDiagnosticsCache,e,t,r,i)}checkAmbientTypes(){this.context.debug(n.blue("Ambient types:"));const e=this.ambientTypes.filter((e=>void 0!==e.snapshot)).map((e=>(this.context.debug(`    ${e.id}`),this.createHash(e.id,e.snapshot))));this.ambientTypesDirty=!this.typesCache.match(e),this.ambientTypesDirty&&this.context.info(n.yellow("ambient types changed, redoing all semantic diagnostics")),e.forEach(this.typesCache.touch,this.typesCache)}getDiagnostics(e,t,r,i,s,n){return this.getCached(t,r,i,"semantic"===e,(()=>Ee(e,s(),n)))}getCached(e,t,r,i,s){if(this.noCache)return s();const o=this.createHash(t,r);if(this.context.debug(`    cache: '${e.path(o)}'`),e.exists(o)&&!this.isDirty(t,i)){this.context.debug(n.green("    cache hit"));const t=e.read(o);if(t)return e.write(o,t),t;this.context.warn(n.yellow("    cache broken, discarding"))}this.context.debug(n.yellow("    cache miss"));const a=s();return e.write(o,a),this.markAsDirty(t),a}init(){this.codeCache=new we(`${this.cacheDir}/code`),this.typesCache=new we(`${this.cacheDir}/types`),this.syntacticDiagnosticsCache=new we(`${this.cacheDir}/syntacticDiagnostics`),this.semanticDiagnosticsCache=new we(`${this.cacheDir}/semanticDiagnostics`)}markAsDirty(e){this.dependencyTree.setNode(e,{dirty:!0})}isDirty(e,t){const r=this.dependencyTree.node(e);if(!r)return!1;if(!t||r.dirty)return r.dirty;if(this.ambientTypesDirty)return!0;const i=f.alg.dijkstra(this.dependencyTree,e);return Object.keys(i).some((e=>{const t=i[e];if(!e||t.distance===1/0)return!1;const r=this.dependencyTree.node(e),s=void 0===r||r.dirty;return s&&this.context.debug(`    import changed: ${e}`),s}))}createHash(e,t){const r=t.getText(0,t.getLength());return m({data:r,id:e,compilerVersion:process.env.HX_Version||process.env.UNI_COMPILER_VERSION},this.hashOptions)}}const $e="tslib",Ue="\0tslib.js",Re=">=5.0.0",Le=">=3.0.0";class je extends o.EventEmitter{constructor(){super(),this._codeMap=new Map,this._easycomUsage=new Map,this._easycoms=[]}has(e){return this._codeMap.has(s.normalizePath(e))}set(e,t){const r=s.normalizePath(e);this.get(r)!==t&&(this._codeMap.set(e,t),this.emit("change",{fileName:r,source:t}))}get(e){return this._codeMap.get(s.normalizePath(e))}forEach(e){this._codeMap.forEach(e)}initUts2jsEasycom(e=this._easycoms){this._easycoms=e||[],this.set("/__uts2js_vfs__/shim-uni-easycom.d.ts",function(e){let t="",r="";return e.forEach(((e,i)=>{const s=c.kebabCase(i).replace(e.pattern,e.replacement);t+=`import ${i} from '${s}'\n`,r+=`  type ${i}ComponentPublicInstance = InstanceType<typeof ${i}>\n`})),`${t}\ndeclare global {\n${r}\n}`}(function(e,t){const r=new Map;return t.forEach(((t,i)=>{const s=c.kebabCase(i),n=e.find((e=>e.pattern.test(s)||c.upperFirst(c.camelCase(e.name))===i));n&&r.set(i,n)})),r}(this._easycoms,this._easycomUsage)))}setEasycomUsage(e,t=[]){e=s.normalizePath(e),this._easycomUsage.forEach(((r,i)=>{t.includes(i)||(r.delete(e),0===r.size&&this._easycomUsage.delete(i))}));for(let r=0;r<t.length;r++){const i=t[r];this._easycomUsage.has(i)?this._easycomUsage.get(i)?.add(e):this._easycomUsage.set(i,new Set([e]))}this.initUts2jsEasycom()}}const Me=e=>{let r,i,o,c,d,u,f,m,h,y,g=!1,x=!1,S=0,v=!0;const b={},N=new Set,C=(e,t,r,i)=>{if(!t)return;e=s.normalizePath(e),N.add(e);const n=((e,t,r)=>h.getSyntacticDiagnostics(e,t,(()=>f.getSyntacticDiagnostics(e)),r).concat(h.getSemanticDiagnostics(e,t,(()=>f.getSemanticDiagnostics(e)),r)))(e,t,i);Ne(r,n,!1!==c.options.pretty),n.length>0&&(v=!1)},_=(e,t)=>{if(!t.dts)return;const r=s.normalizePath(e);b[r]={type:t.dts,map:t.dtsmap},i.debug((()=>`${n.blue("generated declarations")} for '${r}'`))},I=e=>!(e.endsWith(".d.ts")||e.endsWith(".d.cts")||e.endsWith(".d.mts"))&&!!o(e),D=()=>{g||v||i.info(n.yellow("there were errors or warnings.")),h?.done()},A=Object.assign({},{check:!0,verbosity:_e.Warning,clean:!1,cacheRoot:a({name:"rollup-plugin-uts"}),include:["*.(|u)ts+(|x)","**/*.(|u)ts+(|x)","**/*.cts","**/*.mts"],exclude:["*.d.ts","**/*.d.ts","**/*.d.cts","**/*.d.mts"],abortOnError:!1,rollupCommonJSResolveHack:!1,tsconfig:void 0,useTsconfigDeclarationDir:!1,tsconfigOverride:{},transformers:[],tsconfigDefaults:{},objectHashIgnoreUnknownHack:!1,cwd:process.cwd()},e);A.typescript||(A.typescript=require("typescript")),ve(A.typescript,e.modules),globalThis.uts2jsSourceCodeMap=new je;const P={name:"uts",options:e=>(r={...e},e),configureServer(e){e.watcher.addListener("all",((e,t)=>{if("add"===e||"unlink"===e){const e=s.normalizePath(t);E.has(e)&&E.delete(e)}}))},buildStart(){m=xe.createDocumentRegistry(),i=new De(A.verbosity,A.abortOnError,this,"uts: "),g="true"===process.env.ROLLUP_WATCH||!!this.meta.watchMode,({parsedTsConfig:c,fileName:d}=function(e,r){const i=xe.findConfigFile(r.cwd,xe.sys.fileExists,r.tsconfig);void 0===r.tsconfig||i||e.error(`failed to open '${r.tsconfig}'`);let s,n={},o=r.cwd,a=!0;if(i){const r=xe.sys.readFile(i),c=xe.parseConfigFileTextToJson(i,r);a=c.config?.pretty??a,void 0!==c.error&&(Ne(e,Ee("config",[c.error]),a),e.error(`failed to parse '${i}'`)),n=c.config,o=t.dirname(i),s=i}const c={};T.merge(c,r.tsconfigDefaults,n,r.tsconfigOverride);const l=xe.parseJsonConfigFileContent(c,xe.sys,o,Ae(r),s),p=Ae(r,l),d=xe.parseJsonConfigFileContent(c,xe.sys,o,p,s),u=d.options.module;return u!==xe.ModuleKind.ES2015&&u!==xe.ModuleKind.ES2020&&u!==xe.ModuleKind.ES2022&&u!==xe.ModuleKind.ESNext&&e.error(`Incompatible tsconfig option. Module resolves to '${xe.ModuleKind[u]}'. This is incompatible with Rollup, please use 'module: "ES2015"', 'module: "ES2020"', 'module: "ES2022"', or 'module: "ESNext"'.`),Ne(e,Ee("config",d.errors),a),e.debug(`built-in options overrides: ${JSON.stringify(p,void 0,4)}`),e.debug(`parsed tsconfig: ${JSON.stringify(d,void 0,4)}`),{parsedTsConfig:d,fileName:i}}(i,A)),i.info(`typescript version: ${xe.version}`),i.info(`tslib version: ${A.utsOptions.tslibVersion}`),i.info(`rollup version: ${this.meta.rollupVersion}`),l.satisfies(xe.version,Re,{includePrerelease:!0})||i.error(`Installed TypeScript version '${xe.version}' is outside of supported range '${Re}'`),l.satisfies(this.meta.rollupVersion,Le,{includePrerelease:!0})||i.error(`Installed Rollup version '${this.meta.rollupVersion}' is outside of supported range '${Le}'`),x=l.satisfies(this.meta.rollupVersion,">=2.60.0",{includePrerelease:!0}),x||i.warn((()=>`${n.yellow("You are using a Rollup version '<2.60.0'")}. This may result in type-only files being ignored.`)),i.info("rollup-plugin-uts version: 1.0.0"),i.debug((()=>`plugin options:\n${JSON.stringify(A,((e,t)=>"typescript"===e?`version ${t.version}`:t),4)}`)),i.debug((()=>`rollup config:\n${JSON.stringify(r,void 0,4)}`)),i.debug((()=>`tsconfig path: ${d}`)),A.objectHashIgnoreUnknownHack&&i.warn((()=>`${n.yellow("You are using 'objectHashIgnoreUnknownHack' option")}. If you enabled it because of async functions, try disabling it now.`)),A.rollupCommonJSResolveHack&&i.warn((()=>`${n.yellow("You are using 'rollupCommonJSResolveHack' option")}. This is no longer needed, try disabling it now.`)),g&&i.info("running in watch mode"),o=function(e,t,r){let i=t.include,n=t.exclude;return r.options.rootDirs&&(i=Pe(i,r.options.rootDirs),n=Pe(n,r.options.rootDirs)),r.projectReferences&&(i=Pe(i,r.projectReferences.map((e=>e.path))).concat(i),n=Pe(n,r.projectReferences.map((e=>e.path))).concat(n)),e.debug((()=>`included:\n${JSON.stringify(i,void 0,4)}`)),e.debug((()=>`excluded:\n${JSON.stringify(n,void 0,4)}`)),s.createFilter(i,n,{resolve:r.options.rootDir})}(i,A,c),u=new Oe(c,A.transformers,A.cwd),globalThis.uts2jsSourceCodeMap.forEach(((e,t)=>{u.setSnapshot(t,e)})),u.setSnapshot($e,A.utsOptions.tslibSource),globalThis.uts2jsSourceCodeMap.on("change",(function(e){const{fileName:t,source:r}=e||{};u.setSnapshot(t,r)})),f=xe.createLanguageService(u,m),u.setLanguageService(f);const e=A.clean,a=A.noCache||A.clean;if(h=new Fe(a,e,A.objectHashIgnoreUnknownHack,u,A.cacheRoot,c.options,c.fileNames,i),y=new Set,A.check){const e=Ee("options",f.getCompilerOptionsDiagnostics());Ne(i,e,!1!==c.options.pretty),e.length>0&&(v=!1)}},watchChange(e,t){const r=s.normalizePath(e);if(delete b[r],N.delete(r),"web"===process.env.UNI_UTS_PLATFORM)return;const{event:i}=t||{};"create"!==i&&"delete"!==i||E.has(r)&&E.delete(r)},resolveId(e,r){if(e===$e)return Ue;if(!r)return;r=s.normalizePath(r);const o=xe.nodeModuleNameResolver(e,r,c.options,xe.sys);let a=o.resolvedModule?.resolvedFileName;if(a){if(Te.has(s.normalizePath(a))&&(a=a.replace(".ts",".uts")),/.u?vue.ts$/.test(a))return a=a.replace(/.ts$/,""),t.normalize(a);if(I(a))return h.setDependency(a,r),i.debug((()=>`${n.blue("resolving")} '${e}' imported by '${r}'`)),i.debug((()=>`    to '${a}'`)),t.normalize(a)}},load:e=>e===Ue?A.utsOptions.tslibSource:null,async transform(r,a){y.add(a);const l=r.matchAll(/([a-zA-Z0-9]+)ComponentPublicInstance/g),m=[];for(const e of l)m.push(e[1]);m.length>0&&globalThis.uts2jsSourceCodeMap.setEasycomUsage(s.normalizePath(a),m);let S=a;if(S.endsWith(".json")&&(S=S.replace(/.json$/,".uts")),!o(S))return;const b=u.setSnapshot(S,r),E=h.getCompiled(S,b,(()=>{let r;const o=f.getProgram()?.getSourceFile(S);if("uts"===A.utsOptions.emitType){const e=[];if(o){const r=xe.createPrinter({}).printSourceFile(o,{host:be,map:{file:s.normalizePath(t.relative(A.utsOptions.inputDir??"",a)),sourceRoot:"",sourcesDirectoryPath:A.utsOptions.inputDir??""}});r.code&&e.push({name:"",writeByteOrderMark:!1,text:r.code}),r.map&&e.push({name:".map",writeByteOrderMark:!1,text:r.map})}else this.error(new Error(`Could not find source file: '${a}'.`));r={outputFiles:e,emitSkipped:!1}}else r=f.getEmitOutput(S);r.emitSkipped&&(v=!1,C(S,b,i,e?.abortOnError?void 0:new p.SourceMapConsumer(this.getCombinedSourcemap())),this.error(n.red(`Emit skipped for '${a}'. See https://github.com/microsoft/TypeScript/issues/49790 for potential reasons why this may occur`)));const l=function(e,t,r){if(!t)return[];const i=xe.preProcessFile(t.getText(0,t.getLength()),!0,!0);return T.compact(i.referencedFiles.concat(i.importedFiles).map((t=>{const i=xe.nodeModuleNameResolver(t.fileName,e,r,xe.sys),n=i.resolvedModule?.resolvedFileName;return n&&Te.has(s.normalizePath(n))&&n.endsWith(".ts")?n.replace(/.ts$/,".uts"):n})))}(S,b,c.options);return ke(r,l,[...o?.__utsMeta?.uniExtApis||[]])}));if(A.check&&C(S,b,i,new p.SourceMapConsumer(this.getCombinedSourcemap())),!E)return;if(g&&E.references&&(d&&this.addWatchFile(d),E.references.map(this.addWatchFile,this),i.debug((()=>`${n.green("    watching")}: ${E.references.join("\nuts:               ")}`))),_(a,E),E.references&&x)for(const e of E.references){if(!I(e))continue;const t=await this.resolve(e,a);t&&!y.has(t.id)&&await this.load({id:t.id})}if(c.options.emitDeclarationOnly)return void i.debug((()=>`${n.blue("emitDeclarationOnly")} enabled, not transforming TS`));const N={code:E.code,map:{mappings:""},meta:{uniExtApis:E.uniExtApis?[...E.uniExtApis]:[]}};if(E.map){A.sourceMapCallback?.(a,E.map);const e=JSON.parse(E.map);e.sourceRoot&&(e.sources=e.sources.map((r=>t.isAbsolute(r)?r:e.sourceRoot+r))),N.map=e}return N},buildEnd(e){if(S=0,e){D();const t=e.stack?.split(e.message)[1];t?this.error({...e,message:e.message,stack:t}):this.error(e)}if(!A.check)return D();g&&h.walkTree((e=>{if(!o(e))return;const t=u.getScriptSnapshot(e);C(e,t,i)})),c.fileNames.forEach((e=>{const t=s.normalizePath(e);if(N.has(t)||!o(t))return;i.debug((()=>`type-checking missed '${t}'`));const r=u.getScriptSnapshot(t);C(t,r,i)})),D()},generateBundle(e){if(i.debug((()=>`generating target ${S+1}`)),S++,!c.options.declaration)return;c.fileNames.forEach((e=>{const t=s.normalizePath(e);if(t in b||!o(t))return;i.debug((()=>`generating missed declarations for '${t}'`));const r=ke(f.getEmitOutput(t,!0));_(t,r)}));const r=(r,o,a)=>{if(!a)return;let c=a.name;if(c.includes("?")&&(c=c.split("?",1)+o),A.useTsconfigDeclarationDir)return i.debug((()=>`${n.blue("emitting declarations")} for '${r}' to '${c}'`)),void xe.sys.writeFile(c,a.text,a.writeByteOrderMark);let l=a.text;const p=`${A.cacheRoot}/placeholder`;if(".d.ts.map"===o&&(e?.file||e?.dir)){const r=e.file?t.dirname(e.file):e.dir,i=JSON.parse(l);i.sources=i.sources.map((e=>{const i=t.resolve(p,e);return s.normalizePath(t.relative(r,i))})),l=JSON.stringify(i)}const d=s.normalizePath(t.relative(p,c));i.debug((()=>`${n.blue("emitting declarations")} for '${r}' to '${d}'`)),this.emitFile({type:"asset",source:l,fileName:d})};Object.keys(b).forEach((e=>{const{type:t,map:i}=b[e];r(e,".d.ts",t),r(e,".d.ts.map",i)}))}};return P},Ke=h.pathToFileURL(__filename).href,We=t.dirname(h.fileURLToPath(Ke)),ze=i.createRequire(Ke);let Be=!1;exports.uts2js=function({inputDir:r,modules:i,...s}){Be||(Be=!0,globalThis.__utsHacker__={...globalThis.__utsHacker__,...fe});const n=s.include??["**/*.uts","**/*.ts"],o=s.typescript??ze("typescript"),a={...s,modules:i||{},include:n,typescript:o,transformers:[B(o,me,{targetLanguage:"JavaScript",setParentRecursive:!0})],utsOptions:{tslibSource:e.readFileSync(t.resolve(We,"../lib/runtime/index.js"),"utf8")}};a.tsconfigOverride||(a.tsconfigOverride={compilerOptions:{}}),a.tsconfigOverride.compilerOptions||(a.tsconfigOverride.compilerOptions={});const c=a.tsconfigOverride.compilerOptions,l={baseUrl:r?"src"===t.basename(r)?t.dirname(r):r:".",moduleResolution:"Bundler",importHelpers:!0,mapRoot:c.sourceMap?r:void 0,target:"ES2016"};for(const e in l)c.hasOwnProperty(e)||(c[e]=l[e]);return[Me(a)]};
